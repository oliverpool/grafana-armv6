"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7537],{"./public/app/plugins/datasource/grafana/module.ts":(e,a,t)=>{t.r(a),t.d(a,{plugin:()=>k});var n=t("./packages/grafana-data/src/index.ts"),s=t("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/from.js"),r=t("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),l=t("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),i=t("./packages/grafana-runtime/src/index.ts"),o=t("./public/app/plugins/datasource/grafana/types.ts"),d=t("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),u=t("./packages/grafana-ui/src/index.ts"),c=t("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),h=t("./public/app/core/components/TagFilter/TagFilter.tsx"),p=t("./public/app/features/annotations/api.ts"),g=t("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const f=(0,g.jsx)("div",{children:"Specify a list of tags to match. To specify a key and value tag use `key:value` syntax."}),m=[{label:"Dashboard",value:o._$.Dashboard,description:"Query for events created on this dashboard and show them in the panels where they where created"},{label:"Tags",value:o._$.Tags,description:"This will fetch any annotation events that match the tags filter"}],y=[10,50,100,200,300,500,1e3,2e3].map((e=>({label:String(e),value:e})));function b(e){let{query:a,onChange:t}=e;const n=a,{limit:s,matchAny:r,tags:l,type:i}=n,d=v();return(0,g.jsxs)(u.FieldSet,{className:d.container,children:[(0,g.jsx)(u.Field,{label:"Filter by",children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,inputId:"grafana-annotations__filter-by",options:m,value:i,onChange:e=>t(Object.assign({},n,{type:e.value}))})}),(0,g.jsx)(u.Field,{label:"Max limit",children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,inputId:"grafana-annotations__limit",width:16,options:y,value:s,onChange:e=>t(Object.assign({},n,{limit:e.value}))})}),i===o._$.Tags&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(u.Field,{label:"Match any",description:"Enabling this returns annotations that match any of the tags specified below",children:(0,g.jsx)(u.Switch,{id:"grafana-annotations__match-any",value:r,onChange:e=>t(Object.assign({},n,{matchAny:e.target.checked}))})}),(0,g.jsx)(u.Field,{label:"Tags",description:f,children:(0,g.jsx)(h.D,{allowCustomValue:!0,formatCreateLabel:e=>`Use custom value: ${e}`,inputId:"grafana-annotations__tags",onChange:e=>t(Object.assign({},n,{tags:e})),tagOptions:p.lK,tags:null!=l?l:[]})})]})]})}const v=()=>({container:c.css`
      max-width: 600px;
    `});var j=t("./public/app/features/dashboard/services/DashboardSrv.ts"),x=t("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),S=t("./public/app/features/dashboard/state/DashboardMigrator.ts"),C=t("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js");let w=100;class F extends i.DataSourceWithBackend{constructor(e){super(e),this.annotations={QueryEditor:b,prepareAnnotation(e){var a,t,n,s,r;return e.target=null!==(a=e.target)&&void 0!==a?a:{type:null!==(t=e.type)&&void 0!==t?t:o._$.Dashboard,limit:null!==(n=e.limit)&&void 0!==n?n:100,tags:null!==(s=e.tags)&&void 0!==s?s:[],matchAny:null!==(r=e.matchAny)&&void 0!==r&&r},e},prepareQuery(e){let a;if((0,x.isString)(e.datasource)){const t=(0,S.p)(e.datasource,{returnDefaultAsNull:!1});t&&(a=t)}else a=e.datasource;return Object.assign({},e,{refId:e.name,queryType:o.hR.Annotations,datasource:a})}}}query(e){const a=[],t=[],d=(0,i.getTemplateSrv)();for(const r of e.targets){if(r.queryType===o.hR.Annotations)return(0,s.D)(this.getAnnotations({range:e.range,rangeRaw:e.range.raw,annotation:r,dashboard:(0,j.h4)().getCurrent()}));if(!r.hide)if(r.queryType===o.hR.LiveMeasurements){var u,c;let t=d.replace(r.channel,e.scopedVars);const{filter:s}=r;t&&t.startsWith("telegraf/")&&(t="stream/"+t,r.channel=t);const l=(0,n.parseLiveChannelAddress)(t);if(!(0,n.isValidLiveChannelAddress)(l))continue;const o={maxLength:null!==(u=e.maxDataPoints)&&void 0!==u?u:500};r.buffer?(o.maxDelta=r.buffer,o.maxLength=2*o.maxLength):"now"===(null===(c=e.rangeRaw)||void 0===c?void 0:c.to)&&(o.maxDelta=e.range.to.valueOf()-e.range.from.valueOf()),a.push((0,i.getGrafanaLiveSrv)().getDataStream({key:`${e.requestId}.${w++}`,addr:l,filter:s,buffer:o}))}else r.queryType||(r.queryType=o.hR.RandomWalk),t.push(r)}return t.length&&a.push(super.query(Object.assign({},e,{targets:t}))),a.length?1===a.length?a[0]:(0,r.T)(...a):(0,l.of)()}listFiles(e){return this.query({targets:[{refId:"A",queryType:o.hR.List,path:e}]}).pipe((0,C.U)((e=>{var a;const t=null!==(a=e.data[0])&&void 0!==a?a:new n.MutableDataFrame;return new n.DataFrameView(t)})))}metricFindQuery(e){return Promise.resolve([])}async getAnnotations(e){var a;const t=(0,i.getTemplateSrv)(),s=e.annotation,r=s.target,l={from:e.range.from.valueOf(),to:e.range.to.valueOf(),limit:r.limit,tags:r.tags,matchAny:r.matchAny};if(r.type===o._$.Dashboard){if(!e.dashboard.id)return Promise.resolve({data:[]});l.dashboardId=e.dashboard.id,delete l.tags}else{if(!Array.isArray(r.tags)||0===r.tags.length)return Promise.resolve({data:[]});const e="__delimiter__",a=[];for(const n of l.tags){const s=t.replace(n,{},(a=>"string"==typeof a?a:a.join(e)));for(const t of s.split(e))a.push(t)}l.tags=a}const d=await(0,i.getBackendSrv)().get("/api/annotations",l,`grafana-data-source-annotations-${s.name}-${null===(a=e.dashboard)||void 0===a?void 0:a.id}`);return{data:[(0,n.toDataFrame)(d)]}}testDatasource(){return Promise.resolve()}}var T;function q(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class R extends d.PureComponent{constructor(e){super(e),q(this,"state",{channels:[],channelFields:{}}),q(this,"queryTypes",[{label:"Random Walk",value:o.hR.RandomWalk,description:"Random signal within the selected time range"},{label:"Live Measurements",value:o.hR.LiveMeasurements,description:"Stream real-time measurements from Grafana"},{label:"List public files",value:o.hR.List,description:"Show directory listings for public resources"}]),q(this,"onQueryTypeChange",(e=>{const{onChange:a,query:t,onRunQuery:n}=this.props;a(Object.assign({},t,{queryType:e.value})),n(),this.loadChannelInfo()})),q(this,"onChannelChange",(e=>{const{onChange:a,query:t,onRunQuery:n}=this.props;a(Object.assign({},t,{channel:null==e?void 0:e.value})),n()})),q(this,"onFieldNamesChange",(e=>{var a,t;const{onChange:n,query:s,onRunQuery:r}=this.props;let l=[];if(Array.isArray(e)?l=e.map((e=>e.value)):e.value&&(l=[e.value]),1===l.length&&(null===(a=s.filter)||void 0===a||null===(t=a.fields)||void 0===t||!t.length)&&s.channel){var i;const e=(null!==(i=this.state.channelFields[s.channel])&&void 0!==i?i:[]).find((e=>"time"===e.value||"Time"===e.value));e&&e.value&&e.value!==l[0]&&(l=[e.value,...l])}n(Object.assign({},s,{filter:Object.assign({},s.filter,{fields:l})})),r()})),q(this,"checkAndUpdateValue",((e,a)=>{const{onChange:t,query:s,onRunQuery:r}=this.props;if("buffer"===e){let e;if(a)try{e=1e3*n.rangeUtil.intervalToSeconds(a)}catch(e){console.warn("ERROR",e)}t(Object.assign({},s,{buffer:e}))}else t(Object.assign({},s,{[e]:a}));r()})),q(this,"handleEnterKey",(e=>{"Enter"===e.key&&this.checkAndUpdateValue("buffer",e.target.value)})),q(this,"handleBlur",(e=>{this.checkAndUpdateValue("buffer",e.target.value)})),q(this,"onFolderChanged",(e=>{const{onChange:a,query:t,onRunQuery:n}=this.props;a(Object.assign({},t,{path:null==e?void 0:e.value})),n()})),q(this,"handleSearchEnterKey",(e=>{"Enter"===e.key&&this.checkAndUpdateValue("query",e.target.value)})),q(this,"handleSearchBlur",(e=>{this.checkAndUpdateValue("query",e.target.value)})),i.config.featureToggles.panelTitleSearch&&this.queryTypes.push({label:"Search",value:o.hR.Search,description:"Search for grafana resources"})}loadChannelInfo(){(0,i.getBackendSrv)().fetch({url:"api/live/list"}).subscribe({next:e=>{var a;const t=null===(a=e.data)||void 0===a?void 0:a.channels;if(null!=t&&t.length){const e={},a=t.map((a=>{if(a.data){const t=new Set,s=(0,n.dataFrameFromJSON)(a.data);for(const e of s.fields)t.add(e.name);e[a.channel]=Array.from(t).map((e=>({value:e,label:e})))}return{value:a.channel,label:a.channel+" ["+a.minute_rate+" msg/min]"}}));this.setState({channelFields:e,channels:a})}}})}loadFolderInfo(){const e={targets:[{queryType:o.hR.List,refId:"A"}]};(0,i.getDataSourceSrv)().get("-- Grafana --").then((a=>{a.query(e).subscribe({next:e=>{if(e.data.length){const a=e.data[0].fields[0].values.toArray().map((e=>({value:e,label:e})));this.setState({folders:a})}}})}))}componentDidMount(){this.loadChannelInfo()}renderMeasurementsQuery(){var e;let{channel:a,filter:t,buffer:s}=this.props.query,{channels:r,channelFields:l}=this.state,i=r.find((e=>e.value===a));a&&!i&&(i={value:a,label:a,description:`Connected to ${a}`},r=[i,...r]);const o=new Set,d=a&&null!==(e=l[a])&&void 0!==e?e:[];if(null!=t&&t.fields)for(const e of t.fields)o.has(e)||(d.push({value:e,label:`${e} (not loaded)`,description:"Configured, but not found in the query results"}),o.add(e));let c="";return s&&(c=n.rangeUtil.secondsToHms(s/1e3)),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"gf-form",children:(0,g.jsx)(u.InlineField,{label:"Channel",grow:!0,labelWidth:12,children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,options:r,value:i||"",onChange:this.onChannelChange,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"Select measurements channel",isClearable:!0,noOptionsMessage:"Enter channel name",formatCreateLabel:e=>`Connect to: ${e}`})})}),a&&(0,g.jsxs)("div",{className:"gf-form",children:[(0,g.jsx)(u.InlineField,{label:"Fields",grow:!0,labelWidth:12,children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,options:d,value:(null==t?void 0:t.fields)||[],onChange:this.onFieldNamesChange,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"All fields",isClearable:!0,noOptionsMessage:"Unable to list all fields",formatCreateLabel:e=>`Field: ${e}`,isSearchable:!0,isMulti:!0})}),(0,g.jsx)(u.InlineField,{label:"Buffer",children:(0,g.jsx)(u.Input,{placeholder:"Auto",width:12,defaultValue:c,onKeyDown:this.handleEnterKey,onBlur:this.handleBlur,spellCheck:!1})})]}),T||(T=(0,g.jsx)(u.Alert,{title:"Grafana Live - Measurements",severity:"info",children:"This supports real-time event streams in Grafana core. This feature is under heavy development. Expect the interfaces and structures to change as this becomes more production ready."}))]})}renderListPublicFiles(){let{path:e}=this.props.query,{folders:a}=this.state;a||(a=[],this.loadFolderInfo());const t=a.find((a=>a.value===e));return e&&!t&&(a=[...a,{value:e,label:e}]),(0,g.jsx)(u.InlineFieldRow,{children:(0,g.jsx)(u.InlineField,{label:"Path",grow:!0,labelWidth:12,children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,options:a,value:t||"",onChange:this.onFolderChanged,allowCustomValue:!0,backspaceRemovesValue:!0,placeholder:"Select folder",isClearable:!0,formatCreateLabel:e=>`Folder: ${e}`})})})}renderSearch(){let{query:e}=this.props.query;return(0,g.jsx)(u.InlineFieldRow,{children:(0,g.jsx)(u.InlineField,{label:"Query",grow:!0,labelWidth:12,children:(0,g.jsx)(u.Input,{placeholder:"Everything",defaultValue:null!=e?e:"",onKeyDown:this.handleSearchEnterKey,onBlur:this.handleSearchBlur,spellCheck:!1})})})}render(){const e=Object.assign({},o.wi,this.props.query);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(u.InlineFieldRow,{children:(0,g.jsx)(u.InlineField,{label:"Query type",grow:!0,labelWidth:12,children:(0,g.jsx)(u.Select,{menuShouldPortal:!0,options:this.queryTypes,value:this.queryTypes.find((a=>a.value===e.queryType))||this.queryTypes[0],onChange:this.onQueryTypeChange})})}),e.queryType===o.hR.LiveMeasurements&&this.renderMeasurementsQuery(),e.queryType===o.hR.List&&this.renderListPublicFiles(),e.queryType===o.hR.Search&&this.renderSearch()]})}}const k=new n.DataSourcePlugin(F).setQueryEditor(R)},"./public/app/plugins/datasource/grafana/types.ts":(e,a,t)=>{let n;t.d(a,{_$:()=>r,hR:()=>n,wi:()=>s}),function(e){e.LiveMeasurements="measurements",e.Annotations="annotations",e.RandomWalk="randomWalk",e.List="list",e.Read="read",e.Search="search"}(n||(n={}));const s={refId:"A",queryType:n.RandomWalk};let r;!function(e){e.Dashboard="dashboard",e.Tags="tags"}(r||(r={}))}}]);
//# sourceMappingURL=grafanaPlugin.15718e8e3083449662a7.js.map
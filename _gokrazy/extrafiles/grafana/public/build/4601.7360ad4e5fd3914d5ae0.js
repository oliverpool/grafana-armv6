"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4601],{14601:(hi,Re,m)=>{m.r(Re),m.d(Re,{plugin:()=>fi});var Qe=m(7238),Jt=m(55294),Zt=m(1821),h=m(52423),a=m(68404),pe=m(69311),fe=m(2323),z=m(29516),We=m(18302),he=m(91605),f=m(71210),b=m(25474);const Xt=t=>(e,s)=>{const n={};for(const i in t)n[i]=t[i](e[i],s);return n},ve=(t,e,s)=>(0,a.useCallback)(i=>{t(s(e,i))},[t,e,s]),je=(0,a.createContext)(void 0),C=()=>{const t=(0,a.useContext)(je);if(!t)throw new Error("Use DispatchContext first.");return t},ze=t=>({name:t,pipelineAgg:""}),He=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,qe=t=>t.settings?.model==="ewma",ye=t=>t.settings?.model==="holt",ie=t=>t.settings?.model==="holt_winters",es=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),L=t=>E[t.type].requiresField,Y=t=>E[t.type].isPipelineAgg,ae=t=>E[t.type].supportsMultipleBucketPaths,ts=t=>E[t.type].supportsMissing,be=t=>E[t.type].hasSettings,ss=t=>E[t.type].hasMeta,Ue=t=>E[t.type].supportsInlineScript,ns=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],is=t=>ns.includes(t),E={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[ze(He([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",xpack:!0,requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",xpack:!0,requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},as={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},Ge=(t,e)=>{const s=e.filter(n=>ae(n)?n.pipelineVariables?.some(i=>i.pipelineAgg===t.id):L(n)&&t.id===n.field);return[...s,...s.flatMap(n=>Ge(n,e))]},Ee=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],rs=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],re={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"};function le(t="1"){return{type:"count",id:t}}function oe(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const Ye=(t,e)=>t.find(s=>s.id===e);function Se(t,e){return!!t?.metrics?.some(s=>s.type===e)}function ls(t){return t in as}function os(t){return!!E[t].supportsMultipleBucketPaths}var K=m(5048);const W=t=>L(t)?`${E[t.type].label} ${t.field}`:E[t.type].label,Fe=t=>Object.entries(t).reduce((e,[s,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const i=Fe(n);return Object.keys(i).length===0?{...e}:{...e,[s]:i}}return{...e,[s]:n}},{}),Ke=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},J=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",Je=t=>{if(typeof t=="string")return(0,K.valid)(t)||"8.0.0";switch(t){case 2:return"2.0.0";case 5:return"5.0.0";case 56:return"5.6.0";case 60:return"6.0.0";case 70:return"7.0.0";default:return"8.0.0"}},xe=t=>!!(0,K.gte)(t,"7.10.0");var S=m(32557);const Ze=(0,S.PH)("@metrics/add"),Xe=(0,S.PH)("@metrics/remove"),et=(0,S.PH)("@metrics/toggle_visibility"),Me=(0,S.PH)("@metrics/change_field"),Ie=(0,S.PH)("@metrics/change_type"),tt=(0,S.PH)("@metrics/change_attr"),x=(0,S.PH)("@metrics/change_setting"),st=(0,S.PH)("@metrics/change_meta"),Z=(0,S.PH)("init"),nt=(0,S.PH)("change_query"),it=(0,S.PH)("change_alias_pattern"),cs=(t,e)=>nt.match(e)?e.payload:Z.match(e)?t||"":t,us=(t,e)=>it.match(e)?e.payload:Z.match(e)?t||"":t;var we=m(38306);const at=()=>({label:"",query:"*"}),F={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[at()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:we.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}}},rt=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],Pe=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],ds=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],lt=(0,S.PH)("@bucketAggs/add"),ot=(0,S.PH)("@bucketAggs/remove"),ct=(0,S.PH)("@bucketAggs/change_type"),ut=(0,S.PH)("@bucketAggs/change_field"),I=(0,S.PH)("@bucketAggs/change_setting"),gs=t=>(e,s)=>{if(lt.match(s)){const n={id:s.payload,type:"terms",settings:F.terms.defaultSettings},i=e[e.length-1];return i?.type==="date_histogram"?[...e.slice(0,e.length-1),n,i]:[...e,n]}return ot.match(s)?e.filter(n=>n.id!==s.payload):ct.match(s)?e.map(n=>n.id!==s.payload.id?n:{id:n.id,type:s.payload.newType,settings:F[s.payload.newType].defaultSettings}):ut.match(s)?e.map(n=>n.id!==s.payload.id?n:{...n,field:s.payload.newField}):Ie.match(s)?E[s.payload.type].isSingleMetric?[]:e.length===0?[{...oe("2"),field:t}]:e:I.match(s)?e.map(n=>{if(n.id!==s.payload.bucketAgg.id)return n;const i=Fe({...n.settings,[s.payload.settingName]:s.payload.newValue});return{...n,settings:{...i}}}):Z.match(s)?e?.length||0>0?e:[{...oe("2"),field:t}]:e},ms=(t,e)=>{if(Ze.match(e))return[...t,le(e.payload)];if(Xe.match(e)){const s=t.find(r=>r.id===e.payload),n=[s,...Ge(s,t)],i=t.filter(r=>!n.some(l=>l.id===r.id));return i.length===0?[le("1")]:i}return Ie.match(e)?t.filter(s=>E[e.payload.type].isSingleMetric?s.id===e.payload.id:!0).map(s=>s.id!==e.payload.id?s:{id:s.id,type:e.payload.type,...E[e.payload.type].defaults}):Me.match(e)?t.map(s=>{if(s.id!==e.payload.id)return s;const n={...s,field:e.payload.field};return Y(s)?{...n,pipelineAgg:e.payload.field}:n}):et.match(e)?t.map(s=>s.id!==e.payload?s:{...s,hide:!s.hide}):x.match(e)?t.map(s=>{if(s.id!==e.payload.metric.id)return s;if(be(s)){const n=Fe({...s.settings,[e.payload.settingName]:e.payload.newValue});return{...s,settings:{...n}}}return s}):st.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:ss(s)?{...s,meta:{...s.meta,[e.payload.meta]:e.payload.newValue}}:s):tt.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:{...s,[e.payload.attribute]:e.payload.newValue}):Z.match(e)?t?.length||0>0?t:[le("1")]:t},dt=(0,a.createContext)(void 0),gt=(0,a.createContext)(void 0),mt=(0,a.createContext)(void 0),ps=({children:t,onChange:e,onRunQuery:s,query:n,datasource:i,range:r})=>{const l=(0,a.useCallback)(p=>{e(p),s()},[e,s]),c=Xt({query:cs,alias:us,metrics:ms,bucketAggs:gs(i.timeField)}),o=ve(p=>l({...n,...p,timeField:i.timeField}),n,c),u=!n.metrics||!n.bucketAggs||n.query===void 0,[d,g]=(0,a.useState)(u);return(0,a.useEffect)(()=>{d&&(o(Z()),g(!1))},[d,o]),u?null:a.createElement(dt.Provider,{value:i},a.createElement(gt.Provider,{value:n},a.createElement(mt.Provider,{value:r},a.createElement(je.Provider,{value:o},t))))},Ce=t=>()=>{const e=(0,a.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},j=Ce(gt),pt=Ce(dt),fs=Ce(mt),ft=t=>t.id,hs=t=>parseInt(t,10),vs=()=>{const{metrics:t,bucketAggs:e}=j();return(0,a.useMemo)(()=>(Math.max(...[...t?.map(ft)||["0"],...e?.map(ft)||["0"]].map(hs))+1).toString(),[t,e])};var ht=m(81697);const ys=h.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,ce=({iconName:t,onClick:e,className:s,label:n,...i})=>a.createElement("button",{className:(0,h.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:e,...i},a.createElement("span",{className:ys},n),a.createElement(ht.J,{name:t,"aria-hidden":"true"}));var v=m(82897),bs=m(9274),ue=m(24657),vt=m(20017);const yt=({children:t,label:e,onRemoveClick:s,onHideClick:n,hidden:i=!1})=>{const r=(0,z.wW)(Es);return a.createElement(bs.Z,null,a.createElement(ue.m,null,a.createElement(he.W,{width:17,as:"div"},a.createElement("span",null,e),a.createElement("span",{className:r.iconWrapper},n&&a.createElement(vt.h,{name:i?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":i,"aria-label":"hide metric",className:r.icon,type:"button"}),a.createElement(vt.h,{name:"trash-alt",size:"sm",className:r.icon,onClick:s||v.noop,disabled:!s,"aria-label":"remove metric",type:"button"})))),t)},Es=t=>({iconWrapper:h.css`
      display: flex;
    `,icon:h.css`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var _e=m(75154),De=m(29822),R=m(3363);const bt=t=>F[t.type].requiresField,Ss=["date_histogram","histogram","terms","filters","geohash_grid"],Fs=t=>Ss.includes(t),xs=t=>{if(is(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(Fs(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Ms=({text:t})=>({label:t,value:t}),de=t=>{const e=pt(),s=fs(),n=Array.isArray(t)?t:xs(t);let i;return async r=>(i||(i=await(0,R.n)(e.getFields(n,s))),i.filter(({text:l})=>r===void 0||l.includes(r)).map(Ms))},H=h.css`
  min-width: 150px;
`,Is=(t,e)=>({wrapper:h.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:h.css`
      padding-top: ${t.spacing(.5)};
    `,icon:h.css`
      margin-right: ${t.spacing(.5)};
    `,button:h.css`
      justify-content: start;
      ${e&&h.css`
        color: ${t.colors.text.disabled};
      `}
    `}),Et=({label:t,children:e,hidden:s=!1})=>{const[n,i]=(0,a.useState)(!1),r=(0,z.l4)(),l=Is(r,s);return a.createElement(ue.m,null,a.createElement("div",{className:(0,h.cx)(l.wrapper)},a.createElement("button",{className:(0,h.cx)("gf-form-label query-part",l.button,H),onClick:()=>i(!n),"aria-expanded":n,type:"button"},a.createElement(ht.J,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:l.icon}),t),n&&a.createElement("div",{className:l.settingsWrapper},e)))};var O=m(46739),ws=m(68172);const Ps=t=>({value:e})=>e===t,Cs=(t,e)=>e===void 0||t.some(Ps(e))?t:[...t,{value:e,label:e}],St=({options:t,value:e,onChange:s})=>{const[n,i]=(0,a.useState)(Cs(t,e)),r=l=>i([...n,{value:l,label:l}]);return{onCreateOption:l=>{r(l),s({value:l})},onChange:s,allowCustomValue:!0,options:n,value:e}},_s=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],Ds=t=>({value:e})=>e===t,Ns=(t,e,s)=>!s.some(Ds(t))&&t.trim().length>0,Ts=(t,e)=>t.value?.startsWith(e)||!1,ks=({bucketAgg:t})=>{const e=C(),{current:s}=(0,a.useRef)((0,v.uniqueId)("es-date_histogram-")),n=({value:i})=>e(I({bucketAgg:t,settingName:"interval",newValue:i}));return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Interval",...D},a.createElement(O.Ph,{inputId:(0,v.uniqueId)("es-date_histogram-interval"),isValidNewOption:Ns,filterOption:Ts,...St({options:_s,value:t.settings?.interval||F.date_histogram.defaultSettings?.interval,onChange:n})})),a.createElement(f._,{label:"Min Doc Count",...D},a.createElement(b.I,{id:`${s}-min_doc_count`,onBlur:i=>e(I({bucketAgg:t,settingName:"min_doc_count",newValue:i.target.value})),defaultValue:t.settings?.min_doc_count||F.date_histogram.defaultSettings?.min_doc_count})),a.createElement(f._,{label:"Trim Edges",...D,tooltip:"Trim the edges on the timeseries datapoints"},a.createElement(b.I,{id:`${s}-trime_edges`,onBlur:i=>e(I({bucketAgg:t,settingName:"trimEdges",newValue:i.target.value})),defaultValue:t.settings?.trimEdges||F.date_histogram.defaultSettings?.trimEdges})),a.createElement(f._,{label:"Offset",...D,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},a.createElement(b.I,{id:`${s}-offset`,onBlur:i=>e(I({bucketAgg:t,settingName:"offset",newValue:i.target.value})),defaultValue:t.settings?.offset||F.date_histogram.defaultSettings?.offset})),a.createElement(f._,{label:"Timezone",...D},a.createElement(ws.O,{value:t.settings?.timeZone||F.date_histogram.defaultSettings?.timeZone,includeInternal:[we.RQ.utc],onChange:i=>{e(I({bucketAgg:t,settingName:"timeZone",newValue:i}))}})))},Ft=({index:t,onAdd:e,onRemove:s,elements:n})=>a.createElement("div",{className:h.css`
        display: flex;
      `},t===0&&a.createElement(ce,{iconName:"plus",onClick:e,label:"add"}),n.length>=2&&a.createElement(ce,{iconName:"minus",onClick:s,label:"remove"})),Ne=(0,S.PH)("@bucketAggregations/filter/add"),xt=(0,S.PH)("@bucketAggregations/filter/remove"),Te=(0,S.PH)("@bucketAggregations/filter/change"),Vs=(t=[],e)=>Ne.match(e)?[...t,at()]:xt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Te.match(e)?t.map((s,n)=>n!==e.payload.index?s:e.payload.filter):t,$s=({bucketAgg:t})=>{const{current:e}=(0,a.useRef)((0,v.uniqueId)("es-filters-")),s=C(),n=ve(i=>s(I({bucketAgg:t,settingName:"filters",newValue:i})),t.settings?.filters,Vs);return(0,a.useEffect)(()=>{t.settings?.filters?.length||n(Ne())},[n,t.settings?.filters?.length]),a.createElement(a.Fragment,null,a.createElement("div",{className:h.css`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((i,r)=>a.createElement("div",{key:r,className:h.css`
              display: flex;
            `},a.createElement(f._,{label:"Query",labelWidth:8},a.createElement("div",{className:h.css`
                  width: 150px;
                `},a.createElement(We.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:l=>n(Te({index:r,filter:{...i,query:l}})),query:i.query}))),a.createElement(f._,{label:"Label",labelWidth:8},a.createElement(b.I,{width:16,id:`${e}-label-${r}`,placeholder:"Label",onBlur:l=>n(Te({index:r,filter:{...i,label:l.target.value}})),defaultValue:i.label})),a.createElement(Ft,{index:r,elements:t.settings?.filters||[],onAdd:()=>n(Ne()),onRemove:()=>n(xt(r))})))))},Os=({bucketAgg:t})=>{const{metrics:e}=j(),s=Rs(e),{current:n}=(0,a.useRef)((0,v.uniqueId)("es-terms-")),i=C();return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Order",...D},a.createElement(O.Ph,{inputId:`${n}-order`,onChange:r=>i(I({bucketAgg:t,settingName:"order",newValue:r.value})),options:Pe,value:t.settings?.order||F.terms.defaultSettings?.order})),a.createElement(f._,{label:"Size",...D},a.createElement(O.Ph,{inputId:`${n}-size`,...St({options:ds,value:t.settings?.size||F.terms.defaultSettings?.size,onChange({value:r}){i(I({bucketAgg:t,settingName:"size",newValue:r}))}})})),a.createElement(f._,{label:"Min Doc Count",...D},a.createElement(b.I,{id:`${n}-min_doc_count`,onBlur:r=>i(I({bucketAgg:t,settingName:"min_doc_count",newValue:r.target.value})),defaultValue:t.settings?.min_doc_count||F.terms.defaultSettings?.min_doc_count})),a.createElement(f._,{label:"Order By",...D},a.createElement(O.Ph,{inputId:`${n}-order_by`,onChange:r=>i(I({bucketAgg:t,settingName:"orderBy",newValue:r.value})),options:s,value:t.settings?.orderBy||F.terms.defaultSettings?.orderBy})),a.createElement(f._,{label:"Missing",...D},a.createElement(b.I,{id:`${n}-missing`,onBlur:r=>i(I({bucketAgg:t,settingName:"missing",newValue:r.target.value})),defaultValue:t.settings?.missing||F.terms.defaultSettings?.missing})))};function As(t){return t.meta?Object.keys(t.meta).filter(s=>t.meta?.[s]).map(s=>{let n=s;return s==="std_deviation_bounds_lower"&&(n="std_lower"),s==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${W(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function Bs(t){return t.settings?.percents?t.settings.percents.map(e=>{const s=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${W(t)} (${e})`,value:`${t.id}[${s}]`}}):[]}function Ls(t){return t.type!=="top_metrics"&&!Y(t)}const Rs=(t=[])=>{const e=t.filter(Ls).flatMap(s=>s.type==="extended_stats"?As(s):s.type==="percentiles"?Bs(s):{label:W(s),value:s.id});return[...rt,...e]},Mt=t=>e=>e.value===t,Qs=t=>{const{metrics:e}=j();switch(t.type){case"terms":{const s=t.settings?.order||"desc",n=t.settings?.size||"10",i=parseInt(t.settings?.min_doc_count||"0",10),r=t.settings?.orderBy||"_term";let l="";n!=="0"&&(l=`${Pe.find(Mt(s))?.label} ${n}, `),i>0&&(l+=`Min Doc Count: ${i}, `),l+="Order by: ";const c=rt.find(Mt(r));if(c)l+=c.label;else{const o=e?.find(u=>u.id===Ke(r));o?l+=W(o):l+="metric not found"}return n==="0"&&(l+=` (${s})`),l}case"histogram":{const s=t.settings?.interval||1e3,n=t.settings?.min_doc_count||1;return`Interval: ${s}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||F.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${Math.max(Math.min(parseInt(t.settings?.precision||"5",10),12),1)}`;case"date_histogram":{const s=t.settings?.interval||"auto",n=t.settings?.min_doc_count||0,i=t.settings?.trimEdges||0;let r=`Interval: ${s}`;return n>0&&(r+=`, Min Doc Count: ${n}`),i>0&&(r+=`, Trim edges: ${i}`),r}default:return"Settings"}},D={labelWidth:16},Ws=({bucketAgg:t})=>{const{current:e}=(0,a.useRef)((0,v.uniqueId)("es-setting-")),s=C(),n=Qs(t);return a.createElement(Et,{label:n},t.type==="terms"&&a.createElement(Os,{bucketAgg:t}),t.type==="date_histogram"&&a.createElement(ks,{bucketAgg:t}),t.type==="filters"&&a.createElement($s,{bucketAgg:t}),t.type==="geohash_grid"&&a.createElement(f._,{label:"Precision",...D},a.createElement(b.I,{id:`${e}-geohash_grid-precision`,onBlur:i=>s(I({bucketAgg:t,settingName:"precision",newValue:i.target.value})),defaultValue:t.settings?.precision||F[t.type].defaultSettings?.precision})),t.type==="histogram"&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Interval",...D},a.createElement(b.I,{id:`${e}-histogram-interval`,onBlur:i=>s(I({bucketAgg:t,settingName:"interval",newValue:i.target.value})),defaultValue:t.settings?.interval||F[t.type].defaultSettings?.interval})),a.createElement(f._,{label:"Min Doc Count",...D},a.createElement(b.I,{id:`${e}-histogram-min_doc_count`,onBlur:i=>s(I({bucketAgg:t,settingName:"min_doc_count",newValue:i.target.value})),defaultValue:t.settings?.min_doc_count||F[t.type].defaultSettings?.min_doc_count}))))},js=Object.entries(F).map(([t,{label:e}])=>({label:e,value:t})),zs=t=>({label:F[t.type].label,value:t.type}),Hs=({value:t})=>{const e=C(),s=de(t.type);return a.createElement(a.Fragment,null,a.createElement(ue.m,null,a.createElement(_e.X,{className:H,options:js,onChange:n=>e(ct({id:t.id,newType:n.value})),value:zs(t)}),bt(t)&&a.createElement(De.V,{className:H,loadOptions:s,onChange:n=>e(ut({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),a.createElement(Ws,{bucketAgg:t}))},qs=({nextId:t})=>{const e=C(),{bucketAggs:s}=j(),n=s?.length||0;return a.createElement(a.Fragment,null,s.map((i,r)=>a.createElement(yt,{key:`${i.type}-${i.id}`,label:r===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(ot(i.id)))},a.createElement(Hs,{value:i}),r===0&&a.createElement(ce,{iconName:"plus",onClick:()=>e(lt(t)),label:"add"}))))},Us=h.css`
  white-space: nowrap;
`,It=t=>({label:W(t),value:t}),Gs=t=>t.map(It),wt=({options:t,onChange:e,className:s,value:n})=>{const i=t.find(r=>r.id===n);return a.createElement(_e.X,{className:(0,h.cx)(s,Us),options:Gs(t),onChange:e,placeholder:"Select Metric",value:i?It(i):void 0})};var X=m(44727);function _({label:t,settingName:e,metric:s,placeholder:n,tooltip:i}){const r=C(),[l]=(0,a.useState)((0,v.uniqueId)("es-field-id-"));let o=s.settings?.[e]||"";return e==="script"&&(o=J(s)),a.createElement(f._,{label:t,labelWidth:16,tooltip:i},a.createElement(b.I,{id:l,placeholder:n,onBlur:u=>r(x({metric:s,settingName:e,newValue:u.target.value})),defaultValue:o}))}const ke=(0,S.PH)("@pipelineVariables/add"),Pt=(0,S.PH)("@pipelineVariables/remove"),Ct=(0,S.PH)("@pipelineVariables/rename"),_t=(0,S.PH)("@pipelineVariables/change_metric"),Ys=(t=[],e)=>ke.match(e)?[...t,ze(He(t))]:Pt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Ct.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,name:e.payload.newName}):_t.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,pipelineAgg:e.payload.newMetric}):t,Ks=({value:t,previousMetrics:e})=>{const s=C(),n=ve(i=>s(tt({metric:t,attribute:"pipelineVariables",newValue:i})),t.pipelineVariables,Ys);return(0,a.useEffect)(()=>{t.pipelineVariables?.length||n(ke())},[n,t.pipelineVariables?.length]),a.createElement(a.Fragment,null,a.createElement("div",{className:h.css`
          display: flex;
        `},a.createElement(he.W,{width:16},"Variables"),a.createElement("div",{className:h.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((i,r)=>a.createElement(a.Fragment,{key:(0,v.uniqueId)("es-bs-")},a.createElement("div",{className:h.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},a.createElement(b.I,{"aria-label":"Variable name",defaultValue:i.name,placeholder:"Variable Name",onBlur:l=>n(Ct({newName:l.target.value,index:r}))}),a.createElement(wt,{onChange:l=>n(_t({newMetric:l.value.id,index:r})),options:e,value:i.pipelineAgg})),a.createElement(Ft,{index:r,elements:t.pipelineVariables||[],onAdd:()=>n(ke()),onRemove:()=>n(Pt(r))}))))),a.createElement(_,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},Js=({metric:t})=>{const e=C(),{current:s}=(0,a.useRef)((0,v.uniqueId)("es-moving-avg-"));return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Model",labelWidth:16},a.createElement(O.Ph,{inputId:`${s}-model`,onChange:n=>e(x({metric:t,settingName:"model",newValue:n.value})),options:rs,value:t.settings?.model})),a.createElement(_,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),a.createElement(_,{label:"Predict",settingName:"predict",metric:t}),(qe(t)||ye(t)||ie(t))&&a.createElement(f._,{label:"Alpha",labelWidth:16},a.createElement(b.I,{id:`${s}-alpha`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(ye(t)||ie(t))&&a.createElement(f._,{label:"Beta",labelWidth:16},a.createElement(b.I,{id:`${s}-beta`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),ie(t)&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Gamma",labelWidth:16},a.createElement(b.I,{id:`${s}-gamma`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),a.createElement(f._,{label:"Period",labelWidth:16},a.createElement(b.I,{id:`${s}-period`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),a.createElement(f._,{label:"Pad",labelWidth:16},a.createElement(X.x,{id:`${s}-pad`,onChange:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(qe(t)||ye(t)||ie(t))&&a.createElement(f._,{label:"Minimize",labelWidth:16},a.createElement(X.x,{id:`${s}-minimize`,onChange:n=>e(x({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},Zs=t=>({value:t,label:t}),Xs=({metric:t})=>{const e=C(),s=de(["number","date"]),n=de(t.type);return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Metrics",labelWidth:16},a.createElement(O.M8,{onChange:i=>e(x({metric:t,settingName:"metrics",newValue:i.map(r=>r.value)})),loadOptions:n,value:t.settings?.metrics?.map(Zs),closeMenuOnSelect:!1,defaultOptions:!0})),a.createElement(f._,{label:"Order",labelWidth:16},a.createElement(O.Ph,{onChange:i=>e(x({metric:t,settingName:"order",newValue:i.value})),options:Pe,value:t.settings?.order})),a.createElement(f._,{label:"Order By",labelWidth:16,className:h.css`
          & > div {
            width: 100%;
          }
        `},a.createElement(De.V,{className:h.css`
            margin-right: 0;
          `,loadOptions:s,onChange:i=>e(x({metric:t,settingName:"orderBy",newValue:i.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},en=t=>e=>e.value===t,tn=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([s,n])=>n&&Ee.find(en(s))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},ee={labelWidth:16},sn=({metric:t,previousMetrics:e})=>{const{current:s}=(0,a.useRef)((0,v.uniqueId)("es-setting-")),n=C(),i=tn(t),r=j(),l=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],c=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return a.createElement(Et,{label:i,hidden:t.hide},t.type==="derivative"&&a.createElement(_,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&a.createElement(_,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&a.createElement(_,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&a.createElement(Js,{metric:t}),t.type==="moving_fn"&&a.createElement(a.Fragment,null,a.createElement(_,{label:"Window",metric:t,settingName:"window"}),a.createElement(_,{label:"Script",metric:t,settingName:"script"}),a.createElement(_,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&a.createElement(Xs,{metric:t}),t.type==="bucket_script"&&a.createElement(Ks,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&a.createElement(f._,{label:"Size",...ee},a.createElement(b.I,{id:`ES-query-${r.refId}_metric-${t.id}-size`,onBlur:o=>n(x({metric:t,settingName:"size",newValue:o.target.value})),defaultValue:t.settings?.size??E.raw_data.defaults.settings?.size})),t.type==="logs"&&a.createElement(_,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&a.createElement(_,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&a.createElement(a.Fragment,null,Ee.map(o=>a.createElement(nn,{key:o.value,stat:o,onChange:u=>n(st({metric:t,meta:o.value,newValue:u})),value:t.meta?.[o.value]!==void 0?!!t.meta?.[o.value]:!!E.extended_stats.defaults.meta?.[o.value]})),a.createElement(_,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&a.createElement(f._,{label:"Percentiles",...ee},a.createElement(b.I,{id:`${s}-percentiles-percents`,onBlur:o=>n(x({metric:t,settingName:"percents",newValue:o.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||E.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Unit",...ee,"data-testid":"unit-select"},a.createElement(O.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-unit`,onChange:o=>n(x({metric:t,settingName:"unit",newValue:o.value})),options:l,value:t.settings?.unit})),a.createElement(f._,{label:"Mode",...ee,"data-testid":"mode-select"},a.createElement(O.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-mode`,onChange:o=>n(x({metric:t,settingName:"mode",newValue:o.value})),options:c,value:t.settings?.unit}))),Ue(t)&&a.createElement(_,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),ts(t)&&a.createElement(_,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},nn=({stat:t,onChange:e,value:s})=>{const[n]=(0,a.useState)((0,v.uniqueId)("es-field-id-"));return a.createElement(f._,{label:t.label,...ee,key:t.value},a.createElement(X.x,{id:n,onChange:i=>e(i.target.checked),value:s}))},an=(t,e)=>({color:e&&h.css`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),rn=t=>({label:E[t.type].label,value:t.type}),ln=t=>!E[t.type].isPipelineAgg,on=(t,e,s=!1)=>{const n=t.some(ln);return Object.entries(E).filter(([i,{versionRange:r="*"}])=>(0,K.satisfies)(e,r)).filter(([i,r])=>n||!r.isPipelineAgg).filter(([i,r])=>r.xpack?s:!0).map(([i,{label:r}])=>({label:r,value:i}))},cn=({value:t})=>{const e=an((0,z.l4)(),!!t.hide),s=pt(),n=j(),i=C(),r=de(t.type),l=(0,a.useCallback)(async()=>{const o=await r();return Ue(t)?[{label:"None"},...o]:o},[r,t]),c=n.metrics.slice(0,n.metrics.findIndex(o=>o.id===t.id));return a.createElement(a.Fragment,null,a.createElement(ue.m,null,a.createElement(_e.X,{className:(0,h.cx)(e.color,H),options:on(c,s.esVersion,s.xpack),onChange:o=>i(Ie({id:t.id,type:o.value})),value:rn(t)}),L(t)&&!Y(t)&&a.createElement(De.V,{className:(0,h.cx)(e.color,H),loadOptions:l,onChange:o=>i(Me({id:t.id,field:o.value})),placeholder:"Select Field",value:t.field}),Y(t)&&!ae(t)&&a.createElement(wt,{className:(0,h.cx)(e.color,H),onChange:o=>i(Me({id:t.id,field:o.value?.id})),options:c,value:t.field})),be(t)&&a.createElement(sn,{metric:t,previousMetrics:c}))},un=({nextId:t})=>{const e=C(),{metrics:s}=j(),n=s?.length||0;return a.createElement(a.Fragment,null,s?.map((i,r)=>a.createElement(yt,{key:`${i.type}-${i.id}`,label:`Metric (${i.id})`,hidden:i.hide,onHideClick:()=>e(et(i.id)),onRemoveClick:n>1&&(()=>e(Xe(i.id)))},a.createElement(cn,{value:i}),!E[i.type].isSingleMetric&&r===0&&a.createElement(ce,{iconName:"plus",onClick:()=>e(Ze(t)),label:"add"}))))},dn=({query:t,onChange:e,onRunQuery:s,datasource:n,range:i})=>xe(n.esVersion)?a.createElement(ps,{datasource:n,onChange:e,onRunQuery:s,query:t,range:i||(0,pe.JK)()},a.createElement(gn,{value:t})):a.createElement(fe.b,{title:"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"}),Dt=t=>({root:h.css`
    display: flex;
  `,queryFieldWrapper:h.css`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),Nt=({value:t,onChange:e})=>{const s=(0,z.wW)(Dt);return a.createElement("div",{className:s.queryFieldWrapper},a.createElement(We.q,{query:t,onBlur:()=>{},onChange:e,placeholder:"Lucene Query",portalOrigin:"elasticsearch"}))},gn=({value:t})=>{const e=C(),s=vs(),n=(0,z.wW)(Dt),i=t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram",r=t.metrics?.every(l=>!E[l.type].isSingleMetric);return a.createElement(a.Fragment,null,a.createElement("div",{className:n.root},a.createElement(he.W,{width:17},"Query"),a.createElement(Nt,{onChange:l=>e(nt(l)),value:t?.query}),a.createElement(f._,{label:"Alias",labelWidth:15,disabled:!i,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored."},a.createElement(b.I,{id:`ES-query-${t.refId}_alias`,placeholder:"Alias Pattern",onBlur:l=>e(it(l.currentTarget.value)),defaultValue:t.alias}))),a.createElement(un,{nextId:s}),r&&a.createElement(qs,{nextId:s}))};var mn=m(37308),pn=m(32695),fn=m(97064),Tt=m(47694),hn=m(89029),vn=m(28151),kt=m(90723),yn=m(54291),bn=m(2248),En=m(89014),Sn=m(82385),Fn=m(64377);const{FormField:Ve,Switch:xn}=En.LegacyForms,Mn=(0,Sn.B)(()=>({firstRow:h.css`
    display: flex;
  `,nameField:h.css`
    flex: 2;
  `,regexField:h.css`
    flex: 3;
  `,row:h.css`
    display: flex;
    align-items: baseline;
  `,urlField:h.css`
    flex: 1;
  `,urlDisplayLabelField:h.css`
    flex: 1;
  `})),In=t=>{const{value:e,onChange:s,onDelete:n,suggestions:i,className:r}=t,l=Mn(),[c,o]=wn(e.datasourceUid),u=d=>g=>{s({...e,[d]:g.currentTarget.value})};return a.createElement("div",{className:r},a.createElement("div",{className:l.firstRow+" gf-form"},a.createElement(Ve,{className:l.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:e.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:u("field")}),a.createElement(kt.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:d=>{d.preventDefault(),n()}})),a.createElement("div",{className:"gf-form"},a.createElement(Ve,{label:c?"Query":"URL",labelWidth:6,inputEl:a.createElement(Fn.v,{placeholder:c?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:d=>s({...e,url:d}),suggestions:i}),className:l.urlField}),a.createElement(Ve,{className:l.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:e.urlDisplayLabel,onChange:u("urlDisplayLabel"),tooltip:"Use to override the button label."})),a.createElement("div",{className:l.row},a.createElement(xn,{labelClass:"width-6",label:"Internal link",checked:c,onChange:()=>{c&&s({...e,datasourceUid:void 0}),o(!c)}}),c&&a.createElement(bn.q,{tracing:!0,onChange:d=>{s({...e,datasourceUid:d.uid})},current:e.datasourceUid})))};function wn(t){const[e,s]=(0,a.useState)(!!t),n=(0,yn.Z)(t);return(0,a.useEffect)(()=>{!n&&t&&!e&&s(!0),n&&!t&&e&&s(!1)},[n,t,e]),[e,s]}const Pn=t=>({infoText:h.css`
      padding-bottom: ${t.spacing(2)};
      color: ${t.colors.text.secondary};
    `,dataLink:h.css`
      margin-bottom: ${t.spacing(1)};
    `}),Cn=t=>{const{value:e,onChange:s}=t,n=(0,z.wW)(Pn);return a.createElement(a.Fragment,null,a.createElement("h3",{className:"page-heading"},"Data links"),a.createElement("div",{className:n.infoText},"Add links to existing fields. Links will be shown in log row details next to the field value."),e&&e.length>0&&a.createElement("div",{className:"gf-form-group"},e.map((i,r)=>a.createElement(In,{className:n.dataLink,key:r,value:i,onChange:l=>{const c=[...e];c.splice(r,1,l),s(c)},onDelete:()=>{const l=[...e];l.splice(r,1),s(l)},suggestions:[{value:hn.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:vn.L.Value}]}))),a.createElement(kt.zx,{type:"button",variant:"secondary",className:h.css`
          margin-right: 10px;
        `,icon:"plus",onClick:i=>{i.preventDefault();const r=[...e||[],{field:"",url:""}];s(r)}},"Add"))};var _n=m(49922),Vt=m(65587);const $e=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],$t=[{label:"7.10+",value:"7.10.0"},{label:"8.x",value:"8.0.0"}],Dn=({value:t,onChange:e})=>{const s=$t.find(i=>i.value===t.jsonData.esVersion),n=!s&&(0,K.valid)(t.jsonData.esVersion)?{label:t.jsonData.esVersion,value:t.jsonData.esVersion}:void 0;return a.createElement(a.Fragment,null,a.createElement(Vt.C,{label:"Elasticsearch details"},a.createElement(f._,{label:"Index name",labelWidth:26},a.createElement(b.I,{id:"es_config_indexName",value:t.database||"",onChange:Nn("database",t,e),width:24,placeholder:"es-index-name",required:!0})),a.createElement(f._,{label:"Pattern",labelWidth:26},a.createElement(O.Ph,{inputId:"es_config_indexPattern",value:$e.find(i=>i.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:$e,onChange:Tn(t,e),width:24})),a.createElement(f._,{label:"Time field name",labelWidth:26},a.createElement(b.I,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:Oe("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),a.createElement(f._,{label:"ElasticSearch version",labelWidth:26},a.createElement(O.Ph,{inputId:"es_config_version",options:[n,...$t].filter(_n.fQ),onChange:i=>{const r=kn(t.jsonData.maxConcurrentShardRequests);e({...t,jsonData:{...t.jsonData,esVersion:i.value,maxConcurrentShardRequests:r}})},value:s||n,width:24})),a.createElement(f._,{label:"Max concurrent Shard Requests",labelWidth:26},a.createElement(b.I,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:Oe("maxConcurrentShardRequests",t,e),width:24})),a.createElement(f._,{label:"Min time interval",labelWidth:26,tooltip:a.createElement(a.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",a.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},a.createElement(b.I,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:Oe("timeInterval",t,e),width:24,placeholder:"10s"})),a.createElement(f._,{label:"X-Pack enabled",labelWidth:26},a.createElement(X.x,{id:"es_config_xpackEnabled",value:t.jsonData.xpack||!1,onChange:Ot("xpack",t,e)})),t.jsonData.xpack&&a.createElement(f._,{label:"Include Frozen Indices",labelWidth:26},a.createElement(X.x,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:Ot("includeFrozen",t,e)}))))},Nn=(t,e,s)=>n=>{s({...e,[t]:n.currentTarget.value})},Oe=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},Ot=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},Tn=(t,e)=>s=>{const{database:n}=t,i=s.value==="none"?void 0:s.value;if(!n||n.length===0||n.startsWith("[logstash-]")){let r="";if(i!==void 0){const l=$e.find(c=>c.value===i);l&&(r=l.example??"")}e({...t,database:r,jsonData:{...t.jsonData,interval:i}})}else e({...t,jsonData:{...t.jsonData,interval:i}})};function kn(t){return t===256?5:t||At()}function At(){return 5}const Vn=t=>{const{value:e,onChange:s}=t,n=i=>r=>{s({...e,[i]:r.currentTarget.value})};return a.createElement(Vt.C,{label:"Logs"},a.createElement(f._,{label:"Message field name",labelWidth:22},a.createElement(b.I,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),a.createElement(f._,{label:"Level field name",labelWidth:22},a.createElement(b.I,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},Bt=t=>{const e=Je(t.jsonData.esVersion);return{...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",esVersion:e,maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||At(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}},$n=t=>!!(0,K.valid)(t.jsonData.esVersion)&&!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,On=t=>{const e=(0,a.useRef)(t.options.access==="direct"),{options:s,onOptionsChange:n}=t,i=Bt(s);(0,a.useEffect)(()=>{$n(s)||n(Bt(s))},[]);const r=xe(i.jsonData.esVersion);return a.createElement(a.Fragment,null,i.access==="direct"&&a.createElement(fe.b,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),!r&&a.createElement(fe.b,{title:"Deprecation notice",severity:"error"},"Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed"),a.createElement(pn.E,{defaultUrl:"http://localhost:9200",dataSourceConfig:i,showAccessOptions:e.current,onChange:n,sigV4AuthToggleEnabled:Tt.vc.sigV4AuthEnabled,renderSigV4Editor:a.createElement(mn.SIGV4ConnectionConfig,{...t})}),Tt.vc.featureToggles.secureSocksDatasourceProxy&&a.createElement(fn.i,{options:i,onOptionsChange:n}),a.createElement(Dn,{value:i,onChange:n}),a.createElement(Vn,{value:i.jsonData,onChange:l=>n({...i,jsonData:l})}),a.createElement(Cn,{value:i.jsonData.dataLinks,onChange:l=>{n({...i,jsonData:{...i.jsonData,dataLinks:l}})}}))};var ge=m(37537),An=m(71673),q=m(53786),U=m(2101),Ae=m(94514),Lt=m(98356),Bn=m(68193),Ln=m(80136),Rn=m(43464),Rt=m(29236),B=m(46519),te=m(90595),Be=m(40400),Qn=m(9800),Wn=m(47214),Qt=m(93003),jn=m(77213),zn=m(37959),Hn=m(19349),qn=m(98639),Un=m(81042),Le=m(16911),Gn=m(38685),G=m(14582),Wt=m(37219),Yn=m(40229);const jt=`${re.pre}([^@]+)${re.post}`;class zt{constructor(e,s){this.targets=e,this.response=s,this.processResponseToSeries=()=>{const n=[];for(let i=0;i<this.response.responses.length;i++){const r=this.response.responses[i],l=this.targets[i];if(r.error)throw this.getErrorFromElasticResponse(this.response,r.error);if(r.hits&&r.hits.hits.length>0&&this.processHits(r.hits,n,l),r.aggregations){const c=r.aggregations,o=this.targets[i],u=[],d=new Wt.Z;d.refId=o.refId,this.processBuckets(c,o,u,d,{},0),this.trimDatapoints(u,o),this.nameSeries(u,o);for(let g=0;g<u.length;g++)n.push(u[g]);d.rows.length>0&&n.push(d)}}return{data:n}},this.targets=e,this.response=s}processMetrics(e,s,n,i){let r;for(let l=0;l<s.metrics.length;l++){const c=s.metrics[l];if(!c.hide)switch(c.type){case"count":{r={datapoints:[],metric:"count",props:i,refId:s.refId};for(let o=0;o<e.buckets.length;o++){const u=e.buckets[o],d=u.doc_count;r.datapoints.push([d,u.key])}n.push(r);break}case"percentiles":{if(e.buckets.length===0)break;const u=e.buckets[0][c.id].values;for(const d in u){r={datapoints:[],metric:"p"+d,props:i,field:c.field,refId:s.refId};for(let g=0;g<e.buckets.length;g++){const p=e.buckets[g],y=p[c.id].values;r.datapoints.push([y[d],p.key])}n.push(r)}break}case"extended_stats":{for(const o in c.meta)if(c.meta[o]){r={datapoints:[],metric:o,props:i,field:c.field,refId:s.refId};for(let u=0;u<e.buckets.length;u++){const d=e.buckets[u],g=d[c.id];g.std_deviation_bounds_upper=g.std_deviation_bounds.upper,g.std_deviation_bounds_lower=g.std_deviation_bounds.lower,r.datapoints.push([g[o],d.key])}n.push(r)}break}case"top_metrics":{if(c.settings?.metrics?.length)for(const o of c.settings?.metrics){r={datapoints:[],metric:c.type,props:i,refId:s.refId,field:o};for(let u=0;u<e.buckets.length;u++){const d=e.buckets[u],p=d[c.id].top.map(w=>w.metrics[o]?w.metrics[o]:null),y=[p[p.length-1],d.key];r.datapoints.push(y)}n.push(r)}break}default:{r={datapoints:[],metric:c.type,metricId:c.id,props:i,refId:s.refId},L(c)&&(r.field=c.field);for(let o=0;o<e.buckets.length;o++){const u=e.buckets[o],d=u[c.id];d!==void 0&&(d.normalized_value?r.datapoints.push([d.normalized_value,u.key]):r.datapoints.push([d.value,u.key]))}n.push(r);break}}}}processAggregationDocs(e,s,n,i,r){if(i.columns.length===0){for(const o of(0,v.keys)(r))i.addColumn({text:o,filterable:!0});i.addColumn({text:s.field,filterable:!0})}const l=(o,u,d)=>{i.addColumn({text:u}),o.push(d)},c=(0,v.isArray)(e.buckets)?e.buckets:[e.buckets];for(const o of c){const u=[];for(const d of(0,v.values)(r))u.push(d);u.push(o.key);for(const d of n.metrics||[])switch(d.type){case"count":{l(u,this.getMetricName(d.type),o.doc_count);break}case"extended_stats":{for(const g in d.meta){if(!d.meta[g])continue;const p=o[d.id];p.std_deviation_bounds_upper=p.std_deviation_bounds.upper,p.std_deviation_bounds_lower=p.std_deviation_bounds.lower,l(u,this.getMetricName(g),p[g])}break}case"percentiles":{const g=o[d.id].values;for(const p in g)l(u,`p${p} ${d.field}`,g[p]);break}case"top_metrics":{const g=this.getMetricName(d.type);if(d.settings?.metrics)for(const p of d.settings.metrics){const y=d.settings.metrics.length>1?`${g} ${p}`:g,w=o[d.id];l(u,y,w.top[0].metrics[p])}break}default:{let g=this.getMetricName(d.type);(0,v.filter)(n.metrics,{type:d.type}).length>1&&(L(d)&&(g+=" "+d.field),d.type==="bucket_script"&&(g=J(d))),l(u,g,o[d.id].value);break}}i.rows.push(u)}}processBuckets(e,s,n,i,r,l){let c,o,u,d;const g=s.bucketAggs.length-1;for(d in e)if(o=(0,v.find)(s.bucketAggs,{id:d}),u=e[d],!!o)if(l===g)o.type==="date_histogram"?this.processMetrics(u,s,n,r):this.processAggregationDocs(u,o,s,i,r);else for(const p in u.buckets)c=u.buckets[p],r=(0,v.clone)(r),c.key!==void 0?r[o.field]=c.key:r.filter=p,c.key_as_string&&(r[o.field]=c.key_as_string),this.processBuckets(c,s,n,i,r,l+1)}getMetricName(e){const s=Object.entries(E).filter(([i])=>i===e).map(([i,r])=>r)[0];if(s)return s.label;const n=Ee.find(i=>i.value===e);return n?n.label:e}getSeriesName(e,s,n){let i=this.getMetricName(e.metric);if(s.alias){const c=/\{\{([\s\S]+?)\}\}/g;return s.alias.replace(c,(o,u,d)=>{const g=u||d;return g.indexOf("term ")===0?e.props[g.substring(5)]:e.props[g]!==void 0?e.props[g]:g==="metric"?i:g==="field"?e.field||"":o})}if(ls(e.metric))if(e.metric&&os(e.metric)){const c=(0,v.find)(s.metrics,{id:e.metricId});if(c&&c.settings.script){i=J(c);for(const o of c.pipelineVariables){const u=(0,v.find)(s.metrics,{id:o.pipelineAgg});u&&(i=i.replace("params."+o.name,W(u)))}}else i="Unset"}else{const c=(0,v.find)(s.metrics,{id:e.field});c?i+=" "+W(c):i="Unset"}else e.field&&(i+=" "+e.field);if((0,v.keys)(e.props).length===0)return i;let l="";for(const c in e.props)l+=e.props[c]+" ";return n?l.trim()+" "+i:l.trim()}nameSeries(e,s){const n=(0,v.uniq)((0,v.map)(e,"metric")).length,i=(s.metrics?.filter(r=>r.type==="top_metrics")).some(r=>(r?.settings?.metrics?.length||0)>1);for(let r=0;r<e.length;r++){const l=e[r];l.target=this.getSeriesName(l,s,n>1||i)}}processHits(e,s,n){const i=typeof e.total=="number"?e.total:e.total.value,r={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:i,filterable:!0};let l,c,o,u;for(u=0;u<e.hits.length;u++){if(c=e.hits[u],o={_id:c._id,_type:c._type,_index:c._index,sort:c.sort,highlight:c.highlight},c._source)for(l in c._source)o[l]=c._source[l];for(l in c.fields)o[l]=c.fields[l];r.datapoints.push(o)}s.push(r)}trimDatapoints(e,s){const n=(0,v.find)(s.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const r=n.settings.trimEdges;for(const l in e){const c=e[l];c.datapoints.length>r*2&&(c.datapoints=c.datapoints.slice(r,c.datapoints.length-r))}}}getErrorFromElasticResponse(e,s){const n={};return n.data=JSON.stringify(s,null,4),s.root_cause&&s.root_cause.length>0&&s.root_cause[0].reason?n.message=s.root_cause[0].reason:n.message=s.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(s=>Se(s,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(s=>(0,Le.g0)(s))}}getLogs(e,s){return this.processResponseToDataFrames(!0,e,s)}processResponseToDataFrames(e,s,n){const i=[];for(let r=0;r<this.response.responses.length;r++){const l=this.response.responses[r];if(l.error)throw this.getErrorFromElasticResponse(this.response,l.error);if(l.hits){const{propNames:c,docs:o}=Kn(l.hits.hits),u=o.length?Ht(c.map(Jn(o)),e,this.targets[0].timeField,s,n):Ht([],e);e&&qt(u,"logs");for(const g of o){if(n&&(g.level=g[n]),g.highlight){const p=new RegExp(jt,"g"),y=new RegExp(jt),w=Object.keys(g.highlight).flatMap(Q=>g.highlight[Q].flatMap(k=>{const M=k.match(p);return M?M.map(V=>{const P=V.match(y);return P&&P[1]||null}):[]})).filter(v.identity),N=u.meta?.searchWords?(0,v.uniq)([...u.meta.searchWords,...w]):[...w];u.meta=u.meta?{...u.meta,searchWords:N}:{searchWords:N}}u.add(g)}const d=this.targets[r];u.refId=d.refId,i.push(u)}if(l.aggregations){const c=l.aggregations,o=this.targets[r],u=[],d=new Wt.Z;if(this.processBuckets(c,o,u,d,{},0),this.trimDatapoints(u,o),this.nameSeries(u,o),d.rows.length>0){const g=(0,Le.g0)(d);g.refId=o.refId,i.push(g)}for(let g=0;g<u.length;g++){let p=(0,Le.g0)(u[g]);e&&qt(p,"graph"),p.refId=o.refId,i.push(p)}}}return{data:i}}}const Kn=t=>{const e=[];let s=[];for(const n of t){const i=n._source?(0,Yn.default)(n._source):{},r={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...i},...i};for(const l of Object.keys(r))s.indexOf(l)===-1&&s.push(l);e.push(r)}return s.sort(),{docs:e,propNames:s}},Ht=(t,e,s,n,i)=>{const r=new Gn.v({fields:[]});if(s&&r.addField({config:{filterable:!0},name:s,type:G.fS.time}),n){const c=r.addField({name:n,type:G.fS.string});r.setParser(c,o=>o||"")}if(i){const c=r.addField({name:"level",type:G.fS.string});r.setParser(c,o=>o||"")}const l=r.fields.map(c=>c.name);for(const[c,o]of t){if(l.includes(c)||!e&&c==="_source")continue;const u=r.addField({config:{filterable:!0},name:c,type:o});r.setParser(u,d=>d||"")}return r},qt=(t,e)=>{let s=t;s.meta?s.meta.preferredVisualisationType=e:s.meta={preferredVisualisationType:e}},Jn=t=>e=>[e,Zn(t.find(s=>s[e]!==void 0)?.[e])],Zn=t=>{switch(typeof t){case"number":return G.fS.number;case"string":return G.fS.string;default:return G.fS.other}},Xn={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class ei{constructor(e,s){this.pattern=e,this.interval=s,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,B.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,s){if(!this.interval)return this.pattern;const i=Xn[this.interval],r=(0,B.CQ)(e||(0,B.CQ)(s).add(-7,i.amount)).utc().startOf(i.startOf),l=(0,B.CQ)(s||(0,B.CQ)(e).add(7,i.amount)).utc().startOf(i.startOf).valueOf(),c=[];for(;r.valueOf()<=l;)c.push(r.locale(this.dateLocale).format(this.pattern)),r.add(1,i.amount);return c}}var me=m(62163);class ti extends Qe.iL{constructor(e,s){super(),this.datasource=e,Object.assign(this,s)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(s=>{switch(s.operator){case me.K2.Equal:return s.name+':"'+s.value+'"';case me.K2.NotEqual:return"-"+s.name+':"'+s.value+'"';case me.K2.EqualRegEx:return s.name+":/"+s.value+"/";case me.K2.NotEqualRegEx:return"-"+s.name+":/"+s.value+"/"}}).join(" AND ")}}class si{constructor(e){this.timeField=e.timeField}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,s,n){if(s.terms={field:e.field},!e.settings)return s;const i=e.settings?.size?parseInt(e.settings.size,10):500;if(s.terms.size=i===0?500:i,e.settings.orderBy!==void 0){s.terms.order={},e.settings.orderBy==="_term"?s.terms.order._key=e.settings.order:s.terms.order[e.settings.orderBy]=e.settings.order;const r=Ke(e.settings.orderBy);if(r){for(let l of n.metrics||[])if(l.id===r){l.type==="count"?s.terms.order={_count:e.settings.order}:L(l)&&(s.aggs={},s.aggs[l.id]={[l.type]:{field:l.field}});break}}}return e.settings.min_doc_count!==void 0&&(s.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(s.terms.min_doc_count)&&(s.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(s.terms.missing=e.settings.missing),s}getDateHistogramAgg(e){const s={},n=e.settings||{};s.field=e.field||this.timeField,s.min_doc_count=n.min_doc_count||0,s.extended_bounds={min:"$timeFrom",max:"$timeTo"},s.format="epoch_millis",n.timeZone&&n.timeZone!==we.RQ.utc&&(s.time_zone=n.timeZone),n.offset!==""&&(s.offset=n.offset);const i=n.interval==="auto"?"${__interval_ms}ms":n.interval;return s.fixed_interval=i,s}getHistogramAgg(e){const s={},n=e.settings||{};return s.interval=n.interval,s.field=e.field,s.min_doc_count=n.min_doc_count||0,s}getFiltersAgg(e){const s={};for(let{query:n,label:i}of e.settings?.filters||[])s[i||n]={query_string:{query:n,analyze_wildcard:!0}};return s}documentQuery(e,s){return e.size=s,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}addAdhocFilters(e,s){if(!s)return;let n,i,r,l;for(n=0;n<s.length;n++)switch(i=s[n],r={},r[i.key]=i.value,l={},l[i.key]={query:i.value},i.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:l});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:l});break;case"<":r[i.key]={lt:i.value},e.query.bool.filter.push({range:r});break;case">":r[i.key]={gt:i.value},e.query.bool.filter.push({range:r});break;case"=~":e.query.bool.filter.push({regexp:r});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:r}}});break}}build(e,s){e.metrics=e.metrics||[le()],e.bucketAggs=e.bucketAggs||[oe()],e.timeField=this.timeField;let n,i,r,l,c;const o={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(o.query.bool.filter=[...o.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),this.addAdhocFilters(o,s),e.bucketAggs.length===0&&(n=e.metrics[0],!n||!(n.type==="raw_document"||n.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){n=e.metrics[0];const u=n.settings?.size?parseInt(n.settings.size,10):500;return this.documentQuery(o,u||500)}for(c=o,i=0;i<e.bucketAggs.length;i++){const u=e.bucketAggs[i],d={};switch(u.type){case"date_histogram":{d.date_histogram=this.getDateHistogramAgg(u);break}case"histogram":{d.histogram=this.getHistogramAgg(u);break}case"filters":{d.filters={filters:this.getFiltersAgg(u)};break}case"terms":{this.buildTermsAgg(u,d,e);break}case"geohash_grid":{d.geohash_grid={field:u.field,precision:u.settings?.precision};break}}c.aggs=c.aggs||{},c.aggs[u.id]=d,c=d}for(c.aggs={},i=0;i<e.metrics.length;i++){if(n=e.metrics[i],n.type==="count")continue;const u={};let d={};if(Y(n))if(ae(n))if(n.pipelineVariables){for(d={buckets_path:{}},r=0;r<n.pipelineVariables.length;r++)if(l=n.pipelineVariables[r],l.name&&l.pipelineAgg&&/^\d*$/.test(l.pipelineAgg)){const g=Ye(e.metrics,l.pipelineAgg);g&&(g.type==="count"?d.buckets_path[l.name]="_count":d.buckets_path[l.name]=l.pipelineAgg)}}else continue;else if(n.field&&/^\d*$/.test(n.field)){const g=Ye(e.metrics,n.field);g&&(g.type==="count"?d={buckets_path:"_count"}:d={buckets_path:n.field})}else continue;else L(n)&&(d={field:n.field});if(be(n))switch(Object.entries(n.settings||{}).filter(([g,p])=>p!==null).forEach(([g,p])=>{d[g]=g==="script"?this.buildScript(J(n)):p}),n.type){case"moving_avg":d={...d,...d?.window!==void 0&&{window:this.toNumber(d.window)},...d?.predict!==void 0&&{predict:this.toNumber(d.predict)},...es(n)&&{settings:{...d.settings,...Object.fromEntries(Object.entries(d.settings||{}).filter(([g])=>["alpha","beta","gamma","period"].includes(g)).filter(([g,p])=>p!==void 0).map(([g,p])=>[g,this.toNumber(p)]))}}};break;case"serial_diff":d={...d,...d.lag!==void 0&&{lag:this.toNumber(d.lag)}};break;case"top_metrics":d={metrics:n.settings?.metrics?.map(g=>({field:g})),size:1},n.settings?.orderBy&&(d.sort=[{[n.settings?.orderBy]:n.settings?.order}]);break}u[n.type]=d,c.aggs[n.id]=u}return o}buildScript(e){return e}toNumber(e){const s=parseFloat(`${e}`);return isNaN(s)?e:s}getTermsQuery(e){const s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),s.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:i="key",order:r=i==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(r)<0)throw{message:`Invalid query sort order ${r}`};switch(i){case"key":case"term":const l="_key";s.aggs[1].terms.order[l]=r;break;case"doc_count":s.aggs[1].terms.order._count=r;break;default:throw{message:`Invalid query sort type ${i}`}}return s}getLogsQuery(e,s,n){let i={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return this.addAdhocFilters(i,n),e.query&&i.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),i=this.documentQuery(i,s),{...i,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[re.pre],post_tags:[re.post],fragment_size:2147483647}}}}var se=m(26418);function ni(t){const e=t.annotation,s=t.onAnnotationChange;return a.createElement(a.Fragment,null,a.createElement("div",{className:"gf-form-group"},a.createElement(Nt,{value:e.target?.query,onChange:n=>{s({...e,query:n})}})),a.createElement("div",{className:"gf-form-group"},a.createElement("h6",null,"Field mappings"),a.createElement(se.EditorRow,null,a.createElement(se.EditorField,{label:"Time"},a.createElement(b.I,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{s({...e,timeField:n.currentTarget.value})}})),a.createElement(se.EditorField,{label:"Time End"},a.createElement(b.I,{type:"text",value:e.timeEndField,onChange:n=>{s({...e,timeEndField:n.currentTarget.value})}})),a.createElement(se.EditorField,{label:"Text"},a.createElement(b.I,{type:"text",value:e.textField,onChange:n=>{s({...e,textField:n.currentTarget.value})}})),a.createElement(se.EditorField,{label:"Tags"},a.createElement(b.I,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{s({...e,tagsField:n.currentTarget.value})}})))))}var Ut=m(77274),ii=m(92624),ai=m(31886);const ri=({payload:{dashboardId:t,orgId:e,grafanaVersion:s,queries:n}})=>{try{const i=n[ai.id].filter(y=>!y.hide);if(!i?.length)return;const r=i.filter(oi),l=i.filter(y=>!!y.query),c=i.filter(y=>ne(y)==="logs"),o=i.filter(y=>ne(y)==="metric"),u=i.filter(y=>ne(y)==="raw_data"),d=i.filter(y=>ne(y)==="raw_document"),g=i.filter(li),p={grafana_version:s,dashboard_id:t,org_id:e,queries_count:i.length,logs_queries_count:c.length,metric_queries_count:o.length,raw_data_queries_count:u.length,raw_document_queries_count:d.length,queries_with_template_variables_count:r.length,queries_with_changed_line_limit_count:g.length,queries_with_lucene_query_count:l.length};(0,Ut.ff)("grafana_elasticsearch_dashboard_loaded",p)}catch(i){console.error("error in elasticsearch tracking handler",i)}},ne=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",Gt=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},li=t=>{const e=Gt(t);return e!==void 0&&e!==500},oi=t=>ii.J7.test(t.query??""),ci=t=>!!t.startsWith(Kt);function Yt(t,e,s){const{targets:n,app:i}=e;if(!(i===Be.zj.Dashboard||i===Be.zj.PanelViewer))for(const r of n){if(ci(r.refId))return;(0,Ut.ff)("grafana_elasticsearch_query_executed",{app:i,grafana_version:Qt.v.buildInfo.version,with_lucene_query:!!r.query,query_type:ne(r),line_limit:Gt(r),alias:r.alias,has_error:t.error!==void 0,has_data:t.data.some(l=>l.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-s.getTime()})}}const Kt="log-volume-",ui=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class di extends Qn.CK{constructor(e,s=(0,qn.J)()){super(e),this.templateSrv=s,this.getLogRowContext=async(i,r)=>{const c=i.dataFrame.fields.find(A=>A.name==="sort")?.values.get(i.rowIndex)||[i.timeEpochMs],o=r?.direction==="FORWARD"?"asc":"desc",u=r?.direction==="FORWARD"?this.getQueryHeader("query_then_fetch",(0,B.CQ)(i.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,B.CQ)(i.timeEpochMs)),d=r?.limit??10,g=JSON.stringify({size:d,query:{bool:{filter:[{range:{[this.timeField]:{[r?.direction==="FORWARD"?"gte":"lte"]:i.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:o},{_doc:o}],search_after:c}),p=[u,g].join(`
`)+`
`,y=this.getMultiSearchUrl(),w=await(0,R.n)(this.post(y,p)),N=[{refId:`${i.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],k=new zt(N,pi(w,o)).getLogs(this.logMessageField,this.logLevelField),M=(0,v.first)(k.data);if(!M)return{data:[]};const V=M.fields.find(A=>A.name===this.timeField),P=M.fields.find(A=>A.name===this.logMessageField);return V&&P?{data:[{...M,fields:[...M.fields,{...V,name:"ts"},{...P,name:"line"}]}]}:k},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=e.database??"",this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.timeField=n.timeField,this.esVersion=Je(n.esVersion),this.xpack=Boolean(n.xpack),this.indexPattern=new ei(this.index,n.interval),this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new si({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.annotations={QueryEditor:ni},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new ti(this),this.timeSrv=(0,Hn.$t)()}request(e,s,n,i){if(!this.isProxyAccess){const l=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,ge._)(()=>l)}if(!xe(this.esVersion)){const l=new Error("Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed.");return(0,ge._)(()=>l)}const r={url:this.url+"/"+s,method:e,data:n,headers:i};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),(0,Wn.i)().fetch(r).pipe((0,U.U)(l=>(l.data.$$config=l.config,l.data)),(0,Ae.K)(l=>{if(l.data){const c=l.data.error?.reason??l.data.message??"Unknown error";return(0,ge._)({message:"Elasticsearch error: "+c,error:l.data.error})}return(0,ge._)(l)}))}async importFromAbstractQueries(e){return e.map(s=>this.languageProvider.importFromAbstractQuery(s))}get(e,s=(0,pe.JK)()){let n=this.indexPattern.getIndexList(s.from,s.to);Array.isArray(n)||(n=[this.indexPattern.getIndexForToday()]);const i=n.map(r=>r+e);return this.requestAllIndices(i)}requestAllIndices(e){const n=e.length;return(0,An.R)({initialState:0,condition:i=>i<Math.min(n,7),iterate:i=>i+1}).pipe((0,Lt.z)(i=>this.request("GET",e[n-i-1]).pipe((0,Ae.K)(r=>(0,q.of)({err:r})))),(0,Bn.n)(i=>i?.err?.status===404),(0,Ln.T)(()=>"Could not find an available index for this time range."),(0,Rn.P)(),(0,U.U)(i=>{if(i.err)throw i.err;return i}))}post(e,s){return this.request("POST",e,s,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const s=e.annotation,n=s.timeField||"@timestamp",i=s.timeEndField||null,r=s.query,l=s.tagsField||"tags",c=s.textField||null,o=[],u={};if(u[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},o.push({range:u}),i){const N={};N[i]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},o.push({range:N})}const d=this.interpolateLuceneQuery(r),g={bool:{filter:[{bool:{should:o,minimum_should_match:1}}]}};d&&g.bool.filter.push({query_string:{query:d}});const p={query:g,size:1e4},y={search_type:"query_then_fetch",ignore_unavailable:!0};s.index?y.index=s.index:y.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const w=JSON.stringify(y)+`
`+JSON.stringify(p)+`
`;return(0,R.n)(this.post("_msearch",w).pipe((0,U.U)(N=>{const Q=[],k=N.responses[0].hits.hits,M=(V,P)=>{if(!P)return;const A=P.split(".");let $=V;for(let T=0;T<A.length;T++)if($=$[A[T]],!$)return console.log("could not find field in annotation: ",P),"";return $};for(let V=0;V<k.length;V++){const P=k[V]._source;let A=M(P,n);if(typeof k[V].fields<"u"){const T=k[V].fields;((0,v.isString)(T[n])||(0,v.isNumber)(T[n]))&&(A=T[n])}const $={annotation:s,time:(0,B.zh)(A).valueOf(),text:M(P,c),tags:M(P,l)};if(i){const T=M(P,i);T&&($.timeEnd=(0,B.zh)(T).valueOf())}if(s.titleField){const T=M(P,s.titleField);T&&($.text=T+`
`+$.text)}typeof $.tags=="string"&&($.tags=$.tags.split(",")),Q.push($)}return Q})))}interpolateLuceneQuery(e,s){return this.templateSrv.replace(e,s,"lucene")}interpolateVariablesInQueries(e,s){const n=l=>l.type==="filters"?{...l,settings:{...l.settings,filters:l.settings?.filters?.map(c=>({...c,query:this.interpolateLuceneQuery(c.query,s)||"*"}))}}:l,i=e.map(l=>({...l,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(l.query||"",s)),bucketAggs:l.bucketAggs?.map(n)}));return JSON.parse(this.templateSrv.replace(JSON.stringify(i),s))}testDatasource(){return(0,R.n)(this.getFields(["date"]).pipe((0,Lt.z)(e=>(0,v.find)(e,{text:this.timeField})?(0,q.of)({status:"success",message:"Index OK. Time field name OK."}):(0,q.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,Ae.K)(e=>(console.error(e),e.message?(0,q.of)({status:"error",message:e.message}):(0,q.of)({status:"error",message:e.status})))))}getQueryHeader(e,s,n){const i={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(s,n)};return JSON.stringify(i)}getQueryDisplayText(e){const s=e.metrics,n=e.bucketAggs;let i="";return e.query&&(i+="Query: "+e.query+", "),i+="Metrics: ",i+=s?.reduce((r,l)=>{let o=E[l.type].label+"(";return L(l)&&(o+=l.field),ae(l)&&(o+=J(l).replace(new RegExp("params.","g"),"")),o+="), ",`${r} ${o}`},""),i+=n?.reduce((r,l,c)=>{const o=F[l.type];let u="";return c===0&&(u+=" Group by: "),u+=o.label+"(",bt(l)&&(u+=l.field),`${r} ${u}), `},""),e.alias&&(i+="Alias: "+e.alias),i}showContextToggle(){return!0}getDataProvider(e,s){if(this.getSupportedSupplementaryQueryTypes().includes(e))switch(e){case te.v8.LogsVolume:return this.getLogsVolumeDataProvider(s);default:return}}getSupportedSupplementaryQueryTypes(){return[te.v8.LogsVolume]}getSupplementaryQuery(e,s){if(!this.getSupportedSupplementaryQueryTypes().includes(e))return;let n=!1;switch(e){case te.v8.LogsVolume:if(n=s.metrics?.length===1&&s.metrics[0].type==="logs",!n)return;const i=[],r=this.timeField??"@timestamp";return this.logLevelField&&i.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:te.in.unknown},field:this.logLevelField}),i.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:r}),{refId:`${Kt}${s.refId}`,query:s.query,metrics:[{type:"count",id:"1"}],timeField:r,bucketAggs:i};default:return}}getLogsVolumeDataProvider(e){const s=(0,v.cloneDeep)(e),n=s.targets.map(i=>this.getSupplementaryQuery(te.v8.LogsVolume,i)).filter(i=>!!i);if(n.length)return(0,zn.Bz)(this,{...s,targets:n},{range:e.range,targets:e.targets,extractLevel:i=>(0,Un.jx)(i.name||"")})}query(e){if(e.app===Be.zj.Explore&&Qt.v.featureToggles.elasticsearchBackendMigration){const g=new Date;return super.query(e).pipe((0,Rt.b)(p=>Yt(p,e,g)))}let n="";const i=this.interpolateVariablesInQueries((0,v.cloneDeep)(e.targets),e.scopedVars),r=[];let l=i.some(g=>Se(g,"logs"));const c=this.templateSrv.getAdhocFilters(this.name),o=[];for(const g of i){if(g.hide)continue;let p;if(Se(g,"logs")){g.bucketAggs=[oe()];const Q=g.metrics?.find(M=>M.type==="logs"),k=Q.settings?.limit?parseInt(Q.settings?.limit,10):500;o.push(k),g.metrics=[],p=this.queryBuilder.getLogsQuery(g,k,c)}else o.push(),g.alias&&(g.alias=this.interpolateLuceneQuery(g.alias,e.scopedVars)),p=this.queryBuilder.build(g,c);const y=JSON.stringify(p),w="query_then_fetch",N=this.getQueryHeader(w,e.range.from,e.range.to);n+=N+`
`,n+=y+`
`,r.push(g)}if(r.length===0)return(0,q.of)({data:[]});n=n.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),n=n.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),n=this.templateSrv.replace(n,e.scopedVars);const u=this.getMultiSearchUrl(),d=new Date;return this.post(u,n).pipe((0,U.U)(g=>{const p=new zt(r,g);if(l){const y=p.getLogs(this.logMessageField,this.logLevelField);return y.data.forEach((w,N)=>{gi(w,this.dataLinks,o[N])}),y}return p.getTimeSeries()}),(0,Rt.b)(g=>Yt(g,e,d)))}isMetadataField(e){return ui.includes(e)}getFields(e,s){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",s).pipe((0,U.U)(i=>{const r=(u,d)=>this.isMetadataField(d)?!1:!e||e.length===0?!0:e.includes(u.type)||e.includes(n[u.type]),l=[],c={};function o(u){for(const d in u){const g=u[d];if((0,v.isObject)(g.properties)&&(l.push(d),o(g.properties)),(0,v.isObject)(g.fields)&&(l.push(d),o(g.fields)),(0,v.isString)(g.type)){const p=l.concat(d).join(".");r(g,d)&&(c[p]={text:p,type:g.type})}}l.pop()}for(const u in i){const d=i[u];if(d&&d.mappings){const p=d.mappings.properties;o(p)}}return(0,v.map)(c,u=>u)}))}getTerms(e,s=(0,pe.JK)()){const n="query_then_fetch",i=this.getQueryHeader(n,s.from,s.to);let r=JSON.stringify(this.queryBuilder.getTermsQuery(e));r=r.replace(/\$timeFrom/g,s.from.valueOf().toString()),r=r.replace(/\$timeTo/g,s.to.valueOf().toString()),r=i+`
`+r+`
`;const l=this.getMultiSearchUrl();return this.post(l,r).pipe((0,U.U)(c=>{if(!c.responses[0].aggregations)return[];const o=c.responses[0].aggregations[1].buckets;return(0,v.map)(o,u=>({text:u.key_as_string||u.key,value:u.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,s){const n=s?.range,i=JSON.parse(e);if(e){if(i.find==="fields")return i.type=this.interpolateLuceneQuery(i.type),(0,R.n)(this.getFields(i.type,n));if(i.find==="terms")return i.field=this.interpolateLuceneQuery(i.field),i.query=this.interpolateLuceneQuery(i.query),(0,R.n)(this.getTerms(i,n))}return Promise.resolve([])}getTagKeys(){return(0,R.n)(this.getFields())}getTagValues(e){const s=this.timeSrv.timeRange();return(0,R.n)(this.getTerms({field:e.key},s))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const s of e.bucketAggs)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings))return!0;for(const s of e.metrics)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0;return!1}isPrimitive(e){return!!(e==null||["string","number","boolean"].some(s=>s==="boolean"))}objectContainsTemplate(e){if(!e)return!1;for(const s of Object.keys(e))if(this.isPrimitive(e[s])){if(this.templateSrv.containsTemplate(e[s]))return!0}else if(Array.isArray(e[s])){for(const n of e[s])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[s]))return!0;return!1}modifyQuery(e,s){if(!s.options)return e;let n=e.query??"";switch(s.type){case"ADD_FILTER":{n.length>0&&(n+=" AND "),n+=`${s.options.key}:"${s.options.value}"`;break}case"ADD_FILTER_OUT":{n.length>0&&(n+=" AND "),n+=`-${s.options.key}:"${s.options.value}"`;break}}return{...e,query:n}}addAdHocFilters(e){const s=this.templateSrv.getAdhocFilters(this.name);if(s.length===0)return e;const n=s.map(r=>{const{key:l,operator:c,value:o}=r;if(!(!l||!o))switch(c){case"=":return`${l}:"${o}"`;case"!=":return`-${l}:"${o}"`;case"=~":return`${l}:/${o}/`;case"!~":return`-${l}:/${o}/`;case">":return`${l}:>${o}`;case"<":return`${l}:<${o}`}});return[e,...n].filter(r=>r).join(" AND ")}}function gi(t,e,s){if(s&&(t.meta={...t.meta,limit:s}),!!e.length)for(const n of t.fields){const i=e.filter(r=>new RegExp(r.field).test(n.name));i.length!==0&&(n.config=n.config||{},n.config.links=[...(n.config.links,i.map(mi))])}}function mi(t){const e=(0,jn.F)();if(t.datasourceUid){const s=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:s?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function pi(t,e){if(e==="desc")return t;const s=t.responses[0];return{...t,responses:[{...s,hits:{...s.hits,hits:s.hits.hits.reverse()}}]}}const fi=new Qe.hf(di).setQueryEditor(dn).setConfigEditor(On);(0,Zt.N$)().subscribe(Jt.Pl,ri)}}]);

//# sourceMappingURL=4601.7360ad4e5fd3914d5ae0.js.map
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2015],{96907:(L,p,o)=>{o.r(p),o.d(p,{plugin:()=>ue});var y=o(7238),a=o(68404),h=o(32695);const m=e=>{const{options:t,onOptionsChange:n}=e;return a.createElement(a.Fragment,null,a.createElement(h.E,{defaultUrl:"http://localhost:7070",dataSourceConfig:t,showAccessOptions:!1,onChange:n}))};var E=o(82897),P=o(95700),C=o(40400),I=o(37751);const O={labelSelector:"{}",queryType:"both"};var g=o(52423),x=o(29516);function v(e){const t=(0,x.wW)((0,a.useCallback)(n=>M(n,e),[e]));return a.createElement("div",{className:t.root},e.children)}const M=(e,t)=>({root:(0,g.css)({display:"flex",flexDirection:t.direction??"row",flexWrap:t.wrap??!0?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(t.gap??2),flexGrow:t.flexGrow})}),T=({children:e,stackProps:t})=>{const n=(0,x.wW)(z);return a.createElement("div",{className:n.root},a.createElement(v,{gap:2,...t},e))},z=e=>({root:(0,g.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.borderRadius(1)})}),B=({children:e})=>a.createElement(v,{gap:.5,direction:"column"},e);var D=o(56021),W=o(57172);const F={id:"parca",extensions:[".parca"],aliases:["parca"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".fireql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};class Q{constructor(t,n,r){this.datasource=t,this.monaco=n,this.editor=r,this.triggerCharacters=["{",",","[","(","=","~"," ",'"'],this.labels={}}async init(){const t=await this.datasource.getLabelNames();this.labels=t.reduce((n,r)=>(n[r]=[],n),{})}provideCompletionItems(t,n){if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:r,offset:i}=Z(this.monaco,t,n),l=k(t.getValue(),i);return this.getCompletions(l).then(c=>{const f=c.length.toString().length;return{suggestions:c.map((s,u)=>({kind:U(s.type,this.monaco),label:s.label,insertText:s.insertText,sortText:u.toString().padStart(f,"0"),range:r}))}})}async getCompletions(t){if(!Object.keys(this.labels).length)return[];switch(t.type){case"UNKNOWN":return[];case"EMPTY":return Object.keys(this.labels).map(r=>({label:r,insertText:`{${r}="`,type:"LABEL_NAME"}));case"IN_LABEL_NAME":return Object.keys(this.labels).map(r=>({label:r,insertText:r,type:"LABEL_NAME"}));case"IN_LABEL_VALUE":let n=[];return this.labels[t.labelName].length?n=this.labels[t.labelName]:(n=await this.datasource.getLabelValues(t.labelName),this.labels[t.labelName]=n),n.map(r=>({label:r,insertText:t.betweenQuotes?r:`"${r}"`,type:"LABEL_VALUE"}));default:throw new Error(`Unexpected situation ${t}`)}}}function U(e,t){switch(e){case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${e}`)}}const A=/[a-zA-Z_][a-zA-Z0-9_]*/,N=/[^"]*/,$=new RegExp(`(${A.source})="(${N.source})"`,"g"),K=new RegExp(`(${A.source})=("?)${N.source}$`),V=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function k(e,t){if(e==="")return{type:"EMPTY"};const n=e.matchAll($),r=Array.from(n).reduce((c,f)=>{const[d,s,u]=f[1];return c.push({name:s,value:u}),c},[]),i=e.substring(0,t).match(K);return i?{type:"IN_LABEL_VALUE",labelName:i[1],betweenQuotes:!!i[2],otherLabels:r}:e.substring(0,t).match(V)?{type:"IN_LABEL_NAME",otherLabels:r}:{type:"UNKNOWN"}}function Z(e,t,n){const r=t.getWordAtPosition(n),i=r!=null?e.Range.lift({startLineNumber:n.lineNumber,endLineNumber:n.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(n),l={column:n.column,lineNumber:n.lineNumber};return{offset:t.getOffsetAt(l),range:i}}function H(e){const t=G(e.datasource),n=(0,x.wW)(Y),r=(0,D.Z)(e.onRunQuery),i=(0,a.useRef)(null);return a.createElement("div",{className:n.wrapper,ref:i},a.createElement(W.p,{value:e.value,language:b,onBlur:e.onChange,containerStyles:n.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:5,bottom:6}},onBeforeEditorMount:X,onEditorDidMount:(l,c)=>{t(l,c);const f=()=>{const d=i.current;if(d!==null){const s=l.getContentHeight();d.style.height=`${s+j}px`,d.style.width="100%";const u=d.clientWidth;l.layout({width:u,height:s})}};l.onDidContentSizeChange(f),f(),l.addCommand(c.KeyMod.Shift|c.KeyCode.Enter,()=>{r.current(l.getValue())})}}))}const j=2;function G(e){const t=(0,a.useRef)(null);return(0,a.useEffect)(()=>()=>{t.current?.()},[]),async(n,r)=>{const i=new Q(e,r,n);await i.init();const{dispose:l}=r.languages.registerCompletionItemProvider(b,i);t.current=l}}let S=!1;const b="parca";function X(e){if(S===!1){S=!0;const{aliases:t,extensions:n,mimetypes:r,def:i}=F;e.languages.register({id:b,aliases:t,extensions:n,mimetypes:r}),e.languages.setMonarchTokensProvider(b,i.language),e.languages.setLanguageConfiguration(b,i.languageConfiguration)}}const Y=()=>({queryField:g.css`
      flex: 1;
      // Not exactly sure but without this the editor doe not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:g.css`
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var J=o(86253),q=o(81697),_=o(74955),ee=o(318);const w=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function te(e){return e===C.zj.Explore?w:w.filter(t=>t.value!=="both")}function ne({query:e,onQueryTypeChange:t,app:n}){const[r,i]=(0,J.Z)(!1),l=(0,x.wW)(ae),c=te(n);return a.createElement(v,{gap:0,direction:"column"},a.createElement("div",{className:l.header,onClick:i,title:"Click to edit options"},a.createElement("div",{className:l.toggle},a.createElement(q.J,{name:r?"angle-down":"angle-right"})),a.createElement("h6",{className:l.title},"Options"),!r&&a.createElement("div",{className:l.description},a.createElement("span",null,"Type: ",e.queryType))),r&&a.createElement("div",{className:l.body},a.createElement(_.g,{label:"Query Type"},a.createElement(ee.S,{options:c,value:e.queryType,onChange:t}))))}const ae=e=>({switchLabel:(0,g.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),header:(0,g.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:e.colors.text.primary,"&:hover":{background:e.colors.emphasize(e.colors.background.primary,.03)}}),title:(0,g.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,g.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,g.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"}),toggle:(0,g.css)({color:e.colors.text.secondary,marginRight:`${e.spacing(1)}`})});function re(e){const[t,n]=(0,a.useState)([]);function r(s,u){if(u.length===0)return;const R=u[u.length-1].value;if(typeof R!="string")throw new Error("id is not string");e.onChange({...e.query,profileTypeId:R})}function i(s){e.onChange({...e.query,labelSelector:s})}function l(s){e.onChange({...e.query,labelSelector:s}),e.onRunQuery()}(0,P.Z)(async()=>{const s=await e.datasource.getProfileTypes();n(s)});const c=(0,a.useMemo)(()=>{let s=new Map;for(let u of t)s.has(u.name)||s.set(u.name,{label:u.name,value:u.ID,children:[]}),s.get(u.name)?.children?.push({label:u.sample_type,value:u.ID});return Array.from(s.values())},[t]),f=(0,a.useMemo)(()=>{if(!t)return"Loading";const s=t.find(u=>u.ID===e.query.profileTypeId);return s?s.name+" - "+s.sample_type:"Select a profile type"},[e.query.profileTypeId,t]);let d=se(e.query,e.app);return a.createElement(B,null,a.createElement(T,{stackProps:{wrap:!1,gap:1}},a.createElement(I.O,{onChange:r,options:c,buttonProps:{variant:"secondary"}},f),a.createElement(H,{value:d.labelSelector,onChange:i,datasource:e.datasource,onRunQuery:l})),a.createElement(T,null,a.createElement(ne,{query:d,onQueryTypeChange:s=>{e.onChange({...d,queryType:s})},app:e.app})))}function se(e,t){let n=(0,E.defaults)(e,O);return t!==C.zj.Explore&&n.queryType==="both"&&(n.queryType="profile"),n}var oe=o(53786),le=o(9800);class ie extends le.CK{constructor(t){super(t)}query(t){return t.targets.every(n=>n.profileTypeId)?super.query(t):(0,oe.of)({data:[]})}async getProfileTypes(){return await super.getResource("profileTypes")}async getLabelNames(){return await super.getResource("labelNames")}async getLabelValues(t){return await super.getResource("labelValues",{label:t})}}const ue=new y.hf(ie).setConfigEditor(m).setQueryEditor(re)},56021:(L,p,o)=>{o.d(p,{Z:()=>h});var y=o(68404),a=function(m){var E=(0,y.useRef)(m);return E.current=m,E};const h=a},95700:(L,p,o)=>{o.d(p,{Z:()=>h});var y=o(58252),a=function(m){(0,y.Z)(function(){m()})};const h=a}}]);

//# sourceMappingURL=parcaPlugin.d24c7de41a332c657196.js.map
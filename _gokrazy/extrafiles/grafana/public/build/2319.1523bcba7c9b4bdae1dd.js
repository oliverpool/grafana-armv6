"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2319],{87464:(aa,A,a)=>{a.d(A,{ZQ:()=>N,mV:()=>Y,f1:()=>e,$M:()=>X});var n=a(83383),U=a(46519),m=a(55294),h=a(57388),O=a(47214),R=a(93003),H=a(659),F=a(97063),V=a(60499),M=a(29930),b=a(58379),g=a(87449),I=a(9398),w=a(19349),P=a(30992),S=a(10079),Q=a(92624),l=a(81168),y=a(87865),Z=a(85803),E=a(87095),$=a(82302),j=a(66799),W=a(77274);function G(t){const s={dashboardId:t.id,dashboardName:t.title,dashboardUid:t.uid,folderName:t.meta.folderTitle,eventName:j.ct.DashboardView};(0,W.r_)(s)}var v=a(58790);async function z(t,s,o){const d=b.Z.getObject(p);if(d)return e(),d;try{switch(t.routeName){case l.DashboardRoutes.Home:{const r=await M.ae.get("/api/dashboards/home");if(r.redirectUri){const i=n.u.stripBaseFromUrl(r.redirectUri);return h.E1.replace(i),null}return r.meta.canSave=!1,r.meta.canShare=!1,r.meta.canStar=!1,r}case l.DashboardRoutes.Public:return await g.pD.loadDashboard("public",t.urlSlug,t.accessToken);case l.DashboardRoutes.Normal:{const r=await g.pD.loadDashboard(t.urlType,t.urlSlug,t.urlUid);if(t.fixUrl&&r.meta.url&&!S.r0.isPlaying){const i=n.u.stripBaseFromUrl(r.meta.url),c=h.E1.getLocation().pathname;i!==c&&(h.E1.replace({...h.E1.getLocation(),pathname:i}),console.log("not correct url correcting",i,c))}return r}case l.DashboardRoutes.New:return N(t.urlFolderUid,t.panelType);case l.DashboardRoutes.Path:{const r=t.urlSlug??"";return await g.pD.loadDashboard(l.DashboardRoutes.Path,r,r)}default:throw{message:"Unknown route "+t.routeName}}}catch(r){return(0,O.kW)(r)&&r.cancelled||(s((0,v.jA)({message:"Failed to fetch dashboard",error:r})),console.error(r)),null}}const K=(t,s={})=>(t.forEach(o=>{o.panels?K(o.panels,s):o.targets&&o.targets.forEach(d=>{d.datasource?.type&&(s[d.datasource.type]?s[d.datasource.type].push(d):s[d.datasource.type]=[d])})}),s);function Y(t){return async(s,o)=>{s((0,v.sf)());const d=await z(t,s,o);if(!d)return;s((0,v.Nv)());let r;try{r=new $.f(d.dashboard,d.meta)}catch(f){s((0,v.jA)({message:"Failed create dashboard model",error:f})),console.error(f);return}const i=o(),c=h.E1.getSearchObject();c.orgId||h.E1.partial({orgId:i.user.orgId},!0);const T=(0,w.$t)();(0,I.h4)().setCurrent(r),T.init(r);const C=(0,Q.mn)(t.urlUid??r.uid);if(await s((0,Z.LX)(C,r)),(0,y.Tl)({dashboard:r,timeSrv:T}).run({dashboard:r,range:T.timeRange()}),(0,E.cp)(o())===C&&o().dashboard.initPhase===l.DashboardInitPhase.Services){try{r.processRepeats(),c.autofitpanels&&r.autoFitPanels(window.innerHeight,c.kiosk),t.keybindingSrv.setupDashboardBindings(r)}catch(f){f instanceof Error&&s((0,H.$l)((0,V.t_)("Dashboard init failed",f))),console.error(f)}t.routeName!==l.DashboardRoutes.New?(G(r),P.H.watch(r.uid)):P.H.leave(),r.weekStart!==""?(0,U.Ls)(r.weekStart):(0,U.Ls)(R.v.bootData.user.weekStart),F.Z.publish(new m.Pl({dashboardId:r.uid,orgId:i.user.orgId,userId:i.user.user?.id,grafanaVersion:R.v.buildInfo.version,queries:K(r.panels)})),s((0,v.dS)(r))}}}function N(t,s){const o={meta:{canStar:!1,canShare:!1,canDelete:!1,isNew:!0,folderUid:""},dashboard:{title:"New dashboard",panels:[{type:s??"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"Panel Title"}]}};return t&&(o.meta.folderUid=t),o}const p="DASHBOARD_FROM_LS_KEY";function X(t){b.Z.setObject(p,t)}function e(){b.Z.delete(p)}},2319:(aa,A,a)=>{a.r(A),a.d(A,{AddToDashboard:()=>X});var n=a(68404),U=a(26408),m=a(81168),h=a(75090),O=a(82897),R=a(59052),H=a(83383),F=a(77274),V=a(57388),M=a(93003),b=a(6694),g=a(11017),I=a(74955),w=a(318),P=a(2323),S=a(90723),Q=a(99661),l=a(82002),y=a(87464),Z=a(29930),E=(e=>(e.FETCH_DASHBOARD="fetch-dashboard",e.SET_DASHBOARD_LS="set-dashboard-ls-error",e))(E||{});function $(){const e=(0,y.ZQ)();return e.dashboard.panels=[],e}async function j(e){const t=v(e.queries,e.queryResponse),s={targets:e.queries,type:t,title:"New Panel",gridPos:{x:0,y:0,w:12,h:8},datasource:e.datasource};let o;if(e.dashboardUid)try{o=await Z.ae.getDashboardByUid(e.dashboardUid)}catch{throw"fetch-dashboard"}else o=$();o.dashboard.panels=[s,...o.dashboard.panels??[]];try{(0,y.$M)(o)}catch{throw"set-dashboard-ls-error"}}const W=e=>!e.hide,G=e=>t=>t.refId===e;function v(e,t){for(const{refId:s}of e.filter(W)){const o=G(s);if(t.flameGraphFrames.some(o))return"flamegraph";if(t.graphFrames.some(o))return"timeseries";if(t.logsFrames.some(o))return"logs";if(t.nodeGraphFrames.some(o))return"nodeGraph";if(t.traceFrames.some(o))return"traces"}return"table"}var z=(e=>(e.NewDashboard="new-dashboard",e.ExistingDashboard="existing-dashboard",e))(z||{});function K(e){}function Y(e){return e?`d/${e}`:"dashboard/new"}var N=(e=>(e.UNKNOWN="unknown-error",e.NAVIGATION="navigation-error",e))(N||{});const p=({onClose:e,exploreId:t})=>{const s=(0,m.useSelector)((0,h.F)(t)),[o,d]=(0,n.useState)(),{handleSubmit:r,control:i,formState:{errors:c},watch:T}=(0,R.cI)({defaultValues:{saveTarget:"new-dashboard"}}),k=l.Vt.hasAccess(m.AccessControlAction.DashboardsCreate,l.Vt.isEditor),C=l.Vt.hasAccess(m.AccessControlAction.DashboardsWrite,l.Vt.isEditor),u=[];k&&u.push({label:"New dashboard",value:"new-dashboard"}),C&&u.push({label:"Existing dashboard",value:"existing-dashboard"});const f=u.length>1?T("saveTarget"):u[0].value,ea=`Add panel to ${u.length>1?"dashboard":u[0].label.toLowerCase()}`,q=async(L,D)=>{d(void 0);const x=D.saveTarget==="existing-dashboard"?D.dashboardUid:void 0;(0,F.ff)("e_2_d_submit",{newTab:L,saveTarget:D.saveTarget,queries:s.queries.length});try{await j({dashboardUid:x,datasource:s.datasourceInstance?.getRef(),queries:s.queries,queryResponse:s.queryResponse})}catch(J){switch(J){case E.FETCH_DASHBOARD:d({error:J,message:"Could not fetch dashboard information. Please try again."});break;case E.SET_DASHBOARD_LS:d({error:J,message:"Could not add panel to dashboard. Please try again."});break;default:d({error:"unknown-error",message:"Something went wrong. Please try again."})}return}const B=Y(x);if(!L){e(),V.E1.push(H.u.stripBaseFromUrl(B));return}if(!!!a.g.open(M.v.appUrl+B,"_blank")){d({error:"navigation-error",message:"Could not navigate to the selected dashboard. Please try again."}),(0,y.f1)();return}e()};return(0,n.useEffect)(()=>{(0,F.ff)("e_2_d_open")},[]),n.createElement(b.u,{title:ea,onDismiss:e,isOpen:!0},n.createElement("form",null,u.length>1&&n.createElement(g.g,{control:i,render:({field:{ref:L,...D}})=>n.createElement(I.g,{label:"Target dashboard",description:"Choose where to add the panel."},n.createElement(w.S,{options:u,...D,id:"e2d-save-target"})),name:"saveTarget"}),f==="existing-dashboard"&&(()=>n.createElement(g.g,{render:({field:{ref:L,value:D,onChange:x,...B}})=>n.createElement(I.g,{label:"Dashboard",description:"Select in which dashboard the panel will be created.",error:c.dashboardUid?.message,invalid:!!c.dashboardUid},n.createElement(Q.o,{...B,inputId:"e2d-dashboard-picker",defaultOptions:!0,onChange:_=>x(_?.uid)})),control:i,name:"dashboardUid",shouldUnregister:!0,rules:{required:{value:!0,message:"This field is required."}}}))(),o&&n.createElement(P.b,{severity:"error",title:"Error adding the panel"},o.message),n.createElement(b.u.ButtonRow,null,n.createElement(S.zx,{type:"reset",onClick:e,fill:"outline",variant:"secondary"},"Cancel"),n.createElement(S.zx,{type:"submit",variant:"secondary",onClick:r((0,O.partial)(q,!0)),icon:"external-link-alt"},"Open in new tab"),n.createElement(S.zx,{type:"submit",variant:"primary",onClick:r((0,O.partial)(q,!1)),icon:"apps"},"Open dashboard"))))},X=({exploreId:e})=>{const[t,s]=(0,n.useState)(!1),o=(0,h.F)(e),d=!!(0,m.useSelector)(o)?.queries?.length;return n.createElement(n.Fragment,null,n.createElement(U.h,{icon:"apps",variant:"canvas",onClick:()=>s(!0),"aria-label":"Add to dashboard",disabled:!d},"Add to dashboard"),t&&n.createElement(p,{onClose:()=>s(!1),exploreId:e}))}}}]);

//# sourceMappingURL=2319.1523bcba7c9b4bdae1dd.js.map
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9897],{"./public/app/plugins/datasource/elasticsearch/module.ts":(e,t,i)=>{i.r(t),i.d(t,{plugin:()=>qi});var s=i("./packages/grafana-data/src/index.ts"),n=i("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),a=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),l=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),r=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/generate.js"),o=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),d=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),c=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),g=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/skipWhile.js"),p=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/throwIfEmpty.js"),m=i("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/first.js"),h=i("../../opt/drone/yarncache/semver-npm-7.3.5-618cf5db6a-5eafe6102b.zip/node_modules/semver/index.js"),v=i("./packages/grafana-runtime/src/index.ts");class f extends s.LanguageProvider{constructor(e,t){var i,s,n;super(),n=void 0,(s="datasource")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.datasource=e,Object.assign(this,t)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map((e=>{switch(e.operator){case s.AbstractLabelOperator.Equal:return e.name+':"'+e.value+'"';case s.AbstractLabelOperator.NotEqual:return"NOT "+e.name+':"'+e.value+'"';case s.AbstractLabelOperator.EqualRegEx:return e.name+":/"+e.value+"/";case s.AbstractLabelOperator.NotEqualRegEx:return"NOT "+e.name+":/"+e.value+"/"}})).join(" AND ")}}var b=i("./public/app/core/utils/flatten.ts");const y=e=>{var t;return"ewma"===(null===(t=e.settings)||void 0===t?void 0:t.model)},x=e=>{var t;return"holt"===(null===(t=e.settings)||void 0===t?void 0:t.model)},j=e=>{var t;return"holt_winters"===(null===(t=e.settings)||void 0===t?void 0:t.model)},_=e=>{var t;return["holt","ewma","holt_winters"].includes((null===(t=e.settings)||void 0===t?void 0:t.model)||"")},F=e=>N[e.type].requiresField,k=e=>N[e.type].isPipelineAgg,w=e=>N[e.type].supportsMultipleBucketPaths,S=e=>N[e.type].supportsMissing,I=e=>N[e.type].hasSettings,O=e=>N[e.type].supportsInlineScript,q=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],M=e=>({name:e,pipelineAgg:""}),A=e=>`var${Math.max(0,...e.map((e=>{var t;return parseInt((null===(t=e.name.match("^var(\\d+)$"))||void 0===t?void 0:t[1])||"0",10)})))+1}`,N={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0 <8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,versionRange:">=7.0.0",defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,versionRange:">=2.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,versionRange:">=2.0.0",hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[M(A([]))]}},raw_document:{label:"Raw Document (legacy)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",xpack:!0,requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,versionRange:">=7.7.0",hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",xpack:!0,versionRange:">=7.10.0",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},C={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},P=(e,t)=>{const i=t.filter((t=>{var i;return w(t)?null===(i=t.pipelineVariables)||void 0===i?void 0:i.some((t=>t.pipelineAgg===e.id)):F(t)&&e.id===t.field}));return[...i,...i.flatMap((e=>P(e,t)))]},V=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],D=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],$="@HIGHLIGHT@",T="@/HIGHLIGHT@";function L(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"count",id:e}}function B(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"1";return{type:"date_histogram",id:e,settings:{interval:"auto"}}}const R=(e,t)=>e.find((e=>e.id===t));function z(e,t){var i;return!(null==e||null===(i=e.metrics)||void 0===i||!i.some((e=>e.type===t)))}var E=i("./public/app/core/table_model.ts");const W=e=>F(e)?`${N[e.type].label} ${e.field}`:N[e.type].label,H=e=>Object.entries(e).reduce(((e,t)=>{let[i,s]=t;if(null==s)return Object.assign({},e);if(Array.isArray(s)&&0===s.length)return Object.assign({},e);if(0===(null==s?void 0:s.length))return Object.assign({},e);if(!Array.isArray(s)&&"object"==typeof s){const t=H(s);return 0===Object.keys(t).length?Object.assign({},e):Object.assign({},e,{[i]:t})}return Object.assign({},e,{[i]:s})}),{}),Q=e=>{const t=e.match(/^(\d+)/);return t?t[1]:void 0},U=e=>{var t,i,s,n;return("object"==typeof(null===(t=e.settings)||void 0===t?void 0:t.script)?null===(i=e.settings)||void 0===i||null===(s=i.script)||void 0===s?void 0:s.inline:null===(n=e.settings)||void 0===n?void 0:n.script)||""},Y=e=>{if("string"==typeof e)return(0,h.valid)(e)||"5.0.0";switch(e){case 2:return"2.0.0";case 56:return"5.6.0";case 60:return"6.0.0";case 70:return"7.0.0";default:return"5.0.0"}};const G=`${$}([^@]+)${T}`;class Z{constructor(e,t){var i,s,n;n=()=>{const e=[];for(let t=0;t<this.response.responses.length;t++){const i=this.response.responses[t],s=this.targets[t];if(i.error)throw this.getErrorFromElasticResponse(this.response,i.error);if(i.hits&&i.hits.hits.length>0&&this.processHits(i.hits,e,s),i.aggregations){const s=i.aggregations,n=this.targets[t],a=[],l=new E.Z;l.refId=n.refId,this.processBuckets(s,n,a,l,{},0),this.trimDatapoints(a,n),this.nameSeries(a,n);for(let t=0;t<a.length;t++)e.push(a[t]);l.rows.length>0&&e.push(l)}}return{data:e}},(s="processResponseToSeries")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.targets=e,this.response=t,this.targets=e,this.response=t,this.targets=e,this.response=t}processMetrics(e,t,i,s){let n;for(let o=0;o<t.metrics.length;o++){const d=t.metrics[o];if(!d.hide)switch(d.type){case"count":n={datapoints:[],metric:"count",props:s,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i.doc_count;n.datapoints.push([s,i.key])}i.push(n);break;case"percentiles":{if(0===e.buckets.length)break;const a=e.buckets[0][d.id].values;for(const l in a){n={datapoints:[],metric:"p"+l,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].values;n.datapoints.push([s[l],i.key])}i.push(n)}break}case"extended_stats":for(const a in d.meta)if(d.meta[a]){n={datapoints:[],metric:a,props:s,field:d.field,refId:t.refId};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];s.std_deviation_bounds_upper=s.std_deviation_bounds.upper,s.std_deviation_bounds_lower=s.std_deviation_bounds.lower,n.datapoints.push([s[a],i.key])}i.push(n)}break;case"top_metrics":var a,l;if(null!==(a=d.settings)&&void 0!==a&&null!==(l=a.metrics)&&void 0!==l&&l.length)for(const a of null===(r=d.settings)||void 0===r?void 0:r.metrics){var r;n={datapoints:[],metric:d.type,props:s,refId:t.refId,field:a};for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id].top.map((e=>e.metrics[a]?e.metrics[a]:null)),l=[s[s.length-1],i.key];n.datapoints.push(l)}i.push(n)}break;default:n={datapoints:[],metric:d.type,metricId:d.id,props:s,refId:t.refId},F(d)&&(n.field=d.field);for(let t=0;t<e.buckets.length;t++){const i=e.buckets[t],s=i[d.id];void 0!==s&&(s.normalized_value?n.datapoints.push([s.normalized_value,i.key]):n.datapoints.push([s.value,i.key]))}i.push(n)}}}processAggregationDocs(e,t,i,s,a){if(0===s.columns.length){for(const e of(0,n.keys)(a))s.addColumn({text:e,filterable:!0});s.addColumn({text:t.field,filterable:!0})}const l=(e,t,i)=>{s.addColumn({text:t}),e.push(i)},r=(0,n.isArray)(e.buckets)?e.buckets:[e.buckets];for(const e of r){const t=[];for(const e of(0,n.values)(a))t.push(e);t.push(e.key);for(const s of i.metrics||[])switch(s.type){case"count":l(t,this.getMetricName(s.type),e.doc_count);break;case"extended_stats":for(const i in s.meta){if(!s.meta[i])continue;const n=e[s.id];n.std_deviation_bounds_upper=n.std_deviation_bounds.upper,n.std_deviation_bounds_lower=n.std_deviation_bounds.lower,l(t,this.getMetricName(i),n[i])}break;case"percentiles":{const i=e[s.id].values;for(const e in i)l(t,`p${e} ${s.field}`,i[e]);break}case"top_metrics":{var o;const i=this.getMetricName(s.type);if(null!==(o=s.settings)&&void 0!==o&&o.metrics)for(const n of s.settings.metrics){l(t,s.settings.metrics.length>1?`${i} ${n}`:i,e[s.id].top[0].metrics[n])}break}default:{let a=this.getMetricName(s.type);(0,n.filter)(i.metrics,{type:s.type}).length>1&&(F(s)&&(a+=" "+s.field),"bucket_script"===s.type&&(a=U(s))),l(t,a,e[s.id].value);break}}s.rows.push(t)}}processBuckets(e,t,i,s,a,l){let r,o,d,u;const c=t.bucketAggs.length-1;for(u in e)if(o=(0,n.find)(t.bucketAggs,{id:u}),d=e[u],o)if(l===c)"date_histogram"===o.type?this.processMetrics(d,t,i,a):this.processAggregationDocs(d,o,t,s,a);else for(const e in d.buckets)r=d.buckets[e],a=(0,n.clone)(a),void 0!==r.key?a[o.field]=r.key:a.filter=e,r.key_as_string&&(a[o.field]=r.key_as_string),this.processBuckets(r,t,i,s,a,l+1)}getMetricName(e){const t=Object.entries(N).filter((t=>{let[i]=t;return i===e})).map((e=>{let[t,i]=e;return i}))[0];if(t)return t.label;const i=V.find((t=>t.value===e));return i?i.label:e}getSeriesName(e,t,i){let s=this.getMetricName(e.metric);if(t.alias){const i=/\{\{([\s\S]+?)\}\}/g;return t.alias.replace(i,((t,i,n)=>{const a=i||n;return 0===a.indexOf("term ")?e.props[a.substring(5)]:void 0!==e.props[a]?e.props[a]:"metric"===a?s:"field"===a?e.field||"":t}))}if(e.metric in C)if(e.metric&&function(e){return!!N[e].supportsMultipleBucketPaths}(e.metric)){const i=(0,n.find)(t.metrics,{id:e.metricId});if(i&&i.settings.script){s=U(i);for(const e of i.pipelineVariables){const i=(0,n.find)(t.metrics,{id:e.pipelineAgg});i&&(s=s.replace("params."+e.name,W(i)))}}else s="Unset"}else{const i=(0,n.find)(t.metrics,{id:e.field});i?s+=" "+W(i):s="Unset"}else e.field&&(s+=" "+e.field);if(0===(0,n.keys)(e.props).length)return s;let a="";for(const t in e.props)a+=e.props[t]+" ";return i?a.trim()+" "+s:a.trim()}nameSeries(e,t){var i;const s=(0,n.uniq)((0,n.map)(e,"metric")).length,a=(null===(i=t.metrics)||void 0===i?void 0:i.filter((e=>"top_metrics"===e.type))).some((e=>{var t,i;return((null==e||null===(t=e.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.length)||0)>1}));for(let i=0;i<e.length;i++){const n=e[i];n.target=this.getSeriesName(n,t,s>1||a)}}processHits(e,t,i){const s="number"==typeof e.total?e.total:e.total.value,n={target:i.refId,type:"docs",refId:i.refId,datapoints:[],total:s,filterable:!0};let a,l,r,o;for(o=0;o<e.hits.length;o++){if(l=e.hits[o],r={_id:l._id,_type:l._type,_index:l._index,sort:l.sort,highlight:l.highlight},l._source)for(a in l._source)r[a]=l._source[a];for(a in l.fields)r[a]=l.fields[a];n.datapoints.push(r)}t.push(n)}trimDatapoints(e,t){const i=(0,n.find)(t.bucketAggs,{type:"date_histogram"});if(i&&i.settings&&i.settings.trimEdges){const t=i.settings.trimEdges;for(const i in e){const s=e[i];s.datapoints.length>2*t&&(s.datapoints=s.datapoints.slice(t,s.datapoints.length-t))}}}getErrorFromElasticResponse(e,t){const i={};return i.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?i.message=t.root_cause[0].reason:i.message=t.reason||"Unknown elastic error response",e.$$config&&(i.config=e.$$config),i}getTimeSeries(){return this.targets.some((e=>z(e,"raw_data")))?this.processResponseToDataFrames(!1):this.processResponseToSeries()}getLogs(e,t){return this.processResponseToDataFrames(!0,e,t)}processResponseToDataFrames(e,t,i){const a=[];for(let r=0;r<this.response.responses.length;r++){const o=this.response.responses[r];if(o.error)throw this.getErrorFromElasticResponse(this.response,o.error);if(o.hits){const{propNames:s,docs:d}=J(o.hits.hits),u=d.length?K(s.map(ee(d)),e,this.targets[0].timeField,t,i):K([],e);e&&X(u,"logs");for(const e of d){if(i&&(e.level=e[i]),e.highlight){var l;const t=new RegExp(G,"g"),i=new RegExp(G),s=Object.keys(e.highlight).flatMap((s=>e.highlight[s].flatMap((e=>{const s=e.match(t);return s?s.map((e=>{const t=e.match(i);return t&&t[1]||null})):[]})))).filter(n.identity),a=null!==(l=u.meta)&&void 0!==l&&l.searchWords?(0,n.uniq)([...u.meta.searchWords,...s]):[...s];u.meta=u.meta?Object.assign({},u.meta,{searchWords:a}):{searchWords:a}}u.add(e)}const c=this.targets[r];u.refId=c.refId,a.push(u)}if(o.aggregations){const t=o.aggregations,i=this.targets[r],n=[],l=new E.Z;if(this.processBuckets(t,i,n,l,{},0),this.trimDatapoints(n,i),this.nameSeries(n,i),l.rows.length>0){const e=(0,s.toDataFrame)(l);e.refId=i.refId,a.push(e)}for(let t=0;t<n.length;t++){let l=(0,s.toDataFrame)(n[t]);e&&X(l,"graph"),l.refId=i.refId,a.push(l)}}}return{data:a}}}const J=e=>{const t=[];let i=[];for(const s of e){const e=s._source?(0,b.default)(s._source):{},n=Object.assign({_id:s._id,_type:s._type,_index:s._index,sort:s.sort,highlight:s.highlight,_source:Object.assign({},e)},e);for(const e of Object.keys(n))-1===i.indexOf(e)&&i.push(e);t.push(n)}return i.sort(),{docs:t,propNames:i}},K=(e,t,i,n,a)=>{const l=new s.MutableDataFrame({fields:[]});if(i&&l.addField({config:{filterable:!0},name:i,type:s.FieldType.time}),n){const e=l.addField({name:n,type:s.FieldType.string});l.setParser(e,(e=>e||""))}if(a){const e=l.addField({name:"level",type:s.FieldType.string});l.setParser(e,(e=>e||""))}const r=l.fields.map((e=>e.name));for(const[i,s]of e){if(r.includes(i))continue;if(!t&&"_source"===i)continue;const e=l.addField({config:{filterable:!0},name:i,type:s});l.setParser(e,(e=>e||""))}return l},X=(e,t)=>{let i=e;i.meta?i.meta.preferredVisualisationType=t:i.meta={preferredVisualisationType:t}},ee=e=>t=>{var i;return[t,te(null===(i=e.find((e=>void 0!==e[t])))||void 0===i?void 0:i[t])]},te=e=>{switch(typeof e){case"number":return s.FieldType.number;case"string":return s.FieldType.string;default:return s.FieldType.other}};const ie={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class se{constructor(e,t){var i,s,n;n="en",(s="dateLocale")in(i=this)?Object.defineProperty(i,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[s]=n,this.pattern=e,this.interval=t,this.pattern=e,this.interval=t}getIndexForToday(){return this.interval?(0,s.toUtc)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,t){if(!this.interval)return this.pattern;const i=ie[this.interval],n=(0,s.dateTime)(e||(0,s.dateTime)(t).add(-7,i.amount)).utc().startOf(i.startOf),a=(0,s.dateTime)(t||(0,s.dateTime)(e).add(7,i.amount)).utc().startOf(i.startOf).valueOf(),l=[];for(;n.valueOf()<=a;)l.push(n.locale(this.dateLocale).format(this.pattern)),n.add(1,i.amount);return l}}function ne(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class ae{constructor(e){ne(this,"timeField",void 0),ne(this,"esVersion",void 0),this.timeField=e.timeField,this.esVersion=e.esVersion}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,t,i){var s;if(t.terms={field:e.field},!e.settings)return t;const n=null!==(s=e.settings)&&void 0!==s&&s.size?parseInt(e.settings.size,10):500;if(t.terms.size=0===n?500:n,void 0!==e.settings.orderBy){t.terms.order={},"_term"===e.settings.orderBy&&(0,h.gte)(this.esVersion,"6.0.0")?t.terms.order._key=e.settings.order:t.terms.order[e.settings.orderBy]=e.settings.order;const s=Q(e.settings.orderBy);if(s)for(let n of i.metrics||[])if(n.id===s){"count"===n.type?t.terms.order={_count:e.settings.order}:F(n)&&(t.aggs={},t.aggs[n.id]={[n.type]:{field:n.field}});break}}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(t.terms.min_doc_count)&&(t.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(t.terms.missing=e.settings.missing),t}getDateHistogramAgg(e){const t={},i=e.settings||{};t.field=e.field||this.timeField,t.min_doc_count=i.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis",i.timeZone&&i.timeZone!==s.InternalTimeZones.utc&&(t.time_zone=i.timeZone),""!==i.offset&&(t.offset=i.offset);const n="auto"===i.interval?"$__interval":i.interval;return(0,h.gte)(this.esVersion,"8.0.0")?t.fixed_interval=n:t.interval=n,t}getHistogramAgg(e){const t={},i=e.settings||{};return t.interval=i.interval,t.field=e.field,t.min_doc_count=i.min_doc_count||0,t}getFiltersAgg(e){const t={};for(let{query:s,label:n}of(null===(i=e.settings)||void 0===i?void 0:i.filters)||[]){var i;t[n||s]={query_string:{query:s,analyze_wildcard:!0}}}return t}documentQuery(e,t){return e.size=t,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],(0,h.lt)(this.esVersion,"5.0.0")&&(e.fields=["*","_source"]),e.script_fields={},e}addAdhocFilters(e,t){if(!t)return;let i,s,n,a;for(i=0;i<t.length;i++)switch(s=t[i],n={},n[s.key]=s.value,a={},a[s.key]={query:s.value},s.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:a});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:a});break;case"<":n[s.key]={lt:s.value},e.query.bool.filter.push({range:n});break;case">":n[s.key]={gt:s.value},e.query.bool.filter.push({range:n});break;case"=~":e.query.bool.filter.push({regexp:n});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:n}}})}}build(e,t){var i,s,n,a,l,r,o,d,u;let c,g,p,m,h;e.metrics=e.metrics||[L()],e.bucketAggs=e.bucketAggs||[B()],e.timeField=this.timeField;const v={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&""!==e.query&&(v.query.bool.filter=[...v.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),this.addAdhocFilters(v,t),0===e.bucketAggs.length&&(c=e.metrics[0],!c||"raw_document"!==c.type&&"raw_data"!==c.type))throw{message:"Invalid query"};if("raw_document"===(null===(i=e.metrics)||void 0===i||null===(s=i[0])||void 0===s?void 0:s.type)||"raw_data"===(null===(n=e.metrics)||void 0===n||null===(a=n[0])||void 0===a?void 0:a.type)){var f;c=e.metrics[0];const t=null!==(f=c.settings)&&void 0!==f&&f.size?parseInt(c.settings.size,10):500;return this.documentQuery(v,t||500)}for(h=v,g=0;g<e.bucketAggs.length;g++){const t=e.bucketAggs[g],i={};switch(t.type){case"date_histogram":i.date_histogram=this.getDateHistogramAgg(t);break;case"histogram":i.histogram=this.getHistogramAgg(t);break;case"filters":i.filters={filters:this.getFiltersAgg(t)};break;case"terms":this.buildTermsAgg(t,i,e);break;case"geohash_grid":var b;i.geohash_grid={field:t.field,precision:null===(b=t.settings)||void 0===b?void 0:b.precision}}h.aggs=h.aggs||{},h.aggs[t.id]=i,h=i}for(h.aggs={},g=0;g<e.metrics.length;g++){if(c=e.metrics[g],"count"===c.type)continue;const t={};let i={};if(k(c))if(w(c)){if(!c.pipelineVariables)continue;for(i={buckets_path:{}},p=0;p<c.pipelineVariables.length;p++)if(m=c.pipelineVariables[p],m.name&&m.pipelineAgg&&/^\d*$/.test(m.pipelineAgg)){const t=R(e.metrics,m.pipelineAgg);t&&("count"===t.type?i.buckets_path[m.name]="_count":i.buckets_path[m.name]=m.pipelineAgg)}}else{if(!c.field||!/^\d*$/.test(c.field))continue;{const t=R(e.metrics,c.field);t&&(i="count"===t.type?{buckets_path:"_count"}:{buckets_path:c.field})}}else F(c)&&(i={field:c.field});if(I(c))switch(Object.entries(c.settings||{}).filter((e=>{let[t,i]=e;return null!==i})).forEach((e=>{let[t,s]=e;i[t]="script"===t?this.buildScript(U(c)):s})),c.type){case"moving_avg":i=Object.assign({},i,void 0!==(null===(l=i)||void 0===l?void 0:l.window)&&{window:this.toNumber(i.window)},void 0!==(null===(r=i)||void 0===r?void 0:r.predict)&&{predict:this.toNumber(i.predict)},_(c)&&{settings:Object.assign({},i.settings,Object.fromEntries(Object.entries(i.settings||{}).filter((e=>{let[t]=e;return["alpha","beta","gamma","period"].includes(t)})).filter((e=>{let[t,i]=e;return void 0!==i})).map((e=>{let[t,i]=e;return[t,this.toNumber(i)]}))))});break;case"serial_diff":i=Object.assign({},i,void 0!==i.lag&&{lag:this.toNumber(i.lag)});break;case"top_metrics":var y,x;if(i={metrics:null===(o=c.settings)||void 0===o||null===(d=o.metrics)||void 0===d?void 0:d.map((e=>({field:e}))),size:1},null!==(u=c.settings)&&void 0!==u&&u.orderBy)i.sort=[{[null===(y=c.settings)||void 0===y?void 0:y.orderBy]:null===(x=c.settings)||void 0===x?void 0:x.order}]}t[c.type]=i,h.aggs[c.id]=t}return v}buildScript(e){return(0,h.gte)(this.esVersion,"5.6.0")?e:{inline:e}}toNumber(e){const t=parseFloat(`${e}`);return isNaN(t)?e:t}getTermsQuery(e){const t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let i=500;e.size&&(i=e.size),t.aggs={1:{terms:{field:e.field,size:i,order:{}}}};const{orderBy:s="key",order:n=("doc_count"===s?"desc":"asc")}=e;if(["asc","desc"].indexOf(n)<0)throw{message:`Invalid query sort order ${n}`};switch(s){case"key":case"term":const e=(0,h.gte)(this.esVersion,"6.0.0")?"_key":"_term";t.aggs[1].terms.order[e]=n;break;case"doc_count":t.aggs[1].terms.order._count=n;break;default:throw{message:`Invalid query sort type ${s}`}}return t}getLogsQuery(e,t,i){let s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return this.addAdhocFilters(s,i),e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),s=this.documentQuery(s,t),Object.assign({},s,{aggs:this.build(e,null).aggs,highlight:{fields:{"*":{}},pre_tags:[$],post_tags:[T],fragment_size:2147483647}})}}var le=i("./public/app/features/templating/template_srv.ts");const re={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[{label:"",query:"*"}]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:s.InternalTimeZones.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}}},oe=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],de=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],ue=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],ce=e=>re[e.type].requiresField,ge=["date_histogram","histogram","terms","filters","geohash_grid"];var pe=i("./public/app/core/logs_model.ts");function me(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const he=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class ve extends s.DataSourceApi{constructor(e){var t,i;let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,le.J)();super(e),me(this,"basicAuth",void 0),me(this,"withCredentials",void 0),me(this,"url",void 0),me(this,"name",void 0),me(this,"index",void 0),me(this,"timeField",void 0),me(this,"esVersion",void 0),me(this,"xpack",void 0),me(this,"interval",void 0),me(this,"maxConcurrentShardRequests",void 0),me(this,"queryBuilder",void 0),me(this,"indexPattern",void 0),me(this,"logMessageField",void 0),me(this,"logLevelField",void 0),me(this,"dataLinks",void 0),me(this,"languageProvider",void 0),me(this,"includeFrozen",void 0),me(this,"getLogRowContext",(async(e,t)=>{var i;const l=e.dataFrame.fields.find((e=>"sort"===e.name)),r=(null==l?void 0:l.values.get(e.rowIndex))||[e.timeEpochMs],o="FORWARD"===(null==t?void 0:t.direction)?"asc":"desc",d="FORWARD"===(null==t?void 0:t.direction)?this.getQueryHeader("query_then_fetch",(0,s.dateTime)(e.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,s.dateTime)(e.timeEpochMs)),u=null!==(i=null==t?void 0:t.limit)&&void 0!==i?i:10,c=[d,JSON.stringify({size:u,query:{bool:{filter:[{range:{[this.timeField]:{["FORWARD"===(null==t?void 0:t.direction)?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:o},{_doc:o}],search_after:r})].join("\n")+"\n",g=this.getMultiSearchUrl(),p=await(0,a.n)(this.post(g,c)),m=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],h=new Z(m,function(e,t){if("desc"===t)return e;const i=e.responses[0];return Object.assign({},e,{responses:[Object.assign({},i,{hits:Object.assign({},i.hits,{hits:i.hits.hits.reverse()})})]})}(p,o)),v=h.getLogs(this.logMessageField,this.logLevelField),f=(0,n.first)(v.data);if(!f)return{data:[]};const b=f.fields.find((e=>e.name===this.timeField)),y=f.fields.find((e=>e.name===this.logMessageField));return b&&y?{data:[Object.assign({},f,{fields:[...f.fields,Object.assign({},b,{name:"ts"}),Object.assign({},y,{name:"line"})]})]}:v})),this.templateSrv=l,this.templateSrv=l,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=null!==(t=e.database)&&void 0!==t?t:"";const r=e.jsonData||{};this.timeField=r.timeField,this.esVersion=Y(r.esVersion),this.xpack=Boolean(r.xpack),this.indexPattern=new se(this.index,r.interval),this.interval=r.timeInterval,this.maxConcurrentShardRequests=r.maxConcurrentShardRequests,this.queryBuilder=new ae({timeField:this.timeField,esVersion:this.esVersion}),this.logMessageField=r.logMessageField||"",this.logLevelField=r.logLevelField||"",this.dataLinks=r.dataLinks||[],this.includeFrozen=null!==(i=r.includeFrozen)&&void 0!==i&&i,""===this.logMessageField&&(this.logMessageField=void 0),""===this.logLevelField&&(this.logLevelField=void 0),this.languageProvider=new f(this)}request(e,t,i,s){const n={url:this.url+"/"+t,method:e,data:i,headers:s};return(this.basicAuth||this.withCredentials)&&(n.withCredentials=!0),this.basicAuth&&(n.headers={Authorization:this.basicAuth}),(0,v.getBackendSrv)().fetch(n).pipe((0,d.U)((e=>(e.data.$$config=e.config,e.data))),(0,u.K)((e=>{if(e.data){var t,i,s;const n=null!==(t=null!==(i=null===(s=e.data.error)||void 0===s?void 0:s.reason)&&void 0!==i?i:e.data.message)&&void 0!==t?t:"Unknown error";return(0,l._)({message:"Elasticsearch error: "+n,error:e.data.error})}return(0,l._)(e)})))}async importFromAbstractQueries(e){return e.map((e=>this.languageProvider.importFromAbstractQuery(e)))}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,s.getDefaultTimeRange)(),i=this.indexPattern.getIndexList(t.from,t.to);Array.isArray(i)||(i=[this.indexPattern.getIndexForToday()]);const n=i.map((t=>t+e));return this.requestAllIndices(n)}requestAllIndices(e){const t=e.length;return(0,r.R)({initialState:0,condition:e=>e<Math.min(t,7),iterate:e=>e+1}).pipe((0,c.z)((i=>this.request("GET",e[t-i-1]).pipe((0,u.K)((e=>(0,o.of)({err:e})))))),(0,g.n)((e=>{var t;return 404===(null==e||null===(t=e.err)||void 0===t?void 0:t.status)})),(0,p.T)((()=>"Could not find an available index for this time range.")),(0,m.P)(),(0,d.U)((e=>{if(e.err)throw e.err;return e})))}post(e,t){return this.request("POST",e,t,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const t=e.annotation,i=t.timeField||"@timestamp",l=t.timeEndField||null,r=t.query,o=t.tagsField||"tags",u=t.textField||null,c=[],g={};if(g[i]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:g}),l){const t={};t[l]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:t})}const p=this.interpolateLuceneQuery(r),m={bool:{filter:[{bool:{should:c,minimum_should_match:1}}]}};p&&m.bool.filter.push({query_string:{query:p}});const v={query:m,size:1e4};(0,h.lt)(this.esVersion,"5.0.0")&&(v.fields=[i,"_source"]);const f={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?f.index=t.index:f.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const b=JSON.stringify(f)+"\n"+JSON.stringify(v)+"\n";return(0,a.n)(this.post("_msearch",b).pipe((0,d.U)((e=>{const a=[],r=e.responses[0].hits.hits,d=(e,t)=>{if(!t)return;const i=t.split(".");let s=e;for(let e=0;e<i.length;e++)if(s=s[i[e]],!s)return console.log("could not find field in annotation: ",t),"";return s};for(let e=0;e<r.length;e++){const c=r[e]._source;let g=d(c,i);if(void 0!==r[e].fields){const t=r[e].fields;((0,n.isString)(t[i])||(0,n.isNumber)(t[i]))&&(g=t[i])}const p={annotation:t,time:(0,s.toUtc)(g).valueOf(),text:d(c,u),tags:d(c,o)};if(l){const e=d(c,l);e&&(p.timeEnd=(0,s.toUtc)(e).valueOf())}if(t.titleField){const e=d(c,t.titleField);e&&(p.text=e+"\n"+p.text)}"string"==typeof p.tags&&(p.tags=p.tags.split(",")),a.push(p)}return a}))))}interpolateLuceneQuery(e,t){return this.templateSrv.replace(e,t,"lucene")}interpolateVariablesInQueries(e,t){const i=e=>{var i,s;return"filters"===e.type?Object.assign({},e,{settings:Object.assign({},e.settings,{filters:null===(i=e.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.map((e=>Object.assign({},e,{query:this.interpolateLuceneQuery(e.query,t)||"*"})))})}):e},s=e.map((e=>{var s;return Object.assign({},e,{datasource:this.getRef(),query:this.interpolateLuceneQuery(e.query||"",t),bucketAggs:null===(s=e.bucketAggs)||void 0===s?void 0:s.map(i)})}));return JSON.parse(this.templateSrv.replace(JSON.stringify(s),t))}testDatasource(){return(0,a.n)(this.getFields(["date"]).pipe((0,c.z)((e=>(0,n.find)(e,{text:this.timeField})?(0,o.of)({status:"success",message:"Index OK. Time field name OK."}):(0,o.of)({status:"error",message:"No date field named "+this.timeField+" found"}))),(0,u.K)((e=>(console.error(e),e.message?(0,o.of)({status:"error",message:e.message}):(0,o.of)({status:"error",message:e.status}))))))}getQueryHeader(e,t,i){const s={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,i)};return(0,h.satisfies)(this.esVersion,">=5.6.0 <7.0.0")&&(s.max_concurrent_shard_requests=this.maxConcurrentShardRequests),JSON.stringify(s)}getQueryDisplayText(e){const t=e.metrics,i=e.bucketAggs;let s="";return e.query&&(s+="Query: "+e.query+", "),s+="Metrics: ",s+=null==t?void 0:t.reduce(((e,t)=>{let i=N[t.type].label+"(";return F(t)&&(i+=t.field),w(t)&&(i+=U(t).replace(new RegExp("params.","g"),"")),i+="), ",`${e} ${i}`}),""),s+=null==i?void 0:i.reduce(((e,t,i)=>{let s="";return 0===i&&(s+=" Group by: "),s+=re[t.type].label+"(",ce(t)&&(s+=t.field),`${e} ${s}), `}),""),e.alias&&(s+="Alias: "+e.alias),s}showContextToggle(){return(0,h.gte)(this.esVersion,"5.0.0")}getLogsVolumeDataProvider(e){if(!e.targets.some((e=>{var t;return 1===(null===(t=e.metrics)||void 0===t?void 0:t.length)&&"logs"===e.metrics[0].type})))return;const t=(0,n.cloneDeep)(e);return t.targets=t.targets.map((e=>{var t;const i=[],n=null!==(t=this.timeField)&&void 0!==t?t:"@timestamp";this.logLevelField&&i.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:s.LogLevel.unknown},field:this.logLevelField}),i.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:n});return{refId:e.refId,query:e.query,metrics:[{type:"count",id:"1"}],timeField:n,bucketAggs:i}})),(0,pe.Bz)(this,t,{range:e.range,targets:e.targets,extractLevel:e=>(0,s.getLogLevelFromKey)(e.name||"")})}query(e){let t="";const i=this.interpolateVariablesInQueries((0,n.cloneDeep)(e.targets),e.scopedVars),s=[];let a=i.some((e=>z(e,"logs")));const l=this.templateSrv.getAdhocFilters(this.name),r=[];for(const n of i){if(n.hide)continue;let i;if(z(n,"logs")){var u,c,g;n.bucketAggs=[B()];const e=null===(u=n.metrics)||void 0===u?void 0:u.find((e=>"logs"===e.type)),t=null!==(c=e.settings)&&void 0!==c&&c.limit?parseInt(null===(g=e.settings)||void 0===g?void 0:g.limit,10):500;r.push(t),n.metrics=[],i=this.queryBuilder.getLogsQuery(n,t,l)}else r.push(),n.alias&&(n.alias=this.interpolateLuceneQuery(n.alias,e.scopedVars)),i=this.queryBuilder.build(n,l);const a=JSON.stringify(i),o=0===i.size&&(0,h.lt)(this.esVersion,"5.0.0")?"count":"query_then_fetch";t+=this.getQueryHeader(o,e.range.from,e.range.to)+"\n",t+=a+"\n",s.push(n)}if(0===s.length)return(0,o.of)({data:[]});t=t.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),t=t.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),t=this.templateSrv.replace(t,e.scopedVars);const p=this.getMultiSearchUrl();return this.post(p,t).pipe((0,d.U)((e=>{const t=new Z(s,e);if(a){const e=t.getLogs(this.logMessageField,this.logLevelField);return e.data.forEach(((e,t)=>{!function(e,t,i){i&&(e.meta=Object.assign({},e.meta,{limit:i}));if(!t.length)return;for(const i of e.fields){const e=t.filter((e=>new RegExp(e.field).test(i.name)));0!==e.length&&(i.config=i.config||{},i.config.links=[...(i.config.links,e.map(fe))])}}(e,this.dataLinks,r[t])})),e}return t.getTimeSeries()})))}isMetadataField(e){return he.includes(e)}getFields(e,t){const i={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",t).pipe((0,d.U)((t=>{const s=(t,s)=>!this.isMetadataField(s)&&(!e||0===e.length||(e.includes(t.type)||e.includes(i[t.type]))),a=[],l={};function r(e){for(const t in e){const i=e[t];if((0,n.isObject)(i.properties)&&(a.push(t),r(i.properties)),(0,n.isObject)(i.fields)&&(a.push(t),r(i.fields)),(0,n.isString)(i.type)){const e=a.concat(t).join(".");s(i,t)&&(l[e]={text:e,type:i.type})}}a.pop()}for(const e in t){const i=t[e];if(i&&i.mappings){const e=i.mappings;if((0,h.lt)(this.esVersion,"7.0.0"))for(const t in e){r(e[t].properties)}else{r(e.properties)}}}return(0,n.map)(l,(e=>e))})))}getTerms(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,s.getDefaultTimeRange)();const i=(0,h.gte)(this.esVersion,"5.0.0")?"query_then_fetch":"count",a=this.getQueryHeader(i,t.from,t.to);let l=JSON.stringify(this.queryBuilder.getTermsQuery(e));l=l.replace(/\$timeFrom/g,t.from.valueOf().toString()),l=l.replace(/\$timeTo/g,t.to.valueOf().toString()),l=a+"\n"+l+"\n";const r=this.getMultiSearchUrl();return this.post(r,l).pipe((0,d.U)((e=>{if(!e.responses[0].aggregations)return[];const t=e.responses[0].aggregations[1].buckets;return(0,n.map)(t,(e=>({text:e.key_as_string||e.key,value:e.key})))})))}getMultiSearchUrl(){const e=new URLSearchParams;return(0,h.gte)(this.esVersion,"7.0.0")&&this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),(0,h.gte)(this.esVersion,"6.6.0")&&this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,t){const i=null==t?void 0:t.range,s=JSON.parse(e);if(e){if("fields"===s.find)return s.type=this.interpolateLuceneQuery(s.type),(0,a.n)(this.getFields(s.type,i));if("terms"===s.find)return s.field=this.interpolateLuceneQuery(s.field),s.query=this.interpolateLuceneQuery(s.query),(0,a.n)(this.getTerms(s,i))}return Promise.resolve([])}getTagKeys(){return(0,a.n)(this.getFields())}getTagValues(e){return(0,a.n)(this.getTerms({field:e.key}))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const t of e.bucketAggs)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings))return!0;for(const t of e.metrics)if(this.templateSrv.containsTemplate(t.field)||this.objectContainsTemplate(t.settings)||this.objectContainsTemplate(t.meta))return!0;return!1}isPrimitive(e){return null==e||!!["string","number","boolean"].some((e=>"boolean"===e))}objectContainsTemplate(e){if(!e)return!1;for(const t of Object.keys(e))if(this.isPrimitive(e[t])){if(this.templateSrv.containsTemplate(e[t]))return!0}else if(Array.isArray(e[t])){for(const i of e[t])if(this.objectContainsTemplate(i))return!0}else if(this.objectContainsTemplate(e[t]))return!0;return!1}}function fe(e){const t=(0,v.getDataSourceSrv)();if(e.datasourceUid){var i;const s=t.getInstanceSettings(e.datasourceUid);return{title:e.urlDisplayLabel||"",url:"",internal:{query:{query:e.url},datasourceUid:e.datasourceUid,datasourceName:null!==(i=null==s?void 0:s.name)&&void 0!==i?i:"Data source not found"}}}return{title:e.urlDisplayLabel||"",url:e.url}}var be=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),ye=i("./packages/grafana-ui/src/index.ts");const xe=e=>{var t;const i=Y(e.jsonData.esVersion);return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{timeField:e.jsonData.timeField||"@timestamp",esVersion:i,maxConcurrentShardRequests:e.jsonData.maxConcurrentShardRequests||Ae(i),logMessageField:e.jsonData.logMessageField||"",logLevelField:e.jsonData.logLevelField||"",includeFrozen:null!==(t=e.jsonData.includeFrozen)&&void 0!==t&&t})})},je=e=>Boolean(e);var _e,Fe=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const ke=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],we=[{label:"2.x",value:"2.0.0"},{label:"5.x",value:"5.0.0"},{label:"5.6+",value:"5.6.0"},{label:"6.0+",value:"6.0.0"},{label:"7.0+",value:"7.0.0"},{label:"7.7+",value:"7.7.0"},{label:"7.10+",value:"7.10.0"},{label:"8.0+",value:"8.0.0",description:"support for Elasticsearch 8 is currently experimental"}],Se=e=>{var t;let{value:i,onChange:s}=e;const n=we.find((e=>e.value===i.jsonData.esVersion)),a=!n&&(0,h.valid)(i.jsonData.esVersion)?{label:i.jsonData.esVersion,value:i.jsonData.esVersion}:void 0;return(0,Fe.jsx)(Fe.Fragment,{children:(0,Fe.jsxs)(ye.FieldSet,{label:"Elasticsearch details",children:[(0,Fe.jsx)(ye.InlineField,{label:"Index name",labelWidth:26,children:(0,Fe.jsx)(ye.Input,{id:"es_config_indexName",value:i.database||"",onChange:Ie("database",i,s),width:24,placeholder:"es-index-name",required:!0})}),(0,Fe.jsx)(ye.InlineField,{label:"Pattern",labelWidth:26,children:(0,Fe.jsx)(ye.Select,{inputId:"es_config_indexPattern",value:ke.find((e=>e.value===(void 0===i.jsonData.interval?"none":i.jsonData.interval))),options:ke,onChange:Me(i,s),width:24,menuShouldPortal:!0})}),(0,Fe.jsx)(ye.InlineField,{label:"Time field name",labelWidth:26,children:(0,Fe.jsx)(ye.Input,{id:"es_config_timeField",value:i.jsonData.timeField||"",onChange:Oe("timeField",i,s),width:24,placeholder:"@timestamp",required:!0})}),(0,Fe.jsx)(ye.InlineField,{label:"ElasticSearch version",labelWidth:26,children:(0,Fe.jsx)(ye.Select,{inputId:"es_config_version",options:[a,...we].filter(je),onChange:e=>{const t=function(e,t){if(5===e&&(0,h.lt)(t,"7.0.0"))return 256;if(256===e&&(0,h.gte)(t,"7.0.0"))return 5;return e||Ae(t)}(i.jsonData.maxConcurrentShardRequests,e.value);s(Object.assign({},i,{jsonData:Object.assign({},i.jsonData,{esVersion:e.value,maxConcurrentShardRequests:t})}))},value:n||a,width:24,menuShouldPortal:!0})}),(0,h.gte)(i.jsonData.esVersion,"5.6.0")&&(0,Fe.jsx)(ye.InlineField,{label:"Max concurrent Shard Requests",labelWidth:26,children:(0,Fe.jsx)(ye.Input,{id:"es_config_shardRequests",value:i.jsonData.maxConcurrentShardRequests||"",onChange:Oe("maxConcurrentShardRequests",i,s),width:24})}),(0,Fe.jsx)(ye.InlineField,{label:"Min time interval",labelWidth:26,tooltip:(0,Fe.jsxs)(Fe.Fragment,{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",_e||(_e=(0,Fe.jsx)("code",{children:"1m"}))," if your data is written every minute."]}),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!i.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(i.jsonData.timeInterval),children:(0,Fe.jsx)(ye.Input,{id:"es_config_minTimeInterval",value:i.jsonData.timeInterval||"",onChange:Oe("timeInterval",i,s),width:24,placeholder:"10s"})}),(0,Fe.jsx)(ye.InlineField,{label:"X-Pack enabled",labelWidth:26,children:(0,Fe.jsx)(ye.InlineSwitch,{id:"es_config_xpackEnabled",checked:i.jsonData.xpack||!1,onChange:qe("xpack",i,s)})}),(0,h.gte)(i.jsonData.esVersion,"6.6.0")&&i.jsonData.xpack&&(0,Fe.jsx)(ye.InlineField,{label:"Include Frozen Indices",labelWidth:26,children:(0,Fe.jsx)(ye.InlineSwitch,{id:"es_config_frozenIndices",checked:null!==(t=i.jsonData.includeFrozen)&&void 0!==t&&t,onChange:qe("includeFrozen",i,s)})})]})})},Ie=(e,t,i)=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))},Oe=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.value})}))},qe=(e,t,i)=>s=>{i(Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:s.currentTarget.checked})}))},Me=(e,t)=>i=>{const{database:s}=e,n="none"===i.value?void 0:i.value;if(!s||0===s.length||s.startsWith("[logstash-]")){let i="";if(void 0!==n){const e=ke.find((e=>e.value===n));var a;if(e)i=null!==(a=e.example)&&void 0!==a?a:""}t(Object.assign({},e,{database:i,jsonData:Object.assign({},e.jsonData,{interval:n})}))}else t(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{interval:n})}))};function Ae(e){return(0,h.gte)(e,"7.0.0")?5:256}const Ne=e=>{const{value:t,onChange:i}=e,s=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,Fe.jsxs)(ye.FieldSet,{label:"Logs",children:[(0,Fe.jsx)(ye.InlineField,{label:"Message field name",labelWidth:22,children:(0,Fe.jsx)(ye.Input,{id:"es_logs-config_logMessageField",value:t.logMessageField,onChange:s("logMessageField"),placeholder:"_source",width:24})}),(0,Fe.jsx)(ye.InlineField,{label:"Level field name",labelWidth:22,children:(0,Fe.jsx)(ye.Input,{id:"es_logs-config_logLevelField",value:t.logLevelField,onChange:s("logLevelField"),width:24})})]})};var Ce=i("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),Pe=i("./.yarn/__virtual__/react-use-virtual-00326e70ba/3/opt/drone/yarncache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/usePrevious.js");const{FormField:Ve,Switch:De}=ye.LegacyForms,$e=(0,ye.stylesFactory)((()=>({firstRow:Ce.css`
    display: flex;
  `,nameField:Ce.css`
    flex: 2;
  `,regexField:Ce.css`
    flex: 3;
  `,row:Ce.css`
    display: flex;
    align-items: baseline;
  `,urlField:Ce.css`
    flex: 1;
  `,urlDisplayLabelField:Ce.css`
    flex: 1;
  `}))),Te=e=>{const{value:t,onChange:i,onDelete:s,suggestions:n,className:a}=e,l=$e(),[r,o]=function(e){const[t,i]=(0,be.useState)(!!e),s=(0,Pe.Z)(e);return(0,be.useEffect)((()=>{s||!e||t||i(!0),s&&!e&&t&&i(!1)}),[s,e,t]),[t,i]}(t.datasourceUid),d=e=>s=>{i(Object.assign({},t,{[e]:s.currentTarget.value}))};return(0,Fe.jsxs)("div",{className:a,children:[(0,Fe.jsxs)("div",{className:l.firstRow+" gf-form",children:[(0,Fe.jsx)(Ve,{className:l.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:t.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:d("field")}),(0,Fe.jsx)(ye.Button,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),s()}})]}),(0,Fe.jsxs)("div",{className:"gf-form",children:[(0,Fe.jsx)(Ve,{label:r?"Query":"URL",labelWidth:6,inputEl:(0,Fe.jsx)(ye.DataLinkInput,{placeholder:r?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>i(Object.assign({},t,{url:e})),suggestions:n}),className:l.urlField}),(0,Fe.jsx)(Ve,{className:l.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:d("urlDisplayLabel"),tooltip:"Use to override the button label."})]}),(0,Fe.jsxs)("div",{className:l.row,children:[(0,Fe.jsx)(De,{labelClass:"width-6",label:"Internal link",checked:r,onChange:()=>{r&&i(Object.assign({},t,{datasourceUid:void 0})),o(!r)}}),r&&(0,Fe.jsx)(v.DataSourcePicker,{tracing:!0,onChange:e=>{i(Object.assign({},t,{datasourceUid:e.uid}))},current:t.datasourceUid})]})]})};var Le;const Be=e=>({infoText:Ce.css`
      padding-bottom: ${e.spacing(2)};
      color: ${e.colors.text.secondary};
    `,dataLink:Ce.css`
      margin-bottom: ${e.spacing(1)};
    `}),Re=e=>{const{value:t,onChange:i}=e,n=(0,ye.useStyles2)(Be);return(0,Fe.jsxs)(Fe.Fragment,{children:[Le||(Le=(0,Fe.jsx)("h3",{className:"page-heading",children:"Data links"})),(0,Fe.jsx)("div",{className:n.infoText,children:"Add links to existing fields. Links will be shown in log row details next to the field value."}),t&&t.length>0&&(0,Fe.jsx)("div",{className:"gf-form-group",children:t.map(((e,a)=>(0,Fe.jsx)(Te,{className:n.dataLink,value:e,onChange:e=>{const s=[...t];s.splice(a,1,e),i(s)},onDelete:()=>{const e=[...t];e.splice(a,1),i(e)},suggestions:[{value:s.DataLinkBuiltInVars.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:s.VariableOrigin.Value}]},a)))}),(0,Fe.jsx)(ye.Button,{type:"button",variant:"secondary",className:Ce.css`
          margin-right: 10px;
        `,icon:"plus",onClick:e=>{e.preventDefault();const s=[...t||[],{field:"",url:""}];i(s)},children:"Add"})]})};var ze,Ee=i("./public/app/core/config.ts");const We=(e,t,i)=>(0,be.useCallback)((s=>{e(i(t,s))}),[e,t,i]),He=(0,be.createContext)(void 0),Qe=()=>{const e=(0,be.useContext)(He);if(!e)throw new Error("Use DispatchContext first.");return e};var Ue=i("./.yarn/__virtual__/@reduxjs-toolkit-virtual-7692db070f/3/opt/drone/yarncache/@reduxjs-toolkit-npm-1.7.2-7ced4ba4dc-41c17c660f.zip/node_modules/@reduxjs/toolkit/dist/redux-toolkit.esm.js");const Ye=(0,Ue.PH)("init"),Ge=(0,Ue.PH)("change_query"),Ze=(0,Ue.PH)("change_alias_pattern"),Je=(e,t)=>Ge.match(t)?t.payload:Ye.match(t)?e||"":e,Ke=(e,t)=>Ze.match(t)?t.payload:Ye.match(t)?e||"":e,Xe=(0,Ue.PH)("@metrics/add"),et=(0,Ue.PH)("@metrics/remove"),tt=(0,Ue.PH)("@metrics/toggle_visibility"),it=(0,Ue.PH)("@metrics/change_field"),st=(0,Ue.PH)("@metrics/change_type"),nt=(0,Ue.PH)("@metrics/change_attr"),at=(0,Ue.PH)("@metrics/change_setting"),lt=(0,Ue.PH)("@metrics/change_meta"),rt=(e,t)=>{if(Xe.match(t))return[...e,L(t.payload)];if(et.match(t)){const i=e.find((e=>e.id===t.payload)),s=[i,...P(i,e)],n=e.filter((e=>!s.some((t=>t.id===e.id))));return 0===n.length?[L("1")]:n}return st.match(t)?e.filter((e=>!N[t.payload.type].isSingleMetric||e.id===t.payload.id)).map((e=>e.id!==t.payload.id?e:Object.assign({id:e.id,type:t.payload.type},N[t.payload.type].defaults))):it.match(t)?e.map((e=>{if(e.id!==t.payload.id)return e;const i=Object.assign({},e,{field:t.payload.field});return k(e)?Object.assign({},i,{pipelineAgg:t.payload.field}):i})):tt.match(t)?e.map((e=>e.id!==t.payload?e:Object.assign({},e,{hide:!e.hide}))):at.match(t)?e.map((e=>{if(e.id!==t.payload.metric.id)return e;if(I(e)){const i=H(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})}return e})):lt.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:(e=>N[e.type].hasMeta)(e)?Object.assign({},e,{meta:Object.assign({},e.meta,{[t.payload.meta]:t.payload.newValue})}):e)):nt.match(t)?e.map((e=>e.id!==t.payload.metric.id?e:Object.assign({},e,{[t.payload.attribute]:t.payload.newValue}))):Ye.match(t)?null!=e&&e.length?e:[L("1")]:e},ot=(0,Ue.PH)("@bucketAggs/add"),dt=(0,Ue.PH)("@bucketAggs/remove"),ut=(0,Ue.PH)("@bucketAggs/change_type"),ct=(0,Ue.PH)("@bucketAggs/change_field"),gt=(0,Ue.PH)("@bucketAggs/change_setting"),pt=(0,be.createContext)(void 0),mt=(0,be.createContext)(void 0),ht=(0,be.createContext)(void 0),vt=e=>{let{children:t,onChange:i,onRunQuery:s,query:n,datasource:a,range:l}=e;const r=(0,be.useCallback)((e=>{i(e),s()}),[i,s]),o=(d={query:Je,alias:Ke,metrics:rt,bucketAggs:(u=a.timeField,(e,t)=>{if(ot.match(t)){const i={id:t.payload,type:"terms",settings:re.terms.defaultSettings},s=e[e.length-1];return"date_histogram"===(null==s?void 0:s.type)?[...e.slice(0,e.length-1),i,s]:[...e,i]}return dt.match(t)?e.filter((e=>e.id!==t.payload)):ut.match(t)?e.map((e=>e.id!==t.payload.id?e:{id:e.id,type:t.payload.newType,settings:re[t.payload.newType].defaultSettings})):ct.match(t)?e.map((e=>e.id!==t.payload.id?e:Object.assign({},e,{field:t.payload.newField}))):st.match(t)?N[t.payload.type].isSingleMetric?[]:0===e.length?[Object.assign({},B("2"),{field:u})]:e:gt.match(t)?e.map((e=>{if(e.id!==t.payload.bucketAgg.id)return e;const i=H(Object.assign({},e.settings,{[t.payload.settingName]:t.payload.newValue}));return Object.assign({},e,{settings:Object.assign({},i)})})):Ye.match(t)?null!=e&&e.length?e:[Object.assign({},B("2"),{field:u})]:e})},(e,t)=>{const i={};for(const s in d)i[s]=d[s](e[s],t);return i});var d,u;const c=We((e=>r(Object.assign({},n,e,{timeField:a.timeField}))),n,o);return n.metrics&&n.bucketAggs&&void 0!==n.query?(0,Fe.jsx)(pt.Provider,{value:a,children:(0,Fe.jsx)(mt.Provider,{value:n,children:(0,Fe.jsx)(ht.Provider,{value:l,children:(0,Fe.jsx)(He.Provider,{value:c,children:t})})})}):(c(Ye()),null)},ft=e=>()=>{const t=(0,be.useContext)(e);if(!t)throw new Error("use ElasticsearchProvider first.");return t},bt=ft(mt),yt=ft(pt),xt=ft(ht),jt=["iconName","onClick","className","label"];const _t=Ce.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,Ft=e=>{let{iconName:t,onClick:i,className:s,label:n}=e,a=function(e,t){if(null==e)return{};var i,s,n={},a=Object.keys(e);for(s=0;s<a.length;s++)i=a[s],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,jt);return(0,Fe.jsxs)("button",Object.assign({className:(0,Ce.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:i},a,{children:[(0,Fe.jsx)("span",{className:_t,children:n}),(0,Fe.jsx)(ye.Icon,{name:t,"aria-hidden":"true"})]}))},kt=e=>{let{index:t,onAdd:i,onRemove:s,elements:n}=e;return(0,Fe.jsxs)("div",{className:Ce.css`
        display: flex;
      `,children:[0===t&&(0,Fe.jsx)(Ft,{iconName:"plus",onClick:i,label:"add"}),n.length>=2&&(0,Fe.jsx)(Ft,{iconName:"minus",onClick:s,label:"remove"})]})},wt=Ce.css`
  white-space: nowrap;
`,St=e=>({label:W(e),value:e}),It=e=>{let{options:t,onChange:i,className:s,value:n}=e;const a=t.find((e=>e.id===n));return(0,Fe.jsx)(ye.Segment,{className:(0,Ce.cx)(s,wt),options:(l=t,l.map(St)),onChange:i,placeholder:"Select Metric",value:a?St(a):void 0});var l},Ot=(0,Ue.PH)("@pipelineVariables/add"),qt=(0,Ue.PH)("@pipelineVariables/remove"),Mt=(0,Ue.PH)("@pipelineVariables/rename"),At=(0,Ue.PH)("@pipelineVariables/change_metric"),Nt=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return Ot.match(t)?[...e,M(A(e))]:qt.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):Mt.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{name:t.payload.newName}))):At.match(t)?e.map(((e,i)=>i!==t.payload.index?e:Object.assign({},e,{pipelineAgg:t.payload.newMetric}))):e};function Ct(e){let{label:t,settingName:i,metric:s,placeholder:a,tooltip:l}=e;const r=Qe(),[o]=(0,be.useState)((0,n.uniqueId)("es-field-id-")),d=s.settings;let u=(null==d?void 0:d[i])||"";return"script"===i&&(u=U(s)),(0,Fe.jsx)(ye.InlineField,{label:t,labelWidth:16,tooltip:l,children:(0,Fe.jsx)(ye.Input,{id:o,placeholder:a,onBlur:e=>r(at({metric:s,settingName:i,newValue:e.target.value})),defaultValue:u})})}var Pt;const Vt=e=>{var t;let{value:i,previousMetrics:s}=e;const a=Qe(),l=We((e=>a(nt({metric:i,attribute:"pipelineVariables",newValue:e}))),i.pipelineVariables,Nt);return(0,be.useEffect)((()=>{var e;null!==(e=i.pipelineVariables)&&void 0!==e&&e.length||l(Ot())}),[l,null===(t=i.pipelineVariables)||void 0===t?void 0:t.length]),(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsxs)("div",{className:Ce.css`
          display: flex;
        `,children:[Pt||(Pt=(0,Fe.jsx)(ye.InlineLabel,{width:16,children:"Variables"})),(0,Fe.jsx)("div",{className:Ce.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `,children:i.pipelineVariables.map(((e,t)=>(0,Fe.jsxs)(be.Fragment,{children:[(0,Fe.jsxs)("div",{className:Ce.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `,children:[(0,Fe.jsx)(ye.Input,{"aria-label":"Variable name",defaultValue:e.name,placeholder:"Variable Name",onBlur:e=>l(Mt({newName:e.target.value,index:t}))}),(0,Fe.jsx)(It,{onChange:e=>l(At({newMetric:e.value.id,index:t})),options:s,value:e.pipelineAgg})]}),(0,Fe.jsx)(kt,{index:t,elements:i.pipelineVariables||[],onAdd:()=>l(Ot()),onRemove:()=>l(qt(t))})]},(0,n.uniqueId)("es-bs-"))))})]}),(0,Fe.jsx)(Ct,{label:"Script",metric:i,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"})]})},Dt=Ce.css`
  min-width: 150px;
`,$t=e=>{let{label:t,children:i,hidden:s=!1}=e;const[n,a]=(0,be.useState)(!1),l=((e,t)=>({wrapper:Ce.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:Ce.css`
      padding-top: ${e.spacing(.5)};
    `,icon:Ce.css`
      margin-right: ${e.spacing(.5)};
    `,button:Ce.css`
      justify-content: start;
      ${t&&Ce.css`
        color: ${e.colors.text.disabled};
      `}
    `}))((0,ye.useTheme2)(),s);return(0,Fe.jsx)(ye.InlineSegmentGroup,{children:(0,Fe.jsxs)("div",{className:(0,Ce.cx)(l.wrapper),children:[(0,Fe.jsxs)("button",{className:(0,Ce.cx)("gf-form-label query-part",l.button,Dt),onClick:()=>a(!n),"aria-expanded":n,children:[(0,Fe.jsx)(ye.Icon,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:l.icon}),t]}),n&&(0,Fe.jsx)("div",{className:l.settingsWrapper,children:i})]})})},Tt=e=>{var t,i,s,a,l,r,o,d,u,c,g,p;let{metric:m}=e;const h=Qe(),{current:v}=(0,be.useRef)((0,n.uniqueId)("es-moving-avg-"));return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,{label:"Model",labelWidth:16,children:(0,Fe.jsx)(ye.Select,{inputId:`${v}-model`,menuShouldPortal:!0,onChange:e=>h(at({metric:m,settingName:"model",newValue:e.value})),options:D,value:null===(t=m.settings)||void 0===t?void 0:t.model})}),(0,Fe.jsx)(Ct,{label:"Window",settingName:"window",metric:m,placeholder:"5"}),(0,Fe.jsx)(Ct,{label:"Predict",settingName:"predict",metric:m}),(y(m)||x(m)||j(m))&&(0,Fe.jsx)(ye.InlineField,{label:"Alpha",labelWidth:16,children:(0,Fe.jsx)(ye.Input,{id:`${v}-alpha`,onBlur:e=>{var t;return h(at({metric:m,settingName:"settings",newValue:Object.assign({},null===(t=m.settings)||void 0===t?void 0:t.settings,{alpha:e.target.value})}))},defaultValue:null===(i=m.settings)||void 0===i||null===(s=i.settings)||void 0===s?void 0:s.alpha})}),(x(m)||j(m))&&(0,Fe.jsx)(ye.InlineField,{label:"Beta",labelWidth:16,children:(0,Fe.jsx)(ye.Input,{id:`${v}-beta`,onBlur:e=>{var t;return h(at({metric:m,settingName:"settings",newValue:Object.assign({},null===(t=m.settings)||void 0===t?void 0:t.settings,{beta:e.target.value})}))},defaultValue:null===(a=m.settings)||void 0===a||null===(l=a.settings)||void 0===l?void 0:l.beta})}),j(m)&&(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,{label:"Gamma",labelWidth:16,children:(0,Fe.jsx)(ye.Input,{id:`${v}-gamma`,onBlur:e=>{var t;return h(at({metric:m,settingName:"settings",newValue:Object.assign({},null===(t=m.settings)||void 0===t?void 0:t.settings,{gamma:e.target.value})}))},defaultValue:null===(r=m.settings)||void 0===r||null===(o=r.settings)||void 0===o?void 0:o.gamma})}),(0,Fe.jsx)(ye.InlineField,{label:"Period",labelWidth:16,children:(0,Fe.jsx)(ye.Input,{id:`${v}-period`,onBlur:e=>{var t;return h(at({metric:m,settingName:"settings",newValue:Object.assign({},null===(t=m.settings)||void 0===t?void 0:t.settings,{period:e.target.value})}))},defaultValue:null===(d=m.settings)||void 0===d||null===(u=d.settings)||void 0===u?void 0:u.period})}),(0,Fe.jsx)(ye.InlineField,{label:"Pad",labelWidth:16,children:(0,Fe.jsx)(ye.InlineSwitch,{id:`${v}-pad`,onChange:e=>{var t;return h(at({metric:m,settingName:"settings",newValue:Object.assign({},null===(t=m.settings)||void 0===t?void 0:t.settings,{pad:e.target.checked})}))},checked:!(null===(c=m.settings)||void 0===c||null===(g=c.settings)||void 0===g||!g.pad)})})]}),(y(m)||x(m)||j(m))&&(0,Fe.jsx)(ye.InlineField,{label:"Minimize",labelWidth:16,children:(0,Fe.jsx)(ye.InlineSwitch,{id:`${v}-minimize`,onChange:e=>h(at({metric:m,settingName:"minimize",newValue:e.target.checked})),checked:!(null===(p=m.settings)||void 0===p||!p.minimize)})})]})},Lt=e=>{if(t=e,q.includes(t))return"cardinality"===e?[]:["number"];var t;if((e=>ge.includes(e))(e))switch(e){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Bt=e=>{let{text:t}=e;return{label:t,value:t}},Rt=e=>{const t=yt(),i=xt(),s=Array.isArray(e)?e:Lt(e);let n;return async e=>(n||(n=await(0,a.n)(t.getFields(s,i))),n.filter((t=>{let{text:i}=t;return void 0===e||i.includes(e)})).map(Bt))},zt=e=>({value:e,label:e}),Et=e=>{var t,i,s,n;let{metric:a}=e;const l=Qe(),r=Rt(["number","date"]),o=Rt(a.type);return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,{label:"Metrics",labelWidth:16,children:(0,Fe.jsx)(ye.AsyncMultiSelect,{menuShouldPortal:!0,onChange:e=>l(at({metric:a,settingName:"metrics",newValue:e.map((e=>e.value))})),loadOptions:o,value:null===(t=a.settings)||void 0===t||null===(i=t.metrics)||void 0===i?void 0:i.map(zt),closeMenuOnSelect:!1,defaultOptions:!0})}),(0,Fe.jsx)(ye.InlineField,{label:"Order",labelWidth:16,children:(0,Fe.jsx)(ye.Select,{menuShouldPortal:!0,onChange:e=>l(at({metric:a,settingName:"order",newValue:e.value})),options:de,value:null===(s=a.settings)||void 0===s?void 0:s.order})}),(0,Fe.jsx)(ye.InlineField,{label:"Order By",labelWidth:16,className:Ce.css`
          & > div {
            width: 100%;
          }
        `,children:(0,Fe.jsx)(ye.SegmentAsync,{className:Ce.css`
            margin-right: 0;
          `,loadOptions:r,onChange:e=>l(at({metric:a,settingName:"orderBy",newValue:e.value})),placeholder:"Select Field",value:null===(n=a.settings)||void 0===n?void 0:n.orderBy})})]})},Wt={labelWidth:16},Ht=e=>{var t,i,s,a,l,r,o;let{metric:d,previousMetrics:u}=e;const{current:c}=(0,be.useRef)((0,n.uniqueId)("es-setting-")),g=Qe(),p=(e=>{var t,i,s;switch(e.type){case"cardinality":var n;return`Precision threshold: ${(null===(n=e.settings)||void 0===n?void 0:n.precision_threshold)||""}`;case"percentiles":var a;return null!==(t=e.settings)&&void 0!==t&&t.percents&&(null===(i=e.settings)||void 0===i||null===(s=i.percents)||void 0===s?void 0:s.length)>=1?`Values: ${null===(a=e.settings)||void 0===a?void 0:a.percents}`:"Percents: Default";case"extended_stats":{const t=Object.entries(e.meta||{}).map((e=>{var t;let[i,s]=e;return s&&(null===(t=V.find((e=>t=>t.value===e)(i)))||void 0===t?void 0:t.label)})).filter(Boolean);return`Stats: ${t.length>0?t.join(", "):"None selected"}`}case"raw_document":case"raw_data":var l;return`Size: ${(null===(l=e.settings)||void 0===l?void 0:l.size)||500}`;default:return"Options"}})(d),m=bt();return(0,Fe.jsxs)($t,{label:p,hidden:d.hide,children:["derivative"===d.type&&(0,Fe.jsx)(Ct,{label:"Unit",metric:d,settingName:"unit"}),"serial_diff"===d.type&&(0,Fe.jsx)(Ct,{label:"Lag",metric:d,settingName:"lag",placeholder:"1"}),"cumulative_sum"===d.type&&(0,Fe.jsx)(Ct,{label:"Format",metric:d,settingName:"format"}),"moving_avg"===d.type&&(0,Fe.jsx)(Tt,{metric:d}),"moving_fn"===d.type&&(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(Ct,{label:"Window",metric:d,settingName:"window"}),(0,Fe.jsx)(Ct,{label:"Script",metric:d,settingName:"script"}),(0,Fe.jsx)(Ct,{label:"Shift",metric:d,settingName:"shift"})]}),"top_metrics"===d.type&&(0,Fe.jsx)(Et,{metric:d}),"bucket_script"===d.type&&(0,Fe.jsx)(Vt,{value:d,previousMetrics:u}),("raw_data"===d.type||"raw_document"===d.type)&&(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Size"},Wt,{children:(0,Fe.jsx)(ye.Input,{id:`ES-query-${m.refId}_metric-${d.id}-size`,onBlur:e=>g(at({metric:d,settingName:"size",newValue:e.target.value})),defaultValue:null!==(t=null===(i=d.settings)||void 0===i?void 0:i.size)&&void 0!==t?t:null===(s=N.raw_data.defaults.settings)||void 0===s?void 0:s.size})})),"logs"===d.type&&(0,Fe.jsx)(Ct,{label:"Limit",metric:d,settingName:"limit",placeholder:"500"}),"cardinality"===d.type&&(0,Fe.jsx)(Ct,{label:"Precision Threshold",metric:d,settingName:"precision_threshold"}),"extended_stats"===d.type&&(0,Fe.jsxs)(Fe.Fragment,{children:[V.map((e=>{var t,i,s;return(0,Fe.jsx)(Qt,{stat:e,onChange:t=>g(lt({metric:d,meta:e.value,newValue:t})),value:void 0!==(null===(t=d.meta)||void 0===t?void 0:t[e.value])?!(null===(i=d.meta)||void 0===i||!i[e.value]):!(null===(s=N.extended_stats.defaults.meta)||void 0===s||!s[e.value])},e.value)})),(0,Fe.jsx)(Ct,{label:"Sigma",metric:d,settingName:"sigma",placeholder:"3"})]}),"percentiles"===d.type&&(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Percentiles"},Wt,{children:(0,Fe.jsx)(ye.Input,{id:`${c}-percentiles-percents`,onBlur:e=>g(at({metric:d,settingName:"percents",newValue:e.target.value.split(",").filter(Boolean)})),defaultValue:(null===(a=d.settings)||void 0===a?void 0:a.percents)||(null===(l=N.percentiles.defaults.settings)||void 0===l?void 0:l.percents),placeholder:"1,5,25,50,75,95,99"})})),"rate"===d.type&&(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Unit"},Wt,{"data-testid":"unit-select",children:(0,Fe.jsx)(ye.Select,{menuShouldPortal:!0,id:`ES-query-${m.refId}_metric-${d.id}-unit`,onChange:e=>g(at({metric:d,settingName:"unit",newValue:e.value})),options:[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],value:null===(r=d.settings)||void 0===r?void 0:r.unit})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Mode"},Wt,{"data-testid":"mode-select",children:(0,Fe.jsx)(ye.Select,{menuShouldPortal:!0,id:`ES-query-${m.refId}_metric-${d.id}-mode`,onChange:e=>g(at({metric:d,settingName:"mode",newValue:e.value})),options:[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}],value:null===(o=d.settings)||void 0===o?void 0:o.unit})}))]}),O(d)&&(0,Fe.jsx)(Ct,{label:"Script",metric:d,settingName:"script",placeholder:"_value * 1"}),S(d)&&(0,Fe.jsx)(Ct,{label:"Missing",metric:d,settingName:"missing",tooltip:"The missing parameter defines how documents that are missing a value should be treated. By default they will be ignored but it is also possible to treat them as if they had a value"})]})},Qt=e=>{let{stat:t,onChange:i,value:s}=e;const[a]=(0,be.useState)((0,n.uniqueId)("es-field-id-"));return(0,be.createElement)(ye.InlineField,Object.assign({label:t.label},Wt,{key:t.value}),(0,Fe.jsx)(ye.InlineSwitch,{id:a,onChange:e=>i(e.target.checked),value:s}))},Ut=e=>!N[e.type].isPipelineAgg,Yt=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=e.some(Ut);return Object.entries(N).filter((e=>{let[i,{versionRange:s="*"}]=e;return(0,h.satisfies)(t,s)})).filter((e=>{let[t,i]=e;return s||!i.isPipelineAgg})).filter((e=>{let[t,s]=e;return!s.xpack||i})).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}}))},Gt=e=>{let{value:t}=e;const i=(s=(0,ye.useTheme2)(),{color:(n=!!t.hide)&&Ce.css`
        &,
        &:hover,
        label,
        a {
          color: ${n?s.colors.text.disabled:s.colors.text.primary};
        }
      `});var s,n;const a=yt(),l=bt(),r=Qe(),o=Rt(t.type),d=(0,be.useCallback)((async()=>{const e=await o();return O(t)?[{label:"None"},...e]:e}),[o,t]),u=l.metrics.slice(0,l.metrics.findIndex((e=>e.id===t.id)));return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsxs)(ye.InlineSegmentGroup,{children:[(0,Fe.jsx)(ye.Segment,{className:(0,Ce.cx)(i.color,Dt),options:Yt(u,a.esVersion,a.xpack),onChange:e=>r(st({id:t.id,type:e.value})),value:(c=t,{label:N[c.type].label,value:c.type})}),F(t)&&!k(t)&&(0,Fe.jsx)(ye.SegmentAsync,{className:(0,Ce.cx)(i.color,Dt),loadOptions:d,onChange:e=>r(it({id:t.id,field:e.value})),placeholder:"Select Field",value:t.field}),k(t)&&!w(t)&&(0,Fe.jsx)(It,{className:(0,Ce.cx)(i.color,Dt),onChange:e=>{var i;return r(it({id:t.id,field:null===(i=e.value)||void 0===i?void 0:i.id}))},options:u,value:t.field})]}),I(t)&&(0,Fe.jsx)(Ht,{metric:t,previousMetrics:u})]});var c},Zt=e=>{let{children:t,label:i,onRemoveClick:s,onHideClick:a,hidden:l=!1}=e;const r=(0,ye.useStyles2)(Jt);return(0,Fe.jsxs)(ye.InlineFieldRow,{children:[(0,Fe.jsx)(ye.InlineSegmentGroup,{children:(0,Fe.jsxs)(ye.InlineLabel,{width:17,as:"div",children:[(0,Fe.jsx)("span",{children:i}),(0,Fe.jsxs)("span",{className:r.iconWrapper,children:[a&&(0,Fe.jsx)(ye.IconButton,{name:l?"eye-slash":"eye",onClick:a,surface:"header",size:"sm","aria-pressed":l,"aria-label":"hide metric",className:r.icon}),(0,Fe.jsx)(ye.IconButton,{name:"trash-alt",surface:"header",size:"sm",className:r.icon,onClick:s||n.noop,disabled:!s,"aria-label":"remove metric"})]})]})}),t]})},Jt=e=>({iconWrapper:Ce.css`
      display: flex;
    `,icon:Ce.css`
      color: ${e.colors.text.secondary};
      margin-left: ${e.spacing(.25)};
    `}),Kt=e=>{let{nextId:t}=e;const i=Qe(),{metrics:s}=bt(),n=(null==s?void 0:s.length)||0;return(0,Fe.jsx)(Fe.Fragment,{children:null==s?void 0:s.map(((e,s)=>(0,Fe.jsxs)(Zt,{label:`Metric (${e.id})`,hidden:e.hide,onHideClick:()=>i(tt(e.id)),onRemoveClick:n>1&&(()=>i(et(e.id))),children:[(0,Fe.jsx)(Gt,{value:e}),!N[e.type].isSingleMetric&&0===s&&(0,Fe.jsx)(Ft,{iconName:"plus",onClick:()=>i(Xe(t)),label:"add"})]},`${e.type}-${e.id}`)))})},Xt=(0,Ue.PH)("@bucketAggregations/filter/add"),ei=(0,Ue.PH)("@bucketAggregations/filter/remove"),ti=(0,Ue.PH)("@bucketAggregations/filter/change"),ii=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return Xt.match(t)?[...e,{label:"",query:"*"}]:ei.match(t)?e.slice(0,t.payload).concat(e.slice(t.payload+1)):ti.match(t)?e.map(((e,i)=>i!==t.payload.index?e:t.payload.filter)):e},si=e=>{var t,i,s,a;let{bucketAgg:l}=e;const{current:r}=(0,be.useRef)((0,n.uniqueId)("es-filters-")),o=Qe(),d=We((e=>o(gt({bucketAgg:l,settingName:"filters",newValue:e}))),null===(t=l.settings)||void 0===t?void 0:t.filters,ii);return(0,be.useEffect)((()=>{var e,t;null!==(e=l.settings)&&void 0!==e&&null!==(t=e.filters)&&void 0!==t&&t.length||d(Xt())}),[d,null===(i=l.settings)||void 0===i||null===(s=i.filters)||void 0===s?void 0:s.length]),(0,Fe.jsx)(Fe.Fragment,{children:(0,Fe.jsx)("div",{className:Ce.css`
          display: flex;
          flex-direction: column;
        `,children:null===(a=l.settings)||void 0===a?void 0:a.filters.map(((e,t)=>{var i;return(0,Fe.jsxs)("div",{className:Ce.css`
              display: flex;
            `,children:[(0,Fe.jsx)(ye.InlineField,{label:"Query",labelWidth:8,children:(0,Fe.jsx)("div",{className:Ce.css`
                  width: 150px;
                `,children:(0,Fe.jsx)(ye.QueryField,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:i=>d(ti({index:t,filter:Object.assign({},e,{query:i})})),query:e.query})})}),(0,Fe.jsx)(ye.InlineField,{label:"Label",labelWidth:8,children:(0,Fe.jsx)(ye.Input,{width:16,id:`${r}-label-${t}`,placeholder:"Label",onBlur:i=>d(ti({index:t,filter:Object.assign({},e,{label:i.target.value})})),defaultValue:e.label})}),(0,Fe.jsx)(kt,{index:t,elements:(null===(i=l.settings)||void 0===i?void 0:i.filters)||[],onAdd:()=>d(Xt()),onRemove:()=>d(ei(t))})]},t)}))})})},ni=e=>t=>t.value===e,ai=e=>{let{options:t,value:i,onChange:s}=e;const[n,a]=(0,be.useState)(((e,t)=>{return void 0===t||e.some((i=t,e=>{let{value:t}=e;return t===i}))?e:[...e,{value:t,label:t}];var i})(t,i));return{onCreateOption:e=>{var t;t=e,a([...n,{value:t,label:t}]),s({value:e})},onChange:s,allowCustomValue:!0,options:n,value:i}},li=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],ri=(e,t,i)=>{var s;return!i.some((s=e,e=>{let{value:t}=e;return t===s}))&&e.trim().length>0},oi=(e,t)=>{var i;return(null===(i=e.value)||void 0===i?void 0:i.startsWith(t))||!1},di=e=>{var t,i,a,l,r,o,d,u,c,g;let{bucketAgg:p}=e;const m=Qe(),{current:h}=(0,be.useRef)((0,n.uniqueId)("es-date_histogram-"));return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Interval"},hi,{children:(0,Fe.jsx)(ye.Select,Object.assign({menuShouldPortal:!0,inputId:(0,n.uniqueId)("es-date_histogram-interval"),isValidNewOption:ri,filterOption:oi},ai({options:li,value:(null===(t=p.settings)||void 0===t?void 0:t.interval)||(null===(i=re.date_histogram.defaultSettings)||void 0===i?void 0:i.interval),onChange:e=>{let{value:t}=e;return m(gt({bucketAgg:p,settingName:"interval",newValue:t}))}})))})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Min Doc Count"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${h}-min_doc_count`,onBlur:e=>m(gt({bucketAgg:p,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(a=p.settings)||void 0===a?void 0:a.min_doc_count)||(null===(l=re.date_histogram.defaultSettings)||void 0===l?void 0:l.min_doc_count)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Trim Edges"},hi,{tooltip:"Trim the edges on the timeseries datapoints",children:(0,Fe.jsx)(ye.Input,{id:`${h}-trime_edges`,onBlur:e=>m(gt({bucketAgg:p,settingName:"trimEdges",newValue:e.target.value})),defaultValue:(null===(r=p.settings)||void 0===r?void 0:r.trimEdges)||(null===(o=re.date_histogram.defaultSettings)||void 0===o?void 0:o.trimEdges)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Offset"},hi,{tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day",children:(0,Fe.jsx)(ye.Input,{id:`${h}-offset`,onBlur:e=>m(gt({bucketAgg:p,settingName:"offset",newValue:e.target.value})),defaultValue:(null===(d=p.settings)||void 0===d?void 0:d.offset)||(null===(u=re.date_histogram.defaultSettings)||void 0===u?void 0:u.offset)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Timezone"},hi,{children:(0,Fe.jsx)(ye.TimeZonePicker,{value:(null===(c=p.settings)||void 0===c?void 0:c.timeZone)||(null===(g=re.date_histogram.defaultSettings)||void 0===g?void 0:g.timeZone),includeInternal:[s.InternalTimeZones.utc],onChange:e=>{m(gt({bucketAgg:p,settingName:"timeZone",newValue:e}))}})}))]})},ui=e=>{var t,i,s,a,l,r,o,d,u,c;let{bucketAgg:g}=e;const{metrics:p}=bt(),m=mi(p),{current:h}=(0,be.useRef)((0,n.uniqueId)("es-terms-")),v=Qe();return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Order"},hi,{children:(0,Fe.jsx)(ye.Select,{inputId:`${h}-order`,menuShouldPortal:!0,onChange:e=>v(gt({bucketAgg:g,settingName:"order",newValue:e.value})),options:de,value:(null===(t=g.settings)||void 0===t?void 0:t.order)||(null===(i=re.terms.defaultSettings)||void 0===i?void 0:i.order)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Size"},hi,{children:(0,Fe.jsx)(ye.Select,Object.assign({inputId:`${h}-size`,menuShouldPortal:!0},ai({options:ue,value:(null===(s=g.settings)||void 0===s?void 0:s.size)||(null===(a=re.terms.defaultSettings)||void 0===a?void 0:a.size),onChange(e){let{value:t}=e;v(gt({bucketAgg:g,settingName:"size",newValue:t}))}})))})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Min Doc Count"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${h}-min_doc_count`,onBlur:e=>v(gt({bucketAgg:g,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(l=g.settings)||void 0===l?void 0:l.min_doc_count)||(null===(r=re.terms.defaultSettings)||void 0===r?void 0:r.min_doc_count)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Order By"},hi,{children:(0,Fe.jsx)(ye.Select,{inputId:`${h}-order_by`,menuShouldPortal:!0,onChange:e=>v(gt({bucketAgg:g,settingName:"orderBy",newValue:e.value})),options:m,value:(null===(o=g.settings)||void 0===o?void 0:o.orderBy)||(null===(d=re.terms.defaultSettings)||void 0===d?void 0:d.orderBy)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Missing"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${h}-missing`,onBlur:e=>v(gt({bucketAgg:g,settingName:"missing",newValue:e.target.value})),defaultValue:(null===(u=g.settings)||void 0===u?void 0:u.missing)||(null===(c=re.terms.defaultSettings)||void 0===c?void 0:c.missing)})}))]})};function ci(e){if(!e.meta)return[];return Object.keys(e.meta).filter((t=>{var i;return null===(i=e.meta)||void 0===i?void 0:i[t]})).map((t=>{let i=t;return"std_deviation_bounds_lower"===t&&(i="std_lower"),"std_deviation_bounds_upper"===t&&(i="std_upper"),{label:`${W(e)} (${i})`,value:`${e.id}[${i}]`}}))}function gi(e){var t;return null!==(t=e.settings)&&void 0!==t&&t.percents?e.settings.percents.map((t=>{const i=/^\d+\.\d+/.test(`${t}`)?t:`${t}.0`;return{label:`${W(e)} (${t})`,value:`${e.id}[${i}]`}})):[]}function pi(e){return"top_metrics"!==e.type&&!k(e)}const mi=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const t=e.filter(pi).flatMap((e=>"extended_stats"===e.type?ci(e):"percentiles"===e.type?gi(e):{label:W(e),value:e.id}));return[...oe,...t]},hi={labelWidth:16},vi=e=>{var t,i,s,a,l,r;let{bucketAgg:o}=e;const{current:d}=(0,be.useRef)((0,n.uniqueId)("es-setting-")),u=Qe(),c=(e=>{const{metrics:t}=bt();switch(e.type){case"terms":{var i,s,n,a;const r=(null===(i=e.settings)||void 0===i?void 0:i.order)||"desc",o=(null===(s=e.settings)||void 0===s?void 0:s.size)||"10",d=parseInt((null===(n=e.settings)||void 0===n?void 0:n.min_doc_count)||"0",10),u=(null===(a=e.settings)||void 0===a?void 0:a.orderBy)||"_term";let c="";var l;if("0"!==o)c=`${null===(l=de.find(ni(r)))||void 0===l?void 0:l.label} ${o}, `;d>0&&(c+=`Min Doc Count: ${d}, `),c+="Order by: ";const g=oe.find(ni(u));if(g)c+=g.label;else{const e=null==t?void 0:t.find((e=>e.id===Q(u)));c+=e?W(e):"metric not found"}return"0"===o&&(c+=` (${r})`),c}case"histogram":{var r,o;const t=(null===(r=e.settings)||void 0===r?void 0:r.interval)||1e3,i=(null===(o=e.settings)||void 0===o?void 0:o.min_doc_count)||1;return`Interval: ${t}${i>0?`, Min Doc Count: ${i}`:""}`}case"filters":var d,u;return`Filter Queries (${((null===(d=e.settings)||void 0===d?void 0:d.filters)||(null===(u=re.filters.defaultSettings)||void 0===u?void 0:u.filters)).length})`;case"geohash_grid":var c;return`Precision: ${Math.max(Math.min(parseInt((null===(c=e.settings)||void 0===c?void 0:c.precision)||"5",10),12),1)}`;case"date_histogram":{var g,p,m;const t=(null===(g=e.settings)||void 0===g?void 0:g.interval)||"auto",i=(null===(p=e.settings)||void 0===p?void 0:p.min_doc_count)||0,s=(null===(m=e.settings)||void 0===m?void 0:m.trimEdges)||0;let n=`Interval: ${t}`;return i>0&&(n+=`, Min Doc Count: ${i}`),s>0&&(n+=`, Trim edges: ${s}`),n}default:return"Settings"}})(o);return(0,Fe.jsxs)($t,{label:c,children:["terms"===o.type&&(0,Fe.jsx)(ui,{bucketAgg:o}),"date_histogram"===o.type&&(0,Fe.jsx)(di,{bucketAgg:o}),"filters"===o.type&&(0,Fe.jsx)(si,{bucketAgg:o}),"geohash_grid"===o.type&&(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Precision"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${d}-geohash_grid-precision`,onBlur:e=>u(gt({bucketAgg:o,settingName:"precision",newValue:e.target.value})),defaultValue:(null===(t=o.settings)||void 0===t?void 0:t.precision)||(null===(i=re[o.type].defaultSettings)||void 0===i?void 0:i.precision)})})),"histogram"===o.type&&(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Interval"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${d}-histogram-interval`,onBlur:e=>u(gt({bucketAgg:o,settingName:"interval",newValue:e.target.value})),defaultValue:(null===(s=o.settings)||void 0===s?void 0:s.interval)||(null===(a=re[o.type].defaultSettings)||void 0===a?void 0:a.interval)})})),(0,Fe.jsx)(ye.InlineField,Object.assign({label:"Min Doc Count"},hi,{children:(0,Fe.jsx)(ye.Input,{id:`${d}-histogram-min_doc_count`,onBlur:e=>u(gt({bucketAgg:o,settingName:"min_doc_count",newValue:e.target.value})),defaultValue:(null===(l=o.settings)||void 0===l?void 0:l.min_doc_count)||(null===(r=re[o.type].defaultSettings)||void 0===r?void 0:r.min_doc_count)})}))]})]})},fi=Object.entries(re).map((e=>{let[t,{label:i}]=e;return{label:i,value:t}})),bi=e=>{let{value:t}=e;const i=Qe(),s=Rt(t.type);return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsxs)(ye.InlineSegmentGroup,{children:[(0,Fe.jsx)(ye.Segment,{className:Dt,options:fi,onChange:e=>i(ut({id:t.id,newType:e.value})),value:(n=t,{label:re[n.type].label,value:n.type})}),ce(t)&&(0,Fe.jsx)(ye.SegmentAsync,{className:Dt,loadOptions:s,onChange:e=>i(ct({id:t.id,newField:e.value})),placeholder:"Select Field",value:t.field})]}),(0,Fe.jsx)(vi,{bucketAgg:t})]});var n},yi=e=>{let{nextId:t}=e;const i=Qe(),{bucketAggs:s}=bt(),n=(null==s?void 0:s.length)||0;return(0,Fe.jsx)(Fe.Fragment,{children:s.map(((e,s)=>(0,Fe.jsxs)(Zt,{label:0===s?"Group By":"Then By",onRemoveClick:n>1&&(()=>i(dt(e.id))),children:[(0,Fe.jsx)(bi,{value:e}),0===s&&(0,Fe.jsx)(Ft,{iconName:"plus",onClick:()=>i(ot(t)),label:"add"})]},`${e.type}-${e.id}`)))})},xi=e=>e.id,ji=e=>parseInt(e,10);var _i;const Fi=e=>({root:Ce.css`
    display: flex;
  `,queryFieldWrapper:Ce.css`
    flex-grow: 1;
    margin: 0 ${e.spacing(.5)} ${e.spacing(.5)} 0;
  `}),ki=e=>{var t,i,s;let{value:n}=e;const a=Qe(),l=(()=>{const{metrics:e,bucketAggs:t}=bt();return(0,be.useMemo)((()=>(Math.max(...[...(null==e?void 0:e.map(xi))||["0"],...(null==t?void 0:t.map(xi))||["0"]].map(ji))+1).toString()),[e,t])})(),r=(0,ye.useStyles2)(Fi),o="date_histogram"===(null===(t=n.bucketAggs)||void 0===t||null===(i=t.slice(-1)[0])||void 0===i?void 0:i.type),d=null===(s=n.metrics)||void 0===s?void 0:s.every((e=>!N[e.type].isSingleMetric));return(0,Fe.jsxs)(Fe.Fragment,{children:[(0,Fe.jsxs)("div",{className:r.root,children:[_i||(_i=(0,Fe.jsx)(ye.InlineLabel,{width:17,children:"Query"})),(0,Fe.jsx)("div",{className:r.queryFieldWrapper,children:(0,Fe.jsx)(ye.QueryField,{query:n.query,onBlur:()=>{},onChange:e=>a(Ge(e)),placeholder:"Lucene Query",portalOrigin:"elasticsearch"})}),(0,Fe.jsx)(ye.InlineField,{label:"Alias",labelWidth:15,disabled:!o,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",children:(0,Fe.jsx)(ye.Input,{id:`ES-query-${n.refId}_alias`,placeholder:"Alias Pattern",onBlur:e=>a(Ze(e.currentTarget.value)),defaultValue:n.alias})})]}),(0,Fe.jsx)(Kt,{nextId:l}),d&&(0,Fe.jsx)(yi,{nextId:l})]})};class wi{}var Si,Ii,Oi;Oi="partials/annotations.editor.html",(Ii="templateUrl")in(Si=wi)?Object.defineProperty(Si,Ii,{value:Oi,enumerable:!0,configurable:!0,writable:!0}):Si[Ii]=Oi;const qi=new s.DataSourcePlugin(ve).setQueryEditor((e=>{let{query:t,onChange:i,onRunQuery:n,datasource:a,range:l}=e;return(0,Fe.jsx)(vt,{datasource:a,onChange:i,onRunQuery:n,query:t,range:l||(0,s.getDefaultTimeRange)(),children:(0,Fe.jsx)(ki,{value:t})})})).setConfigEditor((e=>{const{options:t,onOptionsChange:i}=e,s=xe(t);return(0,be.useEffect)((()=>{(e=>!!(0,h.valid)(e.jsonData.esVersion)&&!!e.jsonData.timeField&&!!e.jsonData.maxConcurrentShardRequests&&void 0!==e.jsonData.logMessageField&&void 0!==e.jsonData.logLevelField)(t)||i(xe(t))}),[]),(0,Fe.jsxs)(Fe.Fragment,{children:["direct"===s.access&&(ze||(ze=(0,Fe.jsx)(ye.Alert,{title:"Deprecation Notice",severity:"warning",children:"Browser access mode in the Elasticsearch datasource is deprecated and will be removed in a future release."}))),(0,Fe.jsx)(ye.DataSourceHttpSettings,{defaultUrl:"http://localhost:9200",dataSourceConfig:s,showAccessOptions:!0,onChange:i,sigV4AuthToggleEnabled:Ee.vc.sigV4AuthEnabled}),(0,Fe.jsx)(Se,{value:s,onChange:i}),(0,Fe.jsx)(Ne,{value:s.jsonData,onChange:e=>i(Object.assign({},s,{jsonData:e}))}),(0,Fe.jsx)(Re,{value:s.jsonData.dataLinks,onChange:e=>{i(Object.assign({},s,{jsonData:Object.assign({},s.jsonData,{dataLinks:e})}))}})]})})).setAnnotationQueryCtrl(wi)},"./.yarn/__virtual__/react-use-virtual-00326e70ba/3/opt/drone/yarncache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/usePrevious.js":(e,t,i)=>{i.d(t,{Z:()=>n});var s=i("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js");function n(e){var t=(0,s.useRef)();return(0,s.useEffect)((function(){t.current=e})),t.current}}}]);
//# sourceMappingURL=elasticsearchPlugin.15718e8e3083449662a7.js.map
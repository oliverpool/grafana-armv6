"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5783],{90836:(Ta,ne,c)=>{c.r(ne),c.d(ne,{plugin:()=>Sa});var De=c(7238),p=c(82897),n=c(68404),w=c(5916),Re=c(89014),C=c(49371),se=c(68698),R=c(46739),Be=c(2323),Me=c(32695),Le=c(97064),Qe=c(71210),ke=c(47694);const oe="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.";var N=(r=>(r.InfluxQL="InfluxQL",r.Flux="Flux",r))(N||{});const{Input:B,SecretFormField:le}=Re.LegacyForms,ie=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],z=[{label:"InfluxQL",value:N.InfluxQL,description:"The InfluxDB SQL-like query language."},{label:"Flux",value:N.Flux,description:"Advanced data scripting and query language.  Supported in InfluxDB 2.x and 1.8+"}];class Ve extends n.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.onResetPassword=()=>{(0,w.Mf)(this.props,"password")},this.onResetToken=()=>{(0,w.Mf)(this.props,"token")},this.onVersionChanged=t=>{const{options:a,onOptionsChange:s}=this.props,o={...a,jsonData:{...a.jsonData,version:t.value}};t.value===N.Flux&&(o.access="proxy",o.basicAuth=!0,o.jsonData.httpMode="POST",delete o.user,delete o.database),s(o)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,p.uniqueId)("influxdb-config")}renderInflux2x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:s}=this;return n.createElement(n.Fragment,null,n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{htmlFor:`${s}-org`,className:"width-10"},"Organization"),n.createElement("div",{className:"width-10"},n.createElement(B,{id:`${s}-org`,className:"width-20",value:e.jsonData.organization||"",onChange:(0,w._R)(this.props,"organization")})))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(le,{isConfigured:Boolean(t&&t.token),value:a.token||"",label:"Token","aria-label":"Token",labelWidth:10,inputWidth:20,onReset:this.onResetToken,onChange:(0,w.fi)(this.props,"token")}))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{className:"width-10"},"Default Bucket"),n.createElement("div",{className:"width-10"},n.createElement(B,{className:"width-20",placeholder:"default bucket",value:e.jsonData.defaultBucket||"",onChange:(0,w._R)(this.props,"defaultBucket")})))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),n.createElement("div",{className:"width-10"},n.createElement(B,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,w._R)(this.props,"timeInterval")})))))}renderInflux1x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:s}=this;return n.createElement(n.Fragment,null,n.createElement(se.v,null,n.createElement("h5",null,"Database Access"),n.createElement("p",null,"Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",n.createElement("code",null,"SHOW MEASUREMENTS ON _internal")," or",n.createElement("code",null,'SELECT * FROM "_internal".."database" LIMIT 10'),n.createElement("br",null),n.createElement("br",null),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB.")),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{htmlFor:`${s}-db`,className:"width-10"},"Database"),n.createElement("div",{className:"width-20"},n.createElement(B,{id:`${s}-db`,className:"width-20",value:e.database||"",onChange:(0,w.z_)(this.props,"database")})))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{htmlFor:`${s}-user`,className:"width-10"},"User"),n.createElement("div",{className:"width-10"},n.createElement(B,{id:`${s}-user`,className:"width-20",value:e.user||"",onChange:(0,w.z_)(this.props,"user")})))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(le,{isConfigured:Boolean(t&&t.password),value:a.password||"",label:"Password","aria-label":"Password",labelWidth:10,inputWidth:20,onReset:this.onResetPassword,onChange:(0,w.fi)(this.props,"password")}))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{htmlFor:`${s}-http-method`,className:"width-10",tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`},"HTTP Method"),n.createElement(R.Ph,{inputId:`${s}-http-method`,className:"width-10",value:ie.find(o=>o.value===e.jsonData.httpMode),options:ie,defaultValue:e.jsonData.httpMode,onChange:(0,w.nx)(this.props,"httpMode")}))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),n.createElement("div",{className:"width-10"},n.createElement(B,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,w._R)(this.props,"timeInterval")})))))}render(){const{options:e,onOptionsChange:t}=this.props,a=e.access==="direct";return n.createElement(n.Fragment,null,n.createElement("h3",{className:"page-heading"},"Query Language"),n.createElement("div",{className:"gf-form-group"},n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(R.Ph,{"aria-label":"Query language",className:"width-30",value:e.jsonData.version===N.Flux?z[1]:z[0],options:z,defaultValue:z[0],onChange:this.onVersionChanged})))),e.jsonData.version===N.Flux&&n.createElement(se.v,null,n.createElement("h5",null,"Support for Flux in Grafana is currently in beta"),n.createElement("p",null,"Please report any issues to: ",n.createElement("br",null),n.createElement("a",{href:"https://github.com/grafana/grafana/issues/new/choose"},"https://github.com/grafana/grafana/issues"))),a&&n.createElement(Be.b,{title:"Error",severity:"error"},oe),n.createElement(Me.E,{showAccessOptions:a,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t}),ke.vc.featureToggles.secureSocksDatasourceProxy&&n.createElement(Le.i,{options:e,onOptionsChange:t}),n.createElement("div",{className:"gf-form-group"},n.createElement("div",null,n.createElement("h3",{className:"page-heading"},"InfluxDB Details")),e.jsonData.version===N.Flux?this.renderInflux2x():this.renderInflux1x(),n.createElement("div",{className:"gf-form-inline"},n.createElement(Qe._,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000."},n.createElement(B,{placeholder:"1000",type:"number",className:"width-10",value:this.state.maxSeries,onChange:s=>{this.setState({maxSeries:s.currentTarget.value});const o=parseInt(s.currentTarget.value,10);(0,w.tp)(this.props,"maxSeries",Number.isFinite(o)?o:void 0)}})))))}}const Ge=Ve,$e=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],ze=r=>n.createElement("div",null,n.createElement("h2",null,"InfluxDB Cheat Sheet"),$e.map(e=>n.createElement("div",{className:"cheat-sheet-item",key:e.title},n.createElement("div",{className:"cheat-sheet-item__title"},e.title),n.createElement("div",{className:"cheat-sheet-item__label"},e.label))));class We extends n.PureComponent{render(){return n.createElement(ze,{onClickExample:this.props.onClickExample})}}var x=c(52423),H=c(29076),E=c(57591);const K=[],h={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function ue(r){const e=K[r.type];if(!e)throw{message:"Could not find query part "+r.type};return new E.XN(r,e)}function v(r){K[r.type]=new E.zU(r),r.category.push(K[r.type])}const Y=[];function Ue(r,e){return e+' AS "'+r.params[0]+'"'}function ce(r,e){return r.params[0]==="*"?"*":'"'+r.params[0]+'"'}function b(r,e){for(let t=0;t<r.length;t++){const a=r[t];if(a.def.category===h.Aggregations){if(a.def.type===e.def.type)return;if(a.def.type==="count"&&e.def.type==="distinct")break;if(a.def.type==="distinct"){const s=r.length>=t+2;if(e.def.type!=="count"&&s)r[t+1].def.category===h.Aggregations&&r.splice(t+1,1);else if(e.def.type==="count"){(!s||r[t+1].def.type!=="count")&&r.splice(t+1,0,e);return}}r[t]=e;return}if(a.def.category===h.Selectors){r[t]=e;return}}r.splice(1,0,e)}function F(r,e){let t;for(t=0;t<r.length;t++){const a=r[t];if(a.def.category===h.Math||a.def.category===h.Aliasing)break}r.splice(t,0,e)}function je(r,e){const t=r.length;if(t>0){if(r[t-1].def.type==="math"){r[t-1]=e;return}if(t>1&&r[t-2].def.type==="math"){r[t-2]=e;return}else if(r[t-1].def.type==="alias"){r.splice(t-1,0,e);return}}r.push(e)}function He(r,e){const t=r.length;if(t>0&&r[t-1].def.type==="alias"){r[t-1]=e;return}r.push(e)}function Ke(r,e,t){const a=(0,p.map)(r,s=>ue({type:s.def.type,params:(0,p.clone)(s.params)}));t.selectModels.push(a)}v({type:"field",addStrategy:Ke,category:h.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:ce}),v({type:"count",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"distinct",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"integral",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"mean",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"median",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"mode",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"sum",addStrategy:b,category:h.Aggregations,params:[],defaultParams:[],renderer:E.D}),v({type:"derivative",addStrategy:F,category:h.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.D}),v({type:"spread",addStrategy:F,category:h.Transformations,params:[],defaultParams:[],renderer:E.D}),v({type:"non_negative_derivative",addStrategy:F,category:h.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.D}),v({type:"difference",addStrategy:F,category:h.Transformations,params:[],defaultParams:[],renderer:E.D}),v({type:"non_negative_difference",addStrategy:F,category:h.Transformations,params:[],defaultParams:[],renderer:E.D}),v({type:"moving_average",addStrategy:F,category:h.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:E.D}),v({type:"cumulative_sum",addStrategy:F,category:h.Transformations,params:[],defaultParams:[],renderer:E.D}),v({type:"stddev",addStrategy:F,category:h.Transformations,params:[],defaultParams:[],renderer:E.D}),v({type:"time",category:Y,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:E.D}),v({type:"fill",category:Y,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:E.D}),v({type:"elapsed",addStrategy:F,category:h.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:E.D}),v({type:"holt_winters",addStrategy:F,category:h.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:E.D}),v({type:"holt_winters_with_fit",addStrategy:F,category:h.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:E.D}),v({type:"bottom",addStrategy:b,category:h.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:E.D}),v({type:"first",addStrategy:b,category:h.Selectors,params:[],defaultParams:[],renderer:E.D}),v({type:"last",addStrategy:b,category:h.Selectors,params:[],defaultParams:[],renderer:E.D}),v({type:"max",addStrategy:b,category:h.Selectors,params:[],defaultParams:[],renderer:E.D}),v({type:"min",addStrategy:b,category:h.Selectors,params:[],defaultParams:[],renderer:E.D}),v({type:"percentile",addStrategy:b,category:h.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:E.D}),v({type:"top",addStrategy:b,category:h.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:E.D}),v({type:"tag",category:Y,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:ce}),v({type:"math",addStrategy:je,category:h.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:E.C7}),v({type:"alias",addStrategy:He,category:h.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:Ue});const I={create:ue,getCategories:()=>h,replaceAggregationAdd:b};class A{constructor(e,t,a){this.selectModels=[],this.target=e,this.templateSrv=t,this.scopedVars=a,e.policy=e.policy||"default",e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,p.map)(this.target.select,e=>(0,p.map)(e,I.create)),this.groupByParts=(0,p.map)(this.target.groupBy,I.create)}updatePersistedParts(){this.target.select=(0,p.map)(this.selectModels,e=>(0,p.map)(e,t=>({type:t.def.type,params:t.params})))}hasGroupByTime(){return(0,p.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,p.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const a=t[1],s=t[2],o=I.create({type:a,params:[s]}),l=this.target.groupBy.length;l===0?this.target.groupBy.push(o.part):a==="time"?this.target.groupBy.splice(0,0,o.part):a==="tag"?this.target.groupBy[l-1].type==="fill"?this.target.groupBy.splice(l-1,0,o.part):this.target.groupBy.push(o.part):this.target.groupBy.push(o.part),this.updateProjection()}removeGroupByPart(e,t){const a=I.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,p.filter)(this.target.groupBy,s=>s.type!=="fill"),this.target.select=(0,p.map)(this.target.select,s=>(0,p.filter)(s,o=>{const l=I.create(o);return!(l.def.category===a.Aggregations||l.def.category===a.Selectors)}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if(t.def.type==="field"){if(this.selectModels.length>1){const a=(0,p.indexOf)(this.selectModels,e);this.selectModels.splice(a,1)}}else{const a=(0,p.indexOf)(e,t);e.splice(a,1)}this.updatePersistedParts()}addSelectPart(e,t){const a=I.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()}renderTagCondition(e,t,a){let s="",o=e.operator,l=e.value;return t>0&&(s=(e.condition||"AND")+" "),o||(/^\/.*\/$/.test(l)?o="=~":o="="),o!=="=~"&&o!=="!~"?(a&&(l=this.templateSrv.replace(l,this.scopedVars)),o!==">"&&o!=="<"&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'")):a&&(l=this.templateSrv.replace(l,this.scopedVars,"regex")),s+'"'+e.key+'" '+o+" "+l}getMeasurementAndPolicy(e){let t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',t!=="default"?t='"'+this.target.policy+'".':t="",t+a}interpolateQueryStr(e,t,a){return!t.multi&&!t.includeAll?e:typeof e=="string"?(0,H.yI)(e):"("+(0,p.map)(e,H.yI).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let a="SELECT ",s,o;for(s=0;s<this.selectModels.length;s++){const u=this.selectModels[s];let m="";for(o=0;o<u.length;o++)m=u[o].render(m);s>0&&(a+=", "),a+=m}a+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const l=(0,p.map)(t.tags,(u,m)=>this.renderTagCondition(u,m,e));l.length>0&&(a+="("+l.join(" ")+") AND "),a+="$timeFilter";let i="";for(s=0;s<this.groupByParts.length;s++){const u=this.groupByParts[s];s>0&&(i+=u.def.type==="fill"?" ":", "),i+=u.render("")}return i.length&&(a+=" GROUP BY "+i),t.fill&&(a+=" fill("+t.fill+")"),t.orderByTime==="DESC"&&(a+=" ORDER BY time DESC"),t.limit&&(a+=" LIMIT "+t.limit),t.slimit&&(a+=" SLIMIT "+t.slimit),t.tz&&(a+=" tz('"+t.tz+"')"),a}renderAdhocFilters(e){return(0,p.map)(e,(a,s)=>this.renderTagCondition(a,s,!0)).join(" ")}}function me(r){const e=(0,p.cloneDeep)(r);return new A(e).render(!1)}function Ye(r){if(r.policy!==void 0&&r.resultFormat!==void 0&&r.orderByTime!==void 0&&r.tags!==void 0&&r.groupBy!==void 0&&r.select!==void 0)return r;const e=(0,p.cloneDeep)(r);return new A(e).target}function Je(r,e,t){const a=(0,p.cloneDeep)(r),s=new A(a);return s.addSelectPart(s.selectModels[t],e),s.target}function qe(r,e,t){const a=(0,p.cloneDeep)(r),s=new A(a),o=s.selectModels[t];return s.removeSelectPart(o,o[e]),s.target}function Ze(r,e,t,a){const s=[...r.select??[]];return s[e]=[...s[e]],s[e][t]={...s[e][t],params:a},{...r,select:s}}function Xe(r,e){const t=(0,p.cloneDeep)(r),a=new A(t);return a.addGroupBy(e),a.target}function _e(r,e){const t=(0,p.cloneDeep)(r),a=new A(t);return a.removeGroupByPart(a.groupByParts[e],e),a.target}function et(r,e,t){const a=[...r.groupBy??[]];return a[e]={...a[e],params:t},{...r,groupBy:a}}var de=c(69934),Q=c(61723),tt=c(57172),J=c(90723),at=c(75154),q=c(29516);const rt=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class nt extends n.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e}),this.props.onRunQuery()},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate(),this.props.onRunQuery()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:Q.k.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:Q.k.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:Q.k.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:Q.k.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:Q.k.Property,detail:"org configured for the datsource"}],t=(0,de.J)();return t.getVariables().forEach(a=>{const s="${"+a.name+"}";let o=t.replace(s);o===s&&(o=""),e.push({label:s,kind:Q.k.Text,detail:`(Template Variable) ${o}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:t}=this.props,a=st(t),s=n.createElement("div",null,"Type: ",n.createElement("i",null,"ctrl+space")," to show template variable suggestions ",n.createElement("br",null),"Many queries can be copied from Chronograf");return n.createElement(n.Fragment,null,n.createElement(tt.p,{height:"100%",containerStyles:a.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),n.createElement("div",{className:(0,x.cx)("gf-form-inline",a.editorActions)},n.createElement(J.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/"},"Flux language syntax"),n.createElement(at.X,{options:rt,value:"Sample Query",onChange:this.onSampleChange}),n.createElement("div",{className:"gf-form gf-form--grow"},n.createElement("div",{className:"gf-form-label gf-form-label--grow"})),n.createElement(C.c,{width:5,tooltip:s},"Help")))}}const st=r=>({editorContainerStyles:x.css`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${r.isDark?r.colors.background.canvas:r.colors.background.primary};
    padding-bottom: ${r.spacing(1)};
  `,editorActions:x.css`
    margin-top: 6px;
  `}),Z=(0,q.HE)(nt);var ot=c(81202);const lt=({isRaw:r,onChange:e})=>{const[t,a]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{a(!1)},[r]),r?n.createElement(n.Fragment,null,n.createElement(J.zx,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{a(!0)}}),n.createElement(ot.s,{isOpen:t,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{a(!1)}})):n.createElement(J.zx,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var pe=c(79090),it=c(90701),O=c(25474);const ge=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],fe="time_series";var ut=c(54291);function W(r){const[e,t]=(0,n.useState)(r),a=(0,ut.Z)(r);return(0,n.useEffect)(()=>{a!==r&&e!==r&&t(r)},[r,e,a]),[e,t]}var X=c(56991);const ct=({query:r,onChange:e,onRunQuery:t})=>{const[a,s]=W(r.query),[o,l]=W(r.alias),i=(0,X.L)(),u=(0,X.L)(),m=r.resultFormat??fe,d=()=>{e({...r,query:a,alias:o,resultFormat:m}),t()};return n.createElement("div",null,n.createElement(pe.K,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:d,onChange:y=>{s(y.currentTarget.value)},value:a??""}),n.createElement(it.Lh,null,n.createElement(C.c,{htmlFor:u},"Format as"),n.createElement(R.Ph,{inputId:u,onChange:y=>{e({...r,resultFormat:y.value}),t()},value:m,options:ge}),n.createElement(C.c,{htmlFor:i},"Alias by"),n.createElement(O.I,{id:i,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:d,onChange:y=>{l(y.currentTarget.value)},value:o??""})))};var k=c(95539),V=c(91605);function mt(r,e){let t="",a=r.operator,s=r.value;return e>0&&(t=(r.condition||"AND")+" "),a||(/^\/.*\/$/.test(r.value)?a="=~":a="="),(s===""||a!=="=~"&&a!=="!~")&&(s="'"+s.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),t+'"'+r.key+'" '+a+" "+s}class _{constructor(e,t){this.target=e,this.database=t}buildExploreQuery(e,t,a){let s="",o,l;if(e==="TAG_KEYS")s="SHOW TAG KEYS",o=this.target.measurement,l=this.target.policy;else if(e==="TAG_VALUES")s="SHOW TAG VALUES",o=this.target.measurement,l=this.target.policy;else if(e==="MEASUREMENTS")s="SHOW MEASUREMENTS",a&&(s+=" WITH MEASUREMENT =~ /(?i)"+(0,H.yI)(a)+"/");else{if(e==="FIELDS")return o=this.target.measurement,l=this.target.policy,o.match("^/.*/")||(o='"'+o+'"',l&&l!=="default"&&(l='"'+l+'"',o=l+"."+o)),"SHOW FIELD KEYS FROM "+o;if(e==="RETENTION POLICIES")return s='SHOW RETENTION POLICIES on "'+this.database+'"',s}if(o&&(!o.match("^/.*/")&&!o.match(/^merge\(.*\)/)&&(o='"'+o+'"'),l&&l!=="default"&&(l='"'+l+'"',o=l+"."+o),s+=" FROM "+o),t&&(s+=' WITH KEY = "'+t+'"'),this.target.tags&&this.target.tags.length>0){const i=(0,p.reduce)(this.target.tags,(u,m)=>(m.key===t||m.operator===">"||m.operator==="<"||u.push(mt(m,u.length)),u),[]);i.length>0&&(s+=" WHERE "+i.join(" "))}return e==="MEASUREMENTS"&&(s+=" LIMIT 100"),s}}const G=(r,e,t,a,s)=>{const l=new _(a,s.database).buildExploreQuery(r,e,t),i={policy:a.policy};return s.metricFindQuery(l,i)};async function dt(r){return(await G("RETENTION POLICIES",void 0,void 0,{tags:[],measurement:void 0,policy:void 0},r)).map(a=>a.text)}async function pt(r,e,t){return(await G("MEASUREMENTS",void 0,r,{tags:e,measurement:void 0,policy:void 0},t)).map(o=>o.text)}async function he(r,e,t,a){return(await G("TAG_KEYS",void 0,void 0,{tags:t,measurement:r,policy:e},a)).map(l=>l.text)}async function gt(r,e,t,a,s){return(await G("TAG_VALUES",r,void 0,{tags:a,measurement:e,policy:t},s)).map(i=>i.text)}async function ft(r,e,t){return(await G("FIELDS",void 0,void 0,{tags:[],measurement:r,policy:e},t)).map(o=>o.text)}const ee=(0,x.css)({paddingRight:"4px"});function $(r){if(r==null)throw new Error("value must not be nullish");return r}const ht=(0,x.cx)("width-8",ee),yt=({format:r,inputId:e,onChange:t})=>n.createElement(R.Ph,{inputId:e,className:ht,onChange:a=>{t($(a.value))},value:r,options:ge});var vt=c(99151),Et=c.n(vt),St=c(671);const ye=(0,x.css)({minWidth:"160px"}),ve=r=>r,xt=({loadOptions:r,allowCustomValue:e,onChange:t,onClose:a})=>{const s=Et()(r,1e3,{leading:!0});return n.createElement("div",{className:ye},n.createElement(R.qb,{formatCreateLabel:ve,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:a,allowCustomValue:e,loadOptions:s,onChange:t,createOptionPosition:"first"}))},Ct=({loadOptions:r,allowCustomValue:e,onChange:t,onClose:a})=>{const[s,o]=(0,St.Z)(r,[r]);return(0,n.useEffect)(()=>{o("")},[o,r]),n.createElement("div",{className:ye},n.createElement(R.Ph,{isLoading:s.loading,formatCreateLabel:ve,autoFocus:!0,isOpen:!s.loading,onCloseMenu:a,allowCustomValue:e,options:s.value??[],onChange:t,createOptionPosition:"first"}))},bt=({loadOptions:r,filterByLoadOptions:e,allowCustomValue:t,onChange:a,onClose:s})=>e?n.createElement(xt,{loadOptions:r,allowCustomValue:t,onChange:a,onClose:s}):n.createElement(Ct,{loadOptions:r,allowCustomValue:t,onChange:a,onClose:s}),Tt=({initialValue:r,onChange:e,onClose:t})=>{const[a,s]=W(r);return n.createElement(O.I,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:t,onKeyDown:o=>{o.key==="Enter"&&e(a)},onChange:o=>{s(o.currentTarget.value)},value:a})},wt=(0,x.css)({width:"auto",cursor:"pointer"}),D=({value:r,buttonClassName:e,loadOptions:t,filterByLoadOptions:a,allowCustomValue:s,onChange:o})=>{const[l,i]=(0,n.useState)(!1);if(l)return t!==void 0?n.createElement(bt,{loadOptions:t,filterByLoadOptions:a??!1,allowCustomValue:s,onChange:u=>{i(!1),o(u)},onClose:()=>{i(!1)}}):n.createElement(Tt,{initialValue:r,onClose:()=>{i(!1)},onChange:u=>{i(!1),o({value:u,label:u})}});{const u=(0,x.cx)(wt,e);return n.createElement(V.W,{as:"button",className:u,onClick:()=>{i(!0)}},r)}};function P(r){return{label:r,value:r}}const Pt="default",Ft=({policy:r,measurement:e,onChange:t,getPolicyOptions:a,getMeasurementOptions:s})=>{const o=async()=>{const i=await a();return(i.some(m=>m==="default")?i:[Pt,...i]).map(P)},l=async i=>(await s(i)).map(P);return n.createElement(n.Fragment,null,n.createElement(D,{allowCustomValue:!0,value:r??"using default policy",loadOptions:o,onChange:i=>{t(i.value,e)}}),n.createElement(D,{allowCustomValue:!0,value:e??"select measurement",loadOptions:l,filterByLoadOptions:!0,onChange:i=>{t(r,i.value)}}))},U=({value:r,onChange:e,isWide:t,placeholder:a})=>{const[s,o]=W(r),l=()=>{e(s===""?void 0:s)};return n.createElement(n.Fragment,null,n.createElement(O.I,{placeholder:a,className:(0,x.cx)(t??!1?"width-14":"width-8",ee),type:"text",spellCheck:!1,onBlur:l,onChange:i=>{o(i.currentTarget.value)},value:s??""}))},Nt=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],It=(0,x.cx)("width-9",ee),At=({value:r,onChange:e,inputId:t})=>n.createElement(n.Fragment,null,n.createElement(R.Ph,{inputId:t,className:It,onChange:a=>{e($(a.value))},value:r,options:Nt}));var Ot=c(75182),Dt=c(87302),Rt=c(40304);const Ee=({loadOptions:r,allowCustomValue:e,onAdd:t})=>n.createElement(D,{value:"+",loadOptions:r,allowCustomValue:e,onChange:a=>{t($(a.value))}}),Bt=r=>n.createElement(Ot.k,{label:""},n.createElement(Dt.s,{label:"remove",onClick:r})),Mt=(0,x.css)({paddingRight:"0",marginRight:"0"}),Lt=({name:r,onRemove:e})=>n.createElement(Rt.z,{renderMenuItems:()=>Bt(e)},({openMenu:t})=>n.createElement("button",{className:(0,x.cx)("gf-form-label",Mt),onClick:t},r)),Qt=(0,x.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),kt=r=>(0,x.cx)("gf-form-label",(0,x.css)({paddingLeft:"0",lineHeight:r.typography.body.lineHeight,fontSize:r.typography.body.fontSize})),Vt=({name:r,params:e,onChange:t,onRemove:a})=>{const s=(0,q.l4)(),o=(0,n.useMemo)(()=>kt(s),[s]),l=(i,u)=>{const m=e.map(d=>d.value);m[u]=i,t(m)};return n.createElement("div",{className:o},n.createElement(Lt,{name:r,onRemove:a}),"(",e.map((i,u)=>{const{value:m,options:d}=i,y=u===e.length-1,S=d!==null?()=>d().then(f=>f.map(P)):void 0;return n.createElement(n.Fragment,{key:u},n.createElement(D,{allowCustomValue:!0,value:m,buttonClassName:Qt,loadOptions:S,onChange:f=>{l($(f.value),u)}}),!y&&",")}),")")},Se=({parts:r,getNewPartOptions:e,onAddNewPart:t,onRemovePart:a,onChange:s})=>n.createElement(n.Fragment,null,r.map((o,l)=>n.createElement(Vt,{key:l,name:o.name,params:o.params,onRemove:()=>{a(l)},onChange:i=>{s(l,i)}})),n.createElement(Ee,{loadOptions:e,onAdd:t}));function xe(r){return/^\/.*\/$/.test(r)}function Ce(r){return r.operator??(xe(r.value)?"=~":"=")}function be(r,e){return e?void 0:r.condition??"AND"}function Gt(r,e){const t=r==="=~"||r==="!~";return xe(e)?t?r:"=~":t?"=":r}const $t=["=","!=","<>","<",">","=~","!~"],zt=["AND","OR"],Wt=$t.map(P),Ut=zt.map(P),jt=()=>Promise.resolve(Ut),Ht=()=>Promise.resolve(Wt),Kt=({tag:r,isFirst:e,onRemove:t,onChange:a,getTagKeyOptions:s,getTagValueOptions:o})=>{const l=Ce(r),i=be(r,e),u=()=>s().catch(d=>(console.error(d),[])).then(d=>[{label:"-- remove filter --",value:void 0},...d.map(P)]),m=()=>o(r.key).then(d=>d.map(P));return n.createElement("div",{className:"gf-form"},i!=null&&n.createElement(D,{value:i,loadOptions:jt,onChange:d=>{a({...r,condition:d.value})}}),n.createElement(D,{allowCustomValue:!0,value:r.key,loadOptions:u,onChange:d=>{const{value:y}=d;y===void 0?t():a({...r,key:y??""})}}),n.createElement(D,{value:l,loadOptions:Ht,onChange:d=>{a({...r,operator:d.value})}}),n.createElement(D,{allowCustomValue:!0,value:r.value,loadOptions:m,onChange:d=>{const y=d.value??"";a({...r,value:y,operator:Gt(l,y)})}}))},Yt=({tags:r,onChange:e,getTagKeyOptions:t,getTagValueOptions:a})=>{const s=(u,m)=>{const d=r.map((y,S)=>m===S?u:y);e(d)},o=u=>{const m=r.filter((d,y)=>y!==u);e(m)},l=()=>t().then(u=>u.map(P)),i=(u,m)=>{const d={key:u,value:"select tag value"},y={key:d.key,value:d.value,operator:Ce(d),condition:be(d,m)};e([...r,y])};return n.createElement(n.Fragment,null,r.map((u,m)=>n.createElement(Kt,{tag:u,isFirst:m===0,key:m,onChange:d=>{s(d,m)},onRemove:()=>{o(m)},getTagKeyOptions:t,getTagValueOptions:a})),n.createElement(Ee,{allowCustomValue:!0,loadOptions:l,onAdd:u=>{i(u,r.length===0)}}))};function Jt(){const r=I.getCategories(),e=[];return Object.keys(r).forEach(a=>{const s=r[a].map(o=>P(o.type));e.push({label:a,options:s})}),e}async function qt(r,e){const t=await e(),a={...r},s=new A(a),o=[];return s.hasFill()||o.push(P("fill(null)")),s.hasGroupByTime()||o.push(P("time($interval)")),t.forEach(l=>{o.push(P(`tag(${l})`))}),o}function Zt(r,e){const t=I.create(r).def,a=(r.params??[]).map(s=>s.toString());if(a.length!==t.params.length)throw new Error("Invalid query-segment");return a.map((s,o)=>{const l=t.params[o];return l.dynamicLookup?{value:s,options:$(e.get(`${t.type}_${o}`))}:l.options!=null?{value:s,options:()=>Promise.resolve(l.options)}:{value:s,options:null}})}function Te(r,e){return r.map(t=>({name:t.type,params:Zt(t,e)}))}function Xt(){return(0,de.J)().getVariables().map(r=>`/^$${r.name}$/`)}function we(r,e){let t=Xt();return e&&(t=t.filter(a=>a.indexOf(e)>-1)),r.then(a=>[...t,...a])}function te(r,e){return r.filter(t=>e.has(t.key))}const _t=r=>{const e=(0,X.L)(),t=`influxdb-qe-format-as-${e}`,a=`influxdb-qe-order-by${e}`,s=(0,q.wW)(ea),o=Ye(r.query),{datasource:l}=r,{measurement:i,policy:u}=o,m=(0,n.useMemo)(()=>he(i,u,[],l).then(g=>new Set(g)),[i,u,l]),d=(0,n.useMemo)(()=>{const g=new Map([["field_0",()=>i!==void 0?ft(i,u,l):Promise.resolve([])]]);return(o.select??[]).map(T=>Te(T,g))},[i,u,o.select,l]),y=(0,n.useMemo)(()=>()=>m.then(g=>he(i,u,te(o.tags??[],g),l)),[i,u,o.tags,l,m]),S=(0,n.useMemo)(()=>{const g=new Map([["tag_0",y]]);return Te(o.groupBy??[],g)},[y,o.groupBy]),f=g=>{r.onChange(g),r.onRunQuery()},M=(g,T)=>{f({...o,policy:g,measurement:T})},xa=g=>{f({...o,tags:g.length===0?void 0:g})};return n.createElement("div",null,n.createElement(k.f,{label:"FROM",fill:!0},n.createElement(Ft,{policy:u,measurement:i,getPolicyOptions:()=>dt(l),getMeasurementOptions:g=>we(m.then(T=>pt(g===""?void 0:g,te(o.tags??[],T),l)),g),onChange:M}),n.createElement(V.W,{width:"auto",className:s.inlineLabel},"WHERE"),n.createElement(Yt,{tags:o.tags??[],onChange:xa,getTagKeyOptions:y,getTagValueOptions:g=>we(m.then(T=>gt(g,i,u,te(o.tags??[],T),l)))})),d.map((g,T)=>n.createElement(k.f,{key:T,label:T===0?"SELECT":"",fill:!0},n.createElement(Se,{parts:g,getNewPartOptions:()=>Promise.resolve(Jt()),onChange:(L,Ca)=>{const ba=Ze(o,T,L,Ca);f(ba)},onAddNewPart:L=>{f(Je(o,L,T))},onRemovePart:L=>{f(qe(o,L,T))}}))),n.createElement(k.f,{label:"GROUP BY",fill:!0},n.createElement(Se,{parts:S,getNewPartOptions:()=>qt(o,y),onChange:(g,T)=>{const L=et(o,g,T);f(L)},onAddNewPart:g=>{f(Xe(o,g))},onRemovePart:g=>{f(_e(o,g))}})),n.createElement(k.f,{label:"TIMEZONE",fill:!0},n.createElement(U,{placeholder:"(optional)",value:o.tz,onChange:g=>{f({...o,tz:g})}}),n.createElement(V.W,{htmlFor:a,width:"auto",className:s.inlineLabel},"ORDER BY TIME"),n.createElement(At,{inputId:a,value:o.orderByTime==="DESC"?"DESC":"ASC",onChange:g=>{f({...o,orderByTime:g})}})),n.createElement(k.f,{label:"LIMIT",fill:!0},n.createElement(U,{placeholder:"(optional)",value:o.limit?.toString(),onChange:g=>{f({...o,limit:g})}}),n.createElement(V.W,{width:"auto",className:s.inlineLabel},"SLIMIT"),n.createElement(U,{placeholder:"(optional)",value:o.slimit?.toString(),onChange:g=>{f({...o,slimit:g})}})),n.createElement(k.f,{htmlFor:t,label:"FORMAT AS",fill:!0},n.createElement(yt,{inputId:t,format:o.resultFormat??fe,onChange:g=>{f({...o,resultFormat:g})}}),o.resultFormat!=="table"&&n.createElement(n.Fragment,null,n.createElement(V.W,{width:"auto",className:s.inlineLabel},"ALIAS"),n.createElement(U,{isWide:!0,placeholder:"Naming pattern",value:o.alias,onChange:g=>{f({...o,alias:g})}}))))};function ea(r){return{inlineLabel:x.css`
      color: ${r.colors.primary.text};
    `}}const ta=({query:r,onChange:e,onRunQuery:t,datasource:a,range:s,data:o})=>a.isFlux?n.createElement("div",{className:"gf-form-query-content"},n.createElement(Z,{query:r,onChange:e,onRunQuery:t,datasource:a})):n.createElement("div",{className:(0,x.css)({display:"flex"})},n.createElement("div",{className:(0,x.css)({flexGrow:1})},r.rawQuery?n.createElement(ct,{query:r,onChange:e,onRunQuery:t}):n.createElement(_t,{query:r,onChange:e,onRunQuery:t,datasource:a})),n.createElement(lt,{isRaw:r.rawQuery??!1,onChange:l=>{e({...r,query:me(r),rawQuery:l}),t()}}));class aa extends n.PureComponent{constructor(){super(...arguments),this.onRefresh=()=>{}}render(){let{query:e,datasource:t,onChange:a}=this.props;return t.isFlux?n.createElement(Z,{datasource:t,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:s=>a(s.query)}):n.createElement("div",{className:"gf-form-inline"},n.createElement(C.c,{width:10},"Query"),n.createElement("div",{className:"gf-form-inline gf-form--grow"},n.createElement(pe.K,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:s=>a(s.currentTarget.value)})))}}var Pe=c(37537),ra=c(46060),na=c(16313),ae=c(3363),Fe=c(53786),re=c(2101),sa=c(94514),oa=c(16911),la=c(21053),ia=c(9800),Ne=c(47214),Ie=c(88635),ua=c(98639);const ca=r=>{const{query:e,onChange:t}=r,[a,s]=(0,n.useState)(e.query??""),[o,l]=(0,n.useState)(e.textColumn??""),[i,u]=(0,n.useState)(e.tagsColumn??""),[m,d]=(0,n.useState)(e?.timeEndColumn??""),[y]=(0,n.useState)(e?.titleColumn??""),S=(f,M)=>{t({...e,[f]:M,fromAnnotations:!0,textEditor:!0})};return n.createElement("div",{className:"gf-form-group"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{width:12},"InfluxQL Query"),n.createElement(O.I,{value:a,onChange:f=>s(f.currentTarget.value??""),onBlur:()=>S("query",a),placeholder:"select text from events where $timeFilter limit 1000"})),n.createElement(C.c,{width:12,tooltip:n.createElement("div",null,"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage.")},"Field mappings"),n.createElement("div",{className:"gf-form-group"},n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(C.c,{width:12},"Text"),n.createElement(O.I,{value:o,onChange:f=>l(f.currentTarget.value??""),onBlur:()=>S("textColumn",o)})),n.createElement("div",{className:"gf-form"},n.createElement(C.c,{width:12},"Tags"),n.createElement(O.I,{value:i,onChange:f=>u(f.currentTarget.value??""),onBlur:()=>S("tagsColumn",i)})),n.createElement("div",{className:"gf-form"},n.createElement(C.c,{width:12},"TimeEnd"),n.createElement(O.I,{value:m,onChange:f=>d(f.currentTarget.value??""),onBlur:()=>S("timeEndColumn",m)})),n.createElement("div",{className:"gf-form ng-hide"},n.createElement(C.c,{width:12},"Title"),n.createElement(O.I,{defaultValue:y})))))},ma=r=>({query:r.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:r.tagsColumn??"",textColumn:r.textColumn??"",timeEndColumn:r.timeEndColumn??"",titleColumn:r.titleColumn??"",name:r.name??""}),da=r=>(r.target=r.target??ma(r),r);var pa=c(14582),ga=c(37219);class fa{parse(e,t){if(!t?.results||t.results.length===0)return[];const a=t.results[0];if(!a.series)return[];const s=e.toLowerCase(),o=s.indexOf("show field keys")>=0||s.indexOf("show retention policies")>=0,l=new Set;return(0,p.each)(a.series,i=>{(0,p.each)(i.values,u=>{(0,p.isArray)(u)?o?j(l,u[0]):u[1]!==void 0?j(l,u[1]):j(l,u[0]):j(l,u)})}),Array.from(l).map(i=>({text:i}))}getTable(e,t,a){let s=new ga.Z;if(e.length>0)if(s.meta={...a,executedQueryString:e[0].meta?.executedQueryString},s.refId=t.refId,s=ya(e,s,t),e[0].fields[1]&&e[0].fields[1].labels){let o=(0,p.groupBy)(e,i=>i.fields[1].labels?Object.values(i.fields[1].labels):null);const l=Object.keys(o);o=Object.values(o);for(let i=0;i<o.length;i++)s=Ae(o[i],s,[...l[i].split(",")])}else s=Ae(e,s,[]);return s}async transformAnnotationResponse(e,t,a){const s=(0,Ie.z1)(t,[a]);if(s){const o=this.getTable(s.data,a,{}),l=[];let i=null,u=null,m=null;const d=[];let y=null;return(0,p.each)(o.columns,(S,f)=>{if(S.text.toLowerCase()==="time"){u=f;return}if(S.text===e.titleColumn){i=f;return}if(ha(S.text,e.tagsColumn)){d.push(f);return}if(S.text.includes(e.textColumn)){y=f;return}if(S.text===e.timeEndColumn){m=f;return}!i&&y!==f&&(i=f)}),(0,p.each)(o.rows,S=>{const f={annotation:e,time:+new Date(S[u]),title:S[i],timeEnd:S[m],tags:(0,p.flatten)(d.filter(M=>S[M]).map(M=>S[M].split(","))),text:S[y]};l.push(f)}),l}return[]}}function ha(r,e){const t=(e||"").replace(" ","").split(",");for(const a of t)if(r.includes(a))return!0;return!1}function ya(r,e,t){const a=va(t);r[0].fields.forEach(s=>{s.name==="time"?e.columns.push({text:"Time",type:pa.fS.time}):s.name==="value"&&s.labels&&Object.keys(s.labels).forEach(o=>{e.columns.push({text:o})})}),r[0].refId==="metricFindQuery"&&r.forEach(s=>{s.name&&e.columns.push({text:s.name})});for(let s=0;s<a.length;s++)e.columns.push({text:a[s]});return e}function Ae(r,e,t){const a=r[0].fields[0].values.toArray();for(let s=0;s<a.length;s++){const o=a[s],l=r.map(i=>i.fields[1]?i.fields[1].values.toArray()[s]:null);l.indexOf(null)<0&&e.rows.push([o,...t,...l])}return e}function va(r){let e=[];r.select?.forEach(a=>{const s=a.filter(o=>o.type!=="field");s.length>0?e.push(s[0].type):a[0]&&a[0].params&&a[0].params[0]&&e.push(a[0].params[0].toString())});let t=[];return e.forEach(a=>{t.push(Oe(a,a,t,0))}),t}function Oe(r,e,t,a){return t.indexOf(e)>-1?(a++,Oe(r,r+"_"+a,t,a)):e}function j(r,e){r.add(e.toString())}class Ea extends ia.CK{constructor(e,t=(0,ua.J)()){super(e),this.templateSrv=t,this.type="influxdb",this.urls=(e.url??"").split(",").map(s=>s.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.database=e.database,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const a=e.jsonData||{};this.interval=a.timeInterval,this.httpMode=a.httpMode||"GET",this.responseParser=new fa,this.isFlux=a.version===N.Flux,this.isProxyAccess=e.access==="proxy",this.isFlux?this.annotations={QueryEditor:Z}:this.annotations={QueryEditor:ca,prepareAnnotation:da}}query(e){if(!this.isProxyAccess){const a=new Error(oe);return(0,Pe._)(()=>a)}const t={...e,targets:e.targets.filter(a=>a.hide!==!0)};if(this.isFlux)return super.query(t);if(t.targets.some(a=>a.fromAnnotations)){const a=[];for(const s of t.targets)s.query&&a.push(new ra.y(o=>{this.annotationEvents(t,s).then(l=>o.next({data:[(0,oa.g0)(l)]})).catch(l=>o.error(new Error(l))).finally(()=>o.complete())}));return(0,na.T)(...a)}return super.query(t).pipe((0,re.U)(a=>{if(a.error)throw{message:"InfluxDB Error: "+a.error.message,res:a};const s=[],o=(0,p.groupBy)(a.data,l=>l.refId);return Object.keys(o).length>0&&t.targets.forEach(l=>{const i=o[l.refId]??[];switch(l.resultFormat){case"logs":case"table":s.push(this.responseParser.getTable(i,l,{preferredVisualisationType:l.resultFormat}));break;default:{for(let u=0;u<i.length;u++)s.push(i[u]);break}}}),{data:s}}))}getQueryDisplayText(e){return this.isFlux?e.query:new A(e).render(!1)}filterQuery(e){return this.isFlux?!!e.query:!0}applyTemplateVariables(e,t){const{__interval:a,__interval_ms:s,...o}=t;return this.isFlux?{...e,query:this.templateSrv.replace(e.query??"",o)}:(e=this.applyVariables(e,t,o),e)}async annotationEvents(e,t){if(this.isFlux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!t.query)return Promise.reject({message:"Query missing in annotation definition"});const a={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(t.query,void 0,"regex"),rawQuery:!0};return(0,ae.n)((0,Ne.i)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[a]},requestId:t.name}).pipe((0,re.U)(async s=>await this.responseParser.transformAnnotationResponse(t,s,a))))}targetContainsTemplate(e){const t=this.isFlux?e.query:me(e);return this.templateSrv.containsTemplate(t)}interpolateVariablesInQueries(e,t){return!e||e.length===0?[]:e.map(a=>this.isFlux?{...a,datasource:this.getRef(),query:this.templateSrv.replace(a.query??"",t,"regex")}:{...a,datasource:this.getRef(),...this.applyVariables(a,t,t)})}applyVariables(e,t,a){const s={...e};return e.groupBy&&(s.groupBy=e.groupBy.map(o=>({...o,params:o.params?.map(l=>this.templateSrv.replace(l.toString(),void 0,"regex"))}))),e.select&&(s.select=e.select.map(o=>o.map(l=>({...l,params:l.params?.map(i=>this.templateSrv.replace(i.toString(),void 0,"regex"))})))),e.tags&&(s.tags=e.tags.map(o=>({...o,value:this.templateSrv.replace(o.value,t,"regex")}))),{...s,adhocFilters:this.templateSrv.getAdhocFilters(this.name)??[],query:this.templateSrv.replace(e.query??"",a,"regex"),alias:this.templateSrv.replace(e.alias??"",t),limit:this.templateSrv.replace(e.limit?.toString()??"",t,"regex"),measurement:this.templateSrv.replace(e.measurement??"",t,"regex"),policy:this.templateSrv.replace(e.policy??"",t,"regex"),slimit:this.templateSrv.replace(e.slimit?.toString()??"",t,"regex"),tz:this.templateSrv.replace(e.tz??"",t)}}async metricFindQuery(e,t){if(this.isFlux){const s={refId:"metricFindQuery",query:e,rawQuery:!0};return(0,ae.n)(super.query({...t,targets:[s]})).then(o=>o.data?.length?(0,Ie.S9)(o.data[0]):[])}const a=this.templateSrv.replace(e,void 0,"regex");return(0,ae.n)(this._seriesQuery(a,t)).then(s=>this.responseParser.parse(e,s))}getTagKeys(e={}){const a=new _({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(a,e)}getTagValues(e={}){const a=new _({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(a,e)}_seriesQuery(e,t){if(!e)return(0,Fe.of)({results:[]});if(t&&t.range){const a=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",a)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,p.reduce)(e,(t,a,s)=>(a==null||t.push(encodeURIComponent(s)+"="+encodeURIComponent(a)),t),[]).join("&"):""}_influxRequest(e,t,a,s){const o=this.urls.shift();this.urls.push(o);const l={};this.username&&(l.u=this.username,l.p=this.password),s&&s.database?l.db=s.database:this.database&&(l.db=this.database),s?.policy&&(l.rp=s.policy);const{q:i}=a;e==="POST"&&(0,p.has)(a,"q")?((0,p.extend)(l,(0,p.omit)(a,["q"])),a=this.serializeParams((0,p.pick)(a,["q"]))):(e==="GET"||e==="POST")&&((0,p.extend)(l,a),a=null);const u={method:e,url:o+t,params:l,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,Ne.i)().fetch(u).pipe((0,re.U)(m=>{const{data:d}=m;if(d&&(d.executedQueryString=i,d.results)){const y=m.data.results.filter(S=>S.error);if(y.length>0)throw{message:"InfluxDB Error: "+y[0].error,data:d}}return d}),(0,sa.K)(m=>m.cancelled?(0,Fe.of)(m):(0,Pe._)(this.handleErrors(m))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){const t=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),a=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+t+" and time <= "+a}getInfluxTime(e,t,a){if((0,p.isString)(e)){if(e==="now")return"now()";const s=/^now-(\d+)([dhms])$/.exec(e);if(s){const o=parseInt(s[1],10),l=s[2];return"now() - "+o+l}e=la.parse(e,t,a)}return e.valueOf()+"ms"}}const Sa=new De.hf(Ea).setConfigEditor(Ge).setQueryEditor(ta).setVariableQueryEditor(aa).setQueryEditorHelp(We)}}]);

//# sourceMappingURL=influxdbPlugin.5f7b168db31ace79657b.js.map
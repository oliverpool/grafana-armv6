"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1828],{"./public/app/plugins/datasource/loki/components/LokiQueryField.tsx":(e,t,s)=>{s.d(t,{n:()=>k});var a,l,i,n,o=s("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),r=s("./packages/grafana-ui/src/index.ts"),c=s("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),d=s("./.yarn/__virtual__/react-window-virtual-0f9a8c6a67/3/opt/drone/yarncache/react-window-npm-1.8.6-4f5a230226-54ccf2b16c.zip/node_modules/react-window/dist/index.esm.js"),h=s("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),u=s("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");function g(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const p=1e3,b=1e4,m=4,v="{}";function f(e){const t=[];for(const s of e)if(s.selected&&s.values&&s.values.length>0){const e=s.values.filter((e=>e.selected)).map((e=>e.name));e.length>1?t.push(`${s.name}=~"${e.join("|")}"`):1===e.length&&t.push(`${s.name}="${e[0]}"`)}return["{",t.join(","),"}"].join("")}class x extends o.Component{constructor(){super(...arguments),g(this,"state",{labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""}),g(this,"onChangeSearch",(e=>{this.setState({searchTerm:e.target.value})})),g(this,"onClickRunLogsQuery",(()=>{const e=f(this.state.labels);this.props.onChange(e)})),g(this,"onClickRunMetricsQuery",(()=>{const e=`rate(${f(this.state.labels)}[$__interval])`;this.props.onChange(e)})),g(this,"onClickClear",(()=>{this.setState((e=>({labels:e.labels.map((e=>Object.assign({},e,{values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0}))),searchTerm:"",status:"",error:"",validationStatus:""}))),this.props.deleteLastUsedLabels()})),g(this,"onClickLabel",((e,t,s)=>{const a=this.state.labels.find((t=>t.name===e));if(!a)return;const l=!a.selected;let i={selected:l};if(a.values&&!l){const e=a.values.map((e=>Object.assign({},e,{selected:!1})));i=Object.assign({},i,{facets:0,values:e})}this.setState({searchTerm:""}),this.updateLabelState(e,i,"",(()=>this.doFacettingForLabel(e)))})),g(this,"onClickValue",((e,t,s)=>{const a=this.state.labels.find((t=>t.name===e));if(!a||!a.values)return;this.setState({searchTerm:""});const l=a.values.map((e=>Object.assign({},e,{selected:e.name===t?!e.selected:e.selected})));this.updateLabelState(e,{values:l},"",(()=>this.doFacetting(e)))})),g(this,"onClickValidate",(()=>{const e=f(this.state.labels);this.validateSelector(e)})),g(this,"doFacetting",(e=>{const t=f(this.state.labels);if(t===v){const e=this.state.labels.map((e=>Object.assign({},e,{facets:0,values:void 0,hidden:!1})));this.setState({labels:e},(()=>{this.state.labels.forEach((e=>e.selected&&this.fetchValues(e.name,t)))}))}else this.fetchSeries(t,e)}))}updateLabelState(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3?arguments[3]:void 0;this.setState((a=>{const l=a.labels.map((s=>s.name===e?Object.assign({},s,t):s)),i=s?"":a.error;return{labels:l,status:s,error:i,validationStatus:""}}),a)}componentDidMount(){const{languageProvider:e,autoSelect:t=m,lastUsedLabels:s}=this.props;if(e){const a=s;e.start().then((()=>{let s=e.getLabelKeys();if(s.length>p){const e=`Too many labels found (showing only 1000 of ${s.length})`;s=s.slice(0,p),this.setState({error:e})}const l=s.map(((e,s,l)=>({name:e,selected:l.length<=t&&0===a.length||a.includes(e),loading:!1})));this.setState({labels:l},(()=>{this.state.labels.forEach((e=>{e.selected&&this.fetchValues(e.name,v)}))}))}))}}doFacettingForLabel(e){const t=this.state.labels.find((t=>t.name===e));if(!t)return;const s=this.state.labels.filter((e=>e.selected)).map((e=>e.name));this.props.storeLastUsedLabels(s),t.selected?t.values||this.fetchValues(e,f(this.state.labels)):this.doFacetting()}async fetchValues(e,t){const{languageProvider:s}=this.props;this.updateLabelState(e,{loading:!0},`Fetching values for ${e}`);try{let a=await s.getLabelValues(e);if(t!==f(this.state.labels))return void this.updateLabelState(e,{loading:!1},"");if(a.length>b){const t=`Too many values for ${e} (showing only 10000 of ${a.length})`;a=a.slice(0,b),this.setState({error:t})}const l=a.map((e=>({name:e})));this.updateLabelState(e,{values:l,loading:!1})}catch(e){console.error(e)}}async fetchSeries(e,t){const{languageProvider:s}=this.props;t&&this.updateLabelState(t,{loading:!0},`Facetting labels for ${e}`);try{const a=await s.fetchSeriesLabels(e,!0);if(e!==f(this.state.labels))return void(t&&this.updateLabelState(t,{loading:!1}));if(0===Object.keys(a).length)return void this.setState({error:`Empty results, no matching label for ${e}`});const l=function(e,t,s){return e.map((e=>{const a=t[e.name];if(a){let t;if(e.name===s&&e.values)t=e.values;else{var l;const s=new Set((null===(l=e.values)||void 0===l?void 0:l.filter((e=>e.selected)).map((e=>e.name)))||[]);t=a.map((e=>({name:e,selected:s.has(e)})))}return Object.assign({},e,{loading:!1,values:t,facets:t.length})}return Object.assign({},e,{loading:!1,hidden:!a,values:void 0,facets:0})}))}(this.state.labels,a,t);this.setState({labels:l,error:""}),t&&this.updateLabelState(t,{loading:!1})}catch(e){console.error(e)}}async validateSelector(e){const{languageProvider:t}=this.props;this.setState({validationStatus:`Validating selector ${e}`,error:""});const s=await t.fetchSeries(e);this.setState({validationStatus:`Selector is valid (${s.length} streams found)`})}render(){const{theme:e}=this.props,{labels:t,searchTerm:s,status:o,error:g,validationStatus:p}=this.state;if(0===t.length)return a||(a=(0,u.jsx)(r.LoadingPlaceholder,{text:"Loading labels..."}));const b=(e=>({wrapper:c.css`
    background-color: ${e.colors.background.secondary};
    padding: ${e.spacing(2)};
    width: 100%;
  `,list:c.css`
    margin-top: ${e.spacing(1)};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
  `,section:c.css`
    & + & {
      margin: ${e.spacing(2,0)};
    }
    position: relative;
  `,selector:c.css`
    font-family: ${e.typography.fontFamilyMonospace};
    margin-bottom: ${e.spacing(1)};
  `,status:c.css`
    padding: ${e.spacing(.5)};
    color: ${e.colors.text.secondary};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* using absolute positioning because flex interferes with ellipsis */
    position: absolute;
    width: 50%;
    right: 0;
    text-align: right;
    transition: opacity 100ms linear;
    opacity: 0;
  `,statusShowing:c.css`
    opacity: 1;
  `,error:c.css`
    color: ${e.colors.error.main};
  `,valueList:c.css`
    margin-right: ${e.spacing(1)};
  `,valueListWrapper:c.css`
    border-left: 1px solid ${e.colors.border.medium};
    margin: ${e.spacing(1,0)};
    padding: ${e.spacing(1,0,1,1)};
  `,valueListArea:c.css`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${e.spacing(1)};
  `,valueTitle:c.css`
    margin-left: -${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
  `,validationStatus:c.css`
    padding: ${e.spacing(.5)};
    margin-bottom: ${e.spacing(1)};
    color: ${e.colors.text.maxContrast};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `}))(e),m=f(this.state.labels),x=m===v;let y=t.filter((e=>e.selected&&e.values));return y=s?y.map((e=>{const t=e.values.filter((e=>{if(e.selected)return e.highlightParts=void 0,!0;const t=(0,r.fuzzyMatch)(e.name.toLowerCase(),s.toLowerCase());return!!t.found&&(e.highlightParts=t.ranges,e.order=t.distance,!0)}));return Object.assign({},e,{values:(0,h.sortBy)(t,(e=>e.selected?-1/0:e.order))})})):this.state.labels.filter((e=>e.selected&&e.values)).map((e=>Object.assign({},e,{values:null!=e&&e.values?e.values.map((e=>Object.assign({},e,{highlightParts:void 0}))):[]}))),(0,u.jsxs)("div",{className:b.wrapper,children:[(0,u.jsxs)("div",{className:b.section,children:[l||(l=(0,u.jsx)(r.Label,{description:"Which labels would you like to consider for your search?",children:"1. Select labels to search in"})),(0,u.jsx)("div",{className:b.list,children:t.map((e=>(0,u.jsx)(r.BrowserLabel,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets,onClick:this.onClickLabel},e.name)))})]}),(0,u.jsxs)("div",{className:b.section,children:[i||(i=(0,u.jsx)(r.Label,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels.",children:"2. Find values for the selected labels"})),(0,u.jsx)("div",{children:(0,u.jsx)(r.Input,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:s})}),(0,u.jsx)("div",{className:b.valueListArea,children:y.map((e=>{var t,a;return(0,u.jsxs)("div",{role:"list",className:b.valueListWrapper,children:[(0,u.jsx)("div",{className:b.valueTitle,"aria-label":`Values for ${e.name}`,children:(0,u.jsx)(r.BrowserLabel,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets||(null===(t=e.values)||void 0===t?void 0:t.length),onClick:this.onClickLabel})}),(0,u.jsx)(d.t7,{height:200,itemCount:(null===(a=e.values)||void 0===a?void 0:a.length)||0,itemSize:28,itemKey:t=>e.values[t].name,width:200,className:b.valueList,children:t=>{var a;let{index:l,style:i}=t;const n=null===(a=e.values)||void 0===a?void 0:a[l];return n?(0,u.jsx)("div",{style:i,children:(0,u.jsx)(r.BrowserLabel,{name:e.name,value:null==n?void 0:n.name,active:null==n?void 0:n.selected,highlightParts:null==n?void 0:n.highlightParts,onClick:this.onClickValue,searchTerm:s})}):null}})]},e.name)}))})]}),(0,u.jsxs)("div",{className:b.section,children:[n||(n=(0,u.jsx)(r.Label,{children:"3. Resulting selector"})),(0,u.jsx)("div",{"aria-label":"selector",className:b.selector,children:m}),p&&(0,u.jsx)("div",{className:b.validationStatus,children:p}),(0,u.jsxs)(r.HorizontalGroup,{children:[(0,u.jsx)(r.Button,{"aria-label":"Use selector as logs button",disabled:x,onClick:this.onClickRunLogsQuery,children:"Show logs"}),(0,u.jsx)(r.Button,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:x,onClick:this.onClickRunMetricsQuery,children:"Show logs rate"}),(0,u.jsx)(r.Button,{"aria-label":"Validate submit button",variant:"secondary",disabled:x,onClick:this.onClickValidate,children:"Validate selector"}),(0,u.jsx)(r.Button,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear,children:"Clear"}),(0,u.jsx)("div",{className:(0,c.cx)(b.status,(o||g)&&b.statusShowing),children:(0,u.jsx)("span",{className:g?b.error:"",children:g||o})})]})]})]})}}const y=(0,r.withTheme2)(x);var w=s("../../opt/drone/yarncache/prismjs-npm-1.27.0-ca4e1667c6-85c7f4a3e9.zip/node_modules/prismjs/prism.js");function j(e){return t=e/1e3,Math.floor(t/60);var t}var L=s("./public/app/core/components/LocalStorageValueProvider/index.tsx");function S(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function C(e,t){let{typeaheadContext:s,typeaheadText:a}=t;switch(s){case"context-labels":{const t=r.DOMUtil.getNextCharacter();t&&"}"!==t&&","!==t||(e+="=");break}case"context-label-values":a.match(/^(!?=~?"|")/)||(e=`"${e}`),'"'!==r.DOMUtil.getNextCharacter()&&(e=`${e}"`)}return e}class k extends o.PureComponent{constructor(e){super(e),S(this,"plugins",void 0),S(this,"_isMounted",!1),S(this,"onChangeLabelBrowser",(e=>{this.onChangeQuery(e,!0),this.setState({labelBrowserVisible:!1})})),S(this,"onChangeQuery",((e,t)=>{const{query:s,onChange:a,onRunQuery:l}=this.props;if(a){a(Object.assign({},s,{expr:e})),t&&l&&l()}})),S(this,"onClickChooserButton",(()=>{this.setState((e=>({labelBrowserVisible:!e.labelBrowserVisible})))})),S(this,"onTypeahead",(async e=>{const{datasource:t}=this.props;if(!t.languageProvider)return{suggestions:[]};const s=t.languageProvider,{history:a}=this.props,{prefix:l,text:i,value:n,wrapperClasses:o,labelKey:r}=e;return await s.provideCompletionItems({text:i,value:n,prefix:l,wrapperClasses:o,labelKey:r},{history:a})})),this.state={labelsLoaded:!1,labelBrowserVisible:!1},this.plugins=[(0,r.BracesPlugin)(),(0,r.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"logql"},Object.assign({},w.languages,{logql:this.props.datasource.languageProvider.getSyntax()}))]}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(e){const{range:t,datasource:{languageProvider:s}}=this.props,a=function(e,t){if(e&&t){const s=j(e.from.valueOf())===j(t.from.valueOf()),a=j(e.to.valueOf())===j(t.to.valueOf());return!(s&&a)}return!1}(t,e.range);a&&s.fetchLabels()}render(){const{ExtraFieldElement:e,query:t,datasource:s,placeholder:a="Enter a Loki query (run with Shift+Enter)"}=this.props,{labelsLoaded:l,labelBrowserVisible:i}=this.state,n=s.languageProvider,o=s.languageProvider?n.cleanText:void 0,c=n.getLabelKeys().length>0,d=function(e,t){return e?t?"Log browser":"(No logs found)":"Loading labels..."}(l,c),h=!(l&&c);return(0,u.jsx)(L.G,{storageKey:"grafana.datasources.loki.browser.labels",defaultValue:[],children:(s,l,c)=>(0,u.jsxs)(u.Fragment,{children:[(0,u.jsxs)("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"],children:[(0,u.jsxs)("button",{className:"gf-form-label query-keyword pointer",onClick:this.onClickChooserButton,disabled:h,children:[d,(0,u.jsx)(r.Icon,{name:i?"angle-down":"angle-right"})]}),(0,u.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:(0,u.jsx)(r.QueryField,{additionalPlugins:this.plugins,cleanText:o,query:t.expr,onTypeahead:this.onTypeahead,onWillApplySuggestion:C,onChange:this.onChangeQuery,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery,placeholder:a,portalOrigin:"loki"})})]}),i&&(0,u.jsx)("div",{className:"gf-form",children:(0,u.jsx)(y,{languageProvider:n,onChange:this.onChangeLabelBrowser,lastUsedLabels:s||[],storeLastUsedLabels:l,deleteLastUsedLabels:c})}),e]})})}}}}]);
//# sourceMappingURL=1828.15718e8e3083449662a7.js.map
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8016],{18152:(M,Q,s)=>{s.d(Q,{a:()=>h,k:()=>C});var m=s(32504),e=s(73736),v=s(74673);const C=u=>{if(!u?.queries?.length)return!1;const d=u.queries[0].datasource;return u.queries.some(c=>c.datasource?.uid!==d?.uid||c.datasource?.type!==d?.type)},g=(0,m.LC)({reducerPath:"savedQueries",baseQuery:(0,e.ni)({baseUrl:"/"}),endpoints:u=>({getSavedQueryByUids:u.query({async queryFn(d,c,S,O){return{data:await(0,v.o)().getSavedQueries(d)}}}),deleteSavedQuery:u.mutation({async queryFn(d){return await(0,v.o)().deleteSavedQuery(d),{data:null}}}),updateSavedQuery:u.mutation({async queryFn(d){return await(0,v.o)().updateSavedQuery(d.query,d.opts),{data:null}}})})}),{useUpdateSavedQueryMutation:h}=g},74673:(M,Q,s)=>{s.d(Q,{o:()=>C});var m=s(29930);class e{constructor(){this.getSavedQueries=async h=>{if(!h.length)return[];const u=h.map(d=>`uid=${d.uid}`).join("&");return(0,m.i)().get(`/api/query-library?${u}`)},this.deleteSavedQuery=async h=>(0,m.i)().delete(`/api/query-library?uid=${h.uid}`),this.updateSavedQuery=async(h,u)=>(0,m.i)().post("/api/query-library",h)}}const v=new e,C=()=>v},98016:(M,Q,s)=>{s.d(Q,{D:()=>se});var m=s(52423),e=s(68404),v=s(49922),C=s(69311),g=s(40400),h=s(68183),u=s(77213),d=s(2248),c=s(49371),S=s(90723),O=s(90701),x=s(49938),w=s(6694),A=s(82385),N=s(22350),U=s(41959),b=s(47214),H=s(90090);function L({pluginId:l}){const{value:t,loading:n,error:a}=(0,N.Z)(async()=>(0,b.i)().get(`/api/plugins/${l}/markdown/query_help`),[]),r=(0,U.a)(t);return n?e.createElement(H.u,{text:"Loading help..."}):a?e.createElement("h3",null,"An error occurred when loading help."):t===""?e.createElement("h3",null,"No query help could be found."):e.createElement("div",{className:"markdown-html",dangerouslySetInnerHTML:{__html:r}})}var D=s(47694),W=s(29930),I=s(99822),$=s(47471),P=s(53693),V=s(18152),q=s(74673),B=s(22790),z=s(9386),K=s(84457),j=s(33180),R=s(25474),k=s(71210),Z=s(44727),G=s(67254);class J extends e.PureComponent{constructor(t){super(t),this.onRelativeTimeChange=a=>{this.setState({timeRangeFrom:a.target.value})},this.onTimeShiftChange=a=>{this.setState({timeRangeShift:a.target.value})},this.onOverrideTime=a=>{const{options:r,onChange:i}=this.props,o=T(a.target.value),p=F(o);p&&r.timeRange?.from!==o&&i({...r,timeRange:{...r.timeRange??{},from:o}}),this.setState({relativeTimeIsValid:p})},this.onTimeShift=a=>{const{options:r,onChange:i}=this.props,o=T(a.target.value),p=F(o);p&&r.timeRange?.shift!==o&&i({...r,timeRange:{...r.timeRange??{},shift:o}}),this.setState({timeShiftIsValid:p})},this.onToggleTimeOverride=()=>{const{onChange:a,options:r}=this.props;this.setState({timeRangeHide:!this.state.timeRangeHide},()=>{a({...r,timeRange:{...r.timeRange??{},hide:this.state.timeRangeHide}})})},this.onCacheTimeoutBlur=a=>{const{options:r,onChange:i}=this.props;i({...r,cacheTimeout:T(a.target.value)})},this.onMaxDataPointsBlur=a=>{const{options:r,onChange:i}=this.props;let o=parseInt(a.target.value,10);(isNaN(o)||o===0)&&(o=null),o!==r.maxDataPoints&&i({...r,maxDataPoints:o})},this.onMinIntervalBlur=a=>{const{options:r,onChange:i}=this.props,o=T(a.target.value);o!==r.minInterval&&i({...r,minInterval:o})},this.onOpenOptions=()=>{this.setState({isOpen:!0})},this.onCloseOptions=()=>{this.setState({isOpen:!1})};const{options:n}=t;this.state={timeRangeFrom:n.timeRange?.from||"",timeRangeShift:n.timeRange?.shift||"",timeRangeHide:n.timeRange?.hide??!1,isOpen:!1,relativeTimeIsValid:!0,timeShiftIsValid:!0}}renderCacheTimeoutOption(){const{dataSource:t,options:n}=this.props,a=`If your time series store has a query cache this option can override the default cache timeout. Specify a
    numeric value in seconds.`;return t.meta.queryOptions?.cacheTimeout?e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(c.c,{width:9,tooltip:a},"Cache timeout"),e.createElement(R.I,{type:"text",className:"width-6",placeholder:"60",spellCheck:!1,onBlur:this.onCacheTimeoutBlur,defaultValue:n.cacheTimeout??""}))):null}renderMaxDataPointsOption(){const{data:t,options:n}=this.props,a=t.request?.maxDataPoints,r=n.maxDataPoints??"",i=r==="";return e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(c.c,{width:9,tooltip:e.createElement(e.Fragment,null,"The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer.")},"Max data points"),e.createElement(R.I,{type:"number",className:"width-6",placeholder:`${a}`,spellCheck:!1,onBlur:this.onMaxDataPointsBlur,defaultValue:r}),i&&e.createElement(e.Fragment,null,e.createElement("div",{className:"gf-form-label query-segment-operator"},"="),e.createElement("div",{className:"gf-form-label"},"Width of panel"))))}renderIntervalOption(){const{data:t,dataSource:n,options:a}=this.props,r=t.request?.interval,i=n.interval??"No limit";return e.createElement(e.Fragment,null,e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(c.c,{width:9,tooltip:e.createElement(e.Fragment,null,"A lower limit for the interval. Recommended to be set to write frequency, for example ",e.createElement("code",null,"1m")," ","if your data is written every minute. Default value can be set in data source settings for most data sources.")},"Min interval"),e.createElement(R.I,{type:"text",className:"width-6",placeholder:`${i}`,spellCheck:!1,onBlur:this.onMinIntervalBlur,defaultValue:a.minInterval??""}))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(c.c,{width:9,tooltip:e.createElement(e.Fragment,null,"The evaluated interval that is sent to data source and is used in ",e.createElement("code",null,"$__interval")," and"," ",e.createElement("code",null,"$__interval_ms"))},"Interval"),e.createElement(c.c,{width:6},r),e.createElement("div",{className:"gf-form-label query-segment-operator"},"="),e.createElement("div",{className:"gf-form-label"},"Time range / max data points"))))}renderCollapsedText(t){const{data:n,options:a}=this.props,{isOpen:r}=this.state;if(r)return;let i=a.maxDataPoints??"";i===""&&n.request&&(i=`auto = ${n.request.maxDataPoints}`);let o=a.minInterval;return n.request&&(o=`${n.request.interval}`),e.createElement(e.Fragment,null,e.createElement("div",{className:t.collapsedText},"MD = ",i),e.createElement("div",{className:t.collapsedText},"Interval = ",o))}render(){const{timeRangeHide:t,relativeTimeIsValid:n,timeShiftIsValid:a}=this.state,{timeRangeFrom:r,timeRangeShift:i,isOpen:o}=this.state,p=Y();return e.createElement(G.t,{id:"Query options",index:0,title:"Query options",headerElement:this.renderCollapsedText(p),isOpen:o,onOpen:this.onOpenOptions,onClose:this.onCloseOptions},this.renderMaxDataPointsOption(),this.renderIntervalOption(),this.renderCacheTimeoutOption(),e.createElement("div",{className:"gf-form"},e.createElement(c.c,{width:9},"Relative time"),e.createElement(R.I,{type:"text",className:"width-6",placeholder:"1h",onChange:this.onRelativeTimeChange,onBlur:this.onOverrideTime,invalid:!n,value:r})),e.createElement("div",{className:"gf-form"},e.createElement("span",{className:"gf-form-label width-9"},"Time shift"),e.createElement(R.I,{type:"text",className:"width-6",placeholder:"1h",onChange:this.onTimeShiftChange,onBlur:this.onTimeShift,invalid:!a,value:i})),(i||r)&&e.createElement("div",{className:"gf-form-inline"},e.createElement(k._,{label:"Hide time info",labelWidth:18},e.createElement(Z.r,{value:t,onChange:this.onToggleTimeOverride}))))}}const F=l=>l?j.isValidTimeSpan(l):!0,T=l=>l===""?null:l,Y=(0,A.B)(()=>{const{theme:l}=D.vc;return{collapsedText:m.css`
      margin-left: ${l.spacing.md};
      font-size: ${l.typography.size.sm};
      color: ${l.colors.textWeak};
    `}});var X=s(81850),_=s(46739),ee=s(80914),te=s(64823);function ae(l){return l?.loading?[]:l?.value?.totalRows?l.value.view.toArray().map(n=>{const a=n.ds_uid?.length?(0,u.F)().getInstanceSettings(n.ds_uid[0]):void 0;return{value:n.uid,label:n.name,imgUrl:a?.meta.info.logos.small,meta:a?.meta}}):[]}const ne=l=>{const{autoFocus:t,onBlur:n,onChange:a,current:r,openMenuOnFocus:i,placeholder:o,width:p,inputId:f}=l,y=(0,e.useMemo)(()=>({query:"*",explain:!0,kind:["query"]}),[]),ie=(0,N.Z)(async()=>(0,te.getGrafanaSearcher)().search(y),[y]),oe=ae(ie);return e.createElement("div",{"aria-label":h.wl.components.DataSourcePicker.container},e.createElement(_.Ph,{"aria-label":h.wl.components.DataSourcePicker.inputV2,inputId:f||"data-source-picker",className:"ds-picker select-container",isMulti:!1,isClearable:!0,backspaceRemovesValue:!0,options:oe,autoFocus:t,onBlur:n,width:p,value:r,onChange:E=>{a(E?.value??null)},openMenuOnFocus:i,maxMenuHeight:500,placeholder:o??"Select query from the library",noOptionsMessage:"No queries found",getOptionLabel:E=>E.meta&&(0,X.x)(E.meta.signature)?e.createElement(O.Lh,{align:"center",justify:"space-between"},e.createElement("span",null,E.label)," ",e.createElement(ee.o,{status:E.meta.signature})):E.label||""}))};class se extends e.PureComponent{constructor(){super(...arguments),this.backendSrv=W.ae,this.dataSourceSrv=(0,u.F)(),this.querySubscription=null,this.state={isLoadingHelp:!1,helpContent:null,isPickerOpen:!1,isAddingMixed:!1,isHelpOpen:!1,queries:[],savedQueryUid:null,initialState:{queries:[],savedQueryUid:null},data:{state:v.Gu.NotStarted,series:[],timeRange:(0,C.JK)()}},this.onChangeDataSource=async t=>{const{dsSettings:n}=this.state,a=n?await(0,u.F)().get(n.uid):void 0,r=await(0,u.F)().get(t.uid),i=await(0,B.I)(r,t.uid,this.state.queries,a),o=await this.dataSourceSrv.get(t.name);this.onChange({queries:i,savedQueryUid:null,dataSource:{name:t.name,uid:t.uid,type:t.meta.id,default:t.isDefault}}),this.setState({queries:i,savedQueryUid:null,dataSource:o,dsSettings:t})},this.onChangeSavedQuery=async t=>{if(!t?.length){this.onChange({queries:this.state.queries,savedQueryUid:null,dataSource:{name:this.state.dsSettings?.name,uid:this.state.dsSettings?.uid,type:this.state.dsSettings?.meta.id,default:this.state.dsSettings?.isDefault}}),this.setState({queries:this.state.queries,savedQueryUid:null,dataSource:this.state.dataSource,dsSettings:this.state.dsSettings});return}const{dsSettings:n}=this.state,a=n?await(0,u.F)().get(n.uid):void 0,r=await(0,q.o)().getSavedQueries([{uid:t}]);if(!r?.length)throw new Error("TODO error handling");const i=r[0],p=(0,V.k)(i)?await(0,u.F)().get("-- Mixed --"):await(0,u.F)().get(i.queries[0].datasource?.uid),f=await(0,B.I)(p,p.uid,i.queries,a),y=await(0,u.F)().getInstanceSettings(p.uid);if(!y)throw new Error("TODO error handling");this.onChange({queries:f,savedQueryUid:t,dataSource:{name:y.name,uid:y.uid,type:y.meta.id,default:y.isDefault}}),this.setState({queries:f,savedQueryUid:t,dataSource:p,dsSettings:y})},this.onAddQueryClick=()=>{const{queries:t}=this.state;this.onQueriesChange((0,I.DI)(t,this.newQuery())),this.onScrollBottom()},this.onAddExpressionClick=()=>{this.onQueriesChange((0,I.DI)(this.state.queries,$.mV.newQuery())),this.onScrollBottom()},this.onScrollBottom=()=>{setTimeout(()=>{this.state.scrollElement&&this.state.scrollElement.scrollTo({top:1e4})},20)},this.onUpdateAndRun=t=>{this.props.onOptionsChange(t),this.props.onRunQueries()},this.onOpenHelp=()=>{this.setState({isHelpOpen:!0})},this.onCloseHelp=()=>{this.setState({isHelpOpen:!1})},this.renderMixedPicker=()=>e.createElement(d.q,{mixed:!1,onChange:this.onAddMixedQuery,current:null,autoFocus:!0,variables:!0,onBlur:this.onMixedPickerBlur,openMenuOnFocus:!0}),this.onAddMixedQuery=t=>{this.onAddQuery({datasource:t.name}),this.setState({isAddingMixed:!1})},this.onMixedPickerBlur=()=>{this.setState({isAddingMixed:!1})},this.onAddQuery=t=>{const{dsSettings:n,queries:a}=this.state;this.onQueriesChange((0,I.DI)(a,t,{type:n?.type,uid:n?.uid})),this.onScrollBottom()},this.onQueriesChange=t=>{this.onChange({queries:t}),this.setState({queries:t})},this.setScrollRef=t=>{this.setState({scrollElement:t})}}async componentDidMount(){const{options:t,queryRunner:n}=this.props;this.querySubscription=n.getData({withTransforms:!1,withFieldConfig:!1}).subscribe({next:a=>this.onPanelDataUpdate(a)});try{const a=await this.dataSourceSrv.get(t.dataSource),r=this.dataSourceSrv.getInstanceSettings(t.dataSource),i=await this.dataSourceSrv.get(),o=a.getRef(),p=t.queries.map(f=>({...(0,I.vH)(f)&&a?.getDefaultQuery?.(g.zj.PanelEditor),datasource:o,...f}));this.setState({queries:p,dataSource:a,dsSettings:r,defaultDataSource:i,savedQueryUid:t.savedQueryUid,initialState:{queries:t.queries.map(f=>({...f})),dataSource:{...t.dataSource},savedQueryUid:t.savedQueryUid}})}catch(a){console.log("failed to load data source",a)}}componentWillUnmount(){this.querySubscription&&(this.querySubscription.unsubscribe(),this.querySubscription=null)}onPanelDataUpdate(t){this.setState({data:t})}newQuery(){const{dsSettings:t,defaultDataSource:n}=this.state,a=t?.meta.mixed?n:t;return{...this.state.dataSource?.getDefaultQuery?.(g.zj.PanelEditor),datasource:{uid:a?.uid,type:a?.type}}}onChange(t){this.props.onOptionsChange({...this.props.options,...t})}renderTopSection(t){const{onOpenQueryInspector:n,options:a}=this.props,{dataSource:r,data:i}=this.state;return e.createElement("div",null,e.createElement("div",{className:t.dataSourceRow},e.createElement(c.c,{htmlFor:"data-source-picker",width:"auto"},"Data source"),e.createElement("div",{className:t.dataSourceRowItem},e.createElement(d.q,{onChange:this.onChangeDataSource,current:a.dataSource,metrics:!0,mixed:!0,dashboard:!0,variables:!0})),r&&e.createElement(e.Fragment,null,e.createElement("div",{className:t.dataSourceRowItem},e.createElement(S.zx,{variant:"secondary",icon:"question-circle",title:"Open data source help",onClick:this.onOpenHelp})),e.createElement("div",{className:t.dataSourceRowItemOptions},e.createElement(J,{options:a,dataSource:r,data:i,onChange:this.onUpdateAndRun})),n&&e.createElement("div",{className:t.dataSourceRowItem},e.createElement(S.zx,{variant:"secondary",onClick:n,"aria-label":h.wl.components.QueryTab.queryInspectorButton},"Query inspector")))),D.ZP.featureToggles.queryLibrary&&e.createElement(e.Fragment,null,e.createElement("div",{className:t.dataSourceRow},e.createElement(c.c,{htmlFor:"saved-query-picker",width:"auto"},"Saved query"),e.createElement("div",{className:t.dataSourceRowItem},e.createElement(ne,{current:this.state.savedQueryUid,onChange:this.onChangeSavedQuery})))))}renderQueries(t){const{onRunQueries:n}=this.props,{data:a,queries:r}=this.state;return(0,P.yl)(t.name)?e.createElement(P.hD,{queries:r,panelData:a,onChange:this.onQueriesChange,onRunQueries:n}):e.createElement("div",{"aria-label":h.wl.components.QueryTab.content},e.createElement(K.l,{queries:r,dsSettings:t,onQueriesChange:this.onQueriesChange,onAddQuery:this.onAddQuery,onRunQueries:n,data:a}))}isExpressionsSupported(t){return(t.meta.alerting||t.meta.mixed)===!0}renderExtraActions(){return z.S.getAllExtraRenderAction().map((t,n)=>t({onAddQuery:this.onAddQuery,onChangeDataSource:this.onChangeDataSource,key:n})).filter(Boolean)}renderAddQueryRow(t,n){const{isAddingMixed:a}=this.state,r=!(a||(0,P.yl)(t.name));return e.createElement(O.Lh,{spacing:"md",align:"flex-start"},r&&e.createElement(S.zx,{icon:"plus",onClick:this.onAddQueryClick,variant:"secondary","aria-label":h.wl.components.QueryTab.addQuery},"Query"),D.ZP.expressionsEnabled&&this.isExpressionsSupported(t)&&e.createElement(S.zx,{icon:"plus",onClick:this.onAddExpressionClick,variant:"secondary",className:n.expressionButton},e.createElement("span",null,"Expression\xA0")),this.renderExtraActions())}render(){const{isHelpOpen:t,dsSettings:n}=this.state,a=re();return e.createElement(x.$,{autoHeightMin:"100%",scrollRefCallback:this.setScrollRef},e.createElement("div",{className:a.innerWrapper},this.renderTopSection(a),n&&e.createElement(e.Fragment,null,e.createElement("div",{className:a.queriesWrapper},this.renderQueries(n)),this.renderAddQueryRow(n,a),t&&e.createElement(w.u,{title:"Data source help",isOpen:!0,onDismiss:this.onCloseHelp},e.createElement(L,{pluginId:n.meta.id})))))}}const re=(0,A.B)(()=>{const{theme:l}=D.ZP;return{innerWrapper:m.css`
      display: flex;
      flex-direction: column;
      padding: ${l.spacing.md};
    `,dataSourceRow:m.css`
      display: flex;
      margin-bottom: ${l.spacing.md};
    `,dataSourceRowItem:m.css`
      margin-right: ${l.spacing.inlineFormMargin};
    `,dataSourceRowItemOptions:m.css`
      flex-grow: 1;
      margin-right: ${l.spacing.inlineFormMargin};
    `,queriesWrapper:m.css`
      padding-bottom: 16px;
    `,expressionWrapper:m.css``,expressionButton:m.css`
      margin-right: ${l.spacing.sm};
    `}})},22790:(M,Q,s)=>{s.d(Q,{I:()=>C});var m=s(40400),e=s(62163),v=s(9800);async function C(g,h,u,d){let c=u;const S={type:g.type,uid:h},O={...g?.getDefaultQuery?.(m.zj.PanelEditor),datasource:S,refId:"A"};if(d?.meta.id!==g.meta.id){if(g.meta.mixed)return u;if((0,e.p)(d)&&(0,e.CZ)(g)){const x=await d.exportToAbstractQueries(u);c=await g.importFromAbstractQueries(x)}else if(d&&g.importQueries)c=await g.importQueries(u,d);else return[O]}return c.length===0?[O]:c.map(x=>(!(0,v.Pr)(x.datasource)&&!g.meta.mixed&&(x.datasource=S),x))}}}]);

//# sourceMappingURL=8016.af0bcb19b7229b67f039.js.map
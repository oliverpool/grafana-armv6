"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5204],{"./public/app/features/dashboard/state/initDashboard.ts":(e,a,r)=>{r.d(a,{ZQ:()=>w,mV:()=>y,f1:()=>j,$M:()=>k});var t=r("./public/app/core/copy/appNotification.ts"),s=r("./public/app/core/services/backend_srv.ts"),o=r("./public/app/features/dashboard/services/DashboardSrv.ts"),n=r("./public/app/features/dashboard/services/DashboardLoaderSrv.ts"),i=r("./public/app/features/dashboard/services/TimeSrv.ts"),d=r("./public/app/core/services/keybindingSrv.ts"),c=r("./public/app/core/actions/index.ts"),l=r("./public/app/features/dashboard/state/reducers.ts"),u=r("./public/app/types/index.ts"),p=r("./public/app/features/dashboard/state/DashboardModel.ts"),h=r("./packages/grafana-data/src/index.ts"),b=r("./public/app/features/variables/state/actions.ts"),f=r("./packages/grafana-runtime/src/index.ts");var g=r("./public/app/features/live/dashboard/dashboardWatcher.ts"),v=r("./public/app/features/query/state/DashboardQueryRunner/DashboardQueryRunner.ts"),m=r("./public/app/features/variables/state/selectors.ts"),x=r("./public/app/features/variables/utils.ts"),S=r("./public/app/core/store.ts");function y(e){return async(a,r)=>{var y;a((0,l.sf)());const k=await async function(e,a,r){const t=S.Z.getObject(D);if(t)return j(),t;try{switch(e.routeName){case u.vq.Home:{const e=await s.ae.get("/api/dashboards/home");if(e.redirectUri){const a=h.locationUtil.stripBaseFromUrl(e.redirectUri);return f.locationService.replace(a),null}return e.meta.canSave=!1,e.meta.canShare=!1,e.meta.canStar=!1,e}case u.vq.Normal:{const a=await n.pD.loadDashboard(e.urlType,e.urlSlug,e.urlUid);if(e.fixUrl&&a.meta.url){const e=h.locationUtil.stripBaseFromUrl(a.meta.url),r=f.locationService.getLocation().pathname;e!==r&&(f.locationService.replace(Object.assign({},f.locationService.getLocation(),{pathname:e})),console.log("not correct url correcting",e,r))}return a}case u.vq.New:return w(e.urlFolderId);default:throw{message:"Unknown route "+e.routeName}}}catch(e){return e.cancelled||(a((0,l.jA)({message:"Failed to fetch dashboard",error:e})),console.error(e)),null}}(e,a);if(!k)return;let _;a((0,l.Nv)());try{_=new p.f(k.dashboard,k.meta)}catch(e){return a((0,l.jA)({message:"Failed create dashboard model",error:e})),void console.error(e)}const N=r(),A=f.locationService.getSearchObject();A.orgId||f.locationService.partial({orgId:N.user.orgId},!0);const T=(0,i.$t)();(0,o.h4)().setCurrent(_),T.init(_);const U=(0,x.mn)(null!==(y=e.urlUid)&&void 0!==y?y:_.uid);await a((0,b.LX)(U,_));if((0,v.Tl)({dashboard:_,timeSrv:T}).run({dashboard:_,range:T.timeRange()}),(0,m.cp)(r())===U&&r().dashboard.initPhase===u.bG.Services){try{_.processRepeats(),A.autofitpanels&&_.autoFitPanels(window.innerHeight,A.kiosk),d.K.setupDashboardBindings(_)}catch(e){a((0,c.$l)((0,t.t_)("Dashboard init failed",e))),console.error(e)}e.routeName!==u.vq.New?(!function(e){const a={dashboardId:e.id,dashboardName:e.title,dashboardUid:e.uid,folderName:e.meta.folderTitle,eventName:f.MetaAnalyticsEventName.DashboardView};(0,f.reportMetaAnalytics)(a)}(_),g.H.watch(_.uid)):g.H.leave(),""!==_.weekStart?(0,h.setWeekStart)(_.weekStart):(0,h.setWeekStart)(f.config.bootData.user.weekStart),a((0,l.dS)(_))}}}function w(e){const a={meta:{canStar:!1,canShare:!1,isNew:!0,folderId:0},dashboard:{title:"New dashboard",panels:[{type:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"Panel Title"}]}};return e&&(a.meta.folderId=parseInt(e,10)),a}const D="DASHBOARD_FROM_LS_KEY";function k(e){S.Z.setObject(D,e)}function j(){S.Z.delete(D)}},"./public/app/features/explore/AddToDashboard/index.tsx":(e,a,r)=>{r.r(a),r.d(a,{AddToDashboard:()=>_});var t=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),s=r("./packages/grafana-ui/src/index.ts"),o=r("./packages/grafana-data/src/index.ts"),n=r("./public/app/core/services/backend_srv.ts"),i=r("./public/app/features/dashboard/state/initDashboard.ts");let d;async function c(e){var a;const r=function(e,a){for(const{refId:r}of e.filter(l)){const e=u(r);if(a.graphFrames.some(e))return"timeseries";if(a.logsFrames.some(e))return"logs";if(a.nodeGraphFrames.some(e))return"nodeGraph"}return"table"}(e.queries,e.queryResponse),t={targets:e.queries,type:r,title:"New Panel",gridPos:{x:0,y:0,w:12,h:8},datasource:e.datasource};let s;if(e.dashboardUid)try{s=await n.ae.getDashboardByUid(e.dashboardUid)}catch(e){throw d.FETCH_DASHBOARD}else s=function(){const e=(0,i.ZQ)();return e.dashboard.panels=[],e}();s.dashboard.panels=[t,...null!==(a=s.dashboard.panels)&&void 0!==a?a:[]];try{(0,i.$M)(s)}catch{throw d.SET_DASHBOARD_LS}}!function(e){e.FETCH_DASHBOARD="fetch-dashboard",e.SET_DASHBOARD_LS="set-dashboard-ls-error"}(d||(d={}));const l=e=>!e.hide,u=e=>a=>a.refId===e;var p=r("./.yarn/__virtual__/react-redux-virtual-7ad20a440e/3/opt/drone/yarncache/react-redux-npm-7.2.6-134f5ed64d-0bf142ce0d.zip/node_modules/react-redux/es/index.js"),h=r("./public/app/core/components/Select/DashboardPicker.tsx"),b=r("./.yarn/__virtual__/react-hook-form-virtual-92b6119fd4/3/opt/drone/yarncache/react-hook-form-npm-7.5.3-f9cc466c62-fbfaa3b664.zip/node_modules/react-hook-form/dist/index.esm.js"),f=r("./packages/grafana-runtime/src/index.ts"),g=r("./public/app/features/explore/state/selectors.ts"),v=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),m=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const x=["ref"],S=["ref","value","onChange"];function y(e,a){if(null==e)return{};var r,t,s={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],a.indexOf(r)>=0||(s[r]=e[r]);return s}var w;!function(e){e.NewDashboard="new-dashboard",e.ExistingDashboard="existing-dashboard"}(w||(w={}));const D=[{label:"New dashboard",value:w.NewDashboard},{label:"Existing dashboard",value:w.ExistingDashboard}];var k;!function(e){e.UNKNOWN="unknown-error",e.NAVIGATION="navigation-error"}(k||(k={}));const j=e=>{let{onClose:a,exploreId:n}=e;const l=(0,p.useSelector)((0,g.F)(n)),[u,j]=(0,t.useState)(),{handleSubmit:_,control:N,formState:{errors:A},watch:T}=(0,b.cI)({defaultValues:{saveTarget:w.NewDashboard}}),U=T("saveTarget"),I=async(e,t)=>{j(void 0);const s=t.saveTarget===w.ExistingDashboard?t.dashboardUid:void 0;(0,f.reportInteraction)("e2d_submit",{newTab:e,saveTarget:t.saveTarget,queries:l.queries.length});try{var n;await c({dashboardUid:s,datasource:null===(n=l.datasourceInstance)||void 0===n?void 0:n.getRef(),queries:l.queries,queryResponse:l.queryResponse})}catch(e){switch(e){case d.FETCH_DASHBOARD:j({error:e,message:"Could not fetch dashboard information. Please try again."});break;case d.SET_DASHBOARD_LS:j({error:e,message:"Could not add panel to dashboard. Please try again."});break;default:j({error:k.UNKNOWN,message:"Something went wrong. Please try again."})}return}const u=function(e){return e?`d/${e}`:"dashboard/new"}(s);if(!e)return a(),void f.locationService.push(o.locationUtil.stripBaseFromUrl(u));if(!!!r.g.open(f.config.appUrl+u,"_blank"))return j({error:k.NAVIGATION,message:"Could not navigate to the selected dashboard. Please try again."}),void(0,i.f1)();a()};return(0,t.useEffect)((()=>{(0,f.reportInteraction)("e2d_open")}),[]),(0,m.jsx)(s.Modal,{title:"Add panel to dashboard",onDismiss:a,isOpen:!0,children:(0,m.jsxs)("form",{children:[(0,m.jsx)(s.InputControl,{control:N,render:e=>{let{}=e,a=y(e.field,x);return(0,m.jsx)(s.Field,{label:"Target dashboard",description:"Choose where to add the panel.",children:(0,m.jsx)(s.RadioButtonGroup,Object.assign({options:D},a,{id:"e2d-save-target"}))})},name:"saveTarget"}),U===w.ExistingDashboard&&(0,m.jsx)(s.InputControl,{render:e=>{var a;let{field:{onChange:r}}=e,t=y(e.field,S);return(0,m.jsx)(s.Field,{label:"Dashboard",description:"Select in which dashboard the panel will be created.",error:null===(a=A.dashboardUid)||void 0===a?void 0:a.message,invalid:!!A.dashboardUid,children:(0,m.jsx)(h.o,Object.assign({},t,{inputId:"e2d-dashboard-picker",defaultOptions:!0,onChange:e=>r(null==e?void 0:e.uid)}))})},control:N,name:"dashboardUid",shouldUnregister:!0,rules:{required:{value:!0,message:"This field is required."}}}),u&&(0,m.jsx)(s.Alert,{severity:"error",title:"Error adding the panel",children:u.message}),(0,m.jsxs)(s.Modal.ButtonRow,{children:[(0,m.jsx)(s.Button,{type:"reset",onClick:a,fill:"outline",variant:"secondary",children:"Cancel"}),(0,m.jsx)(s.Button,{type:"submit",variant:"secondary",onClick:_((0,v.partial)(I,!0)),icon:"external-link-alt",children:"Open in new tab"}),(0,m.jsx)(s.Button,{type:"submit",variant:"primary",onClick:_((0,v.partial)(I,!1)),icon:"apps",children:"Open dashboard"})]})]})})},_=e=>{var a,r;let{exploreId:o}=e;const[n,i]=(0,t.useState)(!1),d=(0,g.F)(o),c=!(null===(a=(0,p.useSelector)(d))||void 0===a||null===(r=a.queries)||void 0===r||!r.length);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(s.ToolbarButton,{icon:"apps",onClick:()=>i(!0),"aria-label":"Add to dashboard",disabled:!c,children:"Add to dashboard"}),n&&(0,m.jsx)(j,{onClose:()=>i(!1),exploreId:o})]})}}}]);
//# sourceMappingURL=5204.15718e8e3083449662a7.js.map
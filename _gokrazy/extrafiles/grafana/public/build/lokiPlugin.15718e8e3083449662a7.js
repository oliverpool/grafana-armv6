"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1598],{"./public/app/plugins/datasource/loki/components/LokiOptionFields.tsx":(e,t,r)=>{r.d(t,{JX:()=>O,TQ:()=>p,Wz:()=>g,oZ:()=>m,uG:()=>d});r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js");var a,n=r("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),s=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),i=r("./packages/grafana-ui/src/index.ts"),o=r("./packages/grafana-runtime/src/index.ts"),l=r("./public/app/plugins/datasource/loki/types.ts"),c=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const u=["instant","range"];const d=[{value:l.E.Range,label:"Range",description:"Run query over a range of time."},{value:l.E.Instant,label:"Instant",description:'Run query against a single point in time. For this query, the "To" time is used.'}];o.config.featureToggles.lokiLive&&d.push({value:l.E.Stream,label:"Stream",description:"Run a query and keep sending results on an interval"});const p={value:1,label:"1/1"},m=[p].concat((0,s.map)([2,3,4,5,10],(e=>({value:e,label:"1/"+e}))));function O(e){var t,r;const{lineLimitValue:s,resolution:o,onRunQuery:p,runOnBlur:O,onChange:h}=e,f=null!==(t=e.query)&&void 0!==t?t:{};let b=null!==(r=f.queryType)&&void 0!==r?r:f.instant?l.E.Instant:l.E.Range;function y(e){const t=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(f,u);h(Object.assign({},t,{queryType:e}))}return(0,c.jsxs)("div",{"aria-label":"Loki extra field",className:"gf-form-inline",children:[(0,c.jsxs)("div",{"data-testid":"queryTypeField",className:(0,n.cx)("gf-form explore-input-margin",n.css`
            flex-wrap: nowrap;
          `),"aria-label":"Query type field",children:[a||(a=(0,c.jsx)(i.InlineFormLabel,{width:"auto",children:"Query type"})),(0,c.jsx)(i.RadioButtonGroup,{options:d,value:b,onChange:e=>{y(e),O&&p()}})]}),(0,c.jsxs)("div",{"data-testid":"lineLimitField",className:(0,n.cx)("gf-form",n.css`
            flex-wrap: nowrap;
          `),"aria-label":"Line limit field",children:[(0,c.jsx)(i.InlineField,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,c.jsx)(i.Input,{className:"width-4",placeholder:"auto",type:"number",min:0,onChange:function(e){f.maxLines!==g(e.currentTarget.value)&&function(e){const t=Object.assign({},f,{maxLines:g(e)});h(t)}(e.currentTarget.value)},onKeyDown:function(e){"Enter"===e.key&&p()},value:s,onBlur:()=>{O&&p()}})}),(0,c.jsx)(i.InlineField,{label:"Resolution",tooltip:"Resolution 1/1 sets step parameter of Loki metrics range queries such that each pixel corresponds to one data point. For better performance, lower resolutions can be picked. 1/2 only retrieves a data point for every other pixel, and 1/10 retrieves one data point per 10 pixels.",children:(0,c.jsx)(i.Select,{isSearchable:!1,onChange:function(e){const t=Object.assign({},f,{resolution:e.value});h(t)},options:m,value:o,"aria-label":"Select resolution",menuShouldPortal:!0})})]})]})}function g(e){return 0===e.length?NaN:e.length>0&&(isNaN(+e)||+e<0)?0:+e}},"./public/app/plugins/datasource/loki/module.ts":(e,t,r)=>{r.r(t),r.d(t,{plugin:()=>Jr});var a=r("./packages/grafana-data/src/index.ts"),n=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),s=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),i=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),o=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),l=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),c=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),d=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/switchMap.js"),p=r("../../opt/drone/yarncache/prismjs-npm-1.27.0-ca4e1667c6-85c7f4a3e9.zip/node_modules/prismjs/prism.js"),m=r.n(p),O=r("./packages/grafana-runtime/src/index.ts"),g=r("./public/app/features/templating/template_srv.ts"),h=r("./public/app/plugins/datasource/loki/syntax.ts"),f=r("./public/app/plugins/datasource/prometheus/promql.ts");const b=[...f.YO,...f.fP,...f.Os,...h.zy],y=/([A-Za-z:][\w:]*)\b(?![\]{=!",])/g;function v(e,t,r,a,n){if(!t||!r)throw new Error("Need label to add to query.");const s=r===1/0?"+Inf":r.toString();let i;e=e.replace(y,((t,r,a)=>{const s=function(e,t,r,a,n){const s=function(e,t,r,a){const n=e.slice(t).indexOf(r),s=e.slice(t).indexOf(a);return s>-1&&(-1===n||n>s)}(e,r,"{","}"),i=a&&f.fP.indexOf(a)>-1,o=t.endsWith(":"),l='"'===e[r-1],c="$"===e[r-1],u=["s","m","h","d","w"].includes(t)&&Boolean(Number(e[r-1]));if(!(n||s||o||i||l||c||u||-1!==b.indexOf(t)))return!0;return!1}(e,r,a,i,n);return i=r,s?`${r}{}`:r}));const o=/(\$)?{([^{]*)}/g,l=[];let c=0,u="",d=o.exec(e);for(;d;){const r=e.slice(c,d.index);if(c=d.index+d[2].length+2,u=e.slice(d.index+d[0].length),d[0].startsWith("{.")||d[1])l.push(r),l.push(d[0]);else{const e=Q(d[2],t,s,a);l.push(r,e)}d=o.exec(e)}return l.push(u),l.join("")}const x=/(\w+)\s*(=|!=|=~|!~)\s*("[^"]*")/g;function Q(e,t,r,a){const s=[];if(e){let t=x.exec(e);for(;t;)s.push({key:t[1],operator:t[2],value:t[3]}),t=x.exec(e)}const i=a||"=";s.push({key:t,operator:i,value:`"${r}"`});return`{${(0,n.chain)(s).uniqWith(n.isEqual).compact().sortBy("key").map((e=>{let{key:t,operator:r,value:a}=e;return`${t}${r}${a}`})).value().join(",")}}`}var P=r("./public/app/features/dashboard/services/TimeSrv.ts"),_=r("./public/app/core/utils/explore.ts"),j=r("../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/stringify.js"),R=r("../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/validate.js");const q=function(e){if(!(0,R.Z)(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r};function $(e,t,r,a){switch(e){case 0:return t&r^~t&a;case 1:case 3:return t^r^a;case 2:return t&r^t&a^r&a}}function L(e,t){return e<<t|e>>>32-t}var w=function(e,t,r){function a(e,a,n,s){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof a&&(a=q(a)),16!==a.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(a),i.set(e,a.length),(i=r(i))[6]=15&i[6]|t,i[8]=63&i[8]|128,n){s=s||0;for(var o=0;o<16;++o)n[s+o]=i[o];return n}return(0,j.Z)(i)}try{a.name=e}catch(e){}return a.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",a.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",a}("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var n=0;n<a.length;++n)e.push(a.charCodeAt(n))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var s=e.length/4+2,i=Math.ceil(s/16),o=new Array(i),l=0;l<i;++l){for(var c=new Uint32Array(16),u=0;u<16;++u)c[u]=e[64*l+4*u]<<24|e[64*l+4*u+1]<<16|e[64*l+4*u+2]<<8|e[64*l+4*u+3];o[l]=c}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var p=new Uint32Array(80),m=0;m<16;++m)p[m]=o[d][m];for(var O=16;O<80;++O)p[O]=L(p[O-3]^p[O-8]^p[O-14]^p[O-16],1);for(var g=r[0],h=r[1],f=r[2],b=r[3],y=r[4],v=0;v<80;++v){var x=Math.floor(v/20),Q=L(g,5)+$(x,h,f,b)+y+t[x]+p[v]>>>0;y=b,b=f,f=L(h,30)>>>0,h=g,g=Q}r[0]=r[0]+g>>>0,r[1]=r[1]+h>>>0,r[2]=r[2]+f>>>0,r[3]=r[3]+b>>>0,r[4]=r[4]+y>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]}));const T=w;var S=r("./public/app/core/table_model.ts"),k=r("./public/app/plugins/datasource/loki/types.ts");const F=["instant","range"],E=["instant","range"],C=["instant","range"];function X(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}function I(e){return`${e||""}`.trim()}function U(e){let t=e;const r=[];for(;t;){const e=t.search(/\|=|\|~|!=|!~/);if(-1===e)break;const a=t.slice(e,e+2),s=0===t.slice(e).search(/!=|!~/);if(t=t.slice(e+2),s)continue;const i=t.search(/\|=|\|~|!=|!~/);let o;-1===i?o=t.trim():(o=t.slice(0,i).trim(),t=t.slice(i));const l=o.match(/"(.*?)"/),c=o.match(/`(.*?)`/),u=l||c;if(!u)return r;{const e=u[1];"|~"===a?r.push(c?e:e.replace(/\\\\/g,"\\")):r.push((0,n.escapeRegExp)(e))}}return r}function N(e){if(void 0!==e.queryType){return X(e,F)}if(!0===e.instant){const t=X(e,E);return Object.assign({},t,{queryType:k.E.Instant})}const t=X(e,C);return Object.assign({},t,{queryType:k.E.Range})}var z=r("./public/app/plugins/datasource/prometheus/legend.ts");function Y(e,t,r){const n=e.stream,s=Object.entries(n).map((e=>{let[t,r]=e;return`${t}="${r}"`})).sort().join(""),i=new a.ArrayVector([]),o=new a.ArrayVector([]),l=new a.ArrayVector([]),c=new a.ArrayVector([]),u={};for(const[t,a]of e.values)i.add(new Date(parseInt(t.slice(0,-6),10)).toISOString()),o.add(t),l.add(a),c.add(V(t,s,a,u,r));return function(e,t,r,n,s,i,o){const l={refId:o,fields:[{name:"ts",type:a.FieldType.time,config:{displayName:"Time"},values:e},{name:"line",type:a.FieldType.string,config:{},values:r,labels:s},{name:"id",type:a.FieldType.string,config:{},values:n},{name:"tsNs",type:a.FieldType.time,config:{displayName:"Time ns"},values:t}],length:e.length};if(i){const e=new a.MutableDataFrame(l);return e.reverse(),e}return l}(i,o,l,c,n,t,r)}function V(e,t,r,a,n){let s=T(`${e}_${t}_${r}`,"6ec946da-0f49-47a8-983a-1d76d17e7c92");if(s in a){const e=a[s]+1;a[s]=e,s=`${s}_${e}`}else a[s]=0;return n?`${s}_${n}`:s}function D(e,t){const r=function(e,t){var r;let a=void 0===t||(0,n.isEmpty)(t.legendFormat)?function(e){const t=Object.entries(e).map((e=>`${e[0]}="${e[1]}"`)).join(",");return`{${t}}`}(e):(0,z.W)((0,O.getTemplateSrv)().replace(null!==(r=t.legendFormat)&&void 0!==r?r:"",t.scopedVars),e);!a&&t&&(a=t.query);return a}(e.metric,t);return{target:r,title:r,datapoints:M(e.values),tags:e.metric,meta:t.meta,refId:t.refId}}function G(e){switch(e){case"+Inf":return Number.POSITIVE_INFINITY;case"-Inf":return Number.NEGATIVE_INFINITY;default:return parseFloat(e)}}function M(e){const t=[];for(const[r,a]of e){let e=G(a);isNaN(e)&&(e=null);const n=1e3*r;t.push([e,n])}return t}function A(e,t,r,n,s){if(!e||0===e.length)return new S.Z;const i=[...new Set(e.reduce(((e,t)=>e.concat(Object.keys(t.metric))),[])).values()].sort(),o=new S.Z;return o.refId=r,o.meta=n,o.columns=[{text:"Time",type:a.FieldType.time},...i.map((e=>({text:e,filterable:!0,type:a.FieldType.string}))),{text:t>1||s?`Value #${r}`:"Value",type:a.FieldType.number}],e.forEach((e=>{const t={metric:e.metric,values:e.value?[e.value]:e.values};t.values&&(t.metric?o.rows.push(...t.values.map((e=>{let[r,a]=e;return[1e3*r,...i.map((e=>t.metric[e]||"")),parseFloat(a)]}))):o.rows.concat(t.values.map((e=>{let[t,r]=e;return[1e3*t,parseFloat(r)]}))))})),o}function B(e){const t=[];if(!e)return t;for(const a in e){const s=e[a];for(const e in s){const i=s[e];let o;/time/i.test(e)&&i?o="s":/bytes.*persecond/i.test(e)?o="Bps":/bytes/i.test(e)&&(o="decbytes");const l=`${(0,n.capitalize)(a)}: ${r=e,r.replace(/[A-Z]/g,(e=>` ${e.toLowerCase()}`))}`;t.push({displayName:l,value:i,unit:o})}}var r;return t}function W(e,t,r,a){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=r>0?e.data.result:[],i=B(e.data.stats),o={lokiQueryStatKey:"Summary: total bytes processed"},l={searchWords:U(I(t.expr)),limit:r,stats:i,custom:o,preferredVisualisationType:"logs"},c=s.map((e=>{const r=Y(e,n,t.refId);return K(r,a),l.custom&&r.fields.some((e=>e.labels&&Object.keys(e.labels).some((e=>"__error__"===e))))&&(l.custom.error="Error when parsing some of the logs"),Object.assign({},r,{refId:t.refId,meta:l})}));return i.length&&!s.length?[{fields:[],length:0,refId:t.refId,meta:l}]:c}const K=(e,t)=>{var r;if(!t)return;const s=null!==(r=t.derivedFields)&&void 0!==r?r:[];if(!s.length)return;const i=(0,n.groupBy)(s,"name"),o=Object.values(i).map(Z);new a.DataFrameView(e).forEach((e=>{for(const t of o){const r=e.line.match(i[t.name][0].matcherRegex);t.values.add(r&&r[1])}})),e.fields=[...e.fields,...o]};function Z(e){const t=(0,O.getDataSourceSrv)(),r=e.reduce(((e,r)=>{if(r.datasourceUid){var a;const n=t.getInstanceSettings(r.datasourceUid);e.push({title:r.urlDisplayLabel||"",url:"",internal:{query:{query:r.url},datasourceUid:r.datasourceUid,datasourceName:null!==(a=null==n?void 0:n.name)&&void 0!==a?a:"Data source not found"}})}else r.url&&e.push({title:r.urlDisplayLabel||"",url:r.url});return e}),[]);return{name:e[0].name,type:a.FieldType.string,config:{links:r},values:new a.ArrayVector([])}}function H(e,t,r,n,s){const i=function(e,t,r,a,n){var s;const i={format:r.format,legendFormat:null!==(s=r.legendFormat)&&void 0!==s?s:"",start:t.start,end:t.end,step:t.step,query:t.query,responseListLength:a,refId:r.refId,meta:{preferredVisualisationType:"graph"},valueWithRefId:r.valueWithRefId,scopedVars:n};switch(e.data.resultType){case k.o.Vector:return e.data.result.map((e=>D({metric:e.metric,values:[e.value]},i)));case k.o.Matrix:return e.data.result.map((e=>D(e,i)));default:return[]}}(e,t,r,n,s),o=i.map((e=>(0,a.toDataFrame)(e))),{step:l}=t;if(null!=l){const e=1e3*l;o.forEach((t=>{t.fields.forEach((t=>{t.type===a.FieldType.time&&(t.config.interval=e)}))}))}return o}function J(e,t,r,a,n,s,i){let l=arguments.length>7&&void 0!==arguments[7]&&arguments[7];switch(e.data.resultType){case k.o.Stream:return(0,o.of)({data:W(e,t,n,s,l),key:`${t.refId}_log`});case k.o.Vector:case k.o.Matrix:return(0,o.of)({data:H(e,r,Object.assign({},t,{format:"time_series"}),a,i),key:t.refId});default:throw new Error(`Unknown result type "${e.data.resultType}".`)}}function ee(e){const t=e.filter((e=>void 0!==e.refId)),r=(0,n.groupBy)(t,(e=>e.refId));return Object.entries(r).map((e=>{let[t,r]=e;return function(e,t){const r={name:"Time",config:{},values:new a.ArrayVector,type:a.FieldType.time},n={name:`Value #${t}`,config:{},values:new a.ArrayVector,type:a.FieldType.number},s=new Set(e.map((e=>e.fields.map((e=>{var t;return Object.keys(null!==(t=e.labels)&&void 0!==t?t:{})})).flat())).flat()),i=Array.from(s).sort().map((e=>({name:e,config:{filterable:!0},values:new a.ArrayVector,type:a.FieldType.string})));return e.forEach((e=>{var t;const s=e.fields.find((e=>e.type===a.FieldType.time)),o=e.fields.find((e=>e.type===a.FieldType.number));if(null==s||null==o)return;const l=s.values.toArray(),c=o.values.toArray();for(let e of l)r.values.add(e);for(let e of c)n.values.add(e);const u=null!==(t=o.labels)&&void 0!==t?t:{};for(let e of i){var d;const t=null!==(d=u[e.name])&&void 0!==d?d:"";for(let r=0;r<c.length;r++)e.values.add(t)}})),{fields:[r,...i,n],refId:t,meta:{preferredVisualisationType:"table"},length:r.values.length}}(r,t)}))}function te(e,t,r){var a;const n=T(e,"6ec946da-0f49-47a8-983a-1d76d17e7c92"),s=null!==(a=t.get(n))&&void 0!==a?a:0,i=s>0?`${n}_${s}`:n;return t.set(n,s+1),void 0!==r?`${i}_${r}`:i}const re=["meta"],ae=["data"];function ne(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}function se(e,t){const{meta:r}=e,a=ne(e,re),n=Object.assign({},r,t);return Object.assign({},a,{meta:n})}function ie(e,t){const r=se(e,{preferredVisualisationType:"logs",searchWords:void 0!==t?U(I(t.expr)):void 0,custom:{lokiQueryStatKey:"Summary: total bytes processed"}}),n=e.fields.map((e=>"tsNs"===e.name?Object.assign({},e,{type:a.FieldType.time}):e));return n.push(function(e){const t={};e.fields.forEach((e=>{Object.assign(t,e.labels)}));const r=Object.entries(t).map((e=>{let[t,r]=e;return`${t}="${r}"`})).sort().join(""),n=new Map,{length:s}=e,i=new Array(s);for(let t=0;t<s;t++){const a=e.fields.map((e=>String(e.values.get(t)))),s=te(`${r}_${a.join("_")}`,n,e.refId);i[t]=s}return{name:"id",type:a.FieldType.string,config:{},values:new a.ArrayVector(i)}}(e)),Object.assign({},r,{fields:n})}function oe(e,t){return e.map((e=>ie(e,void 0!==e.refId?t.get(e.refId):void 0)))}function le(e){const t={preferredVisualisationType:"graph"};return e.map((e=>se(e,t)))}function ce(e,t){const r=[],n=[],s=[];return e.forEach((e=>{if(function(e){return e.fields.every((e=>e.type===a.FieldType.time||e.type===a.FieldType.number))}(e)){var i;null!=e.refId&&(null===(i=t.get(e.refId))||void 0===i?void 0:i.queryType)===k.E.Instant?n.push(e):s.push(e)}else r.push(e)})),{streamsFrames:r,metricInstantFrames:n,metricRangeFrames:s}}var ue=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/timer.js"),de=r("../../opt/drone/yarncache/tslib-npm-2.3.1-0e21e18015-de17a98d46.zip/node_modules/tslib/tslib.es6.js"),pe=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/Subject.js"),me=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/Subscriber.js"),Oe=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/Observable.js"),ge=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/Subscription.js"),he=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/ReplaySubject.js"),fe={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},be=function(e){function t(t,r){var a=e.call(this)||this;if(a._socket=null,t instanceof Oe.y)a.destination=r,a.source=t;else{var n=a._config=(0,de.__assign)({},fe);if(a._output=new pe.x,"string"==typeof t)n.url=t;else for(var s in t)t.hasOwnProperty(s)&&(n[s]=t[s]);if(!n.WebSocketCtor&&WebSocket)n.WebSocketCtor=WebSocket;else if(!n.WebSocketCtor)throw new Error("no WebSocket constructor can be found");a.destination=new he.t}return a}return(0,de.__extends)(t,e),t.prototype.lift=function(e){var r=new t(this._config,this.destination);return r.operator=e,r.source=this,r},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new he.t),this._output=new pe.x},t.prototype.multiplex=function(e,t,r){var a=this;return new Oe.y((function(n){try{a.next(e())}catch(e){n.error(e)}var s=a.subscribe({next:function(e){try{r(e)&&n.next(e)}catch(e){n.error(e)}},error:function(e){return n.error(e)},complete:function(){return n.complete()}});return function(){try{a.next(t())}catch(e){n.error(e)}s.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,r=t.WebSocketCtor,a=t.protocol,n=t.url,s=t.binaryType,i=this._output,o=null;try{o=a?new r(n,a):new r(n),this._socket=o,s&&(this._socket.binaryType=s)}catch(e){return void i.error(e)}var l=new ge.w0((function(){e._socket=null,o&&1===o.readyState&&o.close()}));o.onopen=function(t){if(!e._socket)return o.close(),void e._resetState();var r=e._config.openObserver;r&&r.next(t);var a=e.destination;e.destination=me.Lv.create((function(t){if(1===o.readyState)try{var r=e._config.serializer;o.send(r(t))}catch(t){e.destination.error(t)}}),(function(t){var r=e._config.closingObserver;r&&r.next(void 0),t&&t.code?o.close(t.code,t.reason):i.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),o.close(),e._resetState()})),a&&a instanceof he.t&&l.add(a.subscribe(e.destination))},o.onerror=function(t){e._resetState(),i.error(t)},o.onclose=function(t){o===e._socket&&e._resetState();var r=e._config.closeObserver;r&&r.next(t),t.wasClean?i.complete():i.error(t)},o.onmessage=function(t){try{var r=e._config.deserializer;i.next(r(t))}catch(e){i.error(e)}}},t.prototype._subscribe=function(e){var t=this,r=this.source;return r?r.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;!t||1!==t.readyState&&0!==t.readyState||t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(pe.u);var ye=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/retryWhen.js"),ve=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),xe=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/finalize.js");class Qe{constructor(){var e,t,r;r={},(t="streams")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}getStream(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,r=this.streams[e.url];if(r)return r;const n=new a.CircularDataFrame({capacity:e.size});var i;return n.addField({name:"ts",type:a.FieldType.time,config:{displayName:"Time"}}),n.addField({name:"tsNs",type:a.FieldType.time,config:{displayName:"Time ns"}}),n.addField({name:"line",type:a.FieldType.string}).labels=(0,a.parseLabels)(e.query),n.addField({name:"labels",type:a.FieldType.other}),n.addField({name:"id",type:a.FieldType.string}),n.meta=Object.assign({},n.meta,{preferredVisualisationType:"logs"}),n.refId=e.refId,r=(i=e.url,new be(i)).pipe((0,c.U)((e=>(function(e,t){const r=e.streams;if(!r||!r.length)return;let n={};for(const e of t.fields)if(e.type===a.FieldType.string){e.labels&&(n=e.labels);break}const s=t.fields[0],i=t.fields[1],o=t.fields[2],l=t.fields[3],c=t.fields[4],u={};for(const e of r){const r=(0,a.findUniqueLabels)(e.stream,n),d=Object.entries(e.stream).map((e=>{let[t,r]=e;return`${t}="${r}"`})).sort().join("");for(const[a,n]of e.values)s.values.add(new Date(parseInt(a.slice(0,-6),10)).toISOString()),i.values.add(a),o.values.add(n),l.values.add(r),c.values.add(V(a,d,n,u,t.refId))}}(e,n),[n]))),(0,ye.a)((e=>e.pipe((0,ve.z)(((e,r)=>{const a=r+1;return 1006===e.code&&a<30?(a>10&&console.warn(`Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: ${e.reason}`),(0,ue.H)(t)):(0,s._)(e)}))))),(0,xe.x)((()=>{delete this.streams[e.url]}))),this.streams[e.url]=r,r}}var Pe=r("../../opt/drone/yarncache/lru-cache-npm-7.7.1-726274dc4d-f362c5a2cf.zip/node_modules/lru-cache/index.js"),_e=r.n(Pe),je=r("./public/app/plugins/datasource/prometheus/language_utils.ts");function Re(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const qe=["job","namespace"],$e="{}",Le=[{label:"$__interval",sortValue:"$__interval"},{label:"$__range",sortValue:"$__range"},{label:"1m",sortValue:"00:01:00"},{label:"5m",sortValue:"00:05:00"},{label:"10m",sortValue:"00:10:00"},{label:"30m",sortValue:"00:30:00"},{label:"1h",sortValue:"01:00:00"},{label:"1d",sortValue:"24:00:00"}],we=e=>({label:e,filterText:`"${e}"`});class Te extends a.LanguageProvider{constructor(e,t){super(),Re(this,"labelKeys",void 0),Re(this,"labelFetchTs",void 0),Re(this,"started",!1),Re(this,"datasource",void 0),Re(this,"lookupsDisabled",!1),Re(this,"seriesCache",new(_e())({max:10})),Re(this,"labelsCache",new(_e())({max:10})),Re(this,"cleanText",(e=>e.replace(/[{}[\]="(),!~+\-*/^%\|]/g,"").trim())),Re(this,"request",(async(e,t)=>{try{return await this.datasource.metadataRequest(e,t)}catch(e){console.error(e)}})),Re(this,"start",(()=>(this.startTask||(this.startTask=this.fetchLabels().then((()=>(this.started=!0,[])))),this.startTask))),Re(this,"getBeginningCompletionItems",(e=>({suggestions:[...this.getEmptyCompletionItems(e).suggestions,...this.getTermCompletionItems().suggestions]}))),Re(this,"getTermCompletionItems",(()=>{const e=[];return e.push({prefixMatch:!0,label:"Functions",items:h.r8.map((e=>Object.assign({},e,{kind:"function"})))}),{suggestions:e}})),Re(this,"getPipeCompletionItem",(()=>{const e=[];return e.push({label:"Operators",items:h.Rd.map((e=>Object.assign({},e,{kind:"operators"})))}),e.push({label:"Parsers",items:h.uR.map((e=>Object.assign({},e,{kind:"parsers"})))}),{suggestions:e}})),Re(this,"fetchSeriesLabels",(async e=>{const t=this.datasource.interpolateString(e),r="/loki/api/v1/series",{start:a,end:n}=this.datasource.getTimeRangeParams(),s=this.generateCacheKey(r,a,n,t);let i=this.seriesCache.get(s);if(!i){this.seriesCache.set(s,{});const e={"match[]":t,start:a,end:n},o=await this.request(r,e),{values:l}=(0,je.DY)(o);i=l,this.seriesCache.set(s,i)}return i})),Re(this,"fetchSeries",(async e=>{const{start:t,end:r}=this.datasource.getTimeRangeParams(),a={"match[]":e,start:t,end:r};return await this.request("/loki/api/v1/series",a)})),this.datasource=e,this.labelKeys=[],this.labelFetchTs=0,Object.assign(this,t)}getSyntax(){return h.ZP}getLabelKeys(){return this.labelKeys}async provideCompletionItems(e,t){const{wrapperClasses:r,value:a,prefix:n,text:s}=e,i={suggestions:[]};if(!a)return i;const o=0===(null==a?void 0:a.document.text.length),l=a.document.getTextsAtRange(a.selection),c=1===l.size?l.first().getText():null,u=c?c[a.selection.anchor.offset]:null,d=r.length>3,p=n&&!d,m=!u||")"===u,O=n&&!s.match(/^['"~=\]})\s]+$/)&&m,g=s.match(/[+\-*/^%]/);return r.includes("context-range")?this.getRangeCompletionItems():r.includes("context-labels")?await this.getLabelCompletionItems(e):r.includes("context-pipe")?this.getPipeCompletionItem():o?this.getEmptyCompletionItems(t):p&&m&&!g?this.getBeginningCompletionItems(t):p&&O?this.getTermCompletionItems():i}getEmptyCompletionItems(e){const t=null==e?void 0:e.history,r=[];if(null!=t&&t.length){const e=(0,n.chain)(t).map((e=>e.query.expr)).filter().uniq().take(10).map(we).map((e=>function(e,t){const r=Date.now()-864e5,n=t.filter((t=>t.ts>r&&t.query.expr===e.label));let s=`Queried ${n.length} times in the last 24h.`;const i=n[0];i&&(s=`${s} Last queried ${(0,a.dateTime)(i.ts).fromNow()}.`);return Object.assign({},e,{documentation:s})}(e,t))).value();r.push({prefixMatch:!0,skipSort:!0,label:"History",items:e})}return{suggestions:r}}getRangeCompletionItems(){return{context:"context-range",suggestions:[{label:"Range vector",items:[...Le]}]}}async getLabelCompletionItems(e){let{text:t,wrapperClasses:r,labelKey:a,value:s}=e,i="context-labels";const o=[];if(!s)return{context:i,suggestions:[]};const l=s.anchorBlock.getText(),c=s.selection.anchor.offset,u=t.match(/^(=|=~|!=|!~)/);let d,p;try{p=(0,je.rV)(l,c),d=p.selector}catch{d=$e}if(!a&&d===$e){await this.start();return{context:i,suggestions:[{label:"Labels",items:this.getLabelKeys().map(we)}]}}const m=p?p.labelKeys:[];let O;if(d)if(d===$e&&a){O={[a]:await this.getLabelValues(a)}}else O=await this.getSeriesLabels(d);if(!O)return console.warn(`Server did not return any values for selector = ${d}`),{context:i,suggestions:o};if(t&&u||r.includes("attr-value"))a&&O[a]&&(i="context-label-values",o.push({label:`Label values for "${a}"`,items:O[a].map(we).filter((e=>{let{filterText:r}=e;return r!==t}))}));else{const e=O?Object.keys(O):qe;if(e){const t=(0,n.difference)(e,m);if(t.length){const e={label:"Labels",items:t.map((e=>({label:e})))};o.push(e)}}}return{context:i,suggestions:o}}importFromAbstractQuery(e){return{refId:e.refId,expr:(0,je.PL)(e),queryType:k.E.Range}}exportToAbstractQuery(e){const t=e.expr;if(!t||0===t.length)return{refId:e.refId,labelMatchers:[]};const r=m().tokenize(t,h.ZP);return{refId:e.refId,labelMatchers:(0,je.UO)(r)}}async getSeriesLabels(e){if(!this.lookupsDisabled)try{return await this.fetchSeriesLabels(e)}catch(e){return void console.error(e)}}async fetchLabels(){const e=this.datasource.getTimeRangeParams();this.labelFetchTs=Date.now().valueOf();const t=await this.request("/loki/api/v1/label",e);if(Array.isArray(t)){const e=t.slice().sort().filter((e=>"__name__"!==e));this.labelKeys=e}return[]}async refreshLogLabels(e){(this.labelKeys&&Date.now().valueOf()-this.labelFetchTs>3e4||e)&&await this.fetchLabels()}generateCacheKey(e,t,r,a){return[e,this.roundTime(t),this.roundTime(r),a].join()}roundTime(e){return e?Math.floor(e/1e6/1e3/60/5):0}async getLabelValues(e){return await this.fetchLabelValues(e)}async fetchLabelValues(e){var t;const r=this.datasource.interpolateString(e),a=`/loki/api/v1/label/${r}/values`,n=this.datasource.getTimeRangeParams(),{start:s,end:i}=n,o=this.generateCacheKey(a,s,i,r),l={start:s,end:i};let c=this.labelsCache.get(o);if(!c){this.labelsCache.set(o,[]);const e=await this.request(a,l);Array.isArray(e)&&(c=e.slice().sort(),this.labelsCache.set(o,c))}return null!==(t=c)&&void 0!==t?t:[]}}var Se=r("./public/app/core/utils/fetch.ts"),ke=r("./public/app/plugins/datasource/loki/components/LokiOptionFields.tsx"),Fe=r("./public/app/core/logs_model.ts"),Ee=r("../../opt/drone/yarncache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/defer.js"),Ce=r("./public/app/features/live/data/StreamingDataFrame.ts");function Xe(e,t,r){var n;const s=r.range,i=s.to.valueOf()-s.from.valueOf()+1e3;let o,l=null!==(n=r.maxDataPoints)&&void 0!==n?n:1e3;l>100&&(l*=2);const u=t=>{if(null!=t&&t.message){const r=t.message;o?o.push(r):o=Ce.Av.fromDataFrameJSON(r,{maxLength:l,maxDelta:i,displayNameFormat:e.legendFormat})}return o};return(0,Ee.P)((()=>async function(e){const t=JSON.stringify({expr:e.expr}),r=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-1",r);return Array.from(new Uint8Array(a.slice(0,8))).map((e=>e.toString(16).padStart(2,"0"))).join("")}(e))).pipe((0,ve.z)((r=>(0,O.getGrafanaLiveSrv)().getStream({scope:a.LiveChannelScope.DataSource,namespace:t.uid,path:`tail/${r}`,data:Object.assign({},e,{timeRange:{from:s.from.valueOf().toString(),to:s.to.valueOf().toString()}})}).pipe((0,c.U)((e=>{const t=u(e);return{data:t?[t]:[],state:a.LoadingState.Streaming}}))))))}const Ie=["__interval","__interval_ms"];function Ue(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ne=1e6,ze="/loki/api/v1/query_range",Ye="/loki/api/v1/query",Ve={direction:"BACKWARD",limit:1e3,query:""};class De extends O.DataSourceWithBackend{constructor(e){var t,r;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.J)(),l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,P.$t)();super(e),t=this,Ue(this,"streams",new Qe),Ue(this,"languageProvider",void 0),Ue(this,"maxLines",void 0),Ue(this,"runInstantQuery",(function(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const n=t.getTime(r.range.to,!0),i=Ae(e.expr)?r.maxDataPoints:e.maxLines,o={query:e.expr,time:`${n+(1e9-n%1e9)}`,limit:Math.min(i||1/0,t.maxLines)},l={preferredVisualisationType:"table"};return t._request(Ye,o).pipe((0,c.U)((r=>r.data.data.resultType===k.o.Stream?{data:r.data?W(r.data,e,o.limit,t.instanceSettings.jsonData):[],key:`${e.refId}_instant`}:{data:[A(r.data.data.result,a,e.refId,l,!0)],key:`${e.refId}_instant`})),(0,u.K)((r=>(0,s._)((()=>t.processError(r,e))))))})),Ue(this,"runRangeQuery",(function(e,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=Ae(e.expr)?r.maxDataPoints||t.maxLines:e.maxLines||t.maxLines;if(r.liveStreaming)return t.runLiveQuery(e,n);const i=t.createRangeQuery(e,r,n),o=e.volumeQuery?{"X-Query-Tags":"Source=logvolhist"}:void 0;return t._request(ze,i,{headers:o}).pipe((0,u.K)((r=>(0,s._)((()=>t.processError(r,e))))),(0,d.w)((s=>J(s.data,e,i,a,n,t.instanceSettings.jsonData,r.scopedVars,r.reverse))))})),Ue(this,"runLiveQuery",((e,t)=>{const r=this.createLiveTarget(e,t);return this.streams.getStream(r).pipe((0,c.U)((e=>({data:e||[],key:`loki-${r.refId}`,state:a.LoadingState.Streaming}))),(0,u.K)((e=>(0,s._)((()=>`Live tailing was stopped due to following error: ${e.reason}`)))))})),Ue(this,"getLogRowContext",((e,t)=>{const r=this.prepareLogRowContextQueryTarget(e,t&&t.limit||10,t&&t.direction||"BACKWARD"),a=t&&"FORWARD"===t.direction;return(0,i.n)(this._request(ze,r).pipe((0,u.K)((e=>{throw{message:"Error during context query. Please check JS console logs.",status:e.status,statusText:e.statusText}})),(0,d.w)((e=>(0,o.of)({data:e.data?e.data.data.result.map((e=>Y(e,a))):[]})))))})),Ue(this,"prepareLogRowContextQueryTarget",((e,t,r)=>{const n=this.languageProvider.getLabelKeys(),s=Object.keys(e.labels).map((t=>n.includes(t)?`${t}="${e.labels[t].replace(/\\/g,"\\\\")}"`:"")).filter((e=>!!e)).join(","),i=72e5,o={limit:t,query:`{${s}}`,expr:`{${s}}`,direction:r},l=new a.FieldCache(e.dataFrame).getFieldByName("tsNs").values.get(e.rowIndex);return"BACKWARD"===r?Object.assign({},o,{start:e.timeEpochMs-i+"000000",end:l,direction:r}):Object.assign({},o,{start:l,end:e.timeEpochMs+i+"000000"})})),this.instanceSettings=e,this.templateSrv=n,this.timeSrv=l,this.instanceSettings=e,this.templateSrv=n,this.timeSrv=l,this.languageProvider=new Te(this);const p=e.jsonData||{};this.maxLines=parseInt(null!==(r=p.maxLines)&&void 0!==r?r:"0",10)||1e3}_request(e,t,r){const a=this.instanceSettings.url,n=t?(0,Se.tW)(t):"",s=`${a}${e}${n.length?`?${n}`:""}`;(this.instanceSettings.withCredentials||this.instanceSettings.basicAuth)&&(r=Object.assign({},r,{withCredentials:!0}),this.instanceSettings.basicAuth&&(r.headers=Object.assign({},r.headers,{Authorization:this.instanceSettings.basicAuth})));const i=Object.assign({},r,{url:s});return(0,O.getBackendSrv)().fetch(i)}getLogsVolumeDataProvider(e){if(!e.targets.some((e=>e.expr&&!Ae(e.expr))))return;const t=(0,n.cloneDeep)(e);return t.targets=t.targets.filter((e=>e.expr&&!Ae(e.expr))).map((e=>Object.assign({},e,{instant:!1,volumeQuery:!0,expr:`sum by (level) (count_over_time(${e.expr}[$__interval]))`}))),(0,Fe.Bz)(this,t,{extractLevel:Be,range:e.range,targets:e.targets})}query(e){const t=[],r=Object.assign({},e.scopedVars,this.getRangeScopedVars(e.range));if(O.config.featureToggles.lokiBackendMode&&e.app===a.CoreApp.Explore){const t=Object.assign({},e,{targets:e.targets.map(N)});return super.query(t).pipe((0,c.U)((e=>function(e,t){const{data:r}=e,n=ne(e,ae),s=r.map((e=>{if(!(0,a.isDataFrame)(e))throw new Error("transformation only supports dataframe responses");return e})),i=new Map(t.targets.map((e=>[e.refId,e]))),{streamsFrames:o,metricInstantFrames:l,metricRangeFrames:c}=ce(s,i);return Object.assign({},n,{data:[...le(c),...(u=l,u.length>0?ee(u):[]),...oe(o,i)]});var u}(e,t))))}const s=e.targets.filter((e=>e.expr&&!e.hide)).map((e=>{const t=this.addAdHocFilters(e.expr);return Object.assign({},e,{expr:this.templateSrv.replace(t,r,this.interpolateQueryExpr)})}));for(const r of s){var i;r.instant||r.queryType===k.E.Instant?t.push(this.runInstantQuery(r,e,s.length)):O.config.featureToggles.lokiLive&&r.queryType===k.E.Stream&&"now"===(null===(i=e.rangeRaw)||void 0===i?void 0:i.to)?t.push(Xe(r,this,e)):t.push(this.runRangeQuery(r,e,s.length))}return(0,n.isEmpty)(t)?(0,o.of)({data:[],state:a.LoadingState.Done}):(0,l.T)(...t)}createRangeQuery(e,t,r){const a=e.expr;let n={};if(t.range){const r=this.getTime(t.range.from,!1),a=this.getTime(t.range.to,!0),s=Math.ceil((a-r)/1e6),i=e.resolution||ke.TQ.value,o=this.adjustInterval(t.intervalMs||1e3,i,s)/1e3;n={start:r,end:a,step:Math.ceil(1e3*o)/1e3}}return Object.assign({},Ve,n,{query:a,limit:r})}createLiveTarget(e,t){const r=e.expr,a=this.instanceSettings.url,n=(0,Se.tW)({query:r});return{query:r,url:(0,_.F3)(`${a}/loki/api/v1/tail?${n}`),refId:e.refId,size:t}}getRangeScopedVars(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeSrv.timeRange();const t=e.to.diff(e.from),r=Math.round(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:r,value:r},__range:{text:r+"s",value:r+"s"}}}interpolateVariablesInQueries(e,t){let r=e;return e&&e.length&&(r=e.map((e=>Object.assign({},e,{datasource:this.getRef(),expr:this.templateSrv.replace(e.expr,t,this.interpolateQueryExpr)})))),r}getQueryDisplayText(e){return e.expr}getTimeRangeParams(){const e=this.timeSrv.timeRange();return{start:e.from.valueOf()*Ne,end:e.to.valueOf()*Ne}}async importFromAbstractQueries(e){await this.languageProvider.start();const t=this.languageProvider.labelKeys;return t&&t.length&&(e=e.map((e=>(e.labelMatchers=e.labelMatchers.filter((e=>t.includes(e.name))),e)))),e.map((e=>this.languageProvider.importFromAbstractQuery(e)))}async exportToAbstractQueries(e){return e.map((e=>this.languageProvider.exportToAbstractQuery(e)))}async metadataRequest(e,t){const r=await(0,i.n)(this._request(e,t,{hideFromInspector:!0}));return r.data.data||r.data.values||[]}async metricFindQuery(e){if(!e)return Promise.resolve([]);const t=this.templateSrv.replace(e,{},this.interpolateQueryExpr);return await this.processMetricFindQuery(t)}async processMetricFindQuery(e){if(e.match(/^label_names\(\)\s*$/))return await this.labelNamesQuery();const t=e.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/);return t?t[1]?await this.labelValuesSeriesQuery(t[1],t[2]):await this.labelValuesQuery(t[2]):Promise.resolve([])}async labelNamesQuery(){const e=this.getTimeRangeParams();return(await this.metadataRequest("/loki/api/v1/label",e)).map((e=>({text:e})))}async labelValuesQuery(e){const t=this.getTimeRangeParams(),r=`/loki/api/v1/label/${e}/values`;return(await this.metadataRequest(r,t)).map((e=>({text:e})))}async labelValuesSeriesQuery(e,t){const r=this.getTimeRangeParams(),a=Object.assign({},r,{"match[]":e}),n=new Set;return(await this.metadataRequest("/loki/api/v1/series",a)).forEach((e=>{e[t]&&n.add({text:e[t]})})),Array.from(n)}async getTagKeys(){return await this.labelNamesQuery()}async getTagValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return await this.labelValuesQuery(e.key)}interpolateQueryExpr(e,t){if(!t.multi&&!t.includeAll)return Ge(e);if("string"==typeof e)return Me(e);return(0,n.map)(e,Me).join("|")}modifyQuery(e,t){var r;let a=null!==(r=e.expr)&&void 0!==r?r:"";switch(t.type){case"ADD_FILTER":a=this.addLabelToQuery(a,t.key,t.value,"=");break;case"ADD_FILTER_OUT":a=this.addLabelToQuery(a,t.key,t.value,"!=")}return Object.assign({},e,{expr:a})}getTime(e,t){return"string"==typeof e&&(e=a.dateMath.parse(e,t)),Math.ceil(1e6*e.valueOf())}testDatasource(){const e=`${Date.now()-6e5}000000`;return(0,i.n)(this._request("/loki/api/v1/label",{start:e}).pipe((0,c.U)((e=>{var t,r;return((null==e||null===(t=e.data)||void 0===t?void 0:t.data)||(null==e||null===(r=e.data)||void 0===r?void 0:r.values)||[]).length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that Loki and Promtail is configured properly."}})),(0,u.K)((e=>{let t="Loki: ";return e.statusText?t+=e.statusText:t+="Cannot connect to Loki",e.status&&(t+=`. ${e.status}`),e.data&&e.data.message?t+=`. ${e.data.message}`:e.data&&(t+=`. ${e.data}`),(0,o.of)({status:"error",message:t})}))))}async annotationQuery(e){const{expr:t,maxLines:r,instant:n,stepInterval:s,tagKeys:o="",titleFormat:l="",textFormat:c=""}=e.annotation;if(!t)return[];const u=this.templateSrv.replace(t,{},this.interpolateQueryExpr),d={refId:`annotation-${e.annotation.name}`,expr:u,maxLines:r,instant:n,stepInterval:s,queryType:n?k.E.Instant:k.E.Range},{data:p}=n?await(0,i.n)(this.runInstantQuery(d,e)):await(0,i.n)(this.runRangeQuery(d,e)),m=[],O=o.split(",").filter((e=>""!==e));for(const e of p){const t={};for(const r of e.fields)if(r.labels)for(const[e,a]of Object.entries(r.labels))t[e]=String(a).trim();const r=[...new Set(Object.entries(t).reduce(((e,t)=>{let[r,a]=t;return""===a||O.length&&!O.includes(r)||e.push.apply(e,[a]),e}),[]))];new a.DataFrameView(e).forEach((e=>{m.push({time:new Date(e.ts).valueOf(),title:(0,z.W)(l,t),text:(0,z.W)(c,t)||e.line,tags:r})}))}return m}showContextToggle(e){return!0===(e&&e.searchWords&&e.searchWords.length>0)}processError(e,t){let r=(0,n.cloneDeep)(e);return e.data.message.includes("escape")&&t.expr.includes("\\")&&(r.data.message=`Error: ${e.data.message}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`),r}adjustInterval(e,t,r){let a=r/11e3;return a>1&&(a=Math.ceil(a)),Math.max(t*e,a)}addAdHocFilters(e){let t=e;return t=this.templateSrv.getAdhocFilters(this.name).reduce(((e,t)=>{const{key:r,operator:a}=t;let{value:n}=t;return"=~"!==a&&"!~"!==a||(n=Ge(n)),this.addLabelToQuery(e,r,n,a,!0)}),t),t}addLabelToQuery(e,t,r,a,n){return!function(e){const t=h.uR.map((e=>`${e.label}`)).join("|");return new RegExp(`\\|\\s?(${t})`).test(e)}(e)||Ae(e)||n?v(e,t,r,a,!0):function(e,t,r,a){return e+` | ${t}${a}"${r.toString()}"`}(e,t,r,a)}filterQuery(e){return!e.hide&&""!==e.expr}applyTemplateVariables(e,t){const r=function(e,t){if(null==e)return{};var r,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)r=s[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(t,Ie);return Object.assign({},e,{legendFormat:this.templateSrv.replace(e.legendFormat,r),expr:this.templateSrv.replace(e.expr,r,this.interpolateQueryExpr)})}interpolateString(e){return this.templateSrv.replace(e,void 0,this.interpolateQueryExpr)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}}function Ge(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function Me(e){return"string"==typeof e?Ge(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()|]/g,"\\\\$&")):e}function Ae(e){if(!e)return!1;return m().tokenize(e,h.ZP).some((e=>"string"!=typeof e&&"function"===e.type))}function Be(e){var t;let r;try{r=new a.FieldCache(e).getFirstFieldOfType(a.FieldType.number)}catch{}return null!==(t=r)&&void 0!==t&&t.labels?function(e){const t=["level","lvl","loglevel"];let r;for(let a of t)if(a in e){r=a;break}return r?(0,a.getLogLevelFromKey)(e[r]):a.LogLevel.unknown}(r.labels):a.LogLevel.unknown}var We,Ke,Ze,He,Je,et,tt,rt,at,nt=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),st=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");function it(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ot=['{job="default/prometheus"}'],lt=["job","app","k8s_app"],ct=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, filters out logs that don’t contain the word "metrics" and parses each log line to extract more labels and filters with them.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class ut extends nt.PureComponent{constructor(){super(...arguments),it(this,"state",{userExamples:[]}),it(this,"checkUserLabels",(async()=>{var e;const t=null===(e=this.props.datasource)||void 0===e?void 0:e.languageProvider;if(t.started){const e=t.getLabelKeys()||[],r=lt.find((t=>e.includes(t)));if(r){const e=await t.getLabelValues(r),a=(0,n.shuffle)(e).slice(0,5).map((e=>`{${r}="${e}"}`));this.setState({userExamples:a})}}else this.scheduleUserLabelChecking()}))}componentDidMount(){this.scheduleUserLabelChecking()}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(e){const{onClickExample:t}=this.props;return(0,st.jsx)("div",{className:"cheat-sheet-item__example",onClick:r=>t({refId:"A",expr:e}),children:(0,st.jsx)("code",{children:e})},e)}render(){const{userExamples:e}=this.state,t=e.length>0;return(0,st.jsxs)("div",{children:[We||(We=(0,st.jsx)("h2",{children:"Loki Cheat Sheet"})),(0,st.jsxs)("div",{className:"cheat-sheet-item",children:[Ke||(Ke=(0,st.jsx)("div",{className:"cheat-sheet-item__title",children:"See your logs"})),Ze||(Ze=(0,st.jsx)("div",{className:"cheat-sheet-item__label",children:"Start by selecting a log stream from the Log browser, or alternatively you can write a stream selector into the query field."})),t?(0,st.jsxs)("div",{children:[He||(He=(0,st.jsx)("div",{className:"cheat-sheet-item__label",children:"Here are some example streams from your logs:"})),e.map((e=>this.renderExpression(e)))]}):(0,st.jsxs)("div",{children:[Je||(Je=(0,st.jsx)("div",{className:"cheat-sheet-item__label",children:"Here is an example of a log stream:"})),this.renderExpression(ot[0])]})]}),(0,st.jsxs)("div",{className:"cheat-sheet-item",children:[et||(et=(0,st.jsx)("div",{className:"cheat-sheet-item__title",children:"Combine stream selectors"})),this.renderExpression('{app="cassandra",namespace="prod"}'),tt||(tt=(0,st.jsx)("div",{className:"cheat-sheet-item__label",children:"Returns all log lines from streams that have both labels."}))]}),(0,st.jsxs)("div",{className:"cheat-sheet-item",children:[rt||(rt=(0,st.jsx)("div",{className:"cheat-sheet-item__title",children:"Filtering for search terms."})),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),at||(at=(0,st.jsxs)("div",{className:"cheat-sheet-item__label",children:[(0,st.jsx)("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql",children:"LogQL"})," ","supports exact and regular expression filters."]}))]}),ct.map((e=>(0,st.jsxs)("div",{className:"cheat-sheet-item",children:[(0,st.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),this.renderExpression(e.expression),(0,st.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.expression)))]})}}var dt,pt=r("./packages/grafana-ui/src/index.ts"),mt=r("./public/app/plugins/datasource/loki/components/LokiQueryField.tsx");function Ot(e){var t;const{query:r,data:a,datasource:n,onChange:s,onRunQuery:i,range:o}=e,l=(0,st.jsx)("div",{className:"gf-form-inline",children:(0,st.jsxs)("div",{className:"gf-form",children:[dt||(dt=(0,st.jsx)(pt.InlineFormLabel,{width:6,tooltip:"Controls the name of the time series, using name or pattern. For example {{hostname}} will be replaced with label value for the label hostname. The legend only applies to metric queries.",children:"Legend"})),(0,st.jsx)("input",{type:"text",className:"gf-form-input",placeholder:"legend format",value:r.legendFormat||"",onChange:e=>{const t=Object.assign({},r,{legendFormat:e.currentTarget.value});s(t)},onBlur:i})]})});return(0,st.jsx)(mt.n,{datasource:n,query:r,onChange:s,onRunQuery:i,onBlur:i,history:[],data:a,"data-testid":gt.editor,range:o,ExtraFieldElement:(0,st.jsxs)(st.Fragment,{children:[(0,st.jsx)(ke.JX,{lineLimitValue:(null==r||null===(t=r.maxLines)||void 0===t?void 0:t.toString())||"",resolution:(null==r?void 0:r.resolution)||1,query:r,onRunQuery:i,onChange:s,runOnBlur:!0}),l]})})}const gt={editor:"loki-editor"};function ht(e){const{query:t,data:r,datasource:a,onChange:n,onRunQuery:s}=e;return(0,st.jsx)(mt.n,{datasource:a,query:t,onChange:n,onRunQuery:s,onBlur:s,history:[],data:r,placeholder:"Enter a Loki query","data-testid":ft.editor})}const ft={editor:"loki-editor-cloud-alerting"},bt=(0,nt.memo)((e=>{var t;const{query:r,data:a,datasource:n,history:s,onChange:i,onRunQuery:o,range:l}=e;return(0,st.jsx)(mt.n,{datasource:n,query:r,onChange:i,onBlur:()=>{},onRunQuery:o,history:s,data:a,range:l,"data-testid":yt.editor,ExtraFieldElement:(0,st.jsx)(ke.JX,{lineLimitValue:(null==r||null===(t=r.maxLines)||void 0===t?void 0:t.toString())||"",resolution:r.resolution||1,query:r,onRunQuery:o,onChange:i})})}));bt.displayName="LokiExploreQueryEditor";const yt={editor:"loki-editor-explore"};var vt=r("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/3/opt/drone/yarncache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),xt=r("./.yarn/__virtual__/@grafana-experimental-virtual-920bad95a1/3/opt/drone/yarncache/@grafana-experimental-npm-0.0.2-canary.22-45d2c4f135-b9a64c0abc.zip/node_modules/@grafana/experimental/index.js"),Qt=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryEditorModeToggle.tsx"),Pt=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/types.ts"),_t=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/LokiAndPromQueryModellerBase.ts"),jt=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/operationUtils.ts");let Rt,qt,$t;!function(e){e.Aggregations="Aggregations",e.RangeFunctions="Range functions",e.Functions="Functions",e.Formats="Formats",e.LineFilters="Line filters",e.LabelFilters="Label filters",e.BinaryOps="Binary operations"}(Rt||(Rt={})),function(e){e.Json="json",e.Logfmt="logfmt",e.Regexp="regexp",e.Pattern="pattern",e.Unpack="unpack",e.LineFormat="line_format",e.LabelFormat="label_format",e.Rate="rate",e.CountOverTime="count_over_time",e.SumOverTime="sum_over_time",e.AvgOverTime="avg_over_time",e.MaxOverTime="max_over_time",e.MinOverTime="min_over_time",e.FirstOverTime="first_over_time",e.LastOverTime="last_over_time",e.StdvarOverTime="stdvar_over_time",e.StddevOverTime="stddev_over_time",e.QuantileOverTime="quantile_over_time",e.BytesRate="bytes_rate",e.BytesOverTime="bytes_over_time",e.AbsentOverTime="absent_over_time",e.Sum="sum",e.Avg="avg",e.Min="min",e.Max="max",e.Stddev="stddev",e.Stdvar="stdvar",e.Count="count",e.TopK="topk",e.BottomK="bottomk",e.LineContains="__line_contains",e.LineContainsNot="__line_contains_not",e.LineMatchesRegex="__line_matches_regex",e.LineMatchesRegexNot="__line_matches_regex_not",e.LabelFilter="__label_filter",e.LabelFilterNoErrors="__label_filter_no_errors",e.Unwrap="unwrap",e.Addition="__addition",e.Subtraction="__subtraction",e.MultiplyBy="__multiply_by",e.DivideBy="__divide_by",e.Modulo="__modulo",e.Exponent="__exponent",e.NestedQuery="__nested_query",e.EqualTo="__equal_to",e.NotEqualTo="__not_equal_to",e.GreaterThan="__greater_than",e.LessThan="__less_than",e.GreaterOrEqual="__greater_or_equal",e.LessOrEqual="__less_or_equal"}(qt||(qt={})),function(e){e[e.LineFilters=1]="LineFilters",e[e.LineFormats=2]="LineFormats",e[e.LabelFilters=3]="LabelFilters",e[e.Unwrap=4]="Unwrap",e[e.NoErrors=5]="NoErrors",e[e.RangeVectorFunction=5]="RangeVectorFunction",e[e.Last=6]="Last"}($t||($t={}));const Lt=[{id:qt.Addition,name:"Add scalar",sign:"+"},{id:qt.Subtraction,name:"Subtract scalar",sign:"-"},{id:qt.MultiplyBy,name:"Multiply by scalar",sign:"*"},{id:qt.DivideBy,name:"Divide by scalar",sign:"/"},{id:qt.Modulo,name:"Modulo by scalar",sign:"%"},{id:qt.Exponent,name:"Exponent",sign:"^"},{id:qt.EqualTo,name:"Equal to",sign:"==",comparison:!0},{id:qt.NotEqualTo,name:"Not equal to",sign:"!=",comparison:!0},{id:qt.GreaterThan,name:"Greater than",sign:">",comparison:!0},{id:qt.LessThan,name:"Less than",sign:"<",comparison:!0},{id:qt.GreaterOrEqual,name:"Greater or equal to",sign:">=",comparison:!0},{id:qt.LessOrEqual,name:"Less or equal to",sign:"<=",comparison:!0}],wt=Lt.map((e=>{const t=[{name:"Value",type:"number"}],r=[2];return e.comparison&&(t.unshift({name:"Bool",type:"boolean",description:"If checked comparison will return 0 or 1 for the value rather than filtering."}),r.unshift(!1)),{id:e.id,name:e.name,params:t,defaultParams:r,alternativesKey:"binary scalar operations",category:Rt.BinaryOps,renderer:(a=e.sign,function(e,t,r){let n=e.params[0],s="";return 2===e.params.length&&(n=e.params[1],s=e.params[0]?" bool":""),`${r} ${a}${s} ${n}`}),addOperationHandler:jt.PP};var a}));function Tt(){const e=[qt.Sum,qt.Min,qt.Max,qt.Avg,qt.Stddev,qt.Stdvar,qt.Count].flatMap((e=>(0,jt.IT)(e,{addOperationHandler:Ut,orderRank:$t.Last}))),t=[qt.TopK,qt.BottomK].flatMap((e=>(0,jt.Z3)(e,{params:[{name:"K-value",type:"number"}],defaultParams:[5]},{addOperationHandler:Ut,orderRank:$t.Last})));return[St(qt.Rate),St(qt.CountOverTime),St(qt.SumOverTime),St(qt.BytesRate),St(qt.BytesOverTime),St(qt.AbsentOverTime),St(qt.AvgOverTime),St(qt.MaxOverTime),St(qt.MinOverTime),St(qt.FirstOverTime),St(qt.LastOverTime),St(qt.StdvarOverTime),St(qt.StddevOverTime),St(qt.QuantileOverTime),...e,...t,{id:qt.Json,name:"Json",params:[],defaultParams:[],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:Xt,addOperationHandler:Ut},{id:qt.Logfmt,name:"Logfmt",params:[],defaultParams:[],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:Xt,addOperationHandler:Ut,explainHandler:()=>"This will extract all keys and values from a [logfmt](https://grafana.com/docs/loki/latest/logql/log_queries/#logfmt) formatted log line as labels. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:qt.Regexp,name:"Regexp",params:[{name:"String",type:"string",hideName:!0,placeholder:"<re>",description:"The regexp expression that matches the structure of a log line.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:(e,t,r)=>`${r} | regexp \`${e.params[0]}\``,addOperationHandler:Ut,explainHandler:()=>'The [regexp parser](https://grafana.com/docs/loki/latest/logql/log_queries/#regular-expression) takes a single parameter | regexp "<re>" which is the regular expression using the Golang RE2 syntax. The regular expression must contain a least one named sub-match (e.g (?P<name>re)), each sub-match will extract a different label. The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.'},{id:qt.Pattern,name:"Pattern",params:[{name:"String",type:"string",hideName:!0,placeholder:"<pattern-expression>",description:"The expression that matches the structure of a log line.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:(e,t,r)=>`${r} | pattern \`${e.params[0]}\``,addOperationHandler:Ut,explainHandler:()=>"The [pattern parser](https://grafana.com/docs/loki/latest/logql/log_queries/#pattern) allows the explicit extraction of fields from log lines by defining a pattern expression (| pattern `<pattern-expression>`). The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:qt.Unpack,name:"Unpack",params:[],defaultParams:[],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:Xt,addOperationHandler:Ut,explainHandler:()=>"This will extract all keys and values from a JSON log line, [unpacking](https://grafana.com/docs/loki/latest/logql/log_queries/#unpack) all embedded labels in the pack stage. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation."},{id:qt.LineFormat,name:"Line format",params:[{name:"String",type:"string",hideName:!0,placeholder:"{{.status_code}}",description:"A line template that can refer to stream labels and extracted labels.",minWidth:20}],defaultParams:[""],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:(e,t,r)=>`${r} | line_format \`${e.params[0]}\``,addOperationHandler:Ut,explainHandler:()=>"This will replace log line using a specified template. The template can refer to stream labels and extracted labels.\n\n        Example: `{{.status_code}} - {{.message}}`\n\n        [Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#line-format-expression) for more.\n        "},{id:qt.LabelFormat,name:"Label format",params:[{name:"Label",type:"string"},{name:"Rename",type:"string"}],defaultParams:["",""],alternativesKey:"format",category:Rt.Formats,orderRank:$t.LineFormats,renderer:(e,t,r)=>`${r} | label_format ${e.params[1]}=\`${e.params[0]}\``,addOperationHandler:Ut,explainHandler:()=>'This will change name of label to desired new label. In the example below, label "error_level" will be renamed to "level".\n\n        Example: error_level=`level`\n\n        [Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#labels-format-expression) for more.\n        '},{id:qt.LineContains,name:"Line contains",params:[{name:"String",type:"string",hideName:!0,placeholder:"Text to find",description:"Find log lines that contains this text",minWidth:20}],defaultParams:[""],alternativesKey:"line filter",category:Rt.LineFilters,orderRank:$t.LineFilters,renderer:Et("|="),addOperationHandler:Ut,explainHandler:e=>`Return log lines that contain string \`${e.params[0]}\`.`},{id:qt.LineContainsNot,name:"Line does not contain",params:[{name:"String",type:"string",hideName:!0,placeholder:"Text to exclude",description:"Find log lines that does not contain this text",minWidth:26}],defaultParams:[""],alternativesKey:"line filter",category:Rt.LineFilters,orderRank:$t.LineFilters,renderer:Et("!="),addOperationHandler:Ut,explainHandler:e=>`Return log lines that does not contain string \`${e.params[0]}\`.`},{id:qt.LineMatchesRegex,name:"Line contains regex match",params:[{name:"Regex",type:"string",hideName:!0,placeholder:"Pattern to match",description:"Find log lines that match this regex pattern",minWidth:30}],defaultParams:[""],alternativesKey:"line filter",category:Rt.LineFilters,orderRank:$t.LineFilters,renderer:Et("|~"),addOperationHandler:Ut,explainHandler:e=>`Return log lines that match regex \`${e.params[0]}\`.`},{id:qt.LineMatchesRegexNot,name:"Line does not match regex",params:[{name:"Regex",type:"string",hideName:!0,placeholder:"Pattern to exclude",description:"Find log lines that does not match this regex pattern",minWidth:30}],defaultParams:[""],alternativesKey:"line filter",category:Rt.LineFilters,orderRank:$t.LineFilters,renderer:Et("!~"),addOperationHandler:Ut,explainHandler:e=>`Return log lines that does not match regex \`${e.params[0]}\`.`},{id:qt.LabelFilter,name:"Label filter expression",params:[{name:"Label",type:"string"},{name:"Operator",type:"string",options:["=","!=",">","<",">=","<="]},{name:"Value",type:"string"}],defaultParams:["","=",""],category:Rt.LabelFilters,orderRank:$t.LabelFilters,renderer:Ct,addOperationHandler:Ut,explainHandler:()=>"Label expression filter allows filtering using original and extracted labels."},{id:qt.LabelFilterNoErrors,name:"No pipeline errors",params:[],defaultParams:[],category:Rt.LabelFilters,orderRank:$t.NoErrors,renderer:(e,t,r)=>`${r} | __error__=\`\``,addOperationHandler:Ut,explainHandler:()=>"Filter out all formatting and parsing errors."},{id:qt.Unwrap,name:"Unwrap",params:[{name:"Identifier",type:"string",hideName:!0,minWidth:16,placeholder:"Label key"}],defaultParams:[""],category:Rt.Formats,orderRank:$t.Unwrap,renderer:(e,t,r)=>`${r} | unwrap ${e.params[0]}`,addOperationHandler:Ut,explainHandler:e=>`Use the extracted label \`${String(e.params[0]).length>0?e.params[0]:"<label>"}\` as sample values instead of log lines for the subsequent range aggregation.`},...wt,{id:qt.NestedQuery,name:"Binary operation with query",params:[],defaultParams:[],category:Rt.BinaryOps,renderer:(e,t,r)=>r,addOperationHandler:Nt}]}function St(e){const t=[{name:"Range",type:"string",options:["$__interval","$__range","1m","5m","10m","1h","24h"]}],r=["$__interval"];let a=kt;return e===qt.QuantileOverTime&&(r.push("0.95"),t.push({name:"Quantile",type:"number"}),a=Ft),{id:e,name:(0,jt.t7)(e),params:t,defaultParams:r,alternativesKey:"range function",category:Rt.RangeFunctions,orderRank:$t.RangeVectorFunction,renderer:a,addOperationHandler:Ut,explainHandler:(e,t)=>{var r,a;let n=null!==(r=null===(a=h.r8.find((t=>t.insertText===e.id)))||void 0===a?void 0:a.documentation)&&void 0!==r?r:"";return"$__interval"===e.params[0]?`${n} \`$__interval\` is variable that will be replaced with a calculated interval based on **Max data points**,  **Min interval** and query time range. You find these options you find under **Query options** at the right of the data source select dropdown.`:`${n} The [range vector](https://grafana.com/docs/loki/latest/logql/metric_queries/#range-vector-aggregation) is set to \`${e.params[0]}\`.`}}}function kt(e,t,r){var a,n;let s=null!==(a=(null!==(n=e.params)&&void 0!==n?n:[])[0])&&void 0!==a?a:"$__interval";return`${t.id}(${r} [${s}])`}function Ft(e,t,r){var a,n;const s=null!==(a=e.params)&&void 0!==a?a:[],i=null!==(n=s[0])&&void 0!==n?n:"$__interval",o=s[1];return`${t.id}(${o}, ${r} [${i}])`}function Et(e){return function(t,r,a){return""===t.params[0]?a:`${a} ${e} \`${t.params[0]}\``}}function Ct(e,t,r){return""===e.params[0]?r:"<"===e.params[1]||">"===e.params[1]?`${r} | ${e.params[0]} ${e.params[1]} ${e.params[2]}`:`${r} | ${e.params[0]}${e.params[1]}\`${e.params[2]}\``}function Xt(e,t,r){return`${r} | ${e.id}`}function It(e,t,r){const a=e.findIndex((e=>{const a=t.getOperationDef(e.id);return!!a&&r(a)}));return-1===a?e.length:a}function Ut(e,t,r){const a={id:e.id,params:e.defaultParams},n=[...t.operations],s=n.find((e=>{const t=r.getOperationDef(e.id);return!!t&&function(e){return e.category===Rt.RangeFunctions}(t)}));switch(e.category){case Rt.Aggregations:case Rt.Functions:if(!s){const e=It(n,r,(e=>e.category===Rt.Functions));n.splice(e,0,{id:qt.Rate,params:["$__interval"]})}n.push(a);break;case Rt.RangeFunctions:if(s){const e=n.indexOf(s);n[e]=a;break}default:const t=It(n,r,(t=>{var r,a;return(null!==(r=e.orderRank)&&void 0!==r?r:100)<(null!==(a=t.orderRank)&&void 0!==a?a:100)}));n.splice(t,0,a)}return Object.assign({},t,{operations:n})}function Nt(e,t){var r;return Object.assign({},t,{binaryQueries:[...null!==(r=t.binaryQueries)&&void 0!==r?r:[],{operator:"/",query:t}]})}class zt extends _t.x{constructor(){super(Tt),this.setOperationCategories([Rt.Aggregations,Rt.RangeFunctions,Rt.Formats,Rt.BinaryOps,Rt.LabelFilters,Rt.LineFilters])}renderLabels(e){return 0===e.length?"{}":super.renderLabels(e)}getQueryPatterns(){return[{name:"Log query and label filter",operations:[{id:qt.LineMatchesRegex,params:[""]},{id:qt.Logfmt,params:[]},{id:qt.LabelFilterNoErrors,params:[]},{id:qt.LabelFilter,params:["","=",""]}]},{name:"Time series query on value inside log line",operations:[{id:qt.LineMatchesRegex,params:[""]},{id:qt.Logfmt,params:[]},{id:qt.LabelFilterNoErrors,params:[]},{id:qt.Unwrap,params:[""]},{id:qt.SumOverTime,params:["$__interval"]},{id:qt.Sum,params:[]}]}]}}const Yt=new zt;var Vt=r("./public/app/core/store.ts");const Dt="LokiQueryEditorModeDefault";function Gt(e){if(null!=e&&""!==e)return Pt.c.Code;const t=Vt.Z.get(Dt);switch(t){case Pt.c.Builder:case Pt.c.Code:case Pt.c.Explain:return t;default:return Pt.c.Builder}}var Mt=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/LabelFilters.tsx"),At=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationList.tsx");function Bt(e){let{query:t}=e;const r=(0,pt.useTheme2)(),a=Wt(r),n=m().highlight(Yt.renderQuery(t),h.xY,"lokiql");return(0,st.jsx)(xt.EditorFieldGroup,{children:(0,st.jsx)(xt.EditorField,{label:"Query text",children:(0,st.jsx)("div",{className:(0,vt.cx)(a.editorField,"prism-syntax-highlight"),"aria-label":"selector",dangerouslySetInnerHTML:{__html:n}})})})}const Wt=e=>({editorField:(0,vt.css)({padding:e.spacing(.25,1),fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize})});var Kt,Zt=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationsEditorRow.tsx"),Ht=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/AutoSizeInput.tsx");const Jt=nt.memo((e=>{let{nestedQuery:t,index:r,datasource:n,onChange:s,onRemove:i,onRunQuery:o}=e;const l=(0,pt.useStyles2)(tr);return(0,st.jsxs)("div",{className:l.card,children:[(0,st.jsxs)("div",{className:l.header,children:[(0,st.jsx)("div",{className:l.name,children:"Operator"}),(0,st.jsx)(pt.Select,{width:"auto",options:er,value:(0,a.toOption)(t.operator),onChange:e=>{s(r,Object.assign({},t,{operator:e.value}))}}),(0,st.jsx)("div",{className:l.name,children:"Vector matches"}),(0,st.jsxs)("div",{className:l.vectorMatchWrapper,children:[(0,st.jsx)(pt.Select,{width:"auto",value:t.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:e=>{s(r,Object.assign({},t,{vectorMatchesType:e.value}))}}),(0,st.jsx)(Ht.H,{className:l.vectorMatchInput,minWidth:20,defaultValue:t.vectorMatches,onCommitChange:e=>{s(r,Object.assign({},t,{vectorMatches:e.currentTarget.value,vectorMatchesType:t.vectorMatchesType||"on"}))}})]}),Kt||(Kt=(0,st.jsx)(xt.FlexItem,{grow:1})),(0,st.jsx)(pt.IconButton,{name:"times",size:"sm",onClick:()=>i(r)})]}),(0,st.jsx)("div",{className:l.body,children:(0,st.jsx)(xt.EditorRows,{children:(0,st.jsx)(ar,{query:t.query,datasource:n,nested:!0,onRunQuery:o,onChange:e=>{s(r,Object.assign({},t,{query:e}))}})})})]})})),er=Lt.map((e=>({label:e.sign,value:e.sign})));Jt.displayName="NestedQuery";const tr=e=>({card:(0,vt.css)({label:"card",display:"flex",flexDirection:"column",gap:e.spacing(.5)}),header:(0,vt.css)({label:"header",padding:e.spacing(.5,.5,.5,1),gap:e.spacing(1),display:"flex",alignItems:"center"}),name:(0,vt.css)({label:"name",whiteSpace:"nowrap"}),body:(0,vt.css)({label:"body",paddingLeft:e.spacing(2)}),vectorMatchInput:(0,vt.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,vt.css)({label:"vectorMatchWrapper",display:"flex"})});function rr(e){var t;let{query:r,datasource:a,onChange:n,onRunQuery:s}=e;const i=null!==(t=r.binaryQueries)&&void 0!==t?t:[],o=(e,t)=>{const a=[...i];a.splice(e,1,t),n(Object.assign({},r,{binaryQueries:a}))},l=e=>{const t=[...i.slice(0,e),...i.slice(e+1)];n(Object.assign({},r,{binaryQueries:t}))};return(0,st.jsx)(xt.Stack,{direction:"column",gap:1,children:i.map(((e,t)=>(0,st.jsx)(Jt,{nestedQuery:e,index:t,onChange:o,datasource:a,onRemove:l,onRunQuery:s},t.toString())))})}const ar=nt.memo((e=>{let{datasource:t,query:r,nested:a,onChange:n,onRunQuery:s}=e;const i=async e=>{const r=await e;return[...t.getVariables(),...r].map((e=>({label:e,value:e})))};return(0,st.jsxs)(st.Fragment,{children:[(0,st.jsx)(xt.EditorRow,{children:(0,st.jsx)(Mt.P,{onGetLabelNames:e=>i((async e=>{const a=r.labels.filter((t=>t!==e));if(0===a.length)return await t.languageProvider.refreshLogLabels(),t.languageProvider.getLabelKeys();const n=Yt.renderLabels(a),s=await t.languageProvider.fetchSeriesLabels(n);return Object.keys(s).sort()})(e)),onGetLabelValues:e=>i((async e=>{var a;if(!e.label)return[];const n=r.labels.filter((t=>t!==e));if(0===n.length)return await t.languageProvider.fetchLabelValues(e.label);const s=Yt.renderLabels(n);return null!==(a=(await t.languageProvider.fetchSeriesLabels(s))[t.interpolateString(e.label)])&&void 0!==a?a:[]})(e)),labelsFilters:r.labels,onChange:e=>{n(Object.assign({},r,{labels:e}))}})}),(0,st.jsx)(Zt.B,{children:(0,st.jsx)(At.P,{queryModeller:Yt,query:r,onChange:n,onRunQuery:s,datasource:t})}),r.binaryQueries&&r.binaryQueries.length>0&&(0,st.jsx)(rr,{query:r,datasource:t,onChange:n,onRunQuery:s}),!a&&(0,st.jsx)(xt.EditorRow,{children:(0,st.jsx)(Bt,{query:r})})]})}));ar.displayName="LokiQueryBuilder";var nr=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationListExplained.tsx"),sr=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationExplainedBox.tsx");const ir=nt.memo((e=>{let{query:t,nested:r}=e;return(0,st.jsxs)(xt.Stack,{gap:0,direction:"column",children:[(0,st.jsx)(sr.B,{stepNumber:1,title:`${Yt.renderLabels(t.labels)}`,children:"Fetch all log lines matching label filters."}),(0,st.jsx)(nr.V,{stepNumber:2,queryModeller:Yt,query:t})]})}));ir.displayName="LokiQueryBuilderExplained";var or=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryOptionGroup.tsx");const lr=nt.memo((e=>{var t,r,a;let{query:n,onChange:s,onRunQuery:i}=e;let o=null!==(t=n.queryType)&&void 0!==t?t:n.instant?k.E.Instant:k.E.Range,l=!Ae(n.expr);return(0,st.jsx)(xt.EditorRow,{children:(0,st.jsxs)(or.d,{title:"Options",collapsedInfo:cr(n,o,l),children:[(0,st.jsx)(xt.EditorField,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.",children:(0,st.jsx)(Ht.H,{placeholder:"{{label}}",id:"loki-query-editor-legend-format",type:"string",minWidth:14,defaultValue:n.legendFormat,onCommitChange:e=>{s(Object.assign({},n,{legendFormat:e.currentTarget.value})),i()}})}),(0,st.jsx)(xt.EditorField,{label:"Type",children:(0,st.jsx)(pt.RadioButtonGroup,{options:ke.uG,value:o,onChange:e=>{s(Object.assign({},n,{queryType:e})),i()}})}),l&&(0,st.jsx)(xt.EditorField,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,st.jsx)(Ht.H,{className:"width-4",placeholder:"auto",type:"number",min:0,defaultValue:null!==(r=null===(a=n.maxLines)||void 0===a?void 0:a.toString())&&void 0!==r?r:"",onCommitChange:function(e){const t=(0,ke.Wz)(e.currentTarget.value);n.maxLines!==t&&(s(Object.assign({},n,{maxLines:t})),i())}})}),(0,st.jsx)(xt.EditorField,{label:"Resolution",children:(0,st.jsx)(pt.Select,{isSearchable:!1,onChange:e=>{s(Object.assign({},n,{resolution:e.value})),i()},options:ke.oZ,value:n.resolution||1,"aria-label":"Select resolution",menuShouldPortal:!0})})]})})}));function cr(e,t,r){const a=ke.uG.find((e=>e.value===t)),n=ke.oZ.find((t=>{var r;return t.value===(null!==(r=e.resolution)&&void 0!==r?r:1)})),s=[];return e.legendFormat&&s.push(`Legend: ${e.legendFormat}`),e.resolution&&s.push(`Resolution: ${null==n?void 0:n.label}`),s.push(`Type: ${null==a?void 0:a.label}`),r&&e.maxLines&&s.push(`Line limit: ${e.maxLines}`),s}function ur(e){let{query:t,datasource:r,range:a,onRunQuery:n,onChange:s,data:i}=e;const o=(0,pt.useStyles2)(dr);return(0,st.jsx)("div",{className:o.wrapper,children:(0,st.jsx)(mt.n,{datasource:r,query:t,range:a,onRunQuery:n,onChange:s,history:[],data:i,"data-testid":gt.editor})})}lr.displayName="LokiQueryBuilderOptions";const dr=e=>({wrapper:vt.css`
      .gf-form {
        margin-bottom: 0;
      }
    `});var pr=r("../../opt/drone/yarncache/@lezer-lr-npm-0.15.8-8c481c39cd-e741225d6a.zip/node_modules/@lezer/lr/dist/index.js");const mr={json:1,logfmt:2,unpack:3,pattern:4,regexp:5,ip:7,label_format:8,line_format:9,label_replace:10,offset:11,bool:12,on:13,ignoring:14,group_left:15,group_right:16,unwrap:6,bytes:17,duration:18,duration_seconds:19},Or={by:20,without:21,and:22,or:23,unless:24,sum:25,avg:26,count:27,max:28,min:29,stddev:30,stdvar:31,bottomk:32,topk:33},gr={__proto__:null,count_over_time:255,rate:257,bytes_over_time:259,bytes_rate:261,avg_over_time:263,sum_over_time:265,min_over_time:267,max_over_time:269,stddev_over_time:271,stdvar_over_time:273,quantile_over_time:275,first_over_time:277,last_over_time:279,absent_over_time:281},hr=pr.WQ.deserialize({version:13,states:"@jOYQPOOO#VQPO'#DSO$fQPO'#DROYQPO'#DROOQO'#EO'#EOO$sQPO'#D}OOQO'#Eg'#EgO$xQPO'#EfQ%TQPOOOOQO'#Eu'#EuO&UQPO'#EuO&ZQPO'#EvOOQO'#D|'#D|OOQO'#DQ'#DQOOQO'#EP'#EPOOQO'#EQ'#EQOOQO'#ER'#EROOQO'#ES'#ESOOQO'#ET'#ETOOQO'#EU'#EUOOQO'#EV'#EVOOQO'#EW'#EWOOQO'#EX'#EXOOQO'#EY'#EYOOQO'#EZ'#EZOOQO'#E['#E[OOQO'#E]'#E]OOQO'#E^'#E^O&`QPO'#DUOOQO'#DT'#DTO&nQPO,59nOOQO'#Da'#DaO&vQPO'#D`O'OQPO'#D_OOQO'#D^'#D^O(lQPO'#D^OOQO'#D]'#D]O*hQPO,59mO+vQPO,59mO+}QPO,5:hO,UQPO,5:iO,aQPO'#EdO.`QPO,5;QO.gQPO,5;QO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SOOQO,5;a,5;aOYQPO,5;bO0rQPO,59pO0wQPO1G/YOOQO1G/Y1G/YOOQO'#Dd'#DdOOQO,59z,59zO1PQPO,59zOOQO,59y,59yO1UQPO'#DUO1sQPO'#DfOOQO'#Df'#DfO3dQPO'#DfO3iQPO'#DmOOQO'#Dl'#DlOOQO'#Dj'#DjO)RQPO'#DjO4QQPO,59xO5nQPO'#DxO5sQPO'#DyOOQO,59x,59xOOQO,59w,59wOOQO1G/X1G/XOOQO1G0S1G0SO5xQPO'#E_O,XQPO'#E_O6aQPO1G0TO6fQPO1G0TO6kQPO,5;OO6sQPO1G0lO8OQPO1G0lO8VQPO1G0lO8^QPO'#EjO:`QPO'#EiO:jQPO'#EiOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO:tQPO1G0|OOQO1G/[1G/[OOQO1G/Z1G/ZOOQO7+$t7+$tO:{QPO1G/fO;QQPO,59pO;WQPO,5:`O;`QPO'#DiO;eQPO'#DhOOQO,5:R,5:ROOQO,5:Q,5:QO=RQPO,5:XO=WQPO,5:UO)RQPO,5:UO)RQPO,5:UOOQO,5:d,5:dO=fQPO'#D{OOQO'#Dz'#DzO=kQPO,5:eO?XQPO'#D^O5xQPO,5:yO?`QPO'#E`O?eQPO'#EbO@OQPO,5:yO6[QPO,5:yO@YQPO,5:yO@aQPO,5:yO@fQPO7+%oO,XQPO7+%oOOQO'#Ee'#EeOAvQPO1G0jOOQO1G0j1G0jOBOQPO7+&WOYQPO7+&WOC`QPO7+&WOCgQPO7+&WOCnQQO'#EkOOQO,5;U,5;UOEpQPO,5;TOEwQPO,5;TOGYQPO7+&YOGaQPO7+&YOOQO7+&Y7+&YOGnQPO7+&YOGuQPO7+&YOHzQPO7+&YOI[QPO7+&hOIaQPO7+%QOIfQPO1G/qOOQO1G/z1G/zOOQO1G/|1G/|OIkQPO,5:TOIpQPO,5:SOOQO1G/s1G/sOOQO1G/p1G/pOIuQPO1G/pOKcQPO,5:gO5sQPO,5:fOKkQPO,5:|OKyQPO1G0eO6[QPO1G0eOLRQPO,5:zO)RQPO,5:|OLWQPO1G0eOL_QPO'#EaOLWQPO1G0eOOQO1G0e1G0eOLdQPO1G0eO6[QPO1G0eOLkQPO1G0eOOQO<<IZ<<IZOLsQPO<<IZOLxQPO,5;POOQO7+&U7+&UOOQO<<Ir<<IrOL}QPO<<IrOYQPO<<IrOOQO'#Em'#EmOMUQPO,5;VOOQO'#El'#ElOOQO,5;V,5;VOOQO1G0o1G0oOM^QPO1G0oO! ZQPO<<JSOOQO<<Hl<<HlO! `QPO7+%]OOQO1G/o1G/oOOQO1G/n1G/nOOQO1G0R1G0ROOQO1G0Q1G0QOOQO'#Ec'#EcOOQO1G0h1G0hO! eQPO1G0hOOQO7+&P7+&POOQO1G0f1G0fO! jQPO1G0hOOQO,5:{,5:{O! {QPO7+&PO6[QPO7+&PO!!SQPO7+&PO!!bQPOAN>uOOQO1G0k1G0kO!#rQPOAN?^O!%SQPOAN?^O!%ZQQO1G0qOOQO1G0q1G0qOOQO7+&Z7+&ZO!%cQPOAN?nO!%hQPO<<HwO!%mQPO7+&SOOQO<<Ik<<IkO!%rQPO<<IkO!%zQPO<<IkO!&VQPO'#EbOOQOG24aG24aOOQOG24xG24xOOQO1G0r1G0rOOQO7+&]7+&]O!&[QPOG25YOOQOAN>cAN>cO!&aQPO<<InOOQOAN?VAN?VO!&fQPOLD*tOOQOAN?YAN?YOOQO,5:e,5:eO!&kQPO!$'N`O!&pQPO!)9CzO!&uQPO!.K9fOOQO!4//Q!4//QO5sQPO'#DyO!&zQPO'#D^O!'lQPO,59mO!'vQPO'#DROYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO.lQPO,5;SO!)RQPO7+&YO!)YQPO7+&YO!)gQPO7+&YO!*oQPO7+&YO!*vQPO7+&YO!)nQPO'#Eh",stateData:"!+T~O#mOSrOS~OYZOiUOjUOkUOlUOmUOnUOoUOpUOqUO!kXO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~OylO~O|oO!OoO!UoO!VoOfuXguXhuX!buX!duX!euX!fuX!guX#cuX#duX#euX#fuX#guX#huX~O!XsO#kuX#ruX~P#[O#qxO~OdyOeyO#qzO~Of}Og|Oh}O|!RO!b!RO!d!RO!e!RO!f!RO!g!RO#c!OO#d!OO#e!PO#f!PO#g!PO#h!QO~O!k!SO~O#q!TO~Oz!UO|!UO}!UO!O!UO~O#o!VO#p!WO~OV!XO{!YO~O|oO!OoO!UoO!VoOf!RXg!RXh!RX!X!RX!b!RX!d!RX!e!RX!f!RX!g!RX#c!RX#d!RX#e!RX#f!RX#g!RX#h!RX#k!RX#r!RXU!RX$R!RX#o!RX~OP!^OQ!_OR!_OS!`OT!`OW!gOX!fOb!aOy!]O#q!dO~O|oO!OoO!UoO!VoOfuaguahua!bua!dua!eua!fua!gua#cua#dua#eua#fua#gua#hua~O!XsO#kua#rua~P)^OftXgtXhtX|tX!btX!dtX!etX!ftX!gtX#ctX#dtX#etX#ftX#gtX#htX~O#r!jO~P*uO#r!kO~P*uO!k!oO#nPO#q!mO~O#q!pO~OYZOiUOjUOkUOlUOmUOnUOoUOpUOqUO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~O!k!rO~P,fO#q!sO~O[!vO]!tO^!tOY#]Pi#]Pj#]Pk#]Pl#]Pm#]Pn#]Po#]Pp#]Pq#]P!k#]P#c#]P#d#]P#n#]P#q#]P#s#]P#t#]P#u#]P#v#]P#w#]P#x#]P#y#]P#z#]P#{#]P#|#]P#}#]P$O#]P$P#]P$Q#]P~O{#OO~OylO#p#QO~O#q#RO~Oz#SO|#SO}!UO!O!UO!b#TO!d#TO!e#TO!f#TO!g#TO~Oy#UOf!YXg!YXh!YX|!YX!O!YX!U!YX!V!YX!X!YX!b!YX!d!YX!e!YX!f!YX!g!YX#c!YX#d!YX#e!YX#f!YX#g!YX#h!YX#k!YX#r!YXU!YX$R!YX#o!YX~O{#XO~Oz#YO|#YO!b#YO!d#YO!e#YO!f#YO!g#YO~Of#[Og#]O#o#[Oh!Qa|!Qa!O!Qa!U!Qa!V!Qa!X!Qa!b!Qa!d!Qa!e!Qa!f!Qa!g!Qa#c!Qa#d!Qa#e!Qa#f!Qa#g!Qa#h!Qa#k!Qa#r!QaU!Qa$R!Qa~O{#^O~Oy#_O~OU#eO|oO!OoO!UoO!VoO!X#bO$R#dO~O#r#jO~O#o#kO~Oy#lO#r#nO~O#r#oO~P*uOf#iXg#iXh#iX|#iX!b#iX!d#iX!e#iX!f#iX!g#iX#c#iX#d#iX#e#iX#f#iX#g#iX#h#iX#r#iX~O#o#pO~P6zO!k#rO~P,fO#q#sO~OY#]Xi#]Xj#]Xk#]Xl#]Xm#]Xn#]Xo#]Xp#]Xq#]X!k#]X#c#]X#d#]X#n#]X#q#]X#s#]X#t#]X#u#]X#v#]X#w#]X#x#]X#y#]X#z#]X#{#]X#|#]X#}#]X$O#]X$P#]X$Q#]X~O_#uO`#uO~P8cO]!tO^!tO~P8cO#o#}O~P*uO{$OO~OV$PO{#OO!i$QO!k$RO~Oz$SO~O#o$TOf![Xg![Xh![X|![X!O![X!U![X!V![X!X![X!b![X!d![X!e![X!f![X!g![X#c![X#d![X#e![X#f![X#g![X#h![X#k![X#r![XU![X$R![X~O!c$UO~Of#[Og#]O#o#[O#r$VO~Oz$XO~O#o$YOf!mag!mah!ma|!ma!O!ma!U!ma!V!ma!X!ma!b!ma!d!ma!e!ma!f!ma!g!ma#c!ma#d!ma#e!ma#f!ma#g!ma#h!ma#k!ma#r!maU!ma$R!ma~OU$ZO~P(lO!c$^O~O!X$_O~OU#eO|oO!OoO!UoO!VoO!X#bO~OZ$aO#r#Ra~P?jO#r$eO~P5xO#r$cO~OdyOeyOf!qqg!qqh!qq|!qq!b!qq!d!qq!e!qq!f!qq!g!qq#c!qq#d!qq#e!qq#f!qq#g!qq#h!qq#k!qq#r!qq#o!qq~O#o$iO#r$jO~OdyOeyOf#Yqg#Yqh#Yq|#Yq!b#Yq!d#Yq!e#Yq!f#Yq!g#Yq#c#Yq#d#Yq#e#Yq#f#Yq#g#Yq#h#Yq#k#Yq#r#Yq#o#Yq~O#r$kO~P*uO#o$mO~P6zO#b$nO#r$qO~OY#]ai#]aj#]ak#]al#]am#]an#]ao#]ap#]aq#]a!k#]a#c#]a#d#]a#n#]a#s#]a#t#]a#u#]a#v#]a#w#]a#x#]a#y#]a#z#]a#{#]a#|#]a#}#]a$O#]a$P#]a$Q#]a~O#q#sO~PCvO_$sO`$sO#q#]a~PCvOf}Oh}O|!RO!b!RO!d!RO!e!RO!f!RO!g!RO#c!OO#d!OO#e#[q#f#[q#g#[q#h#[q#k#[q#r#[q~Og#[q~PFUOf#[qg#[qh#[q~PF[Og|O~PFUO#k#[q#r#[q~P%TOf#[qg#[qh#[q|#[q!b#[q!d#[q!e#[q!f#[q!g#[q#e#[q#f#[q#g#[q#h#[q~O#c!OO#d!OO#k#[q#r#[q~PHPO{$tO~O#r$uO~O#q$vO~O{$wO~Oy#UO~Of#[O#o#[Og!^ih!^i|!^i!O!^i!U!^i!V!^i!X!^i!b!^i!d!^i!e!^i!f!^i!g!^i#c!^i#d!^i#e!^i#f!^i#g!^i#h!^i#k!^i#r!^iU!^i$R!^i~Oy$yO{$yO~Oa${Ob${Oc${Oy$|O~OZ$aO#r#Ri~O$S%PO~O#r#Ri~P?jO!c%RO~O#r%TO~P5xO#r%TO$R#dO~O#r%VO~Oy%WO~O#r%XO~P*uO#o%ZO#r%[O~O#q#sOY#]ii#]ij#]ik#]il#]im#]in#]io#]ip#]iq#]i!k#]i#c#]i#d#]i#n#]i#s#]i#t#]i#u#]i#v#]i#w#]i#x#]i#y#]i#z#]i#{#]i#|#]i#}#]i$O#]i$P#]i$Q#]i~O#o%^O~O{%_O~O#q%`O~Of#[Og#]O#o#[O$R#Ui#r#Ui~O#r#Rq~P?jOU#eOZ%cO!X%dO#r#Rq~OdyOeyOf!q!Rg!q!Rh!q!R|!q!R!b!q!R!d!q!R!e!q!R!f!q!R!g!q!R#c!q!R#d!q!R#e!q!R#f!q!R#g!q!R#h!q!R#k!q!R#r!q!R#o!q!R~OdyOeyOf#Y!Rg#Y!Rh#Y!R|#Y!R!b#Y!R!d#Y!R!e#Y!R!f#Y!R!g#Y!R#c#Y!R#d#Y!R#e#Y!R#f#Y!R#g#Y!R#h#Y!R#k#Y!R#r#Y!R#o#Y!R~O#r%fO~P*uO#b$nO#r%hO~O{%iO~O#r%jO~Oy%kO~OZ$aO#r#Ry~OU#eO!X%dO!c%RO~OU$ZO~O#o%mO~O#r%nO~O{%pO~O#o%qO~O{%rO~O#r%sO~OP!^OQ!_OR!_OS!`OT!`OW%tOX!fOb!aOy!]O#q!dO~O!X%uO#oua~P)^O!X%uO#ouX~P#[Of&POh&PO|&TO!b&TO!d&TO!e&TO!f&TO!g&TO#c&QO#d&QO#e#[q#f#[q#g#[q#h#[q#o#[q~Og#[q~P!(QOf#[qg#[qh#[q~P!(WOg&OO~P!(QOf&POg&OOh&PO|&TO!b&TO!d&TO!e&TO!f&TO!g&TO#c&QO#d&QO#e&RO#f&RO#g&RO#h&SO~O#o#[q~P!)nO#c&QO#d&QO#o#[q~PHPO",goto:"/Y#kPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP#l$k%S%r%uPPPPPP&U&h&x'W'iPP'xP'{'{(Q(T(Z(l(l(uPPPPPP(uP(lP'{'{)O)U)]*O*e*z*z*z*z*z*z*z*z*z*z*z*z*z*z+a+j+},Z,s,v-V*O-Y*O-o.e.v/P/SPPPPPPP*O*O[WORz!s#p$mQ#w!wQ#x!xS#y!y%zQ#z!zQ#{!{Q#|!|Q&U%xQ&V%yQ&W%{Q&X%|Q&Y%}R&Z!Tt]Oz!T!s!w!x!y!z!{!|#p$m%x%y%z%{%|%}RvRjQORz!T!s!w!x!y!z!{!|#p$mS!lx#kQ#h!m]%w%x%y%z%{%|%}RnPQmP^!cs!d#[#]#b$_%uR#P!VQuQQ#c!lQ$`#fQ$d#hQ%S$bR%v%w[tQ!l#f#h$b%w]!iu#c$`$d%S%virQu!l#c#f#h$`$b$d%S%v%whqQu!l#c#f#h$`$b$d%S%v%wR![qkpQqu!l#c#f#h$`$b$d%S%v%wR!ZpV!hs#b%uR#W!^Q#V!^R$x$TU!es#b%uQ#Z!dQ$V#[Q$W#]R%Q$__!cs!d#[#]#b$_%u_!bs!d#[#]#b$_%uQ#a!gR%o%tS#`!g%tR$z$Yj]O!w!x!y!z!{!|%x%y%z%{%|%}QwRQ!qzQ!}!TQ#q!sQ$l#pR%Y$mw[ORz!T!s!w!x!y!z!{!|#p$m%x%y%z%{%|%}wTORz!T!s!w!x!y!z!{!|#p$m%x%y%z%{%|%}wSORz!T!s!w!x!y!z!{!|#p$m%x%y%z%{%|%}Q!nxQ#i!mR$h#kS#f!l#hW$[#c#g$d$fQ%O$]Q%U$eR%b%TQ$b#fQ%O$[Q%a%UR%l%bQ#g!lS$]#c$dQ$c#fQ$f#hS%O$`$bS%a%S%UR%l%cR$}$ZQ{VQ$g#jQ$k#oQ%e%VR%f%XR#m!pwVORz!T!s!w!x!y!z!{!|#p$m%x%y%z%{%|%}Q!w|Q!x}Q!y!OQ!z!PQ!{!QQ!|!RQ%x&OQ%y&PQ%z&QQ%{&RQ%|&SR%}&Th!u|}!O!P!Q!R&O&P&Q&R&S&TR#v!vQ#t!tQ$r#uR%]$sR$o#sQ$p#sR%g%Z",nodeNames:"⚠ Json Logfmt Unpack Pattern Regexp Unwrap Ip LabelFormat LineFormat LabelReplace Offset Bool On Ignoring GroupLeft GroupRight BytesConv DurationConv DurationSecondsConv By Without And Or Unless Sum Avg Count Max Min Stddev Stdvar Bottomk Topk LineComment LogQL Expr LogExpr Selector Matchers Matcher Identifier Eq String Neq Re Nre PipelineExpr PipelineStage LineFilters LineFilter Filter PipeExact PipeMatch FilterOp Pipe LabelParser JsonExpressionParser JsonExpressionList JsonExpression LabelFilter IpLabelFilter UnitFilter DurationFilter Gtr Duration Gte Lss Lte Eql BytesFilter Bytes NumberFilter Number LineFormatExpr LabelFormatExpr LabelsFormat LabelFormatMatcher MetricExpr RangeAggregationExpr RangeOp CountOverTime Rate BytesOverTime BytesRate AvgOverTime SumOverTime MinOverTime MaxOverTime StddevOverTime StdvarOverTime QuantileOverTime FirstOverTime LastOverTime AbsentOverTime LogRangeExpr Range OffsetExpr UnwrapExpr ConvOp Grouping Labels VectorAggregationExpr VectorOp BinOpExpr BinOpModifier OnOrIgnoringModifier GroupingLabels GroupingLabelList GroupingLabel LabelName Add Sub Mul Div Mod Pow LiteralExpr LabelReplaceExpr",maxTerm:142,skippedNodes:[0,34],repeatNodeCount:0,tokenData:"3{~RwX^#lpq#lqr$ars$tst%huv%swx%xxy&gyz&lz{&q{|&v|}&{}!O'Q!O!P'V!P!Q(V!Q!R([!R![)r![!]0r!^!_1W!_!`1e!`!a1z!c!}2X!}#O2o#P#Q2t#Q#R2y#R#S2X#S#T3O#T#o2X#o#p3[#p#q3a#q#r3v#y#z#l$f$g#l#BY#BZ#l$IS$I_#l$I|$JO#l$JT$JU#l$KV$KW#l&FU&FV#l~#qY#m~X^#lpq#l#y#z#l$f$g#l#BY#BZ#l$IS$I_#l$I|$JO#l$JT$JU#l$KV$KW#l&FU&FV#l~$dQ!_!`$j#r#s$o~$oO|~~$tO!O~~$yU{~OY$tZr$trs%]s#O$t#O#P%b#P~$t~%bO{~~%ePO~$t~%mQr~OY%hZ~%h~%xO#g~~%}U{~OY%xZw%xwx%]x#O%x#O#P&a#P~%x~&dPO~%x~&lO#q~~&qO#r~~&vO#e~~&{O#c~~'QO#o~~'VO#d~~'YP!Q![']~'bR!k~!Q![']!g!h'k#X#Y'k~'nR{|'w}!O'w!Q!['}~'zP!Q!['}~(SP!k~!Q!['}~([O#f~~(ae!k~!O!P']!Q![)r!g!h+V!i!j+t!m!n+t!o!p+t!r!s+t!v!w+t#U#V+i#W#X+}#X#Y.P#Z#[.c#[#],f#_#`.c#a#b.l#d#e.c#g#h-n#h#i.c#k#l.}#l#m0W#m#n/i~)wd!k~!O!P']!Q![)r!g!h+V!i!j+t!m!n+t!o!p+t!r!s+t!v!w+t#U#V+i#W#X+}#X#Y.P#Z#[.c#[#],f#_#`.c#a#b.l#d#e.c#g#h-n#h#i.c#k#l.}#m#n/i~+YT{|'w}!O'w!Q!['}!d!e+i#]#^+n~+nO!i~~+qP#U#V+i~+wQ!d!e+i#]#^+n~,SP!c~!Q![,V~,YS!Q![,V#[#],f#a#b,z#g#h-n~,kP!c~!Q![,n~,qR!Q![,n#a#b,z#g#h-n~-PQ!c~!Q![-V#g#h-i~-YR!Q![-V#a#b-c#g#h-n~-fP#g#h-i~-nO!c~~-sP!c~!Q![-v~-yQ!Q![-v#a#b-c~.ST{|'w}!O'w!Q!['}#U#V+i#]#^+n~.fQ#U#V+i#]#^+n~.qS!c~!Q![-V#U#V+i#]#^+n#g#h-i~/SP!c~!Q![/V~/YT!Q![/V#W#X+}#[#],f#a#b,z#g#h-n~/nP!c~!Q![/q~/tU!Q![/q#W#X+}#[#],f#a#b,z#g#h-n#k#l.}~0ZR!Q![0d!c!i0d#T#Z0d~0iR!k~!Q![0d!c!i0d#T#Z0dP0wTyP!Q![0r![!]0r!c!}0r#R#S0r#T#o0r~1]P!e~!_!`1`~1eO!f~~1jQz~!_!`1p#r#s1u~1uO!g~~1zO}~~2PP!b~!_!`2S~2XO!d~R2`TyP#bQ!Q![2X![!]0r!c!}2X#R#S2X#T#o2X~2tO$R~~2yO$S~~3OO#h~~3RRO#S3O#S#T%]#T~3O~3aO#n~~3fQ!X~!_!`3l#r#s3q~3qO!U~~3vO!V~~3{O#p~",tokenizers:[0,1],topRules:{LogQL:[0,35]},specialized:[{term:41,get:(e,t)=>((e,t)=>mr[e.toLowerCase()]||-1)(e)<<1},{term:41,get:(e,t)=>((e,t)=>Or[e.toLowerCase()]||-1)(e)<<1|1},{term:41,get:e=>gr[e]||-1}],tokenPrec:0});var fr=r("./public/app/plugins/datasource/prometheus/querybuilder/shared/parsingUtils.ts");function br(e,t,r){const a=r.query;switch(t.name){case"Matcher":{a.labels.push(function(e,t){const r=t.getChild("Identifier"),a=(0,fr.KF)(e,r),n=(0,fr.KF)(e,r.nextSibling),s=(0,fr.KF)(e,t.getChild("String")).replace(/"/g,"");return{label:a,op:n,value:s}}(e,t));const n=t.getChild(fr.GQ);n&&r.errors.push((0,fr.wf)(e,n));break}case"LineFilter":{const{operation:n,error:s}=function(e,t){if((0,fr.ff)(e,t,"Ip").length>0)return{error:"Matching ip addresses not supported in query builder"};const r={"|=":"__line_contains","!=":"__line_contains_not","|~":"__line_matches_regex","!~":'"__line_matches_regex"_not'},a=(0,fr.KF)(e,t.getChild("Filter")),n=vr((0,fr.KF)(e,t.getChild("String")));return{operation:{id:r[a],params:[n]}}}(e,t);n&&a.operations.push(n),s&&r.errors.push(Qr(e,t,s));break}case"LabelParser":a.operations.push(function(e,t){const r=t.firstChild,a=(0,fr.KF)(e,r),n=vr((0,fr.KF)(e,t.getChild("String")));return{id:a,params:n?[n]:[]}}(e,t));break;case"LabelFilter":{const{operation:n,error:s}=function(e,t){if(t.getChild("Or")||t.getChild("And")||t.getChild("Comma"))return{error:'Label filter with comma, "and", "or" not supported in query builder'};if("IpLabelFilter"===t.firstChild.name)return{error:"IpLabelFilter not supported in query builder"};const r="__label_filter";if("UnitFilter"===t.firstChild.name){const a=t.firstChild.firstChild.firstChild,n=a.nextSibling,s=n.nextSibling,i=vr((0,fr.KF)(e,s));return{operation:{id:r,params:[(0,fr.KF)(e,a),(0,fr.KF)(e,n),i]}}}const a=t.firstChild.firstChild,n=a.nextSibling,s=n.nextSibling,i=[(0,fr.KF)(e,a),(0,fr.KF)(e,n),vr((0,fr.KF)(e,s))];if("__error__="===i.join(""))return{operation:{id:"__label_filter_no_errors",params:[]}};return{operation:{id:r,params:i}}}(e,t);n&&a.operations.push(n),s&&r.errors.push(Qr(e,t,s));break}case"JsonExpressionParser":{const a="JsonExpressionParser not supported in visual query builder";r.errors.push(Qr(e,t,a))}case"LineFormatExpr":a.operations.push(function(e,t){const r="line_format",a=vr((0,fr.KF)(e,t.getChild("String")));return{id:r,params:[a]}}(e,t));break;case"LabelFormatMatcher":a.operations.push(function(e,t){const r="label_format",a=t.getChild("Identifier"),n=a.nextSibling.nextSibling;let s=vr((0,fr.KF)(e,n));return{id:r,params:[(0,fr.KF)(e,a),s]}}(e,t));break;case"UnwrapExpr":{const{operation:n,error:s}=function(e,t){if(t.getChild("ConvOp"))return{error:"Unwrap with conversion operator not supported in query builder"};const r="unwrap",a=(0,fr.KF)(e,t.getChild("Identifier"));return{operation:{id:r,params:[a]}}}(e,t);n&&a.operations.push(n),s&&r.errors.push(Qr(e,t,s));break}case"RangeAggregationExpr":a.operations.push(function(e,t,r){const a=t.getChild("RangeOp"),n=(0,fr.KF)(e,a),s=t.getChild("Number"),i=t.getChild("LogRangeExpr"),o=null!=s?[(0,fr.KF)(e,s)]:[];let l=(0,fr.KF)(e,t).match(/\[(.+)\]/);null!=l&&l[1]&&o.push(l[1]);const c={id:n,params:o};i&&br(e,i,r);return c}(e,t,r));break;case"VectorAggregationExpr":a.operations.push(function(e,t,r){const a=t.getChild("VectorOp");let n=(0,fr.KF)(e,a);const s=t.getChild("Grouping"),i=[];if(s){s.getChild("By")&&n&&(n=`__${n}_by`);s.getChild("Without")&&(n=`__${n}_without`),i.push(...(0,fr.ff)(e,s,"Identifier"))}const o=t.getChild("MetricExpr"),l={id:n,params:i};o&&br(e,o,r);return l}(e,t,r));break;case"BinOpExpr":!function(e,t,r){const a=r.query,n=t.firstChild,s=(0,fr.KF)(e,n.nextSibling),i=function(e,t){if(!t)return;if(t.getChild("Bool"))return{isBool:!0,isMatcher:!1};{var r;const a=t.getChild("OnOrIgnoring");if(!a)return;return{isMatcher:!0,isBool:!1,matches:(0,fr.KF)(e,null===(r=a.getChild("GroupingLabels"))||void 0===r?void 0:r.getChild("GroupingLabelList")),matchType:a.getChild("On")?"on":"ignoring"}}}(e,t.getChild("BinModifiers")),o=t.lastChild,l=yr[s],c=xr(n,"MetricExpr.LiteralExpr.Number"),u=xr(o,"MetricExpr.LiteralExpr.Number"),d=o.getChild("BinOpExpr");c||br(e,n,r);if(u)a.operations.push((0,fr.Es)(l,e,o,!(null==i||!i.isBool)));else if(d){const t=(0,fr.ge)(o);"Number"===(null==t?void 0:t.name)&&a.operations.push((0,fr.Es)(l,e,t,!(null==i||!i.isBool))),br(e,o,r)}else{a.binaryQueries=a.binaryQueries||[];const t={operator:s,query:{labels:[],operations:[]}};null!=i&&i.isMatcher&&(t.vectorMatchesType=i.matchType,t.vectorMatches=i.matches),a.binaryQueries.push(t),br(e,o,{query:t.query,errors:r.errors})}}(e,t,r);break;case fr.GQ:if(function(e){var t;return"Range"===(null==e||null===(t=e.parent)||void 0===t?void 0:t.name)}(t))break;r.errors.push((0,fr.wf)(e,t));break;default:{let a=t.firstChild;for(;a;)br(e,a,r),a=a.nextSibling}}}const yr=Lt.reduce(((e,t)=>(e[t.sign]={id:t.id,comparison:t.comparison},e)),{});function vr(e){return'"'===e[0]&&'"'===e[e.length-1]?e.replace(/"/g,"").replace(/\\\\/g,"\\"):e.replace(/`/g,"")}function xr(e,t){let r=e;const a=t.split(".");for(const e of a)if(r=r.getChild(e),!r)return null;return r}function Qr(e,t,r){const a=(0,fr.wf)(e,t);return a.text=`${r}: ${a.text}`,a}var Pr,_r;const jr=nt.memo((e=>{var t,r;const{onChange:n,onRunQuery:s,data:i}=e,o=(0,pt.useStyles2)(Rr),l=function(e){let t=e;return e.editorMode||(t=Object.assign({},e,{editorMode:Gt(e.expr)})),null==e.expr&&(t=Object.assign({},t,{expr:""})),null==e.queryType&&(t=Object.assign({},t,{queryType:k.E.Range})),t}(e.query),[c,u]=(0,nt.useState)(null!==(t=l.visualQuery)&&void 0!==t?t:{labels:[],operations:[{id:"__line_contains",params:[""]}]}),[d,p]=(0,nt.useState)(!1),[m,O]=(0,nt.useState)(void 0),g=(0,nt.useCallback)((e=>{const t=Object.assign({},l,{editorMode:e});if(e===Pt.c.Builder){const e=function(e){const t=(0,fr.bU)(e),r=hr.parse(t).topNode,a={query:{labels:[],operations:[]},errors:[]};try{br(t,r,a)}catch(e){console.error(e),a.errors.push({text:e.message})}return function(e){return 0===e.labels.length&&0===e.operations.length}(a.query)&&(a.errors=[]),a}(l.expr);if(t.visualQuery=e.query,e.errors.length)return p(!0),void O(t);u(t.visualQuery)}n(t)}),[n,l]),h=e=>{u(e),n(Object.assign({},l,{expr:Yt.renderQuery(e),visualQuery:e,editorMode:Pt.c.Builder}))},f=null!==(r=l.editorMode)&&void 0!==r?r:l.expr?Pt.c.Code:Pt.c.Builder;return(0,st.jsxs)(st.Fragment,{children:[(0,st.jsx)(pt.ConfirmModal,{isOpen:d,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may loose some parts of the query.",confirmText:"Continue",onConfirm:()=>{u(m.visualQuery),n(m),p(!1)},onDismiss:()=>p(!1)}),(0,st.jsxs)(xt.EditorHeader,{children:[Pr||(Pr=(0,st.jsx)(xt.FlexItem,{grow:1})),(0,st.jsx)(pt.Button,{className:o.runQuery,variant:"secondary",size:"sm",fill:"outline",onClick:s,icon:(null==i?void 0:i.state)===a.LoadingState.Loading?"fa fa-spinner":void 0,disabled:(null==i?void 0:i.state)===a.LoadingState.Loading,children:"Run query"}),(0,st.jsx)(xt.InlineSelect,{value:null,placeholder:"Query patterns",allowCustomValue:!0,onChange:e=>{let{value:t}=e;h(Object.assign({},c,{operations:null==t?void 0:t.operations}))},options:Yt.getQueryPatterns().map((e=>({label:e.name,value:e})))}),(0,st.jsx)(Qt.k,{mode:f,onChange:g})]}),_r||(_r=(0,st.jsx)(xt.Space,{v:.5})),(0,st.jsxs)(xt.EditorRows,{children:[f===Pt.c.Code&&(0,st.jsx)(ur,Object.assign({},e)),f===Pt.c.Builder&&(0,st.jsx)(ar,{datasource:e.datasource,query:c,onChange:h,onRunQuery:e.onRunQuery}),f===Pt.c.Explain&&(0,st.jsx)(ir,{query:c}),f!==Pt.c.Explain&&(0,st.jsx)(lr,{query:l,onChange:n,onRunQuery:s})]})]})}));jr.displayName="LokiQueryEditorSelector";const Rr=e=>({runQuery:(0,vt.css)({color:e.colors.text.secondary}),switchLabel:(0,vt.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize})});function qr(e){const{app:t}=e;switch(t){case a.CoreApp.CloudAlerting:return(0,st.jsx)(ht,Object.assign({},e));case a.CoreApp.Explore:return O.config.featureToggles.lokiQueryBuilder?(0,st.jsx)(jr,Object.assign({},e)):(0,st.jsx)(bt,Object.assign({},e));default:return O.config.featureToggles.lokiQueryBuilder?(0,st.jsx)(jr,Object.assign({},e)):(0,st.jsx)(Ot,Object.assign({},e))}}const $r=(0,nt.memo)(qr);class Lr{constructor(e){this.annotation=e.ctrl.annotation,this.annotation.target=this.annotation.target||{},this.onQueryChange=this.onQueryChange.bind(this)}onQueryChange(e){this.annotation.expr=e.expr,this.annotation.maxLines=e.maxLines,this.annotation.instant=e.instant}}var wr,Tr,Sr;Lr.$inject=["$scope"],Sr="partials/annotations.editor.html",(Tr="templateUrl")in(wr=Lr)?Object.defineProperty(wr,Tr,{value:Sr,enumerable:!0,configurable:!0,writable:!0}):wr[Tr]=Sr;const{FormField:kr}=pt.LegacyForms,Fr=e=>{const{value:t,onChange:r}=e;return(0,st.jsx)(kr,{label:"Maximum lines",labelWidth:11,inputWidth:20,inputEl:(0,st.jsx)("input",{type:"number",className:"gf-form-input width-8 gf-form-input--has-help-icon",value:t,onChange:e=>r(e.currentTarget.value),spellCheck:!1,placeholder:"1000"}),tooltip:(0,st.jsx)(st.Fragment,{children:"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results."})})};var Er=r("./.yarn/__virtual__/react-use-virtual-00326e70ba/3/opt/drone/yarncache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/usePrevious.js");const{Switch:Cr,FormField:Xr}=pt.LegacyForms,Ir=(0,pt.stylesFactory)((()=>({row:vt.css`
    display: flex;
    align-items: baseline;
  `,nameField:vt.css`
    flex: 2;
  `,regexField:vt.css`
    flex: 3;
  `,urlField:vt.css`
    flex: 1;
  `,urlDisplayLabelField:vt.css`
    flex: 1;
  `}))),Ur=e=>{const{value:t,onChange:r,onDelete:a,suggestions:n,className:s}=e,i=Ir(),[o,l]=(0,nt.useState)(!!t.datasourceUid),c=(0,Er.Z)(t.datasourceUid);(0,nt.useEffect)((()=>{c||!t.datasourceUid||o||l(!0),c&&!t.datasourceUid&&o&&l(!1)}),[c,t.datasourceUid,o]);const u=e=>a=>{r(Object.assign({},t,{[e]:a.currentTarget.value}))};return(0,st.jsxs)("div",{className:s,children:[(0,st.jsxs)("div",{className:i.row,children:[(0,st.jsx)(Xr,{className:i.nameField,labelWidth:5,inputWidth:null,label:"Name",type:"text",value:t.name,onChange:u("name")}),(0,st.jsx)(Xr,{className:i.regexField,inputWidth:null,label:"Regex",type:"text",value:t.matcherRegex,onChange:u("matcherRegex"),tooltip:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),(0,st.jsx)(pt.Button,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),a()},className:vt.css`
            margin-left: 8px;
          `})]}),(0,st.jsxs)("div",{className:i.row,children:[(0,st.jsx)(Xr,{label:o?"Query":"URL",inputEl:(0,st.jsx)(pt.DataLinkInput,{placeholder:o?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>r(Object.assign({},t,{url:e})),suggestions:n}),className:i.urlField}),(0,st.jsx)(Xr,{className:i.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:t.urlDisplayLabel,onChange:u("urlDisplayLabel"),tooltip:"Use to override the button label when this derived field is found in a log."})]}),(0,st.jsxs)("div",{className:i.row,children:[(0,st.jsx)(Cr,{label:"Internal link",checked:o,onChange:()=>{o&&r(Object.assign({},t,{datasourceUid:void 0})),l(!o)}}),o&&(0,st.jsx)(O.DataSourcePicker,{tracing:!0,onChange:e=>r(Object.assign({},t,{datasourceUid:e.uid})),current:t.datasourceUid})]})]})};var Nr,zr=r("../../opt/drone/yarncache/classnames-npm-2.3.1-f2ae0a8d3c-14db8889d5.zip/node_modules/classnames/index.js"),Yr=r.n(zr),Vr=r("./public/app/features/explore/utils/links.ts");const{FormField:Dr}=pt.LegacyForms,Gr=e=>{const{derivedFields:t,className:r}=e,[n,s]=(0,nt.useState)("");let i=[];return n&&t&&(i=function(e,t){return e.filter((e=>e.name&&e.matcherRegex)).map((e=>{try{const r=t.match(e.matcherRegex),n=r&&r[1];let s=null;return e.url&&n&&(s=(0,Vr.a)({field:{name:"",type:a.FieldType.string,values:new a.ArrayVector([n]),config:{links:[{title:"",url:e.url}]}},rowIndex:0,range:{}})[0]),{name:e.name,value:n||"<no match>",href:s&&s.href}}catch(t){return{name:e.name,error:t}}}))}(t,n)),(0,st.jsxs)("div",{className:r,children:[(0,st.jsx)(Dr,{labelWidth:12,label:"Debug log message",inputEl:(0,st.jsx)("textarea",{placeholder:"Paste an example log line here to test the regular expressions of your derived fields",className:Yr()("gf-form-input gf-form-textarea",vt.css`
                width: 100%;
              `),value:n,onChange:e=>s(e.currentTarget.value)})}),!!i.length&&(0,st.jsx)(Mr,{fields:i})]})},Mr=e=>{let{fields:t}=e;return(0,st.jsxs)("table",{className:"filter-table",children:[Nr||(Nr=(0,st.jsx)("thead",{children:(0,st.jsxs)("tr",{children:[(0,st.jsx)("th",{children:"Name"}),(0,st.jsx)("th",{children:"Value"}),(0,st.jsx)("th",{children:"Url"})]})})),(0,st.jsx)("tbody",{children:t.map((e=>{let t=e.value;return e.error?t=e.error.message:e.href&&(t=(0,st.jsx)("a",{href:e.href,children:t})),(0,st.jsxs)("tr",{children:[(0,st.jsx)("td",{children:e.name}),(0,st.jsx)("td",{children:t}),(0,st.jsx)("td",{children:e.href?(0,st.jsx)("a",{href:e.href,children:e.href}):""})]},`${e.name}=${e.value}`)}))})]})};var Ar;const Br=e=>{const{value:t,onChange:r}=e,n=(e=>({infoText:vt.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,derivedField:vt.css`
    margin-bottom: ${e.spacing(1)};
  `}))((0,pt.useTheme2)()),[s,i]=(0,nt.useState)(!1);return(0,st.jsxs)(st.Fragment,{children:[Ar||(Ar=(0,st.jsx)("h3",{className:"page-heading",children:"Derived fields"})),(0,st.jsx)("div",{className:n.infoText,children:"Derived fields can be used to extract new fields from a log message and create a link from its value."}),(0,st.jsxs)("div",{className:"gf-form-group",children:[t&&t.map(((e,s)=>(0,st.jsx)(Ur,{className:n.derivedField,value:e,onChange:e=>{const a=[...t];a.splice(s,1,e),r(a)},onDelete:()=>{const e=[...t];e.splice(s,1),r(e)},suggestions:[{value:a.DataLinkBuiltInVars.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:a.VariableOrigin.Value}]},s))),(0,st.jsxs)("div",{children:[(0,st.jsx)(pt.Button,{variant:"secondary",className:vt.css`
              margin-right: 10px;
            `,icon:"plus",onClick:e=>{e.preventDefault();const a=[...t||[],{name:"",matcherRegex:""}];r(a)},children:"Add"}),t&&t.length>0&&(0,st.jsx)(pt.Button,{variant:"secondary",type:"button",onClick:()=>i(!s),children:s?"Hide example log message":"Show example log message"})]})]}),s&&(0,st.jsx)("div",{className:"gf-form-group",children:(0,st.jsx)(Gr,{className:vt.css`
              margin-bottom: 10px;
            `,derivedFields:t})})]})};var Wr=r("./public/app/features/alerting/unified/utils/alertmanager.ts");const Kr=e=>(t,r)=>Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{[e]:r})}),Zr=Kr("maxLines"),Hr=Kr("derivedFields"),Jr=new a.DataSourcePlugin(De).setQueryEditor($r).setConfigEditor((e=>{const{options:t,onOptionsChange:r}=e,a=(0,Wr.Tc)();return(0,st.jsxs)(st.Fragment,{children:[(0,st.jsx)(pt.DataSourceHttpSettings,{defaultUrl:"http://localhost:3100",dataSourceConfig:t,showAccessOptions:!1,onChange:r}),(0,st.jsx)(pt.AlertingSettings,{alertmanagerDataSources:a,options:t,onOptionsChange:r}),(0,st.jsx)("div",{className:"gf-form-group",children:(0,st.jsx)("div",{className:"gf-form-inline",children:(0,st.jsx)("div",{className:"gf-form",children:(0,st.jsx)(Fr,{value:t.jsonData.maxLines||"",onChange:e=>r(Zr(t,e))})})})}),(0,st.jsx)(Br,{value:t.jsonData.derivedFields,onChange:e=>r(Hr(t,e))})]})})).setQueryEditorHelp(ut).setAnnotationQueryCtrl(Lr)},"./public/app/plugins/datasource/loki/types.ts":(e,t,r)=>{let a,n;r.d(t,{E:()=>n,o:()=>a}),function(e){e.Stream="streams",e.Vector="vector",e.Matrix="matrix"}(a||(a={})),function(e){e.Range="range",e.Instant="instant",e.Stream="stream"}(n||(n={}))}}]);
//# sourceMappingURL=lokiPlugin.15718e8e3083449662a7.js.map
{"version":3,"file":"prometheusPlugin.36f938e74e4a21f9f522.js","mappings":"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","sources":["webpack://grafana/./public/app/features/datasources/state/contexts.ts","webpack://grafana/./public/app/features/datasources/state/hooks.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromCheatSheet.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPattern.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPatternsModal.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/types.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/state.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/MetricSelect.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/LabelFilterItem.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/LabelFilters.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQuery.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQueryList.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderExplained.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilder.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/QueryPreview.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderContainer.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExemplarField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExploreExtraField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryLegendEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderOptions.tsx","webpack://grafana/./public/app/core/utils/CancelablePromise.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PrometheusMetricsBrowser.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/monaco-query-field/MonacoQueryFieldLazy.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/monaco-query-field/MonacoQueryFieldWrapper.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryCodeEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryEditorSelector.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorForAlerting.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorByApp.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/AzureCredentials.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/AzureCredentialsConfig.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/AzureCredentialsForm.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/AzureAuthSettings.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/ExemplarSetting.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/ExemplarsSettings.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/PromFlavorVersions.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/PromSettings.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/ConfigEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/AnnotationQueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/metric_find_query.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/query_hints.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/result_transformer.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/tracking.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/variables.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/datasource.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/module.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/types.ts","webpack://grafana/../../opt/drone/yarncache/semver-npm-7.3.8-25a996cb4f-ba9c7cbbf2.zip/node_modules/semver/preload.js"],"sourcesContent":["import { createContext } from 'react';\n\nimport { DATASOURCES_ROUTES } from '../constants';\nimport { DataSourcesRoutes } from '../types';\n\n// The purpose of this context is to be able to override the data-sources routes (used for links for example) used under\n// the app/features/datasources modules, so we can reuse them more easily in different parts of the application (e.g. under Connections)\nexport const DataSourcesRoutesContext = createContext<DataSourcesRoutes>(DATASOURCES_ROUTES);\n","import { useContext, useEffect } from 'react';\n\nimport { DataSourcePluginMeta, DataSourceSettings, NavModelItem } from '@grafana/data';\nimport { cleanUpAction } from 'app/core/actions/cleanUp';\nimport appEvents from 'app/core/app_events';\nimport { contextSrv } from 'app/core/core';\nimport { getNavModel } from 'app/core/selectors/navModel';\nimport { AccessControlAction, useDispatch, useSelector } from 'app/types';\nimport { ShowConfirmModalEvent } from 'app/types/events';\n\nimport { DataSourceRights } from '../types';\nimport { constructDataSourceExploreUrl } from '../utils';\n\nimport {\n  initDataSourceSettings,\n  testDataSource,\n  loadDataSource,\n  loadDataSources,\n  loadDataSourcePlugins,\n  addDataSource,\n  updateDataSource,\n  deleteLoadedDataSource,\n} from './actions';\nimport { DataSourcesRoutesContext } from './contexts';\nimport { getDataSourceLoadingNav, buildNavModel, getDataSourceNav } from './navModel';\nimport { getDataSource, getDataSourceMeta } from './selectors';\n\nexport const useInitDataSourceSettings = (uid: string) => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    dispatch(initDataSourceSettings(uid));\n\n    return function cleanUp() {\n      dispatch(\n        cleanUpAction({\n          cleanupAction: (state) => state.dataSourceSettings,\n        })\n      );\n    };\n  }, [uid, dispatch]);\n};\n\nexport const useTestDataSource = (uid: string) => {\n  const dispatch = useDispatch();\n\n  return () => dispatch(testDataSource(uid));\n};\n\nexport const useLoadDataSources = () => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    dispatch(loadDataSources());\n  }, [dispatch]);\n};\n\nexport const useLoadDataSource = (uid: string) => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    dispatch(loadDataSource(uid));\n  }, [dispatch, uid]);\n};\n\nexport const useLoadDataSourcePlugins = () => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    dispatch(loadDataSourcePlugins());\n  }, [dispatch]);\n};\n\nexport const useAddDatasource = () => {\n  const dispatch = useDispatch();\n  const dataSourcesRoutes = useDataSourcesRoutes();\n\n  return (plugin: DataSourcePluginMeta) => {\n    dispatch(addDataSource(plugin, dataSourcesRoutes.Edit));\n  };\n};\n\nexport const useUpdateDatasource = () => {\n  const dispatch = useDispatch();\n\n  return async (dataSource: DataSourceSettings) => dispatch(updateDataSource(dataSource));\n};\n\nexport const useDeleteLoadedDataSource = () => {\n  const dispatch = useDispatch();\n  const { name } = useSelector((state) => state.dataSources.dataSource);\n\n  return () => {\n    appEvents.publish(\n      new ShowConfirmModalEvent({\n        title: 'Delete',\n        text: `Are you sure you want to delete the \"${name}\" data source?`,\n        yesText: 'Delete',\n        icon: 'trash-alt',\n        onConfirm: () => dispatch(deleteLoadedDataSource()),\n      })\n    );\n  };\n};\n\nexport const useDataSource = (uid: string) => {\n  return useSelector((state) => getDataSource(state.dataSources, uid));\n};\n\nexport const useDataSourceExploreUrl = (uid: string) => {\n  const dataSource = useDataSource(uid);\n  return constructDataSourceExploreUrl(dataSource);\n};\n\nexport const useDataSourceMeta = (pluginType: string): DataSourcePluginMeta => {\n  return useSelector((state) => getDataSourceMeta(state.dataSources, pluginType));\n};\n\nexport const useDataSourceSettings = () => {\n  return useSelector((state) => state.dataSourceSettings);\n};\n\nexport const useDataSourceSettingsNav = (dataSourceId: string, pageId: string | null) => {\n  const dataSource = useDataSource(dataSourceId);\n  const { plugin, loadError, loading } = useDataSourceSettings();\n  const navIndex = useSelector((state) => state.navIndex);\n  const navIndexId = pageId ? `datasource-${pageId}-${dataSourceId}` : `datasource-settings-${dataSourceId}`;\n\n  if (loadError) {\n    const node: NavModelItem = {\n      text: loadError,\n      subTitle: 'Data Source Error',\n      icon: 'exclamation-triangle',\n    };\n\n    return {\n      node: node,\n      main: node,\n    };\n  }\n\n  if (loading || !plugin) {\n    return getNavModel(navIndex, navIndexId, getDataSourceLoadingNav('settings'));\n  }\n\n  return getNavModel(navIndex, navIndexId, getDataSourceNav(buildNavModel(dataSource, plugin), pageId || 'settings'));\n};\n\nexport const useDataSourceRights = (uid: string): DataSourceRights => {\n  const dataSource = useDataSource(uid);\n  const readOnly = dataSource.readOnly === true;\n  const hasWriteRights = contextSrv.hasPermissionInMetadata(AccessControlAction.DataSourcesWrite, dataSource);\n  const hasDeleteRights = contextSrv.hasPermissionInMetadata(AccessControlAction.DataSourcesDelete, dataSource);\n\n  return {\n    readOnly,\n    hasWriteRights,\n    hasDeleteRights,\n  };\n};\n\nexport const useDataSourcesRoutes = () => {\n  return useContext(DataSourcesRoutesContext);\n};\n","import React from 'react';\n\nimport { QueryEditorHelpProps } from '@grafana/data';\n\nimport { PromQuery } from '../types';\n\nconst CHEAT_SHEET_ITEMS = [\n  {\n    title: 'Request Rate',\n    expression: 'rate(http_request_total[5m])',\n    label:\n      'Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes.',\n  },\n  {\n    title: '95th Percentile of Request Latencies',\n    expression: 'histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))',\n    label: 'Calculates the 95th percentile of HTTP request rate over 5 minute windows.',\n  },\n  {\n    title: 'Alerts Firing',\n    expression: 'sort_desc(sum(sum_over_time(ALERTS{alertstate=\"firing\"}[24h])) by (alertname))',\n    label: 'Sums up the alerts that have been firing over the last 24 hours.',\n  },\n  {\n    title: 'Step',\n    label:\n      'Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically.',\n  },\n];\n\nconst PromCheatSheet = (props: QueryEditorHelpProps<PromQuery>) => (\n  <div>\n    <h2>PromQL Cheat Sheet</h2>\n    {CHEAT_SHEET_ITEMS.map((item, index) => (\n      <div className=\"cheat-sheet-item\" key={index}>\n        <div className=\"cheat-sheet-item__title\">{item.title}</div>\n        {item.expression ? (\n          <button\n            type=\"button\"\n            className=\"cheat-sheet-item__example\"\n            onClick={(e) => props.onClickExample({ refId: 'A', expr: item.expression })}\n          >\n            <code>{item.expression}</code>\n          </button>\n        ) : null}\n        <div className=\"cheat-sheet-item__label\">{item.label}</div>\n      </div>\n    ))}\n  </div>\n);\n\nexport default PromCheatSheet;\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Card, useStyles2 } from '@grafana/ui';\nimport { RawQuery } from 'app/plugins/datasource/prometheus/querybuilder/shared/RawQuery';\n\nimport promqlGrammar from '../promql';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { PromQueryPattern } from './types';\n\ntype Props = {\n  pattern: PromQueryPattern;\n  hasNewQueryOption: boolean;\n  hasPreviousQuery: boolean | string;\n  selectedPatternName: string | null;\n  setSelectedPatternName: (name: string | null) => void;\n  onPatternSelect: (pattern: PromQueryPattern, selectAsNewQuery?: boolean) => void;\n};\n\nexport const QueryPattern = (props: Props) => {\n  const { pattern, onPatternSelect, hasNewQueryOption, hasPreviousQuery, selectedPatternName, setSelectedPatternName } =\n    props;\n\n  const styles = useStyles2(getStyles);\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Card className={styles.card}>\n      <Card.Heading>{pattern.name}</Card.Heading>\n      <div className={styles.rawQueryContainer}>\n        <RawQuery\n          aria-label={`${pattern.name} raw query`}\n          query={promQueryModeller.renderQuery({\n            labels: [],\n            operations: pattern.operations,\n            binaryQueries: pattern.binaryQueries,\n          })}\n          lang={lang}\n          className={styles.rawQuery}\n        />\n      </div>\n      <Card.Actions>\n        {selectedPatternName !== pattern.name ? (\n          <Button\n            size=\"sm\"\n            aria-label=\"use this query button\"\n            onClick={() => {\n              if (hasPreviousQuery) {\n                // If user has previous query, we need to confirm that they want to apply this query pattern\n                setSelectedPatternName(pattern.name);\n              } else {\n                onPatternSelect(pattern);\n              }\n            }}\n          >\n            Use this query\n          </Button>\n        ) : (\n          <>\n            <div className={styles.spacing}>\n              {`If you would like to use this query, ${\n                hasNewQueryOption\n                  ? 'you can either apply this query pattern or create a new query'\n                  : 'this query pattern will be applied to your current query'\n              }.`}\n            </div>\n            <Button size=\"sm\" aria-label=\"back button\" fill=\"outline\" onClick={() => setSelectedPatternName(null)}>\n              Back\n            </Button>\n            <Button\n              size=\"sm\"\n              aria-label=\"apply query starter button\"\n              onClick={() => {\n                onPatternSelect(pattern);\n              }}\n            >\n              Apply query\n            </Button>\n            {hasNewQueryOption && (\n              <Button\n                size=\"sm\"\n                aria-label=\"create new query button\"\n                onClick={() => {\n                  onPatternSelect(pattern, true);\n                }}\n              >\n                Create new query\n              </Button>\n            )}\n          </>\n        )}\n      </Card.Actions>\n    </Card>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css`\n      width: 49.5%;\n      display: flex;\n      flex-direction: column;\n    `,\n    rawQueryContainer: css`\n      flex-grow: 1;\n    `,\n    rawQuery: css`\n      background-color: ${theme.colors.background.primary};\n      padding: ${theme.spacing(1)};\n      margin-top: ${theme.spacing(1)};\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { capitalize } from 'lodash';\nimport React, { useMemo, useState } from 'react';\n\nimport { CoreApp, DataQuery, GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Collapse, Modal, useStyles2 } from '@grafana/ui';\nimport { getNextRefIdChar } from 'app/core/utils/query';\n\nimport { PromQuery } from '../types';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { QueryPattern } from './QueryPattern';\nimport { buildVisualQueryFromString } from './parsing';\nimport { PromQueryPattern, PromQueryPatternType } from './types';\n\ntype Props = {\n  isOpen: boolean;\n  query: PromQuery;\n  queries: DataQuery[] | undefined;\n  app?: CoreApp;\n  onClose: () => void;\n  onChange: (query: PromQuery) => void;\n  onAddQuery?: (query: PromQuery) => void;\n};\n\nexport const QueryPatternsModal = (props: Props) => {\n  const { isOpen, onClose, onChange, onAddQuery, query, queries, app } = props;\n  const [openTabs, setOpenTabs] = useState<string[]>([]);\n  const [selectedPatternName, setSelectedPatternName] = useState<string | null>(null);\n\n  const styles = useStyles2(getStyles);\n  const hasNewQueryOption = !!onAddQuery;\n  const hasPreviousQuery = useMemo(() => {\n    const visualQuery = buildVisualQueryFromString(query.expr);\n    // has anything entered in the query, metric, labels, operations, or binary queries\n    const hasOperations = visualQuery.query.operations.length > 0,\n      hasMetric = visualQuery.query.metric,\n      hasLabels = visualQuery.query.labels.length > 0,\n      hasBinaryQueries = visualQuery.query.binaryQueries ? visualQuery.query.binaryQueries.length > 0 : false;\n\n    return hasOperations || hasMetric || hasLabels || hasBinaryQueries;\n  }, [query.expr]);\n\n  const onPatternSelect = (pattern: PromQueryPattern, selectAsNewQuery = false) => {\n    const visualQuery = buildVisualQueryFromString(selectAsNewQuery ? '' : query.expr);\n    reportInteraction('grafana_prom_kickstart_your_query_selected', {\n      app: app ?? '',\n      editorMode: query.editorMode,\n      selectedPattern: pattern.name,\n      preSelectedOperationsCount: visualQuery.query.operations.length,\n      preSelectedLabelsCount: visualQuery.query.labels.length,\n      createNewQuery: hasNewQueryOption && selectAsNewQuery,\n    });\n\n    visualQuery.query.operations = pattern.operations;\n    visualQuery.query.binaryQueries = pattern.binaryQueries;\n    if (hasNewQueryOption && selectAsNewQuery) {\n      onAddQuery({\n        ...query,\n        refId: getNextRefIdChar(queries ?? [query]),\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    } else {\n      onChange({\n        ...query,\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    }\n    setSelectedPatternName(null);\n    onClose();\n  };\n\n  return (\n    <Modal aria-label=\"Kick start your query modal\" isOpen={isOpen} title=\"Kick start your query\" onDismiss={onClose}>\n      <div className={styles.spacing}>\n        Kick start your query by selecting one of these queries. You can then continue to complete your query.\n      </div>\n      {Object.values(PromQueryPatternType).map((patternType) => {\n        return (\n          <Collapse\n            aria-label={`open and close ${patternType} query starter card`}\n            key={patternType}\n            label={`${capitalize(patternType)} query starters`}\n            isOpen={openTabs.includes(patternType)}\n            collapsible={true}\n            onToggle={() =>\n              setOpenTabs((tabs) =>\n                // close tab if it's already open, otherwise open it\n                tabs.includes(patternType) ? tabs.filter((t) => t !== patternType) : [...tabs, patternType]\n              )\n            }\n          >\n            <div className={styles.cardsContainer}>\n              {promQueryModeller\n                .getQueryPatterns()\n                .filter((pattern) => pattern.type === patternType)\n                .map((pattern) => (\n                  <QueryPattern\n                    key={pattern.name}\n                    pattern={pattern}\n                    hasNewQueryOption={hasNewQueryOption}\n                    hasPreviousQuery={hasPreviousQuery}\n                    onPatternSelect={onPatternSelect}\n                    selectedPatternName={selectedPatternName}\n                    setSelectedPatternName={setSelectedPatternName}\n                  />\n                ))}\n            </div>\n          </Collapse>\n        );\n      })}\n      <Button aria-label=\"close kick start your query modal\" variant=\"secondary\" onClick={onClose}>\n        Close\n      </Button>\n    </Modal>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    cardsContainer: css`\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      justify-content: space-between;\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { DataQuery, DataSourceJsonData, QueryResultMeta, ScopedVars } from '@grafana/data';\n\nimport { PromApplication } from '../../../types/unified-alerting-dto';\n\nimport { QueryEditorMode } from './querybuilder/shared/types';\n\nexport interface PromQuery extends DataQuery {\n  expr: string;\n  format?: string;\n  instant?: boolean;\n  range?: boolean;\n  exemplar?: boolean;\n  hinting?: boolean;\n  interval?: string;\n  intervalFactor?: number;\n  // Timezone offset to align start & end time on backend\n  utcOffsetSec?: number;\n  legendFormat?: string;\n  valueWithRefId?: boolean;\n  requestId?: string;\n  showingGraph?: boolean;\n  showingTable?: boolean;\n  /** Code, Builder or Explain */\n  editorMode?: QueryEditorMode;\n}\n\nexport interface PromOptions extends DataSourceJsonData {\n  timeInterval?: string;\n  queryTimeout?: string;\n  httpMethod?: string;\n  directUrl?: string;\n  customQueryParameters?: string;\n  disableMetricsLookup?: boolean;\n  exemplarTraceIdDestinations?: ExemplarTraceIdDestination[];\n  prometheusType?: PromApplication;\n  prometheusVersion?: string;\n  defaultEditor?: QueryEditorMode;\n}\n\nexport type ExemplarTraceIdDestination = {\n  name: string;\n  url?: string;\n  urlDisplayLabel?: string;\n  datasourceUid?: string;\n};\n\nexport interface PromQueryRequest extends PromQuery {\n  step?: number;\n  requestId?: string;\n  start: number;\n  end: number;\n  headers?: any;\n}\n\nexport interface PromMetricsMetadataItem {\n  type: string;\n  help: string;\n  unit?: string;\n}\n\nexport interface PromMetricsMetadata {\n  [metric: string]: PromMetricsMetadataItem;\n}\n\nexport interface PromDataSuccessResponse<T = PromData> {\n  status: 'success';\n  data: T;\n}\n\nexport interface PromDataErrorResponse<T = PromData> {\n  status: 'error';\n  errorType: string;\n  error: string;\n  data: T;\n}\n\nexport type PromData = PromMatrixData | PromVectorData | PromScalarData | PromExemplarData[];\n\nexport interface Labels {\n  [index: string]: any;\n}\n\nexport interface Exemplar {\n  labels: Labels;\n  value: number;\n  timestamp: number;\n}\n\nexport interface PromExemplarData {\n  seriesLabels: PromMetric;\n  exemplars: Exemplar[];\n}\n\nexport interface PromVectorData {\n  resultType: 'vector';\n  result: Array<{\n    metric: PromMetric;\n    value: PromValue;\n  }>;\n}\n\nexport interface PromMatrixData {\n  resultType: 'matrix';\n  result: Array<{\n    metric: PromMetric;\n    values: PromValue[];\n  }>;\n}\n\nexport interface PromScalarData {\n  resultType: 'scalar';\n  result: PromValue;\n}\n\nexport type PromValue = [number, any];\n\nexport interface PromMetric {\n  __name__?: string;\n\n  [index: string]: any;\n}\n\nexport function isMatrixData(result: MatrixOrVectorResult): result is PromMatrixData['result'][0] {\n  return 'values' in result;\n}\n\nexport function isExemplarData(result: PromData): result is PromExemplarData[] {\n  if (result == null || !Array.isArray(result)) {\n    return false;\n  }\n  return result.length ? 'exemplars' in result[0] : false;\n}\n\nexport type MatrixOrVectorResult = PromMatrixData['result'][0] | PromVectorData['result'][0];\n\nexport interface TransformOptions {\n  format?: string;\n  step?: number;\n  legendFormat?: string;\n  start: number;\n  end: number;\n  query: string;\n  responseListLength: number;\n  scopedVars?: ScopedVars;\n  refId: string;\n  valueWithRefId?: boolean;\n  meta: QueryResultMeta;\n}\n\nexport interface PromLabelQueryResponse {\n  data: {\n    status: string;\n    data: string[];\n  };\n  cancelled?: boolean;\n}\n\n/**\n * Auto = query.legendFormat == '__auto'\n * Verbose = query.legendFormat == null/undefined/''\n * Custom query.legendFormat.length > 0 && query.legendFormat !== '__auto'\n */\nexport enum LegendFormatMode {\n  Auto = '__auto',\n  Verbose = '__verbose',\n  Custom = '__custom',\n}\n","import { CoreApp } from '@grafana/data';\nimport store from 'app/core/store';\n\nimport { LegendFormatMode, PromQuery } from '../types';\n\nimport { QueryEditorMode } from './shared/types';\n\nconst queryEditorModeDefaultLocalStorageKey = 'PrometheusQueryEditorModeDefault';\n\nexport function changeEditorMode(query: PromQuery, editorMode: QueryEditorMode, onChange: (query: PromQuery) => void) {\n  // If empty query store new mode as default\n  if (query.expr === '') {\n    store.set(queryEditorModeDefaultLocalStorageKey, editorMode);\n  }\n\n  onChange({ ...query, editorMode });\n}\n\nfunction getDefaultEditorMode(expr: string, defaultEditor: QueryEditorMode = QueryEditorMode.Builder): QueryEditorMode {\n  // If we already have an expression default to code view\n  if (expr != null && expr !== '') {\n    return QueryEditorMode.Code;\n  }\n\n  const value: QueryEditorMode = store.get(queryEditorModeDefaultLocalStorageKey);\n  switch (value) {\n    case QueryEditorMode.Builder:\n    case QueryEditorMode.Code:\n      return value;\n    default:\n      return defaultEditor;\n  }\n}\n\n/**\n * Returns query with defaults, and boolean true/false depending on change was required\n */\nexport function getQueryWithDefaults(\n  query: PromQuery,\n  app: CoreApp | undefined,\n  defaultEditor?: QueryEditorMode\n): PromQuery {\n  let result = query;\n\n  if (!query.editorMode) {\n    result = { ...query, editorMode: getDefaultEditorMode(query.expr, defaultEditor) };\n  }\n\n  if (query.expr == null) {\n    result = { ...result, expr: '', legendFormat: LegendFormatMode.Auto };\n  }\n\n  if (query.range == null && query.instant == null) {\n    // Default to range query\n    result = { ...result, range: true };\n\n    // In explore we default to both instant & range\n    if (app === CoreApp.Explore) {\n      result.instant = true;\n    }\n  }\n\n  // Unified Alerting does not support \"both\" for query type  fall back to \"range\".\n  const isBothInstantAndRange = query.instant && query.range;\n  if (app === CoreApp.UnifiedAlerting && isBothInstantAndRange) {\n    result = { ...result, instant: false, range: true };\n  }\n\n  return result;\n}\n","import { css } from '@emotion/css';\nimport debounce from 'debounce-promise';\nimport React, { useCallback, useState } from 'react';\nimport Highlighter from 'react-highlight-words';\n\nimport { SelectableValue, toOption, GrafanaTheme2 } from '@grafana/data';\nimport { EditorField, EditorFieldGroup } from '@grafana/experimental';\nimport { AsyncSelect, FormatOptionLabelMeta, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { regexifyLabelValuesQueryString } from '../shared/parsingUtils';\nimport { QueryBuilderLabelFilter } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\n// We are matching words split with space\nconst splitSeparator = ' ';\n\nexport interface Props {\n  query: PromVisualQuery;\n  onChange: (query: PromVisualQuery) => void;\n  onGetMetrics: () => Promise<SelectableValue[]>;\n  datasource: PrometheusDatasource;\n  labelsFilters: QueryBuilderLabelFilter[];\n}\n\nexport const PROMETHEUS_QUERY_BUILDER_MAX_RESULTS = 1000;\n\nexport function MetricSelect({ datasource, query, onChange, onGetMetrics, labelsFilters }: Props) {\n  const styles = useStyles2(getStyles);\n  const [state, setState] = useState<{\n    metrics?: Array<SelectableValue<any>>;\n    isLoading?: boolean;\n  }>({});\n\n  const customFilterOption = useCallback((option: SelectableValue<any>, searchQuery: string) => {\n    const label = option.label ?? option.value;\n    if (!label) {\n      return false;\n    }\n\n    // custom value is not a string label but a react node\n    if (!label.toLowerCase) {\n      return true;\n    }\n\n    const searchWords = searchQuery.split(splitSeparator);\n    return searchWords.reduce((acc, cur) => acc && label.toLowerCase().includes(cur.toLowerCase()), true);\n  }, []);\n\n  const formatOptionLabel = useCallback(\n    (option: SelectableValue<any>, meta: FormatOptionLabelMeta<any>) => {\n      // For newly created custom value we don't want to add highlight\n      if (option['__isNew__']) {\n        return option.label;\n      }\n\n      return (\n        <Highlighter\n          searchWords={meta.inputValue.split(splitSeparator)}\n          textToHighlight={option.label ?? ''}\n          highlightClassName={styles.highlight}\n        />\n      );\n    },\n    [styles.highlight]\n  );\n\n  const formatLabelFilters = (labelsFilters: QueryBuilderLabelFilter[]): string[] => {\n    return labelsFilters.map((label) => {\n      return `,${label.label}=\"${label.value}\"`;\n    });\n  };\n\n  /**\n   * Transform queryString and any currently set label filters into label_values() string\n   */\n  const queryAndFilterToLabelValuesString = (\n    queryString: string,\n    labelsFilters: QueryBuilderLabelFilter[] | undefined\n  ): string => {\n    return `label_values({__name__=~\".*${queryString}\"${\n      labelsFilters ? formatLabelFilters(labelsFilters).join() : ''\n    }},__name__)`;\n  };\n\n  /**\n   * Reformat the query string and label filters to return all valid results for current query editor state\n   */\n  const formatKeyValueStringsForLabelValuesQuery = (\n    query: string,\n    labelsFilters?: QueryBuilderLabelFilter[]\n  ): string => {\n    const queryString = regexifyLabelValuesQueryString(query);\n\n    return queryAndFilterToLabelValuesString(queryString, labelsFilters);\n  };\n\n  /**\n   * Gets label_values response from prometheus API for current autocomplete query string and any existing labels filters\n   */\n  const getMetricLabels = (query: string) => {\n    // Since some customers can have millions of metrics, whenever the user changes the autocomplete text we want to call the backend and request all metrics that match the current query string\n    const results = datasource.metricFindQuery(formatKeyValueStringsForLabelValuesQuery(query, labelsFilters));\n    return results.then((results) => {\n      if (results.length > PROMETHEUS_QUERY_BUILDER_MAX_RESULTS) {\n        results.splice(0, results.length - PROMETHEUS_QUERY_BUILDER_MAX_RESULTS);\n      }\n      return results.map((result) => {\n        return {\n          label: result.text,\n          value: result.text,\n        };\n      });\n    });\n  };\n\n  const debouncedSearch = debounce((query: string) => getMetricLabels(query), 300);\n\n  return (\n    <EditorFieldGroup>\n      <EditorField label=\"Metric\">\n        <AsyncSelect\n          inputId=\"prometheus-metric-select\"\n          className={styles.select}\n          value={query.metric ? toOption(query.metric) : undefined}\n          placeholder=\"Select metric\"\n          allowCustomValue\n          formatOptionLabel={formatOptionLabel}\n          filterOption={customFilterOption}\n          onOpenMenu={async () => {\n            setState({ isLoading: true });\n            const metrics = await onGetMetrics();\n            if (metrics.length > PROMETHEUS_QUERY_BUILDER_MAX_RESULTS) {\n              metrics.splice(0, metrics.length - PROMETHEUS_QUERY_BUILDER_MAX_RESULTS);\n            }\n            setState({ metrics, isLoading: undefined });\n          }}\n          loadOptions={debouncedSearch}\n          isLoading={state.isLoading}\n          defaultOptions={state.metrics}\n          onChange={({ value }) => {\n            if (value) {\n              onChange({ ...query, metric: value });\n            }\n          }}\n        />\n      </EditorField>\n    </EditorFieldGroup>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  select: css`\n    min-width: 125px;\n  `,\n  highlight: css`\n    label: select__match-highlight;\n    background: inherit;\n    padding: inherit;\n    color: ${theme.colors.warning.contrastText};\n    background-color: ${theme.colors.warning.main};\n  `,\n});\n","import debounce from 'debounce-promise';\nimport React, { useState } from 'react';\n\nimport { SelectableValue, toOption } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { AccessoryButton, InputGroup } from '@grafana/experimental';\nimport { AsyncSelect, Select } from '@grafana/ui';\n\nimport { QueryBuilderLabelFilter } from '../shared/types';\n\nimport { PROMETHEUS_QUERY_BUILDER_MAX_RESULTS } from './MetricSelect';\n\nexport interface Props {\n  defaultOp: string;\n  item: Partial<QueryBuilderLabelFilter>;\n  onChange: (value: QueryBuilderLabelFilter) => void;\n  onGetLabelNames: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onGetLabelValues: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onDelete: () => void;\n  invalidLabel?: boolean;\n  invalidValue?: boolean;\n  getLabelValuesAutofillSuggestions: (query: string, labelName?: string) => Promise<SelectableValue[]>;\n}\n\nexport function LabelFilterItem({\n  item,\n  defaultOp,\n  onChange,\n  onDelete,\n  onGetLabelNames,\n  onGetLabelValues,\n  invalidLabel,\n  invalidValue,\n  getLabelValuesAutofillSuggestions,\n}: Props) {\n  const [state, setState] = useState<{\n    labelNames?: SelectableValue[];\n    labelValues?: SelectableValue[];\n    isLoadingLabelNames?: boolean;\n    isLoadingLabelValues?: boolean;\n  }>({});\n\n  const isMultiSelect = (operator = item.op) => {\n    return operators.find((op) => op.label === operator)?.isMultiValue;\n  };\n\n  const getSelectOptionsFromString = (item?: string): string[] => {\n    if (item) {\n      if (item.indexOf('|') > 0) {\n        return item.split('|');\n      }\n      return [item];\n    }\n    return [];\n  };\n\n  const labelValueSearch = debounce((query: string) => getLabelValuesAutofillSuggestions(query, item.label), 350);\n\n  return (\n    <div data-testid=\"prometheus-dimensions-filter-item\">\n      <InputGroup>\n        {/* Label name select, loads all values at once */}\n        <Select\n          placeholder=\"Select label\"\n          aria-label={selectors.components.QueryBuilder.labelSelect}\n          inputId=\"prometheus-dimensions-filter-item-key\"\n          width=\"auto\"\n          value={item.label ? toOption(item.label) : null}\n          allowCustomValue\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelNames: true });\n            const labelNames = await onGetLabelNames(item);\n            setState({ labelNames, isLoadingLabelNames: undefined });\n          }}\n          isLoading={state.isLoadingLabelNames ?? false}\n          options={state.labelNames}\n          onChange={(change) => {\n            if (change.label) {\n              onChange({\n                ...item,\n                op: item.op ?? defaultOp,\n                label: change.label,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidLabel}\n        />\n\n        {/* Operator select i.e.   = =~ != !~   */}\n        <Select\n          aria-label={selectors.components.QueryBuilder.matchOperatorSelect}\n          className=\"query-segment-operator\"\n          value={toOption(item.op ?? defaultOp)}\n          options={operators}\n          width=\"auto\"\n          onChange={(change) => {\n            if (change.value != null) {\n              onChange({\n                ...item,\n                op: change.value,\n                value: isMultiSelect(change.value) ? item.value : getSelectOptionsFromString(item?.value)[0],\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n        />\n\n        {/* Label value async select: autocomplete calls prometheus API */}\n        <AsyncSelect\n          placeholder=\"Select value\"\n          aria-label={selectors.components.QueryBuilder.valueSelect}\n          inputId=\"prometheus-dimensions-filter-item-value\"\n          width=\"auto\"\n          value={\n            isMultiSelect()\n              ? getSelectOptionsFromString(item?.value).map(toOption)\n              : getSelectOptionsFromString(item?.value).map(toOption)[0]\n          }\n          allowCustomValue\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelValues: true });\n            const labelValues = await onGetLabelValues(item);\n            if (labelValues.length > PROMETHEUS_QUERY_BUILDER_MAX_RESULTS) {\n              labelValues.splice(0, labelValues.length - PROMETHEUS_QUERY_BUILDER_MAX_RESULTS);\n            }\n            setState({\n              ...state,\n              labelValues,\n              isLoadingLabelValues: undefined,\n            });\n          }}\n          defaultOptions={state.labelValues}\n          isMulti={isMultiSelect()}\n          isLoading={state.isLoadingLabelValues}\n          loadOptions={labelValueSearch}\n          onChange={(change) => {\n            if (change.value) {\n              onChange({\n                ...item,\n                value: change.value,\n                op: item.op ?? defaultOp,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            } else {\n              const changes = change\n                .map((change: { label?: string }) => {\n                  return change.label;\n                })\n                .join('|');\n              // eslint-ignore\n              onChange({ ...item, value: changes, op: item.op ?? defaultOp } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidValue}\n        />\n        <AccessoryButton aria-label=\"remove\" icon=\"times\" variant=\"secondary\" onClick={onDelete} />\n      </InputGroup>\n    </div>\n  );\n}\n\nconst operators = [\n  { label: '=', value: '=', isMultiValue: false },\n  { label: '!=', value: '!=', isMultiValue: false },\n  { label: '<', value: '<', isMultiValue: false },\n  { label: '>', value: '>', isMultiValue: false },\n  { label: '=~', value: '=~', isMultiValue: true },\n  { label: '!~', value: '!~', isMultiValue: true },\n];\n","import { isEqual } from 'lodash';\nimport React, { useEffect, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { EditorFieldGroup, EditorField, EditorList } from '@grafana/experimental';\n\nimport { QueryBuilderLabelFilter } from '../shared/types';\n\nimport { LabelFilterItem } from './LabelFilterItem';\n\nexport const MISSING_LABEL_FILTER_ERROR_MESSAGE = 'Select at least 1 label filter (label and value)';\n\nexport interface Props {\n  labelsFilters: QueryBuilderLabelFilter[];\n  onChange: (labelFilters: Array<Partial<QueryBuilderLabelFilter>>) => void;\n  onGetLabelNames: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onGetLabelValues: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  /** If set to true, component will show error message until at least 1 filter is selected */\n  labelFilterRequired?: boolean;\n  getLabelValuesAutofillSuggestions: (query: string, labelName?: string) => Promise<SelectableValue[]>;\n}\n\nexport function LabelFilters({\n  labelsFilters,\n  onChange,\n  onGetLabelNames,\n  onGetLabelValues,\n  labelFilterRequired,\n  getLabelValuesAutofillSuggestions,\n}: Props) {\n  const defaultOp = '=';\n  const [items, setItems] = useState<Array<Partial<QueryBuilderLabelFilter>>>([{ op: defaultOp }]);\n\n  useEffect(() => {\n    if (labelsFilters.length > 0) {\n      setItems(labelsFilters);\n    } else {\n      setItems([{ op: defaultOp }]);\n    }\n  }, [labelsFilters]);\n\n  const onLabelsChange = (newItems: Array<Partial<QueryBuilderLabelFilter>>) => {\n    setItems(newItems);\n\n    // Extract full label filters with both label & value\n    const newLabels = newItems.filter((x) => x.label != null && x.value != null);\n    if (!isEqual(newLabels, labelsFilters)) {\n      onChange(newLabels);\n    }\n  };\n\n  const hasLabelFilter = items.some((item) => item.label && item.value);\n\n  return (\n    <EditorFieldGroup>\n      <EditorField\n        label=\"Label filters\"\n        error={MISSING_LABEL_FILTER_ERROR_MESSAGE}\n        invalid={labelFilterRequired && !hasLabelFilter}\n      >\n        <EditorList\n          items={items}\n          onChange={onLabelsChange}\n          renderItem={(item: Partial<QueryBuilderLabelFilter>, onChangeItem, onDelete) => (\n            <LabelFilterItem\n              item={item}\n              defaultOp={defaultOp}\n              onChange={onChangeItem}\n              onDelete={onDelete}\n              onGetLabelNames={onGetLabelNames}\n              onGetLabelValues={onGetLabelValues}\n              invalidLabel={labelFilterRequired && !item.label}\n              invalidValue={labelFilterRequired && !item.value}\n              getLabelValuesAutofillSuggestions={getLabelValuesAutofillSuggestions}\n            />\n          )}\n        />\n      </EditorField>\n    </EditorFieldGroup>\n  );\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, toOption } from '@grafana/data';\nimport { EditorRows, FlexItem } from '@grafana/experimental';\nimport { AutoSizeInput, IconButton, Select, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { binaryScalarDefs } from '../binaryScalarOperations';\nimport { PromVisualQueryBinary } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\n\nexport interface Props {\n  nestedQuery: PromVisualQueryBinary;\n  datasource: PrometheusDatasource;\n  index: number;\n  onChange: (index: number, update: PromVisualQueryBinary) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport const NestedQuery = React.memo<Props>((props) => {\n  const { nestedQuery, index, datasource, onChange, onRemove, onRunQuery, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.card}>\n      <div className={styles.header}>\n        <div className={styles.name}>Operator</div>\n        <Select\n          width=\"auto\"\n          options={operators}\n          value={toOption(nestedQuery.operator)}\n          onChange={(value) => {\n            onChange(index, {\n              ...nestedQuery,\n              operator: value.value!,\n            });\n          }}\n        />\n        <div className={styles.name}>Vector matches</div>\n        <div className={styles.vectorMatchWrapper}>\n          <Select<PromVisualQueryBinary['vectorMatchesType']>\n            width=\"auto\"\n            value={nestedQuery.vectorMatchesType || 'on'}\n            allowCustomValue\n            options={[\n              { value: 'on', label: 'on' },\n              { value: 'ignoring', label: 'ignoring' },\n            ]}\n            onChange={(val) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatchesType: val.value,\n              });\n            }}\n          />\n          <AutoSizeInput\n            className={styles.vectorMatchInput}\n            minWidth={20}\n            defaultValue={nestedQuery.vectorMatches}\n            onCommitChange={(evt) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatches: evt.currentTarget.value,\n                vectorMatchesType: nestedQuery.vectorMatchesType || 'on',\n              });\n            }}\n          />\n        </div>\n        <FlexItem grow={1} />\n        <IconButton name=\"times\" size=\"sm\" onClick={() => onRemove(index)} />\n      </div>\n      <div className={styles.body}>\n        <EditorRows>\n          <PromQueryBuilder\n            showExplain={showExplain}\n            query={nestedQuery.query}\n            datasource={datasource}\n            onRunQuery={onRunQuery}\n            onChange={(update) => {\n              onChange(index, { ...nestedQuery, query: update });\n            }}\n          />\n        </EditorRows>\n      </div>\n    </div>\n  );\n});\n\nconst operators = binaryScalarDefs.map((def) => ({ label: def.sign, value: def.sign }));\n\nNestedQuery.displayName = 'NestedQuery';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css({\n      label: 'card',\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(0.5),\n    }),\n    header: css({\n      label: 'header',\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      gap: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    name: css({\n      label: 'name',\n      whiteSpace: 'nowrap',\n    }),\n    body: css({\n      label: 'body',\n      paddingLeft: theme.spacing(2),\n    }),\n    vectorMatchInput: css({\n      label: 'vectorMatchInput',\n      marginLeft: -1,\n    }),\n    vectorMatchWrapper: css({\n      label: 'vectorMatchWrapper',\n      display: 'flex',\n    }),\n  };\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/experimental';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromVisualQuery, PromVisualQueryBinary } from '../types';\n\nimport { NestedQuery } from './NestedQuery';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (query: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport function NestedQueryList(props: Props) {\n  const { query, datasource, onChange, onRunQuery, showExplain } = props;\n  const nestedQueries = query.binaryQueries ?? [];\n\n  const onNestedQueryUpdate = (index: number, update: PromVisualQueryBinary) => {\n    const updatedList = [...nestedQueries];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...nestedQueries.slice(0, index), ...nestedQueries.slice(index + 1)];\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  return (\n    <Stack direction=\"column\" gap={1}>\n      {nestedQueries.map((nestedQuery, index) => (\n        <NestedQuery\n          key={index.toString()}\n          nestedQuery={nestedQuery}\n          index={index}\n          onChange={onNestedQueryUpdate}\n          datasource={datasource}\n          onRemove={onRemove}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      ))}\n    </Stack>\n  );\n}\n","import React from 'react';\n\nimport { Stack } from '@grafana/experimental';\n\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { RawQuery } from '../shared/RawQuery';\nimport { PromVisualQuery } from '../types';\n\nexport const EXPLAIN_LABEL_FILTER_CONTENT = 'Fetch all series matching metric name and label filters.';\n\nexport interface Props {\n  query: string;\n}\n\nexport const PromQueryBuilderExplained = React.memo<Props>(({ query }) => {\n  const visQuery = buildVisualQueryFromString(query || '').query;\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Stack gap={0.5} direction=\"column\">\n      <OperationExplainedBox\n        stepNumber={1}\n        title={<RawQuery query={`${visQuery.metric} ${promQueryModeller.renderLabels(visQuery.labels)}`} lang={lang} />}\n      >\n        {EXPLAIN_LABEL_FILTER_CONTENT}\n      </OperationExplainedBox>\n      <OperationListExplained<PromVisualQuery>\n        stepNumber={2}\n        queryModeller={promQueryModeller}\n        query={visQuery}\n        lang={lang}\n      />\n    </Stack>\n  );\n});\n\nPromQueryBuilderExplained.displayName = 'PromQueryBuilderExplained';\n","import React, { useCallback, useState } from 'react';\n\nimport { DataSourceApi, PanelData, SelectableValue } from '@grafana/data';\nimport { EditorRow } from '@grafana/experimental';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { getMetadataString } from '../../language_provider';\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationList } from '../shared/OperationList';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { OperationsEditorRow } from '../shared/OperationsEditorRow';\nimport { QueryBuilderHints } from '../shared/QueryBuilderHints';\nimport { RawQuery } from '../shared/RawQuery';\nimport { regexifyLabelValuesQueryString } from '../shared/parsingUtils';\nimport { QueryBuilderLabelFilter, QueryBuilderOperation } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { LabelFilters } from './LabelFilters';\nimport { MetricSelect, PROMETHEUS_QUERY_BUILDER_MAX_RESULTS } from './MetricSelect';\nimport { NestedQueryList } from './NestedQueryList';\nimport { EXPLAIN_LABEL_FILTER_CONTENT } from './PromQueryBuilderExplained';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport const PromQueryBuilder = React.memo<Props>((props) => {\n  const { datasource, query, onChange, onRunQuery, data, showExplain } = props;\n  const [highlightedOp, setHighlightedOp] = useState<QueryBuilderOperation | undefined>();\n  const onChangeLabels = (labels: QueryBuilderLabelFilter[]) => {\n    onChange({ ...query, labels });\n  };\n\n  /**\n   * Map metric metadata to SelectableValue for Select component and also adds defined template variables to the list.\n   */\n  const withTemplateVariableOptions = useCallback(\n    async (optionsPromise: Promise<SelectableValue[]>): Promise<SelectableValue[]> => {\n      const variables = datasource.getVariables();\n      const options = await optionsPromise;\n      return [\n        ...variables.map((value) => ({ label: value, value })),\n        ...options.map((option) => ({ label: option.value, value: option.value, title: option.description })),\n      ];\n    },\n    [datasource]\n  );\n\n  /**\n   * Function kicked off when user interacts with label in label filters.\n   * Formats a promQL expression and passes that off to helper functions depending on API support\n   * @param forLabel\n   */\n  const onGetLabelNames = async (forLabel: Partial<QueryBuilderLabelFilter>): Promise<SelectableValue[]> => {\n    // If no metric we need to use a different method\n    if (!query.metric) {\n      // Todo add caching but inside language provider!\n      await datasource.languageProvider.fetchLabels();\n      return datasource.languageProvider.getLabelKeys().map((k) => ({ value: k }));\n    }\n\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n    labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n    const expr = promQueryModeller.renderLabels(labelsToConsider);\n\n    let labelsIndex;\n    if (datasource.hasLabelsMatchAPISupport()) {\n      labelsIndex = await datasource.languageProvider.fetchSeriesLabelsMatch(expr);\n    } else {\n      labelsIndex = await datasource.languageProvider.fetchSeriesLabels(expr);\n    }\n\n    // filter out already used labels\n    return Object.keys(labelsIndex)\n      .filter((labelName) => !labelsToConsider.find((filter) => filter.label === labelName))\n      .map((k) => ({ value: k }));\n  };\n\n  const getLabelValuesAutocompleteSuggestions = (\n    queryString?: string,\n    labelName?: string\n  ): Promise<SelectableValue[]> => {\n    const forLabel = {\n      label: labelName ?? '__name__',\n      op: '=~',\n      value: regexifyLabelValuesQueryString(`.*${queryString}`),\n    };\n    const labelsToConsider = query.labels.filter((x) => x.label !== forLabel.label);\n    labelsToConsider.push(forLabel);\n    if (query.metric) {\n      labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n    }\n    const interpolatedLabelsToConsider = labelsToConsider.map((labelObject) => ({\n      ...labelObject,\n      label: datasource.interpolateString(labelObject.label),\n      value: datasource.interpolateString(labelObject.value),\n    }));\n    const expr = promQueryModeller.renderLabels(interpolatedLabelsToConsider);\n    let response;\n    if (datasource.hasLabelsMatchAPISupport()) {\n      response = getLabelValuesFromLabelValuesAPI(forLabel, expr);\n    } else {\n      response = getLabelValuesFromSeriesAPI(forLabel, expr);\n    }\n\n    return response.then((response: SelectableValue[]) => {\n      if (response.length > PROMETHEUS_QUERY_BUILDER_MAX_RESULTS) {\n        response.splice(0, response.length - PROMETHEUS_QUERY_BUILDER_MAX_RESULTS);\n      }\n      return response;\n    });\n  };\n\n  /**\n   * Helper function to fetch and format label value results from legacy API\n   * @param forLabel\n   * @param promQLExpression\n   */\n  const getLabelValuesFromSeriesAPI = (\n    forLabel: Partial<QueryBuilderLabelFilter>,\n    promQLExpression: string\n  ): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return Promise.resolve([]);\n    }\n    const result = datasource.languageProvider.fetchSeries(promQLExpression);\n    const forLabelInterpolated = datasource.interpolateString(forLabel.label);\n    return result.then((result) => {\n      // This query returns duplicate values, scrub them out\n      const set = new Set<string>();\n      result.forEach((labelValue) => {\n        const labelNameString = labelValue[forLabelInterpolated];\n        set.add(labelNameString);\n      });\n\n      return Array.from(set).map((labelValues: string) => ({ label: labelValues, value: labelValues }));\n    });\n  };\n\n  /**\n   * Helper function to fetch label values from a promql string expression and a label\n   * @param forLabel\n   * @param promQLExpression\n   */\n  const getLabelValuesFromLabelValuesAPI = (\n    forLabel: Partial<QueryBuilderLabelFilter>,\n    promQLExpression: string\n  ): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return Promise.resolve([]);\n    }\n    return datasource.languageProvider.fetchSeriesValuesWithMatch(forLabel.label, promQLExpression).then((response) => {\n      return response.map((v) => ({\n        value: v,\n        label: v,\n      }));\n    });\n  };\n\n  /**\n   * Function kicked off when users interact with the value of the label filters\n   * Formats a promQL expression and passes that into helper functions depending on API support\n   * @param forLabel\n   */\n  const onGetLabelValues = async (forLabel: Partial<QueryBuilderLabelFilter>): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return [];\n    }\n    // If no metric is selected, we can get the raw list of labels\n    if (!query.metric) {\n      return (await datasource.languageProvider.getLabelValues(forLabel.label)).map((v) => ({ value: v }));\n    }\n\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n    labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n\n    const interpolatedLabelsToConsider = labelsToConsider.map((labelObject) => ({\n      ...labelObject,\n      label: datasource.interpolateString(labelObject.label),\n      value: datasource.interpolateString(labelObject.value),\n    }));\n\n    const expr = promQueryModeller.renderLabels(interpolatedLabelsToConsider);\n\n    if (datasource.hasLabelsMatchAPISupport()) {\n      return getLabelValuesFromLabelValuesAPI(forLabel, expr);\n    } else {\n      return getLabelValuesFromSeriesAPI(forLabel, expr);\n    }\n  };\n\n  const onGetMetrics = useCallback(() => {\n    return withTemplateVariableOptions(getMetrics(datasource, query));\n  }, [datasource, query, withTemplateVariableOptions]);\n\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <>\n      <EditorRow>\n        <MetricSelect\n          query={query}\n          onChange={onChange}\n          onGetMetrics={onGetMetrics}\n          datasource={datasource}\n          labelsFilters={query.labels}\n        />\n        <LabelFilters\n          getLabelValuesAutofillSuggestions={getLabelValuesAutocompleteSuggestions}\n          labelsFilters={query.labels}\n          // eslint-ignore\n          onChange={onChangeLabels as (labelFilters: Array<Partial<QueryBuilderLabelFilter>>) => void}\n          onGetLabelNames={(forLabel) => withTemplateVariableOptions(onGetLabelNames(forLabel))}\n          onGetLabelValues={(forLabel) => withTemplateVariableOptions(onGetLabelValues(forLabel))}\n        />\n      </EditorRow>\n      {showExplain && (\n        <OperationExplainedBox\n          stepNumber={1}\n          title={<RawQuery query={`${query.metric} ${promQueryModeller.renderLabels(query.labels)}`} lang={lang} />}\n        >\n          {EXPLAIN_LABEL_FILTER_CONTENT}\n        </OperationExplainedBox>\n      )}\n      <OperationsEditorRow>\n        <OperationList<PromVisualQuery>\n          queryModeller={promQueryModeller}\n          // eslint-ignore\n          datasource={datasource as DataSourceApi}\n          query={query}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          highlightedOp={highlightedOp}\n        />\n        <QueryBuilderHints<PromVisualQuery>\n          datasource={datasource}\n          query={query}\n          onChange={onChange}\n          data={data}\n          queryModeller={promQueryModeller}\n          buildVisualQueryFromString={buildVisualQueryFromString}\n        />\n      </OperationsEditorRow>\n      {showExplain && (\n        <OperationListExplained<PromVisualQuery>\n          lang={lang}\n          query={query}\n          stepNumber={2}\n          queryModeller={promQueryModeller}\n          onMouseEnter={(op) => setHighlightedOp(op)}\n          onMouseLeave={() => setHighlightedOp(undefined)}\n        />\n      )}\n      {query.binaryQueries && query.binaryQueries.length > 0 && (\n        <NestedQueryList\n          query={query}\n          datasource={datasource}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      )}\n    </>\n  );\n});\n\n/**\n * Returns list of metrics, either all or filtered by query param. It also adds description string to each metric if it\n * exists.\n * @param datasource\n * @param query\n */\nasync function getMetrics(\n  datasource: PrometheusDatasource,\n  query: PromVisualQuery\n): Promise<Array<{ value: string; description?: string }>> {\n  // Makes sure we loaded the metadata for metrics. Usually this is done in the start() method of the provider but we\n  // don't use it with the visual builder and there is no need to run all the start() setup anyway.\n  if (!datasource.languageProvider.metricsMetadata) {\n    await datasource.languageProvider.loadMetricsMetadata();\n  }\n\n  // Error handling for when metrics metadata returns as undefined\n  if (!datasource.languageProvider.metricsMetadata) {\n    datasource.languageProvider.metricsMetadata = {};\n  }\n\n  let metrics;\n  if (query.labels.length > 0) {\n    const expr = promQueryModeller.renderLabels(query.labels);\n    metrics = (await datasource.languageProvider.getSeries(expr, true))['__name__'] ?? [];\n  } else {\n    metrics = (await datasource.languageProvider.getLabelValues('__name__')) ?? [];\n  }\n\n  return metrics.map((m) => ({\n    value: m,\n    description: getMetadataString(m, datasource.languageProvider.metricsMetadata!),\n  }));\n}\n\nPromQueryBuilder.displayName = 'PromQueryBuilder';\n","import React from 'react';\n\nimport { EditorFieldGroup, EditorRow } from '@grafana/experimental';\n\nimport promqlGrammar from '../../promql';\nimport { RawQuery } from '../shared/RawQuery';\n\nexport interface Props {\n  query: string;\n}\n\nexport function QueryPreview({ query }: Props) {\n  if (!query) {\n    return null;\n  }\n\n  return (\n    <EditorRow>\n      <EditorFieldGroup>\n        <RawQuery query={query} lang={{ grammar: promqlGrammar, name: 'promql' }} />\n      </EditorFieldGroup>\n    </EditorRow>\n  );\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer } from 'react';\n\nimport { PanelData } from '@grafana/data';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromQuery } from '../../types';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { PromVisualQuery } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\nimport { QueryPreview } from './QueryPreview';\n\nexport interface Props {\n  query: PromQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport interface State {\n  visQuery?: PromVisualQuery;\n  expr: string;\n}\n\n/**\n * This component is here just to contain the translation logic between string query and the visual query builder model.\n */\nexport function PromQueryBuilderContainer(props: Props) {\n  const { query, onChange, onRunQuery, datasource, data, showExplain } = props;\n  const [state, dispatch] = useReducer(stateSlice.reducer, { expr: query.expr });\n\n  // Only rebuild visual query if expr changes from outside\n  useEffect(() => {\n    dispatch(exprChanged(query.expr));\n  }, [query.expr]);\n\n  const onVisQueryChange = (visQuery: PromVisualQuery) => {\n    const expr = promQueryModeller.renderQuery(visQuery);\n    dispatch(visualQueryChange({ visQuery, expr }));\n    onChange({ ...props.query, expr: expr });\n  };\n\n  if (!state.visQuery) {\n    return null;\n  }\n\n  return (\n    <>\n      <PromQueryBuilder\n        query={state.visQuery}\n        datasource={datasource}\n        onChange={onVisQueryChange}\n        onRunQuery={onRunQuery}\n        data={data}\n        showExplain={showExplain}\n      />\n      {<QueryPreview query={query.expr} />}\n    </>\n  );\n}\n\nconst stateSlice = createSlice({\n  name: 'prom-builder-container',\n  initialState: { expr: '' } as State,\n  reducers: {\n    visualQueryChange: (state, action: PayloadAction<{ visQuery: PromVisualQuery; expr: string }>) => {\n      state.expr = action.payload.expr;\n      state.visQuery = action.payload.visQuery;\n    },\n    exprChanged: (state, action: PayloadAction<string>) => {\n      if (!state.visQuery || state.expr !== action.payload) {\n        state.expr = action.payload;\n        const parseResult = buildVisualQueryFromString(action.payload);\n        state.visQuery = parseResult.query;\n      }\n    },\n  },\n});\n\nconst { visualQueryChange, exprChanged } = stateSlice.actions;\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { IconButton, InlineLabel, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\ninterface Props {\n  onChange: (exemplar: boolean) => void;\n  datasource: PrometheusDatasource;\n  query: PromQuery;\n  'data-testid'?: string;\n}\n\nexport function PromExemplarField({ datasource, onChange, query, ...rest }: Props) {\n  const [error, setError] = useState<string | null>(null);\n  const styles = useStyles2(getStyles);\n  const prevError = usePrevious(error);\n\n  useEffect(() => {\n    if (!datasource.exemplarsAvailable) {\n      setError('Exemplars for this query are not available');\n      onChange(false);\n    } else if (query.instant && !query.range) {\n      setError('Exemplars are not available for instant queries');\n      onChange(false);\n    } else {\n      setError(null);\n      // If error is cleared, we want to change exemplar to true\n      if (prevError && !error) {\n        onChange(true);\n      }\n    }\n  }, [datasource.exemplarsAvailable, query.instant, query.range, onChange, prevError, error]);\n\n  const iconButtonStyles = cx(\n    {\n      [styles.activeIcon]: !!query.exemplar,\n    },\n    styles.eyeIcon\n  );\n\n  return (\n    <InlineLabel width=\"auto\" data-testid={rest['data-testid']}>\n      <Tooltip content={error ?? ''}>\n        <div className={styles.iconWrapper}>\n          Exemplars\n          <IconButton\n            name=\"eye\"\n            tooltip={!!query.exemplar ? 'Disable query with exemplars' : 'Enable query with exemplars'}\n            disabled={!!error}\n            className={iconButtonStyles}\n            onClick={() => {\n              onChange(!query.exemplar);\n            }}\n          />\n        </div>\n      </Tooltip>\n    </InlineLabel>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    eyeIcon: css`\n      margin-left: ${theme.spacing(2)};\n    `,\n    activeIcon: css`\n      color: ${theme.colors.primary.main};\n    `,\n    iconWrapper: css`\n      display: flex;\n      align-items: center;\n    `,\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { isEqual } from 'lodash';\nimport React, { memo, useCallback } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { InlineFormLabel, RadioButtonGroup } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\nimport { PromExemplarField } from './PromExemplarField';\n\nexport interface PromExploreExtraFieldProps {\n  query: PromQuery;\n  onChange: (value: PromQuery) => void;\n  onRunQuery: () => void;\n  datasource: PrometheusDatasource;\n}\n\nexport const PromExploreExtraField: React.FC<PromExploreExtraFieldProps> = memo(\n  ({ query, datasource, onChange, onRunQuery }) => {\n    const rangeOptions = getQueryTypeOptions(true);\n    const prevQuery = usePrevious(query);\n\n    const onExemplarChange = useCallback(\n      (exemplar: boolean) => {\n        if (!isEqual(query, prevQuery) || exemplar !== query.exemplar) {\n          onChange({ ...query, exemplar });\n        }\n      },\n      [prevQuery, query, onChange]\n    );\n\n    function onChangeQueryStep(interval: string) {\n      onChange({ ...query, interval });\n    }\n\n    function onStepChange(e: React.SyntheticEvent<HTMLInputElement>) {\n      if (e.currentTarget.value !== query.interval) {\n        onChangeQueryStep(e.currentTarget.value);\n      }\n    }\n\n    function onReturnKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n      if (e.key === 'Enter' && e.shiftKey) {\n        onRunQuery();\n      }\n    }\n\n    const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n    return (\n      <div aria-label=\"Prometheus extra field\" className=\"gf-form-inline\" data-testid={testIds.extraFieldEditor}>\n        {/*Query type field*/}\n        <div\n          data-testid={testIds.queryTypeField}\n          className={cx(\n            'gf-form explore-input-margin',\n            css`\n              flex-wrap: nowrap;\n            `\n          )}\n          aria-label=\"Query type field\"\n        >\n          <InlineFormLabel width=\"auto\">Query type</InlineFormLabel>\n\n          <RadioButtonGroup\n            options={rangeOptions}\n            value={query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range'}\n            onChange={onQueryTypeChange}\n          />\n        </div>\n        {/*Step field*/}\n        <div\n          data-testid={testIds.stepField}\n          className={cx(\n            'gf-form',\n            css`\n              flex-wrap: nowrap;\n            `\n          )}\n          aria-label=\"Step field\"\n        >\n          <InlineFormLabel\n            width={6}\n            tooltip={\n              'Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)'\n            }\n          >\n            Min step\n          </InlineFormLabel>\n          <input\n            type={'text'}\n            className=\"gf-form-input width-4\"\n            placeholder={'auto'}\n            onChange={onStepChange}\n            onKeyDown={onReturnKeyDown}\n            value={query.interval ?? ''}\n          />\n        </div>\n\n        <PromExemplarField onChange={onExemplarChange} datasource={datasource} query={query} />\n      </div>\n    );\n  }\n);\n\nPromExploreExtraField.displayName = 'PromExploreExtraField';\n\nexport function getQueryTypeOptions(includeBoth: boolean) {\n  const rangeOptions = [\n    { value: 'range', label: 'Range', description: 'Run query over a range of time' },\n    {\n      value: 'instant',\n      label: 'Instant',\n      description: 'Run query against a single point in time. For this query, the \"To\" time is used',\n    },\n  ];\n\n  if (includeBoth) {\n    rangeOptions.push({ value: 'both', label: 'Both', description: 'Run an Instant query and a Range query' });\n  }\n\n  return rangeOptions;\n}\n\nexport function getQueryTypeChangeHandler(query: PromQuery, onChange: (update: PromQuery) => void) {\n  return (queryType: string) => {\n    if (queryType === 'instant') {\n      onChange({ ...query, instant: true, range: false, exemplar: false });\n    } else if (queryType === 'range') {\n      onChange({ ...query, instant: false, range: true });\n    } else {\n      onChange({ ...query, instant: true, range: true });\n    }\n  };\n}\n\nexport const testIds = {\n  extraFieldEditor: 'prom-editor-extra-field',\n  stepField: 'prom-editor-extra-field-step',\n  queryTypeField: 'prom-editor-extra-field-query-type',\n};\n","import React, { useRef } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { EditorField } from '@grafana/experimental';\nimport { Select, AutoSizeInput } from '@grafana/ui';\n\nimport { LegendFormatMode } from '../../types';\n\nexport interface Props {\n  legendFormat: string | undefined;\n  onChange: (legendFormat: string) => void;\n  onRunQuery: () => void;\n}\n\nconst legendModeOptions = [\n  {\n    label: 'Auto',\n    value: LegendFormatMode.Auto,\n    description: 'Only includes unique labels',\n  },\n  { label: 'Verbose', value: LegendFormatMode.Verbose, description: 'All label names and values' },\n  { label: 'Custom', value: LegendFormatMode.Custom, description: 'Provide a naming template' },\n];\n\n/**\n * Tests for this component are on the parent level (PromQueryBuilderOptions).\n */\nexport const PromQueryLegendEditor = React.memo<Props>(({ legendFormat, onChange, onRunQuery }) => {\n  const mode = getLegendMode(legendFormat);\n  const inputRef = useRef<HTMLInputElement | null>(null);\n\n  const onLegendFormatChanged = (evt: React.FormEvent<HTMLInputElement>) => {\n    let newFormat = evt.currentTarget.value;\n    if (newFormat.length === 0) {\n      newFormat = LegendFormatMode.Auto;\n    }\n\n    if (newFormat !== legendFormat) {\n      onChange(newFormat);\n      onRunQuery();\n    }\n  };\n\n  const onLegendModeChanged = (value: SelectableValue<LegendFormatMode>) => {\n    switch (value.value!) {\n      case LegendFormatMode.Auto:\n        onChange(LegendFormatMode.Auto);\n        break;\n      case LegendFormatMode.Custom:\n        onChange('{{label_name}}');\n        setTimeout(() => {\n          inputRef.current?.focus();\n          inputRef.current?.setSelectionRange(2, 12, 'forward');\n        }, 10);\n        break;\n      case LegendFormatMode.Verbose:\n        onChange('');\n        break;\n    }\n    onRunQuery();\n  };\n\n  return (\n    <EditorField\n      label=\"Legend\"\n      tooltip=\"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.\"\n    >\n      <>\n        {mode === LegendFormatMode.Custom && (\n          <AutoSizeInput\n            id=\"legendFormat\"\n            minWidth={22}\n            placeholder=\"auto\"\n            defaultValue={legendFormat}\n            onCommitChange={onLegendFormatChanged}\n            ref={inputRef}\n          />\n        )}\n        {mode !== LegendFormatMode.Custom && (\n          <Select\n            inputId=\"legend.mode\"\n            isSearchable={false}\n            placeholder=\"Select legend mode\"\n            options={legendModeOptions}\n            width={22}\n            onChange={onLegendModeChanged}\n            value={legendModeOptions.find((x) => x.value === mode)}\n          />\n        )}\n      </>\n    </EditorField>\n  );\n});\n\nPromQueryLegendEditor.displayName = 'PromQueryLegendEditor';\n\nfunction getLegendMode(legendFormat: string | undefined) {\n  // This special value means the new smart minimal series naming\n  if (legendFormat === LegendFormatMode.Auto) {\n    return LegendFormatMode.Auto;\n  }\n\n  // Missing or empty legend format is the old verbose behavior\n  if (legendFormat == null || legendFormat === '') {\n    return LegendFormatMode.Verbose;\n  }\n\n  return LegendFormatMode.Custom;\n}\n\nexport function getLegendModeLabel(legendFormat: string | undefined) {\n  const mode = getLegendMode(legendFormat);\n  if (mode !== LegendFormatMode.Custom) {\n    return legendModeOptions.find((x) => x.value === mode)?.label;\n  }\n  return legendFormat;\n}\n","import React, { SyntheticEvent } from 'react';\n\nimport { CoreApp, SelectableValue } from '@grafana/data';\nimport { EditorField, EditorRow, EditorSwitch } from '@grafana/experimental';\nimport { AutoSizeInput, RadioButtonGroup, Select } from '@grafana/ui';\n\nimport { getQueryTypeChangeHandler, getQueryTypeOptions } from '../../components/PromExploreExtraField';\nimport { PromQuery } from '../../types';\nimport { QueryOptionGroup } from '../shared/QueryOptionGroup';\n\nimport { FORMAT_OPTIONS, INTERVAL_FACTOR_OPTIONS } from './PromQueryEditorSelector';\nimport { getLegendModeLabel, PromQueryLegendEditor } from './PromQueryLegendEditor';\n\nexport interface UIOptions {\n  exemplars: boolean;\n  type: boolean;\n  format: boolean;\n  minStep: boolean;\n  legend: boolean;\n  resolution: boolean;\n}\n\nexport interface Props {\n  query: PromQuery;\n  app?: CoreApp;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport const PromQueryBuilderOptions = React.memo<Props>(({ query, app, onChange, onRunQuery }) => {\n  const onChangeFormat = (value: SelectableValue<string>) => {\n    onChange({ ...query, format: value.value });\n    onRunQuery();\n  };\n\n  const onChangeStep = (evt: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, interval: evt.currentTarget.value });\n    onRunQuery();\n  };\n\n  const queryTypeOptions = getQueryTypeOptions(app === CoreApp.Explore || app === CoreApp.PanelEditor);\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  const onExemplarChange = (event: SyntheticEvent<HTMLInputElement>) => {\n    const isEnabled = event.currentTarget.checked;\n    onChange({ ...query, exemplar: isEnabled });\n    onRunQuery();\n  };\n\n  const onIntervalFactorChange = (value: SelectableValue<number>) => {\n    onChange({ ...query, intervalFactor: value.value });\n    onRunQuery();\n  };\n\n  const formatOption = FORMAT_OPTIONS.find((option) => option.value === query.format) || FORMAT_OPTIONS[0];\n  const queryTypeValue = getQueryTypeValue(query);\n  const queryTypeLabel = queryTypeOptions.find((x) => x.value === queryTypeValue)!.label;\n\n  return (\n    <EditorRow>\n      <QueryOptionGroup\n        title=\"Options\"\n        collapsedInfo={getCollapsedInfo(query, formatOption.label!, queryTypeLabel, app)}\n      >\n        <PromQueryLegendEditor\n          legendFormat={query.legendFormat}\n          onChange={(legendFormat) => onChange({ ...query, legendFormat })}\n          onRunQuery={onRunQuery}\n        />\n        <EditorField\n          label=\"Min step\"\n          tooltip={\n            <>\n              An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n              <code>$__interval</code> and <code>$__rate_interval</code> variables.\n            </>\n          }\n        >\n          <AutoSizeInput\n            type=\"text\"\n            aria-label=\"Set lower limit for the step parameter\"\n            placeholder={'auto'}\n            minWidth={10}\n            onCommitChange={onChangeStep}\n            defaultValue={query.interval}\n          />\n        </EditorField>\n        <EditorField label=\"Format\">\n          <Select value={formatOption} allowCustomValue onChange={onChangeFormat} options={FORMAT_OPTIONS} />\n        </EditorField>\n        <EditorField label=\"Type\">\n          <RadioButtonGroup options={queryTypeOptions} value={queryTypeValue} onChange={onQueryTypeChange} />\n        </EditorField>\n        {shouldShowExemplarSwitch(query, app) && (\n          <EditorField label=\"Exemplars\">\n            <EditorSwitch value={query.exemplar || false} onChange={onExemplarChange} />\n          </EditorField>\n        )}\n        {query.intervalFactor && query.intervalFactor > 1 && (\n          <EditorField label=\"Resolution\">\n            <Select\n              aria-label=\"Select resolution\"\n              isSearchable={false}\n              options={INTERVAL_FACTOR_OPTIONS}\n              onChange={onIntervalFactorChange}\n              value={INTERVAL_FACTOR_OPTIONS.find((option) => option.value === query.intervalFactor)}\n            />\n          </EditorField>\n        )}\n      </QueryOptionGroup>\n    </EditorRow>\n  );\n});\n\nfunction shouldShowExemplarSwitch(query: PromQuery, app?: CoreApp) {\n  if (app === CoreApp.UnifiedAlerting || !query.range) {\n    return false;\n  }\n\n  return true;\n}\n\nfunction getQueryTypeValue(query: PromQuery) {\n  return query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range';\n}\n\nfunction getCollapsedInfo(query: PromQuery, formatOption: string, queryType: string, app?: CoreApp): string[] {\n  const items: string[] = [];\n\n  items.push(`Legend: ${getLegendModeLabel(query.legendFormat)}`);\n  items.push(`Format: ${formatOption}`);\n  items.push(`Step: ${query.interval ?? 'auto'}`);\n  items.push(`Type: ${queryType}`);\n\n  if (shouldShowExemplarSwitch(query, app)) {\n    if (query.exemplar) {\n      items.push(`Exemplars: true`);\n    } else {\n      items.push(`Exemplars: false`);\n    }\n  }\n  return items;\n}\n\nPromQueryBuilderOptions.displayName = 'PromQueryBuilderOptions';\n","// https://github.com/facebook/react/issues/5465\n\nexport interface CancelablePromise<T> {\n  promise: Promise<T>;\n  cancel: () => void;\n}\n\nexport interface CancelablePromiseRejection {\n  isCanceled: boolean;\n}\n\nexport function isCancelablePromiseRejection(promise: unknown): promise is CancelablePromiseRejection {\n  return typeof promise === 'object' && promise !== null && 'isCanceled' in promise;\n}\n\nexport const makePromiseCancelable = <T>(promise: Promise<T>): CancelablePromise<T> => {\n  let hasCanceled_ = false;\n\n  const wrappedPromise = new Promise<T>((resolve, reject) => {\n    const canceledPromiseRejection: CancelablePromiseRejection = { isCanceled: true };\n    promise.then((val) => (hasCanceled_ ? reject(canceledPromiseRejection) : resolve(val)));\n    promise.catch((error) => (hasCanceled_ ? reject(canceledPromiseRejection) : reject(error)));\n  });\n\n  return {\n    promise: wrappedPromise,\n    cancel() {\n      hasCanceled_ = true;\n    },\n  };\n};\n","import { css, cx } from '@emotion/css';\nimport React, { ChangeEvent } from 'react';\nimport { FixedSizeList } from 'react-window';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport {\n  Button,\n  HorizontalGroup,\n  Input,\n  Label,\n  LoadingPlaceholder,\n  stylesFactory,\n  BrowserLabel as PromLabel,\n  withTheme2,\n} from '@grafana/ui';\n\nimport PromQlLanguageProvider from '../language_provider';\nimport { escapeLabelValueInExactSelector, escapeLabelValueInRegexSelector } from '../language_utils';\n\n// Hard limit on labels to render\nconst EMPTY_SELECTOR = '{}';\nconst METRIC_LABEL = '__name__';\nconst LIST_ITEM_SIZE = 25;\n\nexport interface BrowserProps {\n  languageProvider: PromQlLanguageProvider;\n  onChange: (selector: string) => void;\n  theme: GrafanaTheme2;\n  autoSelect?: number;\n  hide?: () => void;\n  lastUsedLabels: string[];\n  storeLastUsedLabels: (labels: string[]) => void;\n  deleteLastUsedLabels: () => void;\n}\n\ninterface BrowserState {\n  labels: SelectableLabel[];\n  labelSearchTerm: string;\n  metricSearchTerm: string;\n  status: string;\n  error: string;\n  validationStatus: string;\n  valueSearchTerm: string;\n}\n\ninterface FacettableValue {\n  name: string;\n  selected?: boolean;\n  details?: string;\n}\n\nexport interface SelectableLabel {\n  name: string;\n  selected?: boolean;\n  loading?: boolean;\n  values?: FacettableValue[];\n  hidden?: boolean;\n  facets?: number;\n}\n\nexport function buildSelector(labels: SelectableLabel[]): string {\n  let singleMetric = '';\n  const selectedLabels = [];\n  for (const label of labels) {\n    if ((label.name === METRIC_LABEL || label.selected) && label.values && label.values.length > 0) {\n      const selectedValues = label.values.filter((value) => value.selected).map((value) => value.name);\n      if (selectedValues.length > 1) {\n        selectedLabels.push(`${label.name}=~\"${selectedValues.map(escapeLabelValueInRegexSelector).join('|')}\"`);\n      } else if (selectedValues.length === 1) {\n        if (label.name === METRIC_LABEL) {\n          singleMetric = selectedValues[0];\n        } else {\n          selectedLabels.push(`${label.name}=\"${escapeLabelValueInExactSelector(selectedValues[0])}\"`);\n        }\n      }\n    }\n  }\n  return [singleMetric, '{', selectedLabels.join(','), '}'].join('');\n}\n\nexport function facetLabels(\n  labels: SelectableLabel[],\n  possibleLabels: Record<string, string[]>,\n  lastFacetted?: string\n): SelectableLabel[] {\n  return labels.map((label) => {\n    const possibleValues = possibleLabels[label.name];\n    if (possibleValues) {\n      let existingValues: FacettableValue[];\n      if (label.name === lastFacetted && label.values) {\n        // Facetting this label, show all values\n        existingValues = label.values;\n      } else {\n        // Keep selection in other facets\n        const selectedValues: Set<string> = new Set(\n          label.values?.filter((value) => value.selected).map((value) => value.name) || []\n        );\n        // Values for this label have not been requested yet, let's use the facetted ones as the initial values\n        existingValues = possibleValues.map((value) => ({ name: value, selected: selectedValues.has(value) }));\n      }\n      return {\n        ...label,\n        loading: false,\n        values: existingValues,\n        hidden: !possibleValues,\n        facets: existingValues.length,\n      };\n    }\n\n    // Label is facetted out, hide all values\n    return { ...label, loading: false, hidden: !possibleValues, values: undefined, facets: 0 };\n  });\n}\n\nconst getStyles = stylesFactory((theme: GrafanaTheme2) => ({\n  wrapper: css`\n    background-color: ${theme.colors.background.secondary};\n    padding: ${theme.spacing(1)};\n    width: 100%;\n  `,\n  list: css`\n    margin-top: ${theme.spacing(1)};\n    display: flex;\n    flex-wrap: wrap;\n    max-height: 200px;\n    overflow: auto;\n    align-content: flex-start;\n  `,\n  section: css`\n    & + & {\n      margin: ${theme.spacing(2)} 0;\n    }\n    position: relative;\n  `,\n  selector: css`\n    font-family: ${theme.typography.fontFamilyMonospace};\n    margin-bottom: ${theme.spacing(1)};\n  `,\n  status: css`\n    padding: ${theme.spacing(0.5)};\n    color: ${theme.colors.text.secondary};\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    /* using absolute positioning because flex interferes with ellipsis */\n    position: absolute;\n    width: 50%;\n    right: 0;\n    text-align: right;\n    transition: opacity 100ms linear;\n    opacity: 0;\n  `,\n  statusShowing: css`\n    opacity: 1;\n  `,\n  error: css`\n    color: ${theme.colors.error.main};\n  `,\n  valueList: css`\n    margin-right: ${theme.spacing(1)};\n    resize: horizontal;\n  `,\n  valueListWrapper: css`\n    border-left: 1px solid ${theme.colors.border.medium};\n    margin: ${theme.spacing(1)} 0;\n    padding: ${theme.spacing(1)} 0 ${theme.spacing(1)} ${theme.spacing(1)};\n  `,\n  valueListArea: css`\n    display: flex;\n    flex-wrap: wrap;\n    margin-top: ${theme.spacing(1)};\n  `,\n  valueTitle: css`\n    margin-left: -${theme.spacing(0.5)};\n    margin-bottom: ${theme.spacing(1)};\n  `,\n  validationStatus: css`\n    padding: ${theme.spacing(0.5)};\n    margin-bottom: ${theme.spacing(1)};\n    color: ${theme.colors.text.maxContrast};\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  `,\n}));\n\n/**\n * TODO #33976: Remove duplicated code. The component is very similar to LokiLabelBrowser.tsx. Check if it's possible\n *              to create a single, generic component.\n */\nexport class UnthemedPrometheusMetricsBrowser extends React.Component<BrowserProps, BrowserState> {\n  valueListsRef = React.createRef<HTMLDivElement>();\n  state: BrowserState = {\n    labels: [] as SelectableLabel[],\n    labelSearchTerm: '',\n    metricSearchTerm: '',\n    status: 'Ready',\n    error: '',\n    validationStatus: '',\n    valueSearchTerm: '',\n  };\n\n  onChangeLabelSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ labelSearchTerm: event.target.value });\n  };\n\n  onChangeMetricSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ metricSearchTerm: event.target.value });\n  };\n\n  onChangeValueSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ valueSearchTerm: event.target.value });\n  };\n\n  onClickRunQuery = () => {\n    const selector = buildSelector(this.state.labels);\n    this.props.onChange(selector);\n  };\n\n  onClickRunRateQuery = () => {\n    const selector = buildSelector(this.state.labels);\n    const query = `rate(${selector}[$__interval])`;\n    this.props.onChange(query);\n  };\n\n  onClickClear = () => {\n    this.setState((state) => {\n      const labels: SelectableLabel[] = state.labels.map((label) => ({\n        ...label,\n        values: undefined,\n        selected: false,\n        loading: false,\n        hidden: false,\n        facets: undefined,\n      }));\n      return {\n        labels,\n        labelSearchTerm: '',\n        metricSearchTerm: '',\n        status: '',\n        error: '',\n        validationStatus: '',\n        valueSearchTerm: '',\n      };\n    });\n    this.props.deleteLastUsedLabels();\n    // Get metrics\n    this.fetchValues(METRIC_LABEL, EMPTY_SELECTOR);\n  };\n\n  onClickLabel = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label) {\n      return;\n    }\n    // Toggle selected state\n    const selected = !label.selected;\n    let nextValue: Partial<SelectableLabel> = { selected };\n    if (label.values && !selected) {\n      // Deselect all values if label was deselected\n      const values = label.values.map((value) => ({ ...value, selected: false }));\n      nextValue = { ...nextValue, facets: 0, values };\n    }\n    // Resetting search to prevent empty results\n    this.setState({ labelSearchTerm: '' });\n    this.updateLabelState(name, nextValue, '', () => this.doFacettingForLabel(name));\n  };\n\n  onClickValue = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label || !label.values) {\n      return;\n    }\n    // Resetting search to prevent empty results\n    this.setState({ labelSearchTerm: '' });\n    // Toggling value for selected label, leaving other values intact\n    const values = label.values.map((v) => ({ ...v, selected: v.name === value ? !v.selected : v.selected }));\n    this.updateLabelState(name, { values }, '', () => this.doFacetting(name));\n  };\n\n  onClickMetric = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    // Finding special metric label\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label || !label.values) {\n      return;\n    }\n    // Resetting search to prevent empty results\n    this.setState({ metricSearchTerm: '' });\n    // Toggling value for selected label, leaving other values intact\n    const values = label.values.map((v) => ({\n      ...v,\n      selected: v.name === value || v.selected ? !v.selected : v.selected,\n    }));\n    // Toggle selected state of special metrics label\n    const selected = values.some((v) => v.selected);\n    this.updateLabelState(name, { selected, values }, '', () => this.doFacetting(name));\n  };\n\n  onClickValidate = () => {\n    const selector = buildSelector(this.state.labels);\n    this.validateSelector(selector);\n  };\n\n  updateLabelState(name: string, updatedFields: Partial<SelectableLabel>, status = '', cb?: () => void) {\n    this.setState((state) => {\n      const labels: SelectableLabel[] = state.labels.map((label) => {\n        if (label.name === name) {\n          return { ...label, ...updatedFields };\n        }\n        return label;\n      });\n      // New status overrides errors\n      const error = status ? '' : state.error;\n      return { labels, status, error, validationStatus: '' };\n    }, cb);\n  }\n\n  componentDidMount() {\n    const { languageProvider, lastUsedLabels } = this.props;\n    if (languageProvider) {\n      const selectedLabels: string[] = lastUsedLabels;\n      languageProvider.start().then(() => {\n        let rawLabels: string[] = languageProvider.getLabelKeys();\n        // Get metrics\n        this.fetchValues(METRIC_LABEL, EMPTY_SELECTOR);\n        // Auto-select previously selected labels\n        const labels: SelectableLabel[] = rawLabels.map((label, i, arr) => ({\n          name: label,\n          selected: selectedLabels.includes(label),\n          loading: false,\n        }));\n        // Pre-fetch values for selected labels\n        this.setState({ labels }, () => {\n          this.state.labels.forEach((label) => {\n            if (label.selected) {\n              this.fetchValues(label.name, EMPTY_SELECTOR);\n            }\n          });\n        });\n      });\n    }\n  }\n\n  doFacettingForLabel(name: string) {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label) {\n      return;\n    }\n    const selectedLabels = this.state.labels.filter((label) => label.selected).map((label) => label.name);\n    this.props.storeLastUsedLabels(selectedLabels);\n    if (label.selected) {\n      // Refetch values for newly selected label...\n      if (!label.values) {\n        this.fetchValues(name, buildSelector(this.state.labels));\n      }\n    } else {\n      // Only need to facet when deselecting labels\n      this.doFacetting();\n    }\n  }\n\n  doFacetting = (lastFacetted?: string) => {\n    const selector = buildSelector(this.state.labels);\n    if (selector === EMPTY_SELECTOR) {\n      // Clear up facetting\n      const labels: SelectableLabel[] = this.state.labels.map((label) => {\n        return { ...label, facets: 0, values: undefined, hidden: false };\n      });\n      this.setState({ labels }, () => {\n        // Get fresh set of values\n        this.state.labels.forEach(\n          (label) => (label.selected || label.name === METRIC_LABEL) && this.fetchValues(label.name, selector)\n        );\n      });\n    } else {\n      // Do facetting\n      this.fetchSeries(selector, lastFacetted);\n    }\n  };\n\n  async fetchValues(name: string, selector: string) {\n    const { languageProvider } = this.props;\n    this.updateLabelState(name, { loading: true }, `Fetching values for ${name}`);\n    try {\n      let rawValues = await languageProvider.getLabelValues(name);\n      // If selector changed, clear loading state and discard result by returning early\n      if (selector !== buildSelector(this.state.labels)) {\n        this.updateLabelState(name, { loading: false });\n        return;\n      }\n      const values: FacettableValue[] = [];\n      const { metricsMetadata } = languageProvider;\n      for (const labelValue of rawValues) {\n        const value: FacettableValue = { name: labelValue };\n        // Adding type/help text to metrics\n        if (name === METRIC_LABEL && metricsMetadata) {\n          const meta = metricsMetadata[labelValue];\n          if (meta) {\n            value.details = `(${meta.type}) ${meta.help}`;\n          }\n        }\n        values.push(value);\n      }\n      this.updateLabelState(name, { values, loading: false });\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async fetchSeries(selector: string, lastFacetted?: string) {\n    const { languageProvider } = this.props;\n    if (lastFacetted) {\n      this.updateLabelState(lastFacetted, { loading: true }, `Facetting labels for ${selector}`);\n    }\n    try {\n      const possibleLabels = await languageProvider.fetchSeriesLabels(selector, true);\n      // If selector changed, clear loading state and discard result by returning early\n      if (selector !== buildSelector(this.state.labels)) {\n        if (lastFacetted) {\n          this.updateLabelState(lastFacetted, { loading: false });\n        }\n        return;\n      }\n      if (Object.keys(possibleLabels).length === 0) {\n        this.setState({ error: `Empty results, no matching label for ${selector}` });\n        return;\n      }\n      const labels: SelectableLabel[] = facetLabels(this.state.labels, possibleLabels, lastFacetted);\n      this.setState({ labels, error: '' });\n      if (lastFacetted) {\n        this.updateLabelState(lastFacetted, { loading: false });\n      }\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async validateSelector(selector: string) {\n    const { languageProvider } = this.props;\n    this.setState({ validationStatus: `Validating selector ${selector}`, error: '' });\n    const streams = await languageProvider.fetchSeries(selector);\n    this.setState({ validationStatus: `Selector is valid (${streams.length} series found)` });\n  }\n\n  render() {\n    const { theme } = this.props;\n    const { labels, labelSearchTerm, metricSearchTerm, status, error, validationStatus, valueSearchTerm } = this.state;\n    const styles = getStyles(theme);\n    if (labels.length === 0) {\n      return (\n        <div className={styles.wrapper}>\n          <LoadingPlaceholder text=\"Loading labels...\" />\n        </div>\n      );\n    }\n\n    // Filter metrics\n    let metrics = labels.find((label) => label.name === METRIC_LABEL);\n    if (metrics && metricSearchTerm) {\n      metrics = {\n        ...metrics,\n        values: metrics.values?.filter((value) => value.selected || value.name.includes(metricSearchTerm)),\n      };\n    }\n\n    // Filter labels\n    let nonMetricLabels = labels.filter((label) => !label.hidden && label.name !== METRIC_LABEL);\n    if (labelSearchTerm) {\n      nonMetricLabels = nonMetricLabels.filter((label) => label.selected || label.name.includes(labelSearchTerm));\n    }\n\n    // Filter non-metric label values\n    let selectedLabels = nonMetricLabels.filter((label) => label.selected && label.values);\n    if (valueSearchTerm) {\n      selectedLabels = selectedLabels.map((label) => ({\n        ...label,\n        values: label.values?.filter((value) => value.selected || value.name.includes(valueSearchTerm)),\n      }));\n    }\n    const selector = buildSelector(this.state.labels);\n    const empty = selector === EMPTY_SELECTOR;\n    const metricCount = metrics?.values?.length || 0;\n\n    return (\n      <div className={styles.wrapper}>\n        <HorizontalGroup align=\"flex-start\" spacing=\"lg\">\n          <div>\n            <div className={styles.section}>\n              <Label description=\"Once a metric is selected only possible labels are shown.\">1. Select a metric</Label>\n              <div>\n                <Input\n                  onChange={this.onChangeMetricSearch}\n                  aria-label=\"Filter expression for metric\"\n                  value={metricSearchTerm}\n                />\n              </div>\n              <div role=\"list\" className={styles.valueListWrapper}>\n                <FixedSizeList\n                  height={Math.min(450, metricCount * LIST_ITEM_SIZE)}\n                  itemCount={metricCount}\n                  itemSize={LIST_ITEM_SIZE}\n                  itemKey={(i) => (metrics!.values as FacettableValue[])[i].name}\n                  width={300}\n                  className={styles.valueList}\n                >\n                  {({ index, style }) => {\n                    const value = metrics?.values?.[index];\n                    if (!value) {\n                      return null;\n                    }\n                    return (\n                      <div style={style}>\n                        <PromLabel\n                          name={metrics!.name}\n                          value={value?.name}\n                          title={value.details}\n                          active={value?.selected}\n                          onClick={this.onClickMetric}\n                          searchTerm={metricSearchTerm}\n                        />\n                      </div>\n                    );\n                  }}\n                </FixedSizeList>\n              </div>\n            </div>\n          </div>\n\n          <div>\n            <div className={styles.section}>\n              <Label description=\"Once label values are selected, only possible label combinations are shown.\">\n                2. Select labels to search in\n              </Label>\n              <div>\n                <Input\n                  onChange={this.onChangeLabelSearch}\n                  aria-label=\"Filter expression for label\"\n                  value={labelSearchTerm}\n                />\n              </div>\n              {/* Using fixed height here to prevent jumpy layout */}\n              <div className={styles.list} style={{ height: 120 }}>\n                {nonMetricLabels.map((label) => (\n                  <PromLabel\n                    key={label.name}\n                    name={label.name}\n                    loading={label.loading}\n                    active={label.selected}\n                    hidden={label.hidden}\n                    facets={label.facets}\n                    onClick={this.onClickLabel}\n                    searchTerm={labelSearchTerm}\n                  />\n                ))}\n              </div>\n            </div>\n            <div className={styles.section}>\n              <Label description=\"Use the search field to find values across selected labels.\">\n                3. Select (multiple) values for your labels\n              </Label>\n              <div>\n                <Input\n                  onChange={this.onChangeValueSearch}\n                  aria-label=\"Filter expression for label values\"\n                  value={valueSearchTerm}\n                />\n              </div>\n              <div className={styles.valueListArea} ref={this.valueListsRef}>\n                {selectedLabels.map((label) => (\n                  <div\n                    role=\"list\"\n                    key={label.name}\n                    aria-label={`Values for ${label.name}`}\n                    className={styles.valueListWrapper}\n                  >\n                    <div className={styles.valueTitle}>\n                      <PromLabel\n                        name={label.name}\n                        loading={label.loading}\n                        active={label.selected}\n                        hidden={label.hidden}\n                        //If no facets, we want to show number of all label values\n                        facets={label.facets || label.values?.length}\n                        onClick={this.onClickLabel}\n                      />\n                    </div>\n                    <FixedSizeList\n                      height={Math.min(200, LIST_ITEM_SIZE * (label.values?.length || 0))}\n                      itemCount={label.values?.length || 0}\n                      itemSize={28}\n                      itemKey={(i) => (label.values as FacettableValue[])[i].name}\n                      width={200}\n                      className={styles.valueList}\n                    >\n                      {({ index, style }) => {\n                        const value = label.values?.[index];\n                        if (!value) {\n                          return null;\n                        }\n                        return (\n                          <div style={style}>\n                            <PromLabel\n                              name={label.name}\n                              value={value?.name}\n                              active={value?.selected}\n                              onClick={this.onClickValue}\n                              searchTerm={valueSearchTerm}\n                            />\n                          </div>\n                        );\n                      }}\n                    </FixedSizeList>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </HorizontalGroup>\n\n        <div className={styles.section}>\n          <Label>4. Resulting selector</Label>\n          <div aria-label=\"selector\" className={styles.selector}>\n            {selector}\n          </div>\n          {validationStatus && <div className={styles.validationStatus}>{validationStatus}</div>}\n          <HorizontalGroup>\n            <Button aria-label=\"Use selector for query button\" disabled={empty} onClick={this.onClickRunQuery}>\n              Use query\n            </Button>\n            <Button\n              aria-label=\"Use selector as metrics button\"\n              variant=\"secondary\"\n              disabled={empty}\n              onClick={this.onClickRunRateQuery}\n            >\n              Use as rate query\n            </Button>\n            <Button\n              aria-label=\"Validate submit button\"\n              variant=\"secondary\"\n              disabled={empty}\n              onClick={this.onClickValidate}\n            >\n              Validate selector\n            </Button>\n            <Button aria-label=\"Selector clear button\" variant=\"secondary\" onClick={this.onClickClear}>\n              Clear\n            </Button>\n            <div className={cx(styles.status, (status || error) && styles.statusShowing)}>\n              <span className={error ? styles.error : ''}>{error || status}</span>\n            </div>\n          </HorizontalGroup>\n        </div>\n      </div>\n    );\n  }\n}\n\nexport const PrometheusMetricsBrowser = withTheme2(UnthemedPrometheusMetricsBrowser);\n","import React, { Suspense } from 'react';\n\nimport { Props } from './MonacoQueryFieldProps';\n\nconst Field = React.lazy(() => import(/* webpackChunkName: \"prom-query-field\" */ './MonacoQueryField'));\n\nexport const MonacoQueryFieldLazy = (props: Props) => {\n  return (\n    <Suspense fallback={null}>\n      <Field {...props} />\n    </Suspense>\n  );\n};\n","import React, { useRef } from 'react';\n\nimport { MonacoQueryFieldLazy } from './MonacoQueryFieldLazy';\nimport { Props as MonacoProps } from './MonacoQueryFieldProps';\n\ntype Props = Omit<MonacoProps, 'onRunQuery' | 'onBlur'> & {\n  onChange: (query: string) => void;\n  onRunQuery: () => void;\n  runQueryOnBlur: boolean;\n};\n\nexport const MonacoQueryFieldWrapper = (props: Props) => {\n  const lastRunValueRef = useRef<string | null>(null);\n  const { runQueryOnBlur, onRunQuery, onChange, ...rest } = props;\n\n  const handleRunQuery = (value: string) => {\n    lastRunValueRef.current = value;\n    onChange(value);\n    onRunQuery();\n  };\n\n  const handleBlur = (value: string) => {\n    if (runQueryOnBlur) {\n      // run handleRunQuery only if the current value is different from the last-time-executed value\n      if (value !== lastRunValueRef.current) {\n        handleRunQuery(value);\n      }\n    } else {\n      onChange(value);\n    }\n  };\n\n  /**\n   * Handles changes without running any queries\n   * @param value\n   */\n  const handleChange = (value: string) => {\n    onChange(value);\n  };\n\n  return <MonacoQueryFieldLazy onChange={handleChange} onRunQuery={handleRunQuery} onBlur={handleBlur} {...rest} />;\n};\n","import { cx } from '@emotion/css';\nimport { LanguageMap, languages as prismLanguages } from 'prismjs';\nimport React, { ReactNode } from 'react';\nimport { Plugin } from 'slate';\nimport { Editor } from 'slate-react';\n\nimport { CoreApp, isDataFrame, QueryEditorProps, QueryHint, TimeRange, toLegacyResponseData } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime/src';\nimport {\n  BracesPlugin,\n  DOMUtil,\n  Icon,\n  SlatePrism,\n  SuggestionsState,\n  TypeaheadInput,\n  TypeaheadOutput,\n  Themeable2,\n  withTheme2,\n  clearButtonStyles,\n} from '@grafana/ui';\nimport { LocalStorageValueProvider } from 'app/core/components/LocalStorageValueProvider';\nimport {\n  CancelablePromise,\n  isCancelablePromiseRejection,\n  makePromiseCancelable,\n} from 'app/core/utils/CancelablePromise';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { roundMsToMin } from '../language_utils';\nimport { PromOptions, PromQuery } from '../types';\n\nimport { PrometheusMetricsBrowser } from './PrometheusMetricsBrowser';\nimport { MonacoQueryFieldWrapper } from './monaco-query-field/MonacoQueryFieldWrapper';\n\nexport const RECORDING_RULES_GROUP = '__recording_rules__';\nconst LAST_USED_LABELS_KEY = 'grafana.datasources.prometheus.browser.labels';\n\nfunction getChooserText(metricsLookupDisabled: boolean, hasSyntax: boolean, hasMetrics: boolean) {\n  if (metricsLookupDisabled) {\n    return '(Disabled)';\n  }\n\n  if (!hasSyntax) {\n    return 'Loading metrics...';\n  }\n\n  if (!hasMetrics) {\n    return '(No metrics found)';\n  }\n\n  return 'Metrics browser';\n}\n\nexport function willApplySuggestion(suggestion: string, { typeaheadContext, typeaheadText }: SuggestionsState): string {\n  // Modify suggestion based on context\n  switch (typeaheadContext) {\n    case 'context-labels': {\n      const nextChar = DOMUtil.getNextCharacter();\n      if (!nextChar || nextChar === '}' || nextChar === ',') {\n        suggestion += '=';\n      }\n      break;\n    }\n\n    case 'context-label-values': {\n      // Always add quotes and remove existing ones instead\n      if (!typeaheadText.match(/^(!?=~?\"|\")/)) {\n        suggestion = `\"${suggestion}`;\n      }\n      if (DOMUtil.getNextCharacter() !== '\"') {\n        suggestion = `${suggestion}\"`;\n      }\n      break;\n    }\n\n    default:\n  }\n  return suggestion;\n}\n\ninterface PromQueryFieldProps extends QueryEditorProps<PrometheusDatasource, PromQuery, PromOptions>, Themeable2 {\n  ExtraFieldElement?: ReactNode;\n  'data-testid'?: string;\n}\n\ninterface PromQueryFieldState {\n  labelBrowserVisible: boolean;\n  syntaxLoaded: boolean;\n  hint: QueryHint | null;\n}\n\nclass PromQueryField extends React.PureComponent<PromQueryFieldProps, PromQueryFieldState> {\n  plugins: Array<Plugin<Editor>>;\n  declare languageProviderInitializationPromise: CancelablePromise<any>;\n\n  constructor(props: PromQueryFieldProps, context: React.Context<any>) {\n    super(props, context);\n\n    this.plugins = [\n      BracesPlugin(),\n      SlatePrism(\n        {\n          onlyIn: (node: any) => node.type === 'code_block',\n          getSyntax: (node: any) => 'promql',\n        },\n        { ...(prismLanguages as LanguageMap), promql: this.props.datasource.languageProvider.syntax }\n      ),\n    ];\n\n    this.state = {\n      labelBrowserVisible: false,\n      syntaxLoaded: false,\n      hint: null,\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.datasource.languageProvider) {\n      this.refreshMetrics();\n    }\n    this.refreshHint();\n  }\n\n  componentWillUnmount() {\n    if (this.languageProviderInitializationPromise) {\n      this.languageProviderInitializationPromise.cancel();\n    }\n  }\n\n  componentDidUpdate(prevProps: PromQueryFieldProps) {\n    const {\n      data,\n      datasource: { languageProvider },\n      range,\n    } = this.props;\n\n    if (languageProvider !== prevProps.datasource.languageProvider) {\n      // We reset this only on DS change so we do not flesh loading state on every rangeChange which happens on every\n      // query run if using relative range.\n      this.setState({\n        syntaxLoaded: false,\n      });\n    }\n\n    const changedRangeToRefresh = this.rangeChangedToRefresh(range, prevProps.range);\n    // We want to refresh metrics when language provider changes and/or when range changes (we round up intervals to a minute)\n    if (languageProvider !== prevProps.datasource.languageProvider || changedRangeToRefresh) {\n      this.refreshMetrics();\n    }\n\n    if (data && prevProps.data && prevProps.data.series !== data.series) {\n      this.refreshHint();\n    }\n  }\n\n  refreshHint = () => {\n    const { datasource, query, data } = this.props;\n    const initHints = datasource.getInitHints();\n    const initHint = initHints.length > 0 ? initHints[0] : null;\n\n    if (!data || data.series.length === 0) {\n      this.setState({\n        hint: initHint,\n      });\n      return;\n    }\n\n    const result = isDataFrame(data.series[0]) ? data.series.map(toLegacyResponseData) : data.series;\n    const queryHints = datasource.getQueryHints(query, result);\n    let queryHint = queryHints.length > 0 ? queryHints[0] : null;\n\n    this.setState({ hint: queryHint ?? initHint });\n  };\n\n  refreshMetrics = async () => {\n    const {\n      datasource: { languageProvider },\n    } = this.props;\n\n    this.languageProviderInitializationPromise = makePromiseCancelable(languageProvider.start());\n\n    try {\n      const remainingTasks = await this.languageProviderInitializationPromise.promise;\n      await Promise.all(remainingTasks);\n      this.onUpdateLanguage();\n    } catch (err) {\n      if (isCancelablePromiseRejection(err) && err.isCanceled) {\n        // do nothing, promise was canceled\n      } else {\n        throw err;\n      }\n    }\n  };\n\n  rangeChangedToRefresh(range?: TimeRange, prevRange?: TimeRange): boolean {\n    if (range && prevRange) {\n      const sameMinuteFrom = roundMsToMin(range.from.valueOf()) === roundMsToMin(prevRange.from.valueOf());\n      const sameMinuteTo = roundMsToMin(range.to.valueOf()) === roundMsToMin(prevRange.to.valueOf());\n      // If both are same, don't need to refresh.\n      return !(sameMinuteFrom && sameMinuteTo);\n    }\n    return false;\n  }\n\n  /**\n   * TODO #33976: Remove this, add histogram group (query = `histogram_quantile(0.95, sum(rate(${metric}[5m])) by (le))`;)\n   */\n  onChangeLabelBrowser = (selector: string) => {\n    this.onChangeQuery(selector, true);\n    this.setState({ labelBrowserVisible: false });\n  };\n\n  onChangeQuery = (value: string, override?: boolean) => {\n    // Send text change to parent\n    const { query, onChange, onRunQuery } = this.props;\n    if (onChange) {\n      const nextQuery: PromQuery = { ...query, expr: value };\n      onChange(nextQuery);\n\n      if (override && onRunQuery) {\n        onRunQuery();\n      }\n    }\n  };\n\n  onClickChooserButton = () => {\n    this.setState((state) => ({ labelBrowserVisible: !state.labelBrowserVisible }));\n\n    reportInteraction('user_grafana_prometheus_metrics_browser_clicked', {\n      editorMode: this.state.labelBrowserVisible ? 'metricViewClosed' : 'metricViewOpen',\n      app: this.props?.app ?? '',\n    });\n  };\n\n  onClickHintFix = () => {\n    const { datasource, query, onChange, onRunQuery } = this.props;\n    const { hint } = this.state;\n    if (hint?.fix?.action) {\n      onChange(datasource.modifyQuery(query, hint.fix.action));\n    }\n    onRunQuery();\n  };\n\n  onUpdateLanguage = () => {\n    const {\n      datasource: { languageProvider },\n    } = this.props;\n    const { metrics } = languageProvider;\n\n    if (!metrics) {\n      return;\n    }\n\n    this.setState({ syntaxLoaded: true });\n  };\n\n  onTypeahead = async (typeahead: TypeaheadInput): Promise<TypeaheadOutput> => {\n    const {\n      datasource: { languageProvider },\n    } = this.props;\n\n    if (!languageProvider) {\n      return { suggestions: [] };\n    }\n\n    const { history } = this.props;\n    const { prefix, text, value, wrapperClasses, labelKey } = typeahead;\n\n    const result = await languageProvider.provideCompletionItems(\n      { text, value, prefix, wrapperClasses, labelKey },\n      { history }\n    );\n\n    return result;\n  };\n\n  render() {\n    const {\n      datasource,\n      datasource: { languageProvider },\n      query,\n      ExtraFieldElement,\n      history = [],\n      theme,\n    } = this.props;\n\n    const { labelBrowserVisible, syntaxLoaded, hint } = this.state;\n    const hasMetrics = languageProvider.metrics.length > 0;\n    const chooserText = getChooserText(datasource.lookupsDisabled, syntaxLoaded, hasMetrics);\n    const buttonDisabled = !(syntaxLoaded && hasMetrics);\n\n    return (\n      <LocalStorageValueProvider<string[]> storageKey={LAST_USED_LABELS_KEY} defaultValue={[]}>\n        {(lastUsedLabels, onLastUsedLabelsSave, onLastUsedLabelsDelete) => {\n          return (\n            <>\n              <div\n                className=\"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1\"\n                data-testid={this.props['data-testid']}\n              >\n                <button\n                  className=\"gf-form-label query-keyword pointer\"\n                  onClick={this.onClickChooserButton}\n                  disabled={buttonDisabled}\n                  type=\"button\"\n                >\n                  {chooserText}\n                  <Icon name={labelBrowserVisible ? 'angle-down' : 'angle-right'} />\n                </button>\n\n                <div className=\"gf-form gf-form--grow flex-shrink-1 min-width-15\">\n                  <MonacoQueryFieldWrapper\n                    runQueryOnBlur={this.props.app !== CoreApp.Explore}\n                    languageProvider={languageProvider}\n                    history={history}\n                    onChange={this.onChangeQuery}\n                    onRunQuery={this.props.onRunQuery}\n                    initialValue={query.expr ?? ''}\n                    placeholder=\"Enter a PromQL query\"\n                  />\n                </div>\n              </div>\n              {labelBrowserVisible && (\n                <div className=\"gf-form\">\n                  <PrometheusMetricsBrowser\n                    languageProvider={languageProvider}\n                    onChange={this.onChangeLabelBrowser}\n                    lastUsedLabels={lastUsedLabels || []}\n                    storeLastUsedLabels={onLastUsedLabelsSave}\n                    deleteLastUsedLabels={onLastUsedLabelsDelete}\n                  />\n                </div>\n              )}\n\n              {ExtraFieldElement}\n              {hint ? (\n                <div className=\"query-row-break\">\n                  <div className=\"prom-query-field-info text-warning\">\n                    {hint.label}{' '}\n                    {hint.fix ? (\n                      <button\n                        type=\"button\"\n                        className={cx(clearButtonStyles(theme), 'text-link', 'muted')}\n                        onClick={this.onClickHintFix}\n                      >\n                        {hint.fix.label}\n                      </button>\n                    ) : null}\n                  </div>\n                </div>\n              ) : null}\n            </>\n          );\n        }}\n      </LocalStorageValueProvider>\n    );\n  }\n}\n\nexport default withTheme2(PromQueryField);\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\n\nimport PromQueryField from '../../components/PromQueryField';\nimport { PromQueryEditorProps } from '../../components/types';\n\nimport { PromQueryBuilderExplained } from './PromQueryBuilderExplained';\n\ntype Props = PromQueryEditorProps & {\n  showExplain: boolean;\n};\n\nexport function PromQueryCodeEditor(props: Props) {\n  const { query, datasource, range, onRunQuery, onChange, data, app, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      <PromQueryField\n        datasource={datasource}\n        query={query}\n        range={range}\n        onRunQuery={onRunQuery}\n        onChange={onChange}\n        history={[]}\n        data={data}\n        app={app}\n      />\n\n      {showExplain && <PromQueryBuilderExplained query={query.expr} />}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    // This wrapper styling can be removed after the old PromQueryEditor is removed.\n    // This is removing margin bottom on the old legacy inline form styles\n    wrapper: css`\n      .gf-form {\n        margin-bottom: 0;\n      }\n    `,\n  };\n};\n","import { map } from 'lodash';\nimport React, { SyntheticEvent, useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, LoadingState, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorHeader, EditorRows, FlexItem, Space } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, ConfirmModal } from '@grafana/ui';\n\nimport { PromQueryEditorProps } from '../../components/types';\nimport { PromQuery } from '../../types';\nimport { QueryPatternsModal } from '../QueryPatternsModal';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { QueryEditorModeToggle } from '../shared/QueryEditorModeToggle';\nimport { QueryHeaderSwitch } from '../shared/QueryHeaderSwitch';\nimport { promQueryEditorExplainKey, useFlag } from '../shared/hooks/useFlag';\nimport { QueryEditorMode } from '../shared/types';\nimport { changeEditorMode, getQueryWithDefaults } from '../state';\n\nimport { PromQueryBuilderContainer } from './PromQueryBuilderContainer';\nimport { PromQueryBuilderOptions } from './PromQueryBuilderOptions';\nimport { PromQueryCodeEditor } from './PromQueryCodeEditor';\n\nexport const FORMAT_OPTIONS: Array<SelectableValue<string>> = [\n  { label: 'Time series', value: 'time_series' },\n  { label: 'Table', value: 'table' },\n  { label: 'Heatmap', value: 'heatmap' },\n];\n\nexport const INTERVAL_FACTOR_OPTIONS: Array<SelectableValue<number>> = map([1, 2, 3, 4, 5, 10], (value: number) => ({\n  value,\n  label: '1/' + value,\n}));\n\ntype Props = PromQueryEditorProps;\n\nexport const PromQueryEditorSelector = React.memo<Props>((props) => {\n  const {\n    onChange,\n    onRunQuery,\n    data,\n    app,\n    onAddQuery,\n    datasource: { defaultEditor },\n    queries,\n  } = props;\n\n  const [parseModalOpen, setParseModalOpen] = useState(false);\n  const [queryPatternsModalOpen, setQueryPatternsModalOpen] = useState(false);\n  const [dataIsStale, setDataIsStale] = useState(false);\n  const { flag: explain, setFlag: setExplain } = useFlag(promQueryEditorExplainKey);\n\n  const query = getQueryWithDefaults(props.query, app, defaultEditor);\n  // This should be filled in from the defaults by now.\n  const editorMode = query.editorMode!;\n\n  const onEditorModeChange = useCallback(\n    (newMetricEditorMode: QueryEditorMode) => {\n      reportInteraction('user_grafana_prometheus_editor_mode_clicked', {\n        newEditor: newMetricEditorMode,\n        previousEditor: query.editorMode ?? '',\n        newQuery: !query.expr,\n        app: app ?? '',\n      });\n\n      if (newMetricEditorMode === QueryEditorMode.Builder) {\n        const result = buildVisualQueryFromString(query.expr || '');\n        // If there are errors, give user a chance to decide if they want to go to builder as that can lose some data.\n        if (result.errors.length) {\n          setParseModalOpen(true);\n          return;\n        }\n      }\n      changeEditorMode(query, newMetricEditorMode, onChange);\n    },\n    [onChange, query, app]\n  );\n\n  useEffect(() => {\n    setDataIsStale(false);\n  }, [data]);\n\n  const onChangeInternal = (query: PromQuery) => {\n    setDataIsStale(true);\n    onChange(query);\n  };\n\n  const onShowExplainChange = (e: SyntheticEvent<HTMLInputElement>) => {\n    setExplain(e.currentTarget.checked);\n  };\n\n  return (\n    <>\n      <ConfirmModal\n        isOpen={parseModalOpen}\n        title=\"Query parsing\"\n        body=\"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.\"\n        confirmText=\"Continue\"\n        onConfirm={() => {\n          changeEditorMode(query, QueryEditorMode.Builder, onChange);\n          setParseModalOpen(false);\n        }}\n        onDismiss={() => setParseModalOpen(false)}\n      />\n      <QueryPatternsModal\n        isOpen={queryPatternsModalOpen}\n        onClose={() => setQueryPatternsModalOpen(false)}\n        query={query}\n        queries={queries}\n        app={app}\n        onChange={onChange}\n        onAddQuery={onAddQuery}\n      />\n      <EditorHeader>\n        <Button\n          aria-label={selectors.components.QueryBuilder.queryPatterns}\n          variant=\"secondary\"\n          size=\"sm\"\n          onClick={() => setQueryPatternsModalOpen((prevValue) => !prevValue)}\n        >\n          Kick start your query\n        </Button>\n        <QueryHeaderSwitch label=\"Explain\" value={explain} onChange={onShowExplainChange} />\n        <FlexItem grow={1} />\n        {app !== CoreApp.Explore && app !== CoreApp.Correlations && (\n          <Button\n            variant={dataIsStale ? 'primary' : 'secondary'}\n            size=\"sm\"\n            onClick={onRunQuery}\n            icon={data?.state === LoadingState.Loading ? 'fa fa-spinner' : undefined}\n            disabled={data?.state === LoadingState.Loading}\n          >\n            Run queries\n          </Button>\n        )}\n        <QueryEditorModeToggle mode={editorMode} onChange={onEditorModeChange} />\n      </EditorHeader>\n      <Space v={0.5} />\n      <EditorRows>\n        {editorMode === QueryEditorMode.Code && <PromQueryCodeEditor {...props} query={query} showExplain={explain} />}\n        {editorMode === QueryEditorMode.Builder && (\n          <PromQueryBuilderContainer\n            query={query}\n            datasource={props.datasource}\n            onChange={onChangeInternal}\n            onRunQuery={props.onRunQuery}\n            data={data}\n            showExplain={explain}\n          />\n        )}\n        <PromQueryBuilderOptions query={query} app={props.app} onChange={onChange} onRunQuery={onRunQuery} />\n      </EditorRows>\n    </>\n  );\n});\n\nPromQueryEditorSelector.displayName = 'PromQueryEditorSelector';\n","import React from 'react';\n\nimport PromQueryField from './PromQueryField';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorForAlerting(props: PromQueryEditorProps) {\n  const { datasource, query, range, data, onChange, onRunQuery } = props;\n\n  return (\n    <PromQueryField\n      datasource={datasource}\n      query={query}\n      onRunQuery={onRunQuery}\n      onChange={onChange}\n      history={[]}\n      range={range}\n      data={data}\n      data-testid={testIds.editor}\n    />\n  );\n}\n\nexport const testIds = {\n  editor: 'prom-editor-cloud-alerting',\n};\n","import React, { memo } from 'react';\n\nimport { CoreApp } from '@grafana/data';\n\nimport { PromQueryEditorSelector } from '../querybuilder/components/PromQueryEditorSelector';\n\nimport { PromQueryEditorForAlerting } from './PromQueryEditorForAlerting';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorByApp(props: PromQueryEditorProps) {\n  const { app } = props;\n\n  switch (app) {\n    case CoreApp.CloudAlerting:\n      return <PromQueryEditorForAlerting {...props} />;\n    default:\n      return <PromQueryEditorSelector {...props} />;\n  }\n}\n\nexport default memo(PromQueryEditorByApp);\n","import { SelectableValue } from '@grafana/data';\n\nexport enum AzureCloud {\n  Public = 'AzureCloud',\n  China = 'AzureChinaCloud',\n  USGovernment = 'AzureUSGovernment',\n  None = '',\n}\n\nexport const KnownAzureClouds = [\n  { value: AzureCloud.Public, label: 'Azure' },\n  { value: AzureCloud.China, label: 'Azure China' },\n  { value: AzureCloud.USGovernment, label: 'Azure US Government' },\n] as SelectableValue[];\n\nexport type AzureAuthType = 'msi' | 'clientsecret';\n\nexport type ConcealedSecret = symbol;\n\ninterface AzureCredentialsBase {\n  authType: AzureAuthType;\n  defaultSubscriptionId?: string;\n}\n\nexport interface AzureManagedIdentityCredentials extends AzureCredentialsBase {\n  authType: 'msi';\n}\n\nexport interface AzureClientSecretCredentials extends AzureCredentialsBase {\n  authType: 'clientsecret';\n  azureCloud?: string;\n  tenantId?: string;\n  clientId?: string;\n  clientSecret?: string | ConcealedSecret;\n}\n\nexport type AzureCredentials = AzureManagedIdentityCredentials | AzureClientSecretCredentials;\n\nexport function isCredentialsComplete(credentials: AzureCredentials): boolean {\n  switch (credentials.authType) {\n    case 'msi':\n      return true;\n    case 'clientsecret':\n      return !!(credentials.azureCloud && credentials.tenantId && credentials.clientId && credentials.clientSecret);\n  }\n}\n","import { DataSourceSettings } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { AzureCloud, AzureCredentials, ConcealedSecret } from './AzureCredentials';\n\nconst concealed: ConcealedSecret = Symbol('Concealed client secret');\n\nfunction getDefaultAzureCloud(): string {\n  return config.azure.cloud || AzureCloud.Public;\n}\n\nfunction getSecret(options: DataSourceSettings<any, any>): undefined | string | ConcealedSecret {\n  if (options.secureJsonFields.azureClientSecret) {\n    // The secret is concealed on server\n    return concealed;\n  } else {\n    const secret = options.secureJsonData?.azureClientSecret;\n    return typeof secret === 'string' && secret.length > 0 ? secret : undefined;\n  }\n}\n\nexport function hasCredentials(options: DataSourceSettings<any, any>): boolean {\n  return !!options.jsonData.azureCredentials;\n}\n\nexport function getDefaultCredentials(): AzureCredentials {\n  if (config.azure.managedIdentityEnabled) {\n    return { authType: 'msi' };\n  } else {\n    return { authType: 'clientsecret', azureCloud: getDefaultAzureCloud() };\n  }\n}\n\nexport function getCredentials(options: DataSourceSettings<any, any>): AzureCredentials {\n  const credentials = options.jsonData.azureCredentials as AzureCredentials | undefined;\n\n  // If no credentials saved, then return empty credentials\n  // of type based on whether the managed identity enabled\n  if (!credentials) {\n    return getDefaultCredentials();\n  }\n\n  switch (credentials.authType) {\n    case 'msi':\n      if (config.azure.managedIdentityEnabled) {\n        return {\n          authType: 'msi',\n        };\n      } else {\n        // If authentication type is managed identity but managed identities were disabled in Grafana config,\n        // then we should fallback to an empty app registration (client secret) configuration\n        return {\n          authType: 'clientsecret',\n          azureCloud: getDefaultAzureCloud(),\n        };\n      }\n    case 'clientsecret':\n      return {\n        authType: 'clientsecret',\n        azureCloud: credentials.azureCloud || getDefaultAzureCloud(),\n        tenantId: credentials.tenantId,\n        clientId: credentials.clientId,\n        clientSecret: getSecret(options),\n      };\n  }\n}\n\nexport function updateCredentials(\n  options: DataSourceSettings<any, any>,\n  credentials: AzureCredentials\n): DataSourceSettings<any, any> {\n  switch (credentials.authType) {\n    case 'msi':\n      if (!config.azure.managedIdentityEnabled) {\n        throw new Error('Managed Identity authentication is not enabled in Grafana config.');\n      }\n\n      options = {\n        ...options,\n        jsonData: {\n          ...options.jsonData,\n          azureCredentials: {\n            authType: 'msi',\n          },\n        },\n      };\n\n      return options;\n\n    case 'clientsecret':\n      options = {\n        ...options,\n        jsonData: {\n          ...options.jsonData,\n          azureCredentials: {\n            authType: 'clientsecret',\n            azureCloud: credentials.azureCloud || getDefaultAzureCloud(),\n            tenantId: credentials.tenantId,\n            clientId: credentials.clientId,\n          },\n        },\n        secureJsonData: {\n          ...options.secureJsonData,\n          azureClientSecret:\n            typeof credentials.clientSecret === 'string' && credentials.clientSecret.length > 0\n              ? credentials.clientSecret\n              : undefined,\n        },\n        secureJsonFields: {\n          ...options.secureJsonFields,\n          azureClientSecret: typeof credentials.clientSecret === 'symbol',\n        },\n      };\n\n      return options;\n  }\n}\n\nexport function setDefaultCredentials(options: DataSourceSettings<any, any>): Partial<DataSourceSettings<any, any>> {\n  return {\n    jsonData: {\n      ...options.jsonData,\n      azureCredentials: getDefaultCredentials(),\n    },\n  };\n}\n\nexport function resetCredentials(options: DataSourceSettings<any, any>): Partial<DataSourceSettings<any, any>> {\n  return {\n    jsonData: {\n      ...options.jsonData,\n      azureAuth: undefined,\n      azureCredentials: undefined,\n      azureEndpointResourceId: undefined,\n    },\n  };\n}\n","import React, { ChangeEvent, FunctionComponent, useEffect, useReducer, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { InlineFormLabel, Button } from '@grafana/ui/src/components';\nimport { Input } from '@grafana/ui/src/components/Forms/Legacy/Input/Input';\nimport { Select } from '@grafana/ui/src/components/Forms/Legacy/Select/Select';\n\nimport { AzureAuthType, AzureCredentials, isCredentialsComplete } from './AzureCredentials';\n\nexport interface Props {\n  managedIdentityEnabled: boolean;\n  credentials: AzureCredentials;\n  azureCloudOptions?: SelectableValue[];\n  onCredentialsChange: (updatedCredentials: AzureCredentials) => void;\n  getSubscriptions?: () => Promise<SelectableValue[]>;\n  disabled?: boolean;\n}\n\nconst authTypeOptions: Array<SelectableValue<AzureAuthType>> = [\n  {\n    value: 'msi',\n    label: 'Managed Identity',\n  },\n  {\n    value: 'clientsecret',\n    label: 'App Registration',\n  },\n];\n\nexport const AzureCredentialsForm: FunctionComponent<Props> = (props: Props) => {\n  const { credentials, azureCloudOptions, onCredentialsChange, getSubscriptions, disabled } = props;\n  const hasRequiredFields = isCredentialsComplete(credentials);\n\n  const [subscriptions, setSubscriptions] = useState<Array<SelectableValue<string>>>([]);\n  const [loadSubscriptionsClicked, onLoadSubscriptions] = useReducer((val) => val + 1, 0);\n  useEffect(() => {\n    if (!getSubscriptions || !hasRequiredFields) {\n      updateSubscriptions([]);\n      return;\n    }\n    let canceled = false;\n    getSubscriptions().then((result) => {\n      if (!canceled) {\n        updateSubscriptions(result, loadSubscriptionsClicked);\n      }\n    });\n    return () => {\n      canceled = true;\n    };\n    // This effect is intended to be called only once initially and on Load Subscriptions click\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [loadSubscriptionsClicked]);\n\n  const updateSubscriptions = (received: Array<SelectableValue<string>>, autoSelect = false) => {\n    setSubscriptions(received);\n    if (getSubscriptions) {\n      if (autoSelect && !credentials.defaultSubscriptionId && received.length > 0) {\n        // Selecting the default subscription if subscriptions received but no default subscription selected\n        onSubscriptionChange(received[0]);\n      } else if (credentials.defaultSubscriptionId) {\n        const found = received.find((opt) => opt.value === credentials.defaultSubscriptionId);\n        if (!found) {\n          // Unselecting the default subscription if it isn't found among the received subscriptions\n          onSubscriptionChange(undefined);\n        }\n      }\n    }\n  };\n\n  const onAuthTypeChange = (selected: SelectableValue<AzureAuthType>) => {\n    if (onCredentialsChange) {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        authType: selected.value || 'msi',\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onAzureCloudChange = (selected: SelectableValue<string>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        azureCloud: selected.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onTenantIdChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        tenantId: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientIdChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientId: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientSecretChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientSecret: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientSecretReset = () => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientSecret: '',\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onSubscriptionChange = (selected: SelectableValue<string> | undefined) => {\n    if (onCredentialsChange) {\n      const updated: AzureCredentials = {\n        ...credentials,\n        defaultSubscriptionId: selected?.value,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  return (\n    <div className=\"gf-form-group\">\n      {props.managedIdentityEnabled && (\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <InlineFormLabel className=\"width-12\" tooltip=\"Choose the type of authentication to Azure services\">\n              Authentication\n            </InlineFormLabel>\n            <Select\n              className=\"width-15\"\n              value={authTypeOptions.find((opt) => opt.value === credentials.authType)}\n              options={authTypeOptions}\n              onChange={onAuthTypeChange}\n              isDisabled={disabled}\n            />\n          </div>\n        </div>\n      )}\n      {credentials.authType === 'clientsecret' && (\n        <>\n          {azureCloudOptions && (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel className=\"width-12\" tooltip=\"Choose an Azure Cloud\">\n                  Azure Cloud\n                </InlineFormLabel>\n                <Select\n                  className=\"width-15\"\n                  value={azureCloudOptions.find((opt) => opt.value === credentials.azureCloud)}\n                  options={azureCloudOptions}\n                  onChange={onAzureCloudChange}\n                  isDisabled={disabled}\n                />\n              </div>\n            </div>\n          )}\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Directory (tenant) ID</InlineFormLabel>\n              <div className=\"width-15\">\n                <Input\n                  className=\"width-30\"\n                  placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                  value={credentials.tenantId || ''}\n                  onChange={onTenantIdChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Application (client) ID</InlineFormLabel>\n              <div className=\"width-15\">\n                <Input\n                  className=\"width-30\"\n                  placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                  value={credentials.clientId || ''}\n                  onChange={onClientIdChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          {typeof credentials.clientSecret === 'symbol' ? (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel htmlFor=\"azure-client-secret\" className=\"width-12\">\n                  Client Secret\n                </InlineFormLabel>\n                <Input id=\"azure-client-secret\" className=\"width-25\" placeholder=\"configured\" disabled />\n              </div>\n              {!disabled && (\n                <div className=\"gf-form\">\n                  <div className=\"max-width-30 gf-form-inline\">\n                    <Button variant=\"secondary\" type=\"button\" onClick={onClientSecretReset}>\n                      reset\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel className=\"width-12\">Client Secret</InlineFormLabel>\n                <div className=\"width-15\">\n                  <Input\n                    className=\"width-30\"\n                    placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                    value={credentials.clientSecret || ''}\n                    onChange={onClientSecretChange}\n                    disabled={disabled}\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n      {getSubscriptions && (\n        <>\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Default Subscription</InlineFormLabel>\n              <div className=\"width-25\">\n                <Select\n                  value={\n                    credentials.defaultSubscriptionId\n                      ? subscriptions.find((opt) => opt.value === credentials.defaultSubscriptionId)\n                      : undefined\n                  }\n                  options={subscriptions}\n                  onChange={onSubscriptionChange}\n                  isDisabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <div className=\"max-width-30 gf-form-inline\">\n                <Button\n                  variant=\"secondary\"\n                  size=\"sm\"\n                  type=\"button\"\n                  onClick={onLoadSubscriptions}\n                  disabled={!hasRequiredFields}\n                >\n                  Load Subscriptions\n                </Button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n};\n\nexport default AzureCredentialsForm;\n","import React, { FunctionComponent, FormEvent, useMemo, useState } from 'react';\n\nimport { config } from '@grafana/runtime';\nimport { InlineField, InlineFieldRow, InlineSwitch, Input } from '@grafana/ui';\nimport { HttpSettingsBaseProps } from '@grafana/ui/src/components/DataSourceSettings/types';\n\nimport { KnownAzureClouds, AzureCredentials } from './AzureCredentials';\nimport { getCredentials, updateCredentials } from './AzureCredentialsConfig';\nimport { AzureCredentialsForm } from './AzureCredentialsForm';\n\nexport const AzureAuthSettings: FunctionComponent<HttpSettingsBaseProps> = (props: HttpSettingsBaseProps) => {\n  const { dataSourceConfig, onChange } = props;\n\n  const [overrideAudienceAllowed] = useState<boolean>(\n    config.featureToggles.prometheusAzureOverrideAudience || !!dataSourceConfig.jsonData.azureEndpointResourceId\n  );\n  const [overrideAudienceChecked, setOverrideAudienceChecked] = useState<boolean>(\n    !!dataSourceConfig.jsonData.azureEndpointResourceId\n  );\n\n  const credentials = useMemo(() => getCredentials(dataSourceConfig), [dataSourceConfig]);\n\n  const onCredentialsChange = (credentials: AzureCredentials): void => {\n    onChange(updateCredentials(dataSourceConfig, credentials));\n  };\n\n  const onOverrideAudienceChange = (ev: FormEvent<HTMLInputElement>): void => {\n    setOverrideAudienceChecked(ev.currentTarget.checked);\n    if (!ev.currentTarget.checked) {\n      onChange({\n        ...dataSourceConfig,\n        jsonData: { ...dataSourceConfig.jsonData, azureEndpointResourceId: undefined },\n      });\n    }\n  };\n\n  const onResourceIdChange = (ev: FormEvent<HTMLInputElement>): void => {\n    if (overrideAudienceChecked) {\n      onChange({\n        ...dataSourceConfig,\n        jsonData: { ...dataSourceConfig.jsonData, azureEndpointResourceId: ev.currentTarget.value },\n      });\n    }\n  };\n\n  return (\n    <>\n      <h6>Azure Authentication</h6>\n      <AzureCredentialsForm\n        managedIdentityEnabled={config.azure.managedIdentityEnabled}\n        credentials={credentials}\n        azureCloudOptions={KnownAzureClouds}\n        onCredentialsChange={onCredentialsChange}\n        disabled={dataSourceConfig.readOnly}\n      />\n      {overrideAudienceAllowed && (\n        <>\n          <h6>Azure Configuration</h6>\n          <div className=\"gf-form-group\">\n            <InlineFieldRow>\n              <InlineField labelWidth={26} label=\"Override AAD audience\" disabled={dataSourceConfig.readOnly}>\n                <InlineSwitch value={overrideAudienceChecked} onChange={onOverrideAudienceChange} />\n              </InlineField>\n            </InlineFieldRow>\n            {overrideAudienceChecked && (\n              <InlineFieldRow>\n                <InlineField labelWidth={26} label=\"Resource ID\" disabled={dataSourceConfig.readOnly}>\n                  <Input\n                    className=\"width-30\"\n                    value={dataSourceConfig.jsonData.azureEndpointResourceId || ''}\n                    onChange={onResourceIdChange}\n                  />\n                </InlineField>\n              </InlineFieldRow>\n            )}\n          </div>\n        </>\n      )}\n    </>\n  );\n};\n\nexport default AzureAuthSettings;\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, InlineField, InlineSwitch, Input } from '@grafana/ui';\n\nimport { ExemplarTraceIdDestination } from '../types';\n\ntype Props = {\n  value: ExemplarTraceIdDestination;\n  onChange: (value: ExemplarTraceIdDestination) => void;\n  onDelete: () => void;\n  disabled?: boolean;\n};\n\nexport default function ExemplarSetting({ value, onChange, onDelete, disabled }: Props) {\n  const [isInternalLink, setIsInternalLink] = useState(Boolean(value.datasourceUid));\n\n  return (\n    <div className=\"gf-form-group\">\n      <InlineField label=\"Internal link\" labelWidth={24} disabled={disabled}>\n        <>\n          <InlineSwitch\n            value={isInternalLink}\n            aria-label={selectors.components.DataSource.Prometheus.configPage.internalLinkSwitch}\n            onChange={(ev) => setIsInternalLink(ev.currentTarget.checked)}\n          />\n          {!disabled && (\n            <Button\n              variant=\"destructive\"\n              title=\"Remove link\"\n              icon=\"times\"\n              onClick={(event) => {\n                event.preventDefault();\n                onDelete();\n              }}\n              className={css`\n                margin-left: 8px;\n              `}\n            />\n          )}\n        </>\n      </InlineField>\n\n      {isInternalLink ? (\n        <InlineField\n          label=\"Data source\"\n          labelWidth={24}\n          tooltip=\"The data source the exemplar is going to navigate to.\"\n          disabled={disabled}\n        >\n          <DataSourcePicker\n            tracing={true}\n            current={value.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds) =>\n              onChange({\n                ...value,\n                datasourceUid: ds.uid,\n                url: undefined,\n              })\n            }\n          />\n        </InlineField>\n      ) : (\n        <InlineField\n          label=\"URL\"\n          labelWidth={24}\n          tooltip=\"The URL of the trace backend the user would go to see its trace.\"\n          disabled={disabled}\n        >\n          <Input\n            placeholder=\"https://example.com/${__value.raw}\"\n            spellCheck={false}\n            width={40}\n            value={value.url}\n            onChange={(event) =>\n              onChange({\n                ...value,\n                datasourceUid: undefined,\n                url: event.currentTarget.value,\n              })\n            }\n          />\n        </InlineField>\n      )}\n\n      <InlineField\n        label=\"URL Label\"\n        labelWidth={24}\n        tooltip=\"Use to override the button label on the exemplar traceID field.\"\n        disabled={disabled}\n      >\n        <Input\n          placeholder=\"Go to example.com\"\n          spellCheck={false}\n          width={40}\n          value={value.urlDisplayLabel}\n          onChange={(event) =>\n            onChange({\n              ...value,\n              urlDisplayLabel: event.currentTarget.value,\n            })\n          }\n        />\n      </InlineField>\n      <InlineField\n        label=\"Label name\"\n        labelWidth={24}\n        tooltip=\"The name of the field in the labels object that should be used to get the traceID.\"\n        disabled={disabled}\n      >\n        <Input\n          placeholder=\"traceID\"\n          spellCheck={false}\n          width={40}\n          value={value.name}\n          onChange={(event) =>\n            onChange({\n              ...value,\n              name: event.currentTarget.value,\n            })\n          }\n        />\n      </InlineField>\n    </div>\n  );\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Button } from '@grafana/ui';\n\nimport { ExemplarTraceIdDestination } from '../types';\n\nimport ExemplarSetting from './ExemplarSetting';\n\ntype Props = {\n  options?: ExemplarTraceIdDestination[];\n  onChange: (value: ExemplarTraceIdDestination[]) => void;\n  disabled?: boolean;\n};\n\nexport function ExemplarsSettings({ options, onChange, disabled }: Props) {\n  return (\n    <>\n      <h3 className=\"page-heading\">Exemplars</h3>\n\n      {options &&\n        options.map((option, index) => {\n          return (\n            <ExemplarSetting\n              key={index}\n              value={option}\n              onChange={(newField) => {\n                const newOptions = [...options];\n                newOptions.splice(index, 1, newField);\n                onChange(newOptions);\n              }}\n              onDelete={() => {\n                const newOptions = [...options];\n                newOptions.splice(index, 1);\n                onChange(newOptions);\n              }}\n              disabled={disabled}\n            />\n          );\n        })}\n\n      {!disabled && (\n        <Button\n          variant=\"secondary\"\n          aria-label={selectors.components.DataSource.Prometheus.configPage.exemplarsAddButton}\n          className={css`\n            margin-bottom: 10px;\n          `}\n          icon=\"plus\"\n          onClick={(event) => {\n            event.preventDefault();\n            const newOptions = [...(options || []), { name: 'traceID' }];\n            onChange(newOptions);\n          }}\n        >\n          Add\n        </Button>\n      )}\n    </>\n  );\n}\n","export const PromFlavorVersions: { [index: string]: Array<{ value?: string; label: string }> } = {\n  Prometheus: [\n    { value: undefined, label: 'Please select' },\n    { value: '2.0.0', label: '< 2.14.x' },\n    { value: '2.14.0', label: '2.14.x' },\n    { value: '2.15.0', label: '2.15.x' },\n    { value: '2.16.0', label: '2.16.x' },\n    { value: '2.17.0', label: '2.17.x' },\n    { value: '2.18.0', label: '2.18.x' },\n    { value: '2.19.0', label: '2.19.x' },\n    { value: '2.20.0', label: '2.20.x' },\n    { value: '2.21.0', label: '2.21.x' },\n    { value: '2.22.0', label: '2.22.x' },\n    { value: '2.23.0', label: '2.23.x' },\n    { value: '2.24.0', label: '2.24.x' },\n    { value: '2.25.0', label: '2.25.x' },\n    { value: '2.26.0', label: '2.26.x' },\n    { value: '2.27.0', label: '2.27.x' },\n    { value: '2.28.0', label: '2.28.x' },\n    { value: '2.29.0', label: '2.29.x' },\n    { value: '2.30.0', label: '2.30.x' },\n    { value: '2.31.0', label: '2.31.x' },\n    { value: '2.32.0', label: '2.32.x' },\n    { value: '2.33.0', label: '2.33.x' },\n    { value: '2.34.0', label: '2.34.x' },\n    { value: '2.35.0', label: '2.35.x' },\n    { value: '2.36.0', label: '2.36.x' },\n    { value: '2.37.0', label: '2.37.x' },\n    { value: '2.38.0', label: '2.38.x' },\n    { value: '2.39.0', label: '2.39.x' },\n    { value: '2.40.0', label: '2.40.x' },\n\n    // This value will be returned for future versions of prometheus until we add new entries to this object\n    { value: '2.40.1', label: '> 2.40.x' },\n  ],\n  Mimir: [\n    { value: undefined, label: 'Please select' },\n    { value: '2.0.0', label: '2.0.x' },\n    { value: '2.1.0', label: '2.1.x' },\n    { value: '2.2.0', label: '2.2.x' },\n    { value: '2.3.0', label: '2.3.x' },\n    { value: '2.4.0', label: '> 2.3.x' },\n  ],\n  Thanos: [\n    { value: undefined, label: 'Please select' },\n    { value: '0.0.0', label: '< 0.16.x' },\n    { value: '0.16.0', label: '0.16.x' },\n    { value: '0.17.0', label: '0.17.x' },\n    { value: '0.18.0', label: '0.18.x' },\n    { value: '0.19.0', label: '0.19.x' },\n    { value: '0.20.0', label: '0.20.x' },\n    { value: '0.21.0', label: '0.21.x' },\n    { value: '0.22.0', label: '0.22.x' },\n    { value: '0.23.0', label: '0.23.x' },\n    { value: '0.24.0', label: '0.24.x' },\n    { value: '0.25.0', label: '0.25.x' },\n    { value: '0.26.0', label: '0.26.x' },\n    { value: '0.27.0', label: '0.27.x' },\n    { value: '0.28.0', label: '0.28.x' },\n    { value: '0.29.0', label: '> 0.28.x' },\n  ],\n  Cortex: [\n    { value: undefined, label: 'Please select' },\n    { value: '0.0.0', label: '< 1.0.0' },\n    { value: '1.0.0', label: '1.0.0' },\n    { value: '1.1.0', label: '1.1.x' },\n    { value: '1.2.0', label: '1.2.x' },\n    { value: '1.3.0', label: '1.3.x' },\n    { value: '1.4.0', label: '1.4.x' },\n    { value: '1.5.0', label: '1.5.x' },\n    { value: '1.6.0', label: '1.6.x' },\n    { value: '1.7.0', label: '1.7.x' },\n    { value: '1.8.0', label: '1.8.x' },\n    { value: '1.9.0', label: '1.9.x' },\n    { value: '1.10.0', label: '1.10.x' },\n    { value: '1.11.0', label: '1.11.x' },\n    { value: '1.13.0', label: '1.13.x' },\n    { value: '1.14.0', label: '> 1.13.x' },\n  ],\n};\n","import React, { SyntheticEvent } from 'react';\nimport semver from 'semver/preload';\n\nimport {\n  DataSourcePluginOptionsEditorProps,\n  DataSourceSettings as DataSourceSettingsType,\n  onUpdateDatasourceJsonDataOptionChecked,\n  SelectableValue,\n  updateDatasourcePluginJsonDataOption,\n} from '@grafana/data';\nimport { getBackendSrv } from '@grafana/runtime/src';\nimport {\n  EventsWithValidation,\n  InlineField,\n  InlineFormLabel,\n  InlineSwitch,\n  LegacyForms,\n  regexValidation,\n  Select,\n} from '@grafana/ui';\n\nimport { useUpdateDatasource } from '../../../../features/datasources/state';\nimport { PromApplication, PromBuildInfoResponse } from '../../../../types/unified-alerting-dto';\nimport { QueryEditorMode } from '../querybuilder/shared/types';\nimport { PromOptions } from '../types';\n\nimport { ExemplarsSettings } from './ExemplarsSettings';\nimport { PromFlavorVersions } from './PromFlavorVersions';\n\nconst { Input, FormField } = LegacyForms;\n\nconst httpOptions = [\n  { value: 'POST', label: 'POST' },\n  { value: 'GET', label: 'GET' },\n];\n\nconst editorOptions = [\n  { value: QueryEditorMode.Builder, label: 'Builder' },\n  { value: QueryEditorMode.Code, label: 'Code' },\n];\n\ntype PrometheusSelectItemsType = Array<{ value: PromApplication; label: PromApplication }>;\n\nconst prometheusFlavorSelectItems: PrometheusSelectItemsType = [\n  { value: PromApplication.Prometheus, label: PromApplication.Prometheus },\n  { value: PromApplication.Cortex, label: PromApplication.Cortex },\n  { value: PromApplication.Mimir, label: PromApplication.Mimir },\n  { value: PromApplication.Thanos, label: PromApplication.Thanos },\n];\n\ntype Props = Pick<DataSourcePluginOptionsEditorProps<PromOptions>, 'options' | 'onOptionsChange'>;\n\n/**\n * Returns the closest version to what the user provided that we have in our PromFlavorVersions for the currently selected flavor\n * Bugs: It will only reject versions that are a major release apart, so Mimir 2.x might get selected for Prometheus 2.8 if the user selects an incorrect flavor\n * Advantages: We don't need to maintain a list of every possible version for each release\n *\n * This function will return the closest version from PromFlavorVersions that is equal or lower to the version argument,\n * unless the versions are a major release apart.\n */\nconst getVersionString = (version: string, flavor?: string): string | undefined => {\n  if (!flavor || !PromFlavorVersions[flavor]) {\n    return;\n  }\n  const flavorVersionValues = PromFlavorVersions[flavor];\n\n  // As long as it's assured we're using versions which are sorted, we could just filter out the values greater than the target version, and then check the last element in the array\n  const versionsLessThanOrEqual = flavorVersionValues\n    ?.filter((el) => !!el.value && semver.lte(el.value, version))\n    .map((el) => el.value);\n\n  const closestVersion = versionsLessThanOrEqual[versionsLessThanOrEqual.length - 1];\n\n  if (closestVersion) {\n    const differenceBetweenActualAndClosest = semver.diff(closestVersion, version);\n\n    // Only return versions if the target is close to the actual.\n    if (['patch', 'prepatch', 'prerelease', null].includes(differenceBetweenActualAndClosest)) {\n      return closestVersion;\n    }\n  }\n\n  return;\n};\n\nconst unableToDeterminePrometheusVersion = (error?: Error): void => {\n  console.warn('Error fetching version from buildinfo API, must manually select version!', error);\n};\n\n/**\n * I don't like the daisy chain of network requests, and that we have to save on behalf of the user, but currently\n * the backend doesn't allow for the prometheus client url to be passed in from the frontend, so we currently need to save it\n * to the database before consumption.\n *\n * Since the prometheus version fields are below the url field, we can expect users to populate this field before\n * hitting save and test at the bottom of the page. For this case we need to save the current fields before calling the\n * resource to auto-detect the version.\n *\n * @param options\n * @param onOptionsChange\n * @param onUpdate\n */\nconst setPrometheusVersion = (\n  options: DataSourceSettingsType<PromOptions>,\n  onOptionsChange: (options: DataSourceSettingsType<PromOptions>) => void,\n  onUpdate: (dataSource: DataSourceSettingsType<PromOptions>) => Promise<DataSourceSettingsType<PromOptions>>\n) => {\n  // This will save the current state of the form, as the url is needed for this API call to function\n  onUpdate(options)\n    .then((updatedOptions) => {\n      getBackendSrv()\n        .get(`/api/datasources/${updatedOptions.id}/resources/version-detect`)\n        .then((rawResponse: PromBuildInfoResponse) => {\n          const rawVersionStringFromApi = rawResponse.data?.version ?? '';\n          if (rawVersionStringFromApi && semver.valid(rawVersionStringFromApi)) {\n            const parsedVersion = getVersionString(rawVersionStringFromApi, updatedOptions.jsonData.prometheusType);\n            // If we got a successful response, let's update the backend with the version right away if it's new\n            if (parsedVersion) {\n              onUpdate({\n                ...updatedOptions,\n                jsonData: {\n                  ...updatedOptions.jsonData,\n                  prometheusVersion: parsedVersion,\n                },\n              }).then((updatedUpdatedOptions) => {\n                onOptionsChange(updatedUpdatedOptions);\n              });\n            }\n          } else {\n            unableToDeterminePrometheusVersion();\n          }\n        });\n    })\n    .catch((error) => {\n      unableToDeterminePrometheusVersion(error);\n    });\n};\n\nexport const PromSettings = (props: Props) => {\n  const { options, onOptionsChange } = props;\n\n  // This update call is typed as void, but it returns a response which we need\n  const onUpdate = useUpdateDatasource();\n\n  // We are explicitly adding httpMethod so, it is correctly displayed in dropdown.\n  // This way, it is more predictable for users.\n  if (!options.jsonData.httpMethod) {\n    options.jsonData.httpMethod = 'POST';\n  }\n\n  return (\n    <>\n      <div className=\"gf-form-group\">\n        {/* Scrape interval */}\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <FormField\n              label=\"Scrape interval\"\n              labelWidth={13}\n              inputEl={\n                <Input\n                  className=\"width-6\"\n                  value={options.jsonData.timeInterval}\n                  spellCheck={false}\n                  placeholder=\"15s\"\n                  onChange={onChangeHandler('timeInterval', options, onOptionsChange)}\n                  validationEvents={promSettingsValidationEvents}\n                  disabled={options.readOnly}\n                />\n              }\n              tooltip=\"Set this to the typical scrape and evaluation interval configured in Prometheus. Defaults to 15s.\"\n            />\n          </div>\n        </div>\n        {/* Query Timeout */}\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <FormField\n              label=\"Query timeout\"\n              labelWidth={13}\n              inputEl={\n                <Input\n                  className=\"width-6\"\n                  value={options.jsonData.queryTimeout}\n                  onChange={onChangeHandler('queryTimeout', options, onOptionsChange)}\n                  spellCheck={false}\n                  placeholder=\"60s\"\n                  validationEvents={promSettingsValidationEvents}\n                  disabled={options.readOnly}\n                />\n              }\n              tooltip=\"Set the Prometheus query timeout.\"\n            />\n          </div>\n        </div>\n        {/* HTTP Method */}\n        <div className=\"gf-form\">\n          <InlineFormLabel\n            width={13}\n            tooltip=\"You can use either POST or GET HTTP method to query your Prometheus data source. POST is the recommended method as it allows bigger queries. Change this to GET if you have a Prometheus version older than 2.1 or if POST requests are restricted in your network.\"\n          >\n            HTTP method\n          </InlineFormLabel>\n          <Select\n            aria-label=\"Select HTTP method\"\n            options={httpOptions}\n            value={httpOptions.find((o) => o.value === options.jsonData.httpMethod)}\n            onChange={onChangeHandler('httpMethod', options, onOptionsChange)}\n            className=\"width-6\"\n            disabled={options.readOnly}\n          />\n        </div>\n      </div>\n\n      <h3 className=\"page-heading\">Type and version</h3>\n      {!options.jsonData.prometheusType && !options.jsonData.prometheusVersion && options.readOnly && (\n        <div style={{ marginBottom: '12px' }}>\n          For more information on configuring prometheus type and version in data sources, see the{' '}\n          <a\n            style={{ textDecoration: 'underline' }}\n            href=\"https://grafana.com/docs/grafana/latest/administration/provisioning/\"\n          >\n            provisioning documentation\n          </a>\n          .\n        </div>\n      )}\n      <div className=\"gf-form-group\">\n        <div className=\"gf-form\">\n          <div className=\"gf-form\">\n            <FormField\n              label=\"Prometheus type\"\n              labelWidth={13}\n              inputEl={\n                <Select\n                  aria-label=\"Prometheus type\"\n                  options={prometheusFlavorSelectItems}\n                  value={prometheusFlavorSelectItems.find((o) => o.value === options.jsonData.prometheusType)}\n                  onChange={onChangeHandler(\n                    'prometheusType',\n                    {\n                      ...options,\n                      jsonData: { ...options.jsonData, prometheusVersion: undefined },\n                    },\n                    (options) => {\n                      // Check buildinfo api and set default version if we can\n                      setPrometheusVersion(options, onOptionsChange, onUpdate);\n                      return onOptionsChange({\n                        ...options,\n                        jsonData: { ...options.jsonData, prometheusVersion: undefined },\n                      });\n                    }\n                  )}\n                  width={20}\n                  disabled={options.readOnly}\n                />\n              }\n              tooltip=\"Set this to the type of your prometheus database, e.g. Prometheus, Cortex, Mimir or Thanos. Changing this field will save your current settings, and attempt to detect the version.\"\n            />\n          </div>\n        </div>\n        <div className=\"gf-form\">\n          {options.jsonData.prometheusType && (\n            <div className=\"gf-form\">\n              <FormField\n                label={`${options.jsonData.prometheusType} version`}\n                labelWidth={13}\n                inputEl={\n                  <Select\n                    aria-label={`${options.jsonData.prometheusType} type`}\n                    options={PromFlavorVersions[options.jsonData.prometheusType]}\n                    value={PromFlavorVersions[options.jsonData.prometheusType]?.find(\n                      (o) => o.value === options.jsonData.prometheusVersion\n                    )}\n                    onChange={onChangeHandler('prometheusVersion', options, onOptionsChange)}\n                    width={20}\n                    disabled={options.readOnly}\n                  />\n                }\n                tooltip={`Use this to set the version of your ${options.jsonData.prometheusType} instance if it is not automatically configured.`}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n\n      <h3 className=\"page-heading\">Misc</h3>\n      <div className=\"gf-form-group\">\n        <div className=\"gf-form\">\n          <InlineField\n            labelWidth={28}\n            label=\"Disable metrics lookup\"\n            tooltip=\"Checking this option will disable the metrics chooser and metric/label support in the query field's autocomplete. This helps if you have performance issues with bigger Prometheus instances.\"\n            disabled={options.readOnly}\n          >\n            <InlineSwitch\n              value={options.jsonData.disableMetricsLookup ?? false}\n              onChange={onUpdateDatasourceJsonDataOptionChecked(props, 'disableMetricsLookup')}\n            />\n          </InlineField>\n        </div>\n        <div className=\"gf-form\">\n          <FormField\n            label=\"Default Editor\"\n            labelWidth={14}\n            inputEl={\n              <Select\n                aria-label={`Default Editor (Code or Builder)`}\n                options={editorOptions}\n                value={editorOptions.find((o) => o.value === options.jsonData.defaultEditor)}\n                onChange={onChangeHandler('defaultEditor', options, onOptionsChange)}\n                width={20}\n                disabled={options.readOnly}\n              />\n            }\n            tooltip={`Set default editor option (builder/code) for all users of this datasource. If no option was selected, the default editor will be the \"builder\". If they switch to other option rather than the specified with this setting on the panel we always show the selected editor for that user.`}\n          />\n        </div>\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form max-width-30\">\n            <FormField\n              label=\"Custom query parameters\"\n              labelWidth={14}\n              tooltip=\"Add custom parameters to all Prometheus or Thanos queries.\"\n              inputEl={\n                <Input\n                  className=\"width-25\"\n                  value={options.jsonData.customQueryParameters}\n                  onChange={onChangeHandler('customQueryParameters', options, onOptionsChange)}\n                  spellCheck={false}\n                  placeholder=\"Example: max_source_resolution=5m&timeout=10\"\n                  disabled={options.readOnly}\n                />\n              }\n            />\n          </div>\n        </div>\n      </div>\n      <ExemplarsSettings\n        options={options.jsonData.exemplarTraceIdDestinations}\n        onChange={(exemplarOptions) =>\n          updateDatasourcePluginJsonDataOption(\n            { onOptionsChange, options },\n            'exemplarTraceIdDestinations',\n            exemplarOptions\n          )\n        }\n        disabled={options.readOnly}\n      />\n    </>\n  );\n};\n\nexport const promSettingsValidationEvents = {\n  [EventsWithValidation.onBlur]: [\n    regexValidation(\n      /^$|^\\d+(ms|[Mwdhmsy])$/,\n      'Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s'\n    ),\n  ],\n};\n\nexport const getValueFromEventItem = (eventItem: SyntheticEvent<HTMLInputElement> | SelectableValue<string>) => {\n  if (!eventItem) {\n    return '';\n  }\n\n  if (eventItem.hasOwnProperty('currentTarget')) {\n    return eventItem.currentTarget.value;\n  }\n\n  return (eventItem as SelectableValue<string>).value;\n};\n\nconst onChangeHandler =\n  (key: keyof PromOptions, options: Props['options'], onOptionsChange: Props['onOptionsChange']) =>\n  (eventItem: SyntheticEvent<HTMLInputElement> | SelectableValue<string>) => {\n    onOptionsChange({\n      ...options,\n      jsonData: {\n        ...options.jsonData,\n        [key]: getValueFromEventItem(eventItem),\n      },\n    });\n  };\n","import React, { useRef } from 'react';\n\nimport { SIGV4ConnectionConfig } from '@grafana/aws-sdk';\nimport { DataSourcePluginOptionsEditorProps, DataSourceSettings } from '@grafana/data';\nimport { AlertingSettings, DataSourceHttpSettings, Alert, SecureSocksProxySettings } from '@grafana/ui';\nimport { config } from 'app/core/config';\n\nimport { PromOptions } from '../types';\n\nimport { AzureAuthSettings } from './AzureAuthSettings';\nimport { hasCredentials, setDefaultCredentials, resetCredentials } from './AzureCredentialsConfig';\nimport { PromSettings } from './PromSettings';\n\nexport type Props = DataSourcePluginOptionsEditorProps<PromOptions>;\nexport const ConfigEditor = (props: Props) => {\n  const { options, onOptionsChange } = props;\n  // use ref so this is evaluated only first time it renders and the select does not disappear suddenly.\n  const showAccessOptions = useRef(props.options.access === 'direct');\n\n  const azureAuthSettings = {\n    azureAuthSupported: config.azureAuthEnabled,\n    getAzureAuthEnabled: (config: DataSourceSettings<any, any>): boolean => hasCredentials(config),\n    setAzureAuthEnabled: (config: DataSourceSettings<any, any>, enabled: boolean) =>\n      enabled ? setDefaultCredentials(config) : resetCredentials(config),\n    azureSettingsUI: AzureAuthSettings,\n  };\n\n  return (\n    <>\n      {options.access === 'direct' && (\n        <Alert title=\"Error\" severity=\"error\">\n          Browser access mode in the Prometheus datasource is no longer available. Switch to server access mode.\n        </Alert>\n      )}\n\n      <DataSourceHttpSettings\n        defaultUrl=\"http://localhost:9090\"\n        dataSourceConfig={options}\n        showAccessOptions={showAccessOptions.current}\n        onChange={onOptionsChange}\n        sigV4AuthToggleEnabled={config.sigV4AuthEnabled}\n        azureAuthSettings={azureAuthSettings}\n        renderSigV4Editor={<SIGV4ConnectionConfig {...props}></SIGV4ConnectionConfig>}\n      />\n\n      {config.featureToggles.secureSocksDatasourceProxy && (\n        <SecureSocksProxySettings options={options} onOptionsChange={onOptionsChange} />\n      )}\n\n      <AlertingSettings<PromOptions> options={options} onOptionsChange={onOptionsChange} />\n\n      <PromSettings options={options} onOptionsChange={onOptionsChange} />\n    </>\n  );\n};\n","import React from 'react';\n\nimport { AnnotationQuery } from '@grafana/data';\nimport { EditorField, EditorRow, EditorRows, EditorSwitch, Space } from '@grafana/experimental';\nimport { AutoSizeInput, Input } from '@grafana/ui';\n\nimport { PromQueryCodeEditor } from '../querybuilder/components/PromQueryCodeEditor';\nimport { PromQuery } from '../types';\n\nimport { PromQueryEditorProps } from './types';\n\ntype Props = PromQueryEditorProps & {\n  annotation?: AnnotationQuery<PromQuery>;\n  onAnnotationChange?: (annotation: AnnotationQuery<PromQuery>) => void;\n};\n\nexport function AnnotationQueryEditor(props: Props) {\n  // This is because of problematic typing. See AnnotationQueryEditorProps in grafana-data/annotations.ts.\n  const annotation = props.annotation!;\n  const onAnnotationChange = props.onAnnotationChange!;\n  const query = { expr: annotation.expr, refId: annotation.name, interval: annotation.step };\n\n  return (\n    <>\n      <EditorRows>\n        <PromQueryCodeEditor\n          {...props}\n          query={query}\n          showExplain={false}\n          onChange={(query) => {\n            onAnnotationChange({\n              ...annotation,\n              expr: query.expr,\n            });\n          }}\n        />\n        <EditorRow>\n          <EditorField\n            label=\"Min step\"\n            tooltip={\n              <>\n                An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n                <code>$__interval</code> and <code>$__rate_interval</code> variables.\n              </>\n            }\n          >\n            <AutoSizeInput\n              type=\"text\"\n              aria-label=\"Set lower limit for the step parameter\"\n              placeholder={'auto'}\n              minWidth={10}\n              onCommitChange={(ev) => {\n                onAnnotationChange({\n                  ...annotation,\n                  step: ev.currentTarget.value,\n                });\n              }}\n              defaultValue={query.interval}\n            />\n          </EditorField>\n        </EditorRow>\n      </EditorRows>\n      <Space v={0.5} />\n      <EditorRow>\n        <EditorField\n          label=\"Title\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"{{alertname}}\"\n            value={annotation.titleFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                titleFormat: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n        <EditorField label=\"Tags\">\n          <Input\n            type=\"text\"\n            placeholder=\"label1,label2\"\n            value={annotation.tagKeys}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                tagKeys: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n        <EditorField\n          label=\"Text\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"{{instance}}\"\n            value={annotation.textFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                textFormat: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n        <EditorField\n          label=\"Series value as timestamp\"\n          tooltip={\n            'The unit of timestamp is milliseconds. If the unit of the series value is seconds, multiply its range vector by 1000.'\n          }\n        >\n          <EditorSwitch\n            value={annotation.useValueForTime}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                useValueForTime: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n      </EditorRow>\n    </>\n  );\n}\n","import { chain, map as _map, uniq } from 'lodash';\nimport { lastValueFrom } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport { MetricFindValue, TimeRange } from '@grafana/data';\nimport { getTimeSrv } from 'app/features/dashboard/services/TimeSrv';\n\nimport { PrometheusDatasource } from './datasource';\nimport { PromQueryRequest } from './types';\n\nexport default class PrometheusMetricFindQuery {\n  range: TimeRange;\n\n  constructor(private datasource: PrometheusDatasource, private query: string) {\n    this.datasource = datasource;\n    this.query = query;\n    this.range = getTimeSrv().timeRange();\n  }\n\n  process(): Promise<MetricFindValue[]> {\n    const labelNamesRegex = /^label_names\\(\\)\\s*$/;\n    const labelValuesRegex = /^label_values\\((?:(.+),\\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s*$/;\n    const metricNamesRegex = /^metrics\\((.+)\\)\\s*$/;\n    const queryResultRegex = /^query_result\\((.+)\\)\\s*$/;\n    const labelNamesQuery = this.query.match(labelNamesRegex);\n    if (labelNamesQuery) {\n      return this.labelNamesQuery();\n    }\n\n    const labelValuesQuery = this.query.match(labelValuesRegex);\n    if (labelValuesQuery) {\n      if (labelValuesQuery[1]) {\n        return this.labelValuesQuery(labelValuesQuery[2], labelValuesQuery[1]);\n      } else {\n        return this.labelValuesQuery(labelValuesQuery[2]);\n      }\n    }\n\n    const metricNamesQuery = this.query.match(metricNamesRegex);\n    if (metricNamesQuery) {\n      return this.metricNameQuery(metricNamesQuery[1]);\n    }\n\n    const queryResultQuery = this.query.match(queryResultRegex);\n    if (queryResultQuery) {\n      return lastValueFrom(this.queryResultQuery(queryResultQuery[1]));\n    }\n\n    // if query contains full metric name, return metric name and label list\n    return this.metricNameAndLabelsQuery(this.query);\n  }\n\n  labelNamesQuery() {\n    const start = this.datasource.getPrometheusTime(this.range.from, false);\n    const end = this.datasource.getPrometheusTime(this.range.to, true);\n    const params = {\n      start: start.toString(),\n      end: end.toString(),\n    };\n\n    const url = `/api/v1/labels`;\n\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      return _map(result.data.data, (value) => {\n        return { text: value };\n      });\n    });\n  }\n\n  labelValuesQuery(label: string, metric?: string) {\n    const start = this.datasource.getPrometheusTime(this.range.from, false);\n    const end = this.datasource.getPrometheusTime(this.range.to, true);\n    const params = { ...(metric && { 'match[]': metric }), start: start.toString(), end: end.toString() };\n\n    if (!metric || this.datasource.hasLabelsMatchAPISupport()) {\n      const url = `/api/v1/label/${label}/values`;\n\n      return this.datasource.metadataRequest(url, params).then((result: any) => {\n        return _map(result.data.data, (value) => {\n          return { text: value };\n        });\n      });\n    } else {\n      const url = `/api/v1/series`;\n\n      return this.datasource.metadataRequest(url, params).then((result: any) => {\n        const _labels = _map(result.data.data, (metric) => {\n          return metric[label] || '';\n        }).filter((label) => {\n          return label !== '';\n        });\n\n        return uniq(_labels).map((metric) => {\n          return {\n            text: metric,\n            expandable: true,\n          };\n        });\n      });\n    }\n  }\n\n  metricNameQuery(metricFilterPattern: string) {\n    const start = this.datasource.getPrometheusTime(this.range.from, false);\n    const end = this.datasource.getPrometheusTime(this.range.to, true);\n    const params = {\n      start: start.toString(),\n      end: end.toString(),\n    };\n    const url = `/api/v1/label/__name__/values`;\n\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      return chain(result.data.data)\n        .filter((metricName) => {\n          const r = new RegExp(metricFilterPattern);\n          return r.test(metricName);\n        })\n        .map((matchedMetricName) => {\n          return {\n            text: matchedMetricName,\n            expandable: true,\n          };\n        })\n        .value();\n    });\n  }\n\n  queryResultQuery(query: string) {\n    const end = this.datasource.getPrometheusTime(this.range.to, true);\n    const instantQuery: PromQueryRequest = { expr: query } as PromQueryRequest;\n    return this.datasource.performInstantQuery(instantQuery, end).pipe(\n      map((result) => {\n        switch (result.data.data.resultType) {\n          case 'scalar': // [ <unix_time>, \"<scalar_value>\" ]\n          case 'string': // [ <unix_time>, \"<string_value>\" ]\n            return [\n              {\n                text: result.data.data.result[1] || '',\n                expandable: false,\n              },\n            ];\n          case 'vector':\n            return _map(result.data.data.result, (metricData) => {\n              let text = metricData.metric.__name__ || '';\n              delete metricData.metric.__name__;\n              text +=\n                '{' +\n                _map(metricData.metric, (v, k) => {\n                  return k + '=\"' + v + '\"';\n                }).join(',') +\n                '}';\n              text += ' ' + metricData.value[1] + ' ' + metricData.value[0] * 1000;\n\n              return {\n                text: text,\n                expandable: true,\n              };\n            });\n          default:\n            throw Error(`Unknown/Unhandled result type: [${result.data.data.resultType}]`);\n        }\n      })\n    );\n  }\n\n  metricNameAndLabelsQuery(query: string): Promise<MetricFindValue[]> {\n    const start = this.datasource.getPrometheusTime(this.range.from, false);\n    const end = this.datasource.getPrometheusTime(this.range.to, true);\n    const params = {\n      'match[]': query,\n      start: start.toString(),\n      end: end.toString(),\n    };\n\n    const url = `/api/v1/series`;\n    const self = this;\n\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      return _map(result.data.data, (metric: { [key: string]: string }) => {\n        return {\n          text: self.datasource.getOriginalMetricName(metric),\n          expandable: true,\n        };\n      });\n    });\n  }\n}\n","import { size } from 'lodash';\n\nimport { QueryHint, QueryFix } from '@grafana/data';\n\nimport { PrometheusDatasource } from './datasource';\n\n/**\n * Number of time series results needed before starting to suggest sum aggregation hints\n */\nexport const SUM_HINT_THRESHOLD_COUNT = 20;\n\nexport function getQueryHints(query: string, series?: any[], datasource?: PrometheusDatasource): QueryHint[] {\n  const hints = [];\n\n  // ..._bucket metric needs a histogram_quantile()\n  const histogramMetric = query.trim().match(/^\\w+_bucket$|^\\w+_bucket{.*}$/);\n  if (histogramMetric) {\n    const label = 'Selected metric has buckets.';\n    hints.push({\n      type: 'HISTOGRAM_QUANTILE',\n      label,\n      fix: {\n        label: 'Consider calculating aggregated quantile by adding histogram_quantile().',\n        action: {\n          type: 'ADD_HISTOGRAM_QUANTILE',\n          query,\n        },\n      } as QueryFix,\n    });\n  }\n\n  // Check for need of rate()\n  if (query.indexOf('rate(') === -1 && query.indexOf('increase(') === -1) {\n    // Use metric metadata for exact types\n    const nameMatch = query.match(/\\b(\\w+_(total|sum|count))\\b/);\n    let counterNameMetric = nameMatch ? nameMatch[1] : '';\n    const metricsMetadata = datasource?.languageProvider?.metricsMetadata;\n    let certain = false;\n\n    if (metricsMetadata) {\n      // Tokenize the query into its identifiers (see https://prometheus.io/docs/concepts/data_model/#metric-names-and-labels)\n      const queryTokens = Array.from(query.matchAll(/\\$?[a-zA-Z_:][a-zA-Z0-9_:]*/g))\n        .map(([match]) => match)\n        // Exclude variable identifiers\n        .filter((token) => !token.startsWith('$'))\n        // Split composite keys to match the tokens returned by the language provider\n        .flatMap((token) => token.split(':'));\n      // Determine whether any of the query identifier tokens refers to a counter metric\n      counterNameMetric =\n        queryTokens.find((metricName) => {\n          // Only considering first type information, could be non-deterministic\n          const metadata = metricsMetadata[metricName];\n          if (metadata && metadata.type.toLowerCase() === 'counter') {\n            certain = true;\n            return true;\n          } else {\n            return false;\n          }\n        }) ?? '';\n    }\n\n    if (counterNameMetric) {\n      // FixableQuery consists of metric name and optionally label-value pairs. We are not offering fix for complex queries yet.\n      const fixableQuery = query.trim().match(/^\\w+$|^\\w+{.*}$/);\n      const verb = certain ? 'is' : 'looks like';\n      let label = `Selected metric ${verb} a counter.`;\n      let fix: QueryFix | undefined;\n\n      if (fixableQuery) {\n        fix = {\n          label: 'Consider calculating rate of counter by adding rate().',\n          action: {\n            type: 'ADD_RATE',\n            query,\n          },\n        };\n      } else {\n        label = `${label} Consider calculating rate of counter by adding rate().`;\n      }\n\n      hints.push({\n        type: 'APPLY_RATE',\n        label,\n        fix,\n      });\n    }\n  }\n\n  // Check for recording rules expansion\n  if (datasource && datasource.ruleMappings) {\n    const mapping = datasource.ruleMappings;\n    const mappingForQuery = Object.keys(mapping).reduce((acc, ruleName) => {\n      if (query.search(ruleName) > -1) {\n        return {\n          ...acc,\n          [ruleName]: mapping[ruleName],\n        };\n      }\n      return acc;\n    }, {});\n    if (size(mappingForQuery) > 0) {\n      const label = 'Query contains recording rules.';\n      hints.push({\n        type: 'EXPAND_RULES',\n        label,\n        fix: {\n          label: 'Expand rules',\n          action: {\n            type: 'EXPAND_RULES',\n            query,\n            options: mappingForQuery,\n          },\n        } as unknown as QueryFix,\n      });\n    }\n  }\n\n  if (series && series.length >= SUM_HINT_THRESHOLD_COUNT) {\n    const simpleMetric = query.trim().match(/^\\w+$/);\n    if (simpleMetric) {\n      hints.push({\n        type: 'ADD_SUM',\n        label: 'Many time series results returned.',\n        fix: {\n          label: 'Consider aggregating with sum().',\n          action: {\n            type: 'ADD_SUM',\n            query: query,\n            preventSubmit: true,\n          },\n        } as QueryFix,\n      });\n    }\n  }\n\n  return hints;\n}\n\nexport function getInitHints(datasource: PrometheusDatasource): QueryHint[] {\n  const hints = [];\n  // Hint if using Loki as Prometheus data source\n  if (datasource.directUrl.includes('/loki') && !datasource.languageProvider.metrics.length) {\n    hints.push({\n      label: `Using Loki as a Prometheus data source is no longer supported. You must use the Loki data source for your Loki instance.`,\n      type: 'INFO',\n    });\n  }\n\n  // Hint for big disabled lookups\n  if (datasource.lookupsDisabled) {\n    hints.push({\n      label: `Labels and metrics lookup was disabled in data source settings.`,\n      type: 'INFO',\n    });\n  }\n\n  return hints;\n}\n","import { descending, deviation } from 'd3';\nimport { flatten, forOwn, groupBy, partition } from 'lodash';\n\nimport {\n  ArrayDataFrame,\n  ArrayVector,\n  CoreApp,\n  DataFrame,\n  DataFrameType,\n  DataLink,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataTopic,\n  Field,\n  FieldType,\n  formatLabels,\n  getDisplayProcessor,\n  Labels,\n  MutableField,\n  PreferredVisualisationType,\n  ScopedVars,\n  TIME_SERIES_TIME_FIELD_NAME,\n  TIME_SERIES_VALUE_FIELD_NAME,\n} from '@grafana/data';\nimport { FetchResponse, getDataSourceSrv, getTemplateSrv } from '@grafana/runtime';\n\nimport { renderLegendFormat } from './legend';\nimport {\n  ExemplarTraceIdDestination,\n  isExemplarData,\n  isMatrixData,\n  MatrixOrVectorResult,\n  PromDataSuccessResponse,\n  PromMetric,\n  PromQuery,\n  PromQueryRequest,\n  PromValue,\n  TransformOptions,\n} from './types';\n\n// handles case-insensitive Inf, +Inf, -Inf (with optional \"inity\" suffix)\nconst INFINITY_SAMPLE_REGEX = /^[+-]?inf(?:inity)?$/i;\n\ninterface TimeAndValue {\n  [TIME_SERIES_TIME_FIELD_NAME]: number;\n  [TIME_SERIES_VALUE_FIELD_NAME]: number;\n}\n\nconst isTableResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  // We want to process vector and scalar results in Explore as table\n  if (\n    options.app === CoreApp.Explore &&\n    (dataFrame.meta?.custom?.resultType === 'vector' || dataFrame.meta?.custom?.resultType === 'scalar')\n  ) {\n    return true;\n  }\n\n  // We want to process all dataFrames with target.format === 'table' as table\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'table';\n};\n\nconst isHeatmapResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'heatmap';\n};\n\n// V2 result transformer used to transform query results from queries that were run through prometheus backend\nexport function transformV2(\n  response: DataQueryResponse,\n  request: DataQueryRequest<PromQuery>,\n  options: { exemplarTraceIdDestinations?: ExemplarTraceIdDestination[] }\n) {\n  const [tableFrames, framesWithoutTable] = partition<DataFrame>(response.data, (df) => isTableResult(df, request));\n  const processedTableFrames = transformDFToTable(tableFrames);\n\n  const [exemplarFrames, framesWithoutTableAndExemplars] = partition<DataFrame>(\n    framesWithoutTable,\n    (df) => df.meta?.custom?.resultType === 'exemplar'\n  );\n\n  // EXEMPLAR FRAMES: We enrich exemplar frames with data links and add dataTopic meta info\n  const { exemplarTraceIdDestinations: destinations } = options;\n  const processedExemplarFrames = exemplarFrames.map((dataFrame) => {\n    if (destinations?.length) {\n      for (const exemplarTraceIdDestination of destinations) {\n        const traceIDField = dataFrame.fields.find((field) => field.name === exemplarTraceIdDestination.name);\n        if (traceIDField) {\n          const links = getDataLinks(exemplarTraceIdDestination);\n          traceIDField.config.links = traceIDField.config.links?.length\n            ? [...traceIDField.config.links, ...links]\n            : links;\n        }\n      }\n    }\n\n    return { ...dataFrame, meta: { ...dataFrame.meta, dataTopic: DataTopic.Annotations } };\n  });\n\n  const [heatmapResults, framesWithoutTableHeatmapsAndExemplars] = partition<DataFrame>(\n    framesWithoutTableAndExemplars,\n    (df) => isHeatmapResult(df, request)\n  );\n\n  // this works around the fact that we only get back frame.name with le buckets when legendFormat == {{le}}...which is not the default\n  heatmapResults.forEach((df) => {\n    if (df.name == null) {\n      let f = df.fields.find((f) => f.name === 'Value');\n\n      if (f) {\n        let le = f.labels?.le;\n\n        if (le) {\n          // this is used for sorting the frames by numeric ascending le labels for de-accum\n          df.name = le;\n          // this is used for renaming the Value fields to le label\n          f.config.displayNameFromDS = le;\n        }\n      }\n    }\n  });\n\n  // Group heatmaps by query\n  const heatmapResultsGroupedByQuery = groupBy<DataFrame>(heatmapResults, (h) => h.refId);\n\n  // Initialize empty array to push grouped histogram frames to\n  let processedHeatmapResultsGroupedByQuery: DataFrame[][] = [];\n\n  // Iterate through every query in this heatmap\n  for (const query in heatmapResultsGroupedByQuery) {\n    // Get reference to dataFrames for heatmap\n    const heatmapResultsGroup = heatmapResultsGroupedByQuery[query];\n\n    // Create a new grouping by iterating through the data frames...\n    const heatmapResultsGroupedByValues = groupBy<DataFrame>(heatmapResultsGroup, (dataFrame) => {\n      // Each data frame has `Time` and `Value` properties, we want to get the values\n      const values = dataFrame.fields.find((field) => field.name === TIME_SERIES_VALUE_FIELD_NAME);\n      // Specific functionality for special \"le\" quantile heatmap value, we know if this value exists, that we do not want to calculate the heatmap density across data frames from the same quartile\n      if (values?.labels && HISTOGRAM_QUANTILE_LABEL_NAME in values.labels) {\n        const { le, ...notLE } = values?.labels;\n        return Object.values(notLE).join();\n      }\n\n      // Return a string made from the concatenation of this frame's values to represent a grouping in the query\n      return Object.values(values?.labels ?? []).join();\n    });\n\n    // Then iterate through the resultant object\n    forOwn(heatmapResultsGroupedByValues, (dataFrames, key) => {\n      // Sort frames within each grouping\n      const sortedHeatmap = dataFrames.sort(sortSeriesByLabel);\n      // And push the sorted grouping with the rest\n      processedHeatmapResultsGroupedByQuery.push(mergeHeatmapFrames(transformToHistogramOverTime(sortedHeatmap)));\n    });\n  }\n\n  // Everything else is processed as time_series result and graph preferredVisualisationType\n  const otherFrames = framesWithoutTableHeatmapsAndExemplars.map((dataFrame) => {\n    const df: DataFrame = {\n      ...dataFrame,\n      meta: {\n        ...dataFrame.meta,\n        preferredVisualisationType: 'graph',\n      },\n    };\n    return df;\n  });\n\n  const flattenedProcessedHeatmapFrames = flatten(processedHeatmapResultsGroupedByQuery);\n\n  return {\n    ...response,\n    data: [...otherFrames, ...processedTableFrames, ...flattenedProcessedHeatmapFrames, ...processedExemplarFrames],\n  };\n}\n\nconst HISTOGRAM_QUANTILE_LABEL_NAME = 'le';\n\nexport function transformDFToTable(dfs: DataFrame[]): DataFrame[] {\n  // If no dataFrames or if 1 dataFrames with no values, return original dataFrame\n  if (dfs.length === 0 || (dfs.length === 1 && dfs[0].length === 0)) {\n    return dfs;\n  }\n\n  // Group results by refId and process dataFrames with the same refId as 1 dataFrame\n  const dataFramesByRefId = groupBy(dfs, 'refId');\n  const refIds = Object.keys(dataFramesByRefId);\n\n  const frames = refIds.map((refId) => {\n    // Create timeField, valueField and labelFields\n    const valueText = getValueText(refIds.length, refId);\n    const valueField = getValueField({ data: [], valueName: valueText });\n    const timeField = getTimeField([]);\n    const labelFields: MutableField[] = [];\n\n    // Fill labelsFields with labels from dataFrames\n    dataFramesByRefId[refId].forEach((df) => {\n      const frameValueField = df.fields[1];\n      const promLabels = frameValueField.labels ?? {};\n\n      Object.keys(promLabels)\n        .sort()\n        .forEach((label) => {\n          // If we don't have label in labelFields, add it\n          if (!labelFields.some((l) => l.name === label)) {\n            const numberField = label === HISTOGRAM_QUANTILE_LABEL_NAME;\n            labelFields.push({\n              name: label,\n              config: { filterable: true },\n              type: numberField ? FieldType.number : FieldType.string,\n              values: new ArrayVector(),\n            });\n          }\n        });\n    });\n\n    // Fill valueField, timeField and labelFields with values\n    dataFramesByRefId[refId].forEach((df) => {\n      df.fields[0].values.toArray().forEach((value) => timeField.values.add(value));\n      df.fields[1].values.toArray().forEach((value) => {\n        valueField.values.add(parseSampleValue(value));\n        const labelsForField = df.fields[1].labels ?? {};\n        labelFields.forEach((field) => field.values.add(getLabelValue(labelsForField, field.name)));\n      });\n    });\n\n    const fields = [timeField, ...labelFields, valueField];\n    return {\n      refId,\n      fields,\n      // Prometheus specific UI for instant queries\n      meta: { ...dfs[0].meta, preferredVisualisationType: 'rawPrometheus' as PreferredVisualisationType },\n      length: timeField.values.length,\n    };\n  });\n  return frames;\n}\n\nfunction getValueText(responseLength: number, refId = '') {\n  return responseLength > 1 ? `Value #${refId}` : 'Value';\n}\n\nexport function transform(\n  response: FetchResponse<PromDataSuccessResponse>,\n  transformOptions: {\n    query: PromQueryRequest;\n    exemplarTraceIdDestinations?: ExemplarTraceIdDestination[];\n    target: PromQuery;\n    responseListLength: number;\n    scopedVars?: ScopedVars;\n  }\n) {\n  // Create options object from transformOptions\n  const options: TransformOptions = {\n    format: transformOptions.target.format,\n    step: transformOptions.query.step,\n    legendFormat: transformOptions.target.legendFormat,\n    start: transformOptions.query.start,\n    end: transformOptions.query.end,\n    query: transformOptions.query.expr,\n    responseListLength: transformOptions.responseListLength,\n    scopedVars: transformOptions.scopedVars,\n    refId: transformOptions.target.refId,\n    valueWithRefId: transformOptions.target.valueWithRefId,\n    meta: {\n      // Fix for showing of Prometheus results in Explore table\n      preferredVisualisationType: transformOptions.query.instant ? 'rawPrometheus' : 'graph',\n    },\n  };\n  const prometheusResult = response.data.data;\n\n  if (isExemplarData(prometheusResult)) {\n    const events: TimeAndValue[] = [];\n    prometheusResult.forEach((exemplarData) => {\n      const data = exemplarData.exemplars.map((exemplar) => {\n        return {\n          [TIME_SERIES_TIME_FIELD_NAME]: exemplar.timestamp * 1000,\n          [TIME_SERIES_VALUE_FIELD_NAME]: exemplar.value,\n          ...exemplar.labels,\n          ...exemplarData.seriesLabels,\n        };\n      });\n      events.push(...data);\n    });\n\n    // Grouping exemplars by step\n    const sampledExemplars = sampleExemplars(events, options);\n\n    const dataFrame = new ArrayDataFrame(sampledExemplars);\n    dataFrame.meta = { dataTopic: DataTopic.Annotations };\n\n    // Add data links if configured\n    if (transformOptions.exemplarTraceIdDestinations?.length) {\n      for (const exemplarTraceIdDestination of transformOptions.exemplarTraceIdDestinations) {\n        const traceIDField = dataFrame.fields.find((field) => field.name === exemplarTraceIdDestination.name);\n        if (traceIDField) {\n          const links = getDataLinks(exemplarTraceIdDestination);\n          traceIDField.config.links = traceIDField.config.links?.length\n            ? [...traceIDField.config.links, ...links]\n            : links;\n        }\n      }\n    }\n    return [dataFrame];\n  }\n\n  if (!prometheusResult?.result) {\n    return [];\n  }\n\n  // Return early if result type is scalar\n  if (prometheusResult.resultType === 'scalar') {\n    return [\n      {\n        meta: options.meta,\n        refId: options.refId,\n        length: 1,\n        fields: [getTimeField([prometheusResult.result]), getValueField({ data: [prometheusResult.result] })],\n      },\n    ];\n  }\n\n  // Return early again if the format is table, this needs special transformation.\n  if (options.format === 'table') {\n    const tableData = transformMetricDataToTable(prometheusResult.result, options);\n    return [tableData];\n  }\n\n  // Process matrix and vector results to DataFrame\n  const dataFrame: DataFrame[] = [];\n  prometheusResult.result.forEach((data: MatrixOrVectorResult) => dataFrame.push(transformToDataFrame(data, options)));\n\n  // When format is heatmap use the already created data frames and transform it more\n  if (options.format === 'heatmap') {\n    return mergeHeatmapFrames(transformToHistogramOverTime(dataFrame.sort(sortSeriesByLabel)));\n  }\n\n  // Return matrix or vector result as DataFrame[]\n  return dataFrame;\n}\n\nfunction getDataLinks(options: ExemplarTraceIdDestination): DataLink[] {\n  const dataLinks: DataLink[] = [];\n\n  if (options.datasourceUid) {\n    const dataSourceSrv = getDataSourceSrv();\n    const dsSettings = dataSourceSrv.getInstanceSettings(options.datasourceUid);\n\n    // dsSettings is undefined because of the reasons below:\n    // - permissions issues (probably most likely)\n    // - deleted datasource\n    // - misconfiguration\n    if (dsSettings) {\n      dataLinks.push({\n        title: options.urlDisplayLabel || `Query with ${dsSettings?.name}`,\n        url: '',\n        internal: {\n          query: { query: '${__value.raw}', queryType: 'traceql' },\n          datasourceUid: options.datasourceUid,\n          datasourceName: dsSettings?.name ?? 'Data source not found',\n        },\n      });\n    }\n  }\n\n  if (options.url) {\n    dataLinks.push({\n      title: options.urlDisplayLabel || `Go to ${options.url}`,\n      url: options.url,\n      targetBlank: true,\n    });\n  }\n  return dataLinks;\n}\n\n/**\n * Reduce the density of the exemplars by making sure that the highest value exemplar is included\n * and then only the ones that are 2 times the standard deviation of the all the values.\n * This makes sure not to show too many dots near each other.\n */\nfunction sampleExemplars(events: TimeAndValue[], options: TransformOptions) {\n  const step = options.step || 15;\n  const bucketedExemplars: { [ts: string]: TimeAndValue[] } = {};\n  const values: number[] = [];\n  for (const exemplar of events) {\n    // Align exemplar timestamp to nearest step second\n    const alignedTs = String(Math.floor(exemplar[TIME_SERIES_TIME_FIELD_NAME] / 1000 / step) * step * 1000);\n    if (!bucketedExemplars[alignedTs]) {\n      // New bucket found\n      bucketedExemplars[alignedTs] = [];\n    }\n    bucketedExemplars[alignedTs].push(exemplar);\n    values.push(exemplar[TIME_SERIES_VALUE_FIELD_NAME]);\n  }\n\n  // Getting exemplars from each bucket\n  const standardDeviation = deviation(values);\n  const sampledBuckets = Object.keys(bucketedExemplars).sort();\n  const sampledExemplars = [];\n  for (const ts of sampledBuckets) {\n    const exemplarsInBucket = bucketedExemplars[ts];\n    if (exemplarsInBucket.length === 1) {\n      sampledExemplars.push(exemplarsInBucket[0]);\n    } else {\n      // Choose which values to sample\n      const bucketValues = exemplarsInBucket.map((ex) => ex[TIME_SERIES_VALUE_FIELD_NAME]).sort(descending);\n      const sampledBucketValues = bucketValues.reduce((acc: number[], curr) => {\n        if (acc.length === 0) {\n          // First value is max and is always added\n          acc.push(curr);\n        } else {\n          // Then take values only when at least 2 standard deviation distance to previously taken value\n          const prev = acc[acc.length - 1];\n          if (standardDeviation && prev - curr >= 2 * standardDeviation) {\n            acc.push(curr);\n          }\n        }\n        return acc;\n      }, []);\n      // Find the exemplars for the sampled values\n      sampledExemplars.push(\n        ...sampledBucketValues.map(\n          (value) => exemplarsInBucket.find((ex) => ex[TIME_SERIES_VALUE_FIELD_NAME] === value)!\n        )\n      );\n    }\n  }\n  return sampledExemplars;\n}\n\n/**\n * Transforms matrix and vector result from Prometheus result to DataFrame\n */\nfunction transformToDataFrame(data: MatrixOrVectorResult, options: TransformOptions): DataFrame {\n  const { name, labels } = createLabelInfo(data.metric, options);\n\n  const fields: Field[] = [];\n\n  if (isMatrixData(data)) {\n    const stepMs = options.step ? options.step * 1000 : NaN;\n    let baseTimestamp = options.start * 1000;\n    const dps: PromValue[] = [];\n\n    for (const value of data.values) {\n      let dpValue: number | null = parseSampleValue(value[1]);\n\n      if (isNaN(dpValue)) {\n        dpValue = null;\n      }\n\n      const timestamp = value[0] * 1000;\n      for (let t = baseTimestamp; t < timestamp; t += stepMs) {\n        dps.push([t, null]);\n      }\n      baseTimestamp = timestamp + stepMs;\n      dps.push([timestamp, dpValue]);\n    }\n\n    const endTimestamp = options.end * 1000;\n    for (let t = baseTimestamp; t <= endTimestamp; t += stepMs) {\n      dps.push([t, null]);\n    }\n    fields.push(getTimeField(dps, true));\n    fields.push(getValueField({ data: dps, parseValue: false, labels, displayNameFromDS: name }));\n  } else {\n    fields.push(getTimeField([data.value]));\n    fields.push(getValueField({ data: [data.value], labels, displayNameFromDS: name }));\n  }\n\n  return {\n    meta: options.meta,\n    refId: options.refId,\n    length: fields[0].values.length,\n    fields,\n    name,\n  };\n}\n\nfunction transformMetricDataToTable(md: MatrixOrVectorResult[], options: TransformOptions): DataFrame {\n  if (!md || md.length === 0) {\n    return {\n      meta: options.meta,\n      refId: options.refId,\n      length: 0,\n      fields: [],\n    };\n  }\n\n  const valueText = options.responseListLength > 1 || options.valueWithRefId ? `Value #${options.refId}` : 'Value';\n\n  const timeField = getTimeField([]);\n  const metricFields = Object.keys(md.reduce((acc, series) => ({ ...acc, ...series.metric }), {}))\n    .sort()\n    .map((label) => {\n      // Labels have string field type, otherwise table tries to figure out the type which can result in unexpected results\n      // Only \"le\" label has a number field type\n      const numberField = label === HISTOGRAM_QUANTILE_LABEL_NAME;\n      return {\n        name: label,\n        config: { filterable: true },\n        type: numberField ? FieldType.number : FieldType.string,\n        values: new ArrayVector(),\n      };\n    });\n  const valueField = getValueField({ data: [], valueName: valueText });\n\n  md.forEach((d) => {\n    if (isMatrixData(d)) {\n      d.values.forEach((val) => {\n        timeField.values.add(val[0] * 1000);\n        metricFields.forEach((metricField) => metricField.values.add(getLabelValue(d.metric, metricField.name)));\n        valueField.values.add(parseSampleValue(val[1]));\n      });\n    } else {\n      timeField.values.add(d.value[0] * 1000);\n      metricFields.forEach((metricField) => metricField.values.add(getLabelValue(d.metric, metricField.name)));\n      valueField.values.add(parseSampleValue(d.value[1]));\n    }\n  });\n\n  return {\n    meta: options.meta,\n    refId: options.refId,\n    length: timeField.values.length,\n    fields: [timeField, ...metricFields, valueField],\n  };\n}\n\nfunction getLabelValue(metric: PromMetric, label: string): string | number {\n  if (metric.hasOwnProperty(label)) {\n    if (label === HISTOGRAM_QUANTILE_LABEL_NAME) {\n      return parseSampleValue(metric[label]);\n    }\n    return metric[label];\n  }\n  return '';\n}\n\nfunction getTimeField(data: PromValue[], isMs = false): MutableField {\n  return {\n    name: TIME_SERIES_TIME_FIELD_NAME,\n    type: FieldType.time,\n    config: {},\n    values: new ArrayVector<number>(data.map((val) => (isMs ? val[0] : val[0] * 1000))),\n  };\n}\n\ntype ValueFieldOptions = {\n  data: PromValue[];\n  valueName?: string;\n  parseValue?: boolean;\n  labels?: Labels;\n  displayNameFromDS?: string;\n};\n\nfunction getValueField({\n  data,\n  valueName = TIME_SERIES_VALUE_FIELD_NAME,\n  parseValue = true,\n  labels,\n  displayNameFromDS,\n}: ValueFieldOptions): MutableField {\n  return {\n    name: valueName,\n    type: FieldType.number,\n    display: getDisplayProcessor(),\n    config: {\n      displayNameFromDS,\n    },\n    labels,\n    values: new ArrayVector<number | null>(data.map((val) => (parseValue ? parseSampleValue(val[1]) : val[1]))),\n  };\n}\n\nfunction createLabelInfo(labels: { [key: string]: string }, options: TransformOptions) {\n  if (options?.legendFormat) {\n    const title = renderLegendFormat(getTemplateSrv().replace(options.legendFormat, options?.scopedVars), labels);\n    return { name: title, labels };\n  }\n\n  const { __name__, ...labelsWithoutName } = labels;\n  const labelPart = formatLabels(labelsWithoutName);\n  let title = `${__name__ ?? ''}${labelPart}`;\n\n  if (!title) {\n    title = options.query;\n  }\n\n  return { name: title, labels: labelsWithoutName };\n}\n\nexport function getOriginalMetricName(labelData: { [key: string]: string }) {\n  const metricName = labelData.__name__ || '';\n  delete labelData.__name__;\n  const labelPart = Object.entries(labelData)\n    .map((label) => `${label[0]}=\"${label[1]}\"`)\n    .join(',');\n  return `${metricName}{${labelPart}}`;\n}\n\nfunction mergeHeatmapFrames(frames: DataFrame[]): DataFrame[] {\n  if (frames.length === 0) {\n    return [];\n  }\n\n  const timeField = frames[0].fields.find((field) => field.type === FieldType.time)!;\n  const countFields = frames.map((frame) => {\n    let field = frame.fields.find((field) => field.type === FieldType.number)!;\n\n    return {\n      ...field,\n      name: field.config.displayNameFromDS!,\n    };\n  });\n\n  return [\n    {\n      ...frames[0],\n      meta: {\n        ...frames[0].meta,\n        type: DataFrameType.HeatmapRows,\n      },\n      fields: [timeField!, ...countFields],\n    },\n  ];\n}\n\nfunction transformToHistogramOverTime(seriesList: DataFrame[]) {\n  /*      t1 = timestamp1, t2 = timestamp2 etc.\n            t1  t2  t3          t1  t2  t3\n    le10    10  10  0     =>    10  10  0\n    le20    20  10  30    =>    10  0   30\n    le30    30  10  35    =>    10  0   5\n    */\n  for (let i = seriesList.length - 1; i > 0; i--) {\n    const topSeries = seriesList[i].fields.find((s) => s.name === TIME_SERIES_VALUE_FIELD_NAME);\n    const bottomSeries = seriesList[i - 1].fields.find((s) => s.name === TIME_SERIES_VALUE_FIELD_NAME);\n    if (!topSeries || !bottomSeries) {\n      throw new Error('Prometheus heatmap transform error: data should be a time series');\n    }\n\n    for (let j = 0; j < topSeries.values.length; j++) {\n      const bottomPoint = bottomSeries.values.get(j) || [0];\n      topSeries.values.toArray()[j] -= bottomPoint;\n    }\n  }\n\n  return seriesList;\n}\n\nfunction sortSeriesByLabel(s1: DataFrame, s2: DataFrame): number {\n  let le1, le2;\n\n  try {\n    // fail if not integer. might happen with bad queries\n    le1 = parseSampleValue(s1.name ?? '');\n    le2 = parseSampleValue(s2.name ?? '');\n  } catch (err) {\n    console.error(err);\n    return 0;\n  }\n\n  if (le1 > le2) {\n    return 1;\n  }\n\n  if (le1 < le2) {\n    return -1;\n  }\n\n  return 0;\n}\n\n/** @internal */\nexport function parseSampleValue(value: string): number {\n  if (INFINITY_SAMPLE_REGEX.test(value)) {\n    return value[0] === '-' ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY;\n  }\n  return parseFloat(value);\n}\n","import { CoreApp, DataQueryRequest, DataQueryResponse } from '@grafana/data';\nimport { reportInteraction, config } from '@grafana/runtime';\n\nimport { PromQuery } from './types';\n\nexport function trackQuery(\n  response: DataQueryResponse,\n  request: DataQueryRequest<PromQuery> & { targets: PromQuery[] },\n  startTime: Date\n): void {\n  const { app, targets: queries } = request;\n  // We do want to track panel-editor and explore\n  // We do not want to track queries from the dashboard or viewing a panel\n  // also included in the tracking is cloud-alerting, unified-alerting, and unknown\n  if (app === CoreApp.Dashboard || app === CoreApp.PanelViewer) {\n    return;\n  }\n\n  for (const query of queries) {\n    reportInteraction('grafana_prometheus_query_executed', {\n      app,\n      grafana_version: config.buildInfo.version,\n      has_data: response.data.some((frame) => frame.length > 0),\n      has_error: response.error !== undefined,\n      expr: query.expr,\n      format: query.format,\n      instant: query.instant,\n      range: query.range,\n      exemplar: query.exemplar,\n      hinting: query.hinting,\n      interval: query.interval,\n      intervalFactor: query.intervalFactor,\n      utcOffsetSec: query.utcOffsetSec,\n      legend: query.legendFormat,\n      valueWithRefId: query.valueWithRefId,\n      requestId: query.requestId,\n      showingGraph: query.showingGraph,\n      showingTable: query.showingTable,\n      editor_mode: query.editorMode,\n      simultaneously_sent_query_count: queries.length,\n      time_range_from: request?.range?.from?.toISOString(),\n      time_range_to: request?.range?.to?.toISOString(),\n      time_taken: Date.now() - startTime.getTime(),\n    });\n  }\n}\n","import { from, Observable, of } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport {\n  DataQueryRequest,\n  DataQueryResponse,\n  rangeUtil,\n  StandardVariableQuery,\n  StandardVariableSupport,\n} from '@grafana/data';\nimport { getTemplateSrv, TemplateSrv } from '@grafana/runtime';\n\nimport { getTimeSrv, TimeSrv } from '../../../features/dashboard/services/TimeSrv';\n\nimport { PrometheusDatasource } from './datasource';\nimport PrometheusMetricFindQuery from './metric_find_query';\nimport { PromQuery } from './types';\n\nexport class PrometheusVariableSupport extends StandardVariableSupport<PrometheusDatasource> {\n  constructor(\n    private readonly datasource: PrometheusDatasource,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    private readonly timeSrv: TimeSrv = getTimeSrv()\n  ) {\n    super();\n    this.query = this.query.bind(this);\n  }\n\n  query(request: DataQueryRequest<PromQuery>): Observable<DataQueryResponse> {\n    const query = request.targets[0].expr;\n    if (!query) {\n      return of({ data: [] });\n    }\n\n    const scopedVars = {\n      ...request.scopedVars,\n      __interval: { text: this.datasource.interval, value: this.datasource.interval },\n      __interval_ms: {\n        text: rangeUtil.intervalToMs(this.datasource.interval),\n        value: rangeUtil.intervalToMs(this.datasource.interval),\n      },\n      ...this.datasource.getRangeScopedVars(this.timeSrv.timeRange()),\n    };\n\n    const interpolated = this.templateSrv.replace(query, scopedVars, this.datasource.interpolateQueryExpr);\n    const metricFindQuery = new PrometheusMetricFindQuery(this.datasource, interpolated);\n    const metricFindStream = from(metricFindQuery.process());\n\n    return metricFindStream.pipe(map((results) => ({ data: results })));\n  }\n\n  toDataQuery(query: StandardVariableQuery): PromQuery {\n    return {\n      refId: 'PrometheusDatasource-VariableQuery',\n      expr: query.query,\n    };\n  }\n}\n","import { cloneDeep, defaults } from 'lodash';\nimport LRU from 'lru-cache';\nimport React from 'react';\nimport { forkJoin, lastValueFrom, merge, Observable, of, OperatorFunction, pipe, throwError } from 'rxjs';\nimport { catchError, filter, map, tap } from 'rxjs/operators';\nimport semver from 'semver/preload';\n\nimport {\n  AbstractQuery,\n  AnnotationEvent,\n  AnnotationQueryRequest,\n  CoreApp,\n  DataFrame,\n  DataQueryError,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceInstanceSettings,\n  DataSourceWithQueryExportSupport,\n  DataSourceWithQueryImportSupport,\n  dateMath,\n  DateTime,\n  dateTime,\n  LoadingState,\n  QueryFixAction,\n  rangeUtil,\n  ScopedVars,\n  TimeRange,\n} from '@grafana/data';\nimport {\n  BackendDataSourceResponse,\n  BackendSrvRequest,\n  DataSourceWithBackend,\n  FetchError,\n  FetchResponse,\n  getBackendSrv,\n  isFetchError,\n  toDataQueryResponse,\n} from '@grafana/runtime';\nimport { Badge, BadgeColor, Tooltip } from '@grafana/ui';\nimport { safeStringifyValue } from 'app/core/utils/explore';\nimport { discoverDataSourceFeatures } from 'app/features/alerting/unified/api/buildInfo';\nimport { getTimeSrv, TimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { getTemplateSrv, TemplateSrv } from 'app/features/templating/template_srv';\nimport { PromApiFeatures, PromApplication } from 'app/types/unified-alerting-dto';\n\nimport { addLabelToQuery } from './add_label_to_query';\nimport { AnnotationQueryEditor } from './components/AnnotationQueryEditor';\nimport PrometheusLanguageProvider from './language_provider';\nimport { expandRecordingRules } from './language_utils';\nimport { renderLegendFormat } from './legend';\nimport PrometheusMetricFindQuery from './metric_find_query';\nimport { getInitHints, getQueryHints } from './query_hints';\nimport { QueryEditorMode } from './querybuilder/shared/types';\nimport { getOriginalMetricName, transform, transformV2 } from './result_transformer';\nimport { trackQuery } from './tracking';\nimport {\n  ExemplarTraceIdDestination,\n  PromDataErrorResponse,\n  PromDataSuccessResponse,\n  PromExemplarData,\n  PromMatrixData,\n  PromOptions,\n  PromQuery,\n  PromQueryRequest,\n  PromScalarData,\n  PromVectorData,\n} from './types';\nimport { PrometheusVariableSupport } from './variables';\n\nconst ANNOTATION_QUERY_STEP_DEFAULT = '60s';\nconst GET_AND_POST_METADATA_ENDPOINTS = ['api/v1/query', 'api/v1/query_range', 'api/v1/series', 'api/v1/labels'];\n\nexport class PrometheusDatasource\n  extends DataSourceWithBackend<PromQuery, PromOptions>\n  implements DataSourceWithQueryImportSupport<PromQuery>, DataSourceWithQueryExportSupport<PromQuery>\n{\n  type: string;\n  editorSrc: string;\n  ruleMappings: { [index: string]: string };\n  url: string;\n  id: number;\n  directUrl: string;\n  access: 'direct' | 'proxy';\n  basicAuth: any;\n  withCredentials: any;\n  metricsNameCache = new LRU<string, string[]>({ max: 10 });\n  interval: string;\n  queryTimeout: string | undefined;\n  httpMethod: string;\n  languageProvider: PrometheusLanguageProvider;\n  exemplarTraceIdDestinations: ExemplarTraceIdDestination[] | undefined;\n  lookupsDisabled: boolean;\n  customQueryParameters: any;\n  datasourceConfigurationPrometheusFlavor?: PromApplication;\n  datasourceConfigurationPrometheusVersion?: string;\n  defaultEditor?: QueryEditorMode;\n  exemplarsAvailable: boolean;\n  subType: PromApplication;\n  rulerEnabled: boolean;\n\n  constructor(\n    instanceSettings: DataSourceInstanceSettings<PromOptions>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    private readonly timeSrv: TimeSrv = getTimeSrv(),\n    languageProvider?: PrometheusLanguageProvider\n  ) {\n    super(instanceSettings);\n\n    this.type = 'prometheus';\n    this.subType = PromApplication.Prometheus;\n    this.rulerEnabled = false;\n    this.editorSrc = 'app/features/prometheus/partials/query.editor.html';\n    this.id = instanceSettings.id;\n    this.url = instanceSettings.url!;\n    this.access = instanceSettings.access;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.interval = instanceSettings.jsonData.timeInterval || '15s';\n    this.queryTimeout = instanceSettings.jsonData.queryTimeout;\n    this.httpMethod = instanceSettings.jsonData.httpMethod || 'GET';\n    // `directUrl` is never undefined, we set it at https://github.com/grafana/grafana/blob/main/pkg/api/frontendsettings.go#L108\n    // here we \"fall back\" to this.url to make typescript happy, but it should never happen\n    this.directUrl = instanceSettings.jsonData.directUrl ?? this.url;\n    this.exemplarTraceIdDestinations = instanceSettings.jsonData.exemplarTraceIdDestinations;\n    this.ruleMappings = {};\n    this.languageProvider = languageProvider ?? new PrometheusLanguageProvider(this);\n    this.lookupsDisabled = instanceSettings.jsonData.disableMetricsLookup ?? false;\n    this.customQueryParameters = new URLSearchParams(instanceSettings.jsonData.customQueryParameters);\n    this.datasourceConfigurationPrometheusFlavor = instanceSettings.jsonData.prometheusType;\n    this.datasourceConfigurationPrometheusVersion = instanceSettings.jsonData.prometheusVersion;\n    this.defaultEditor = instanceSettings.jsonData.defaultEditor;\n    this.variables = new PrometheusVariableSupport(this, this.templateSrv, this.timeSrv);\n    this.exemplarsAvailable = true;\n\n    // This needs to be here and cannot be static because of how annotations typing affects casting of data source\n    // objects to DataSourceApi types.\n    // We don't use the default processing for prometheus.\n    // See standardAnnotationSupport.ts/[shouldUseMappingUI|shouldUseLegacyRunner]\n    this.annotations = {\n      QueryEditor: AnnotationQueryEditor,\n    };\n  }\n\n  init = async () => {\n    this.loadRules();\n    this.exemplarsAvailable = await this.areExemplarsAvailable();\n  };\n\n  getQueryDisplayText(query: PromQuery) {\n    return query.expr;\n  }\n\n  hasLabelsMatchAPISupport(): boolean {\n    return (\n      // https://github.com/prometheus/prometheus/releases/tag/v2.24.0\n      this._isDatasourceVersionGreaterOrEqualTo('2.24.0', PromApplication.Prometheus) ||\n      // All versions of Mimir support matchers for labels API\n      this._isDatasourceVersionGreaterOrEqualTo('2.0.0', PromApplication.Mimir) ||\n      // https://github.com/cortexproject/cortex/discussions/4542\n      this._isDatasourceVersionGreaterOrEqualTo('1.11.0', PromApplication.Cortex) ||\n      // https://github.com/thanos-io/thanos/pull/3566\n      //https://github.com/thanos-io/thanos/releases/tag/v0.18.0\n      this._isDatasourceVersionGreaterOrEqualTo('0.18.0', PromApplication.Thanos)\n    );\n  }\n\n  _isDatasourceVersionGreaterOrEqualTo(targetVersion: string, targetFlavor: PromApplication): boolean {\n    // User hasn't configured flavor/version yet, default behavior is to not support features that require version configuration when not provided\n    if (!this.datasourceConfigurationPrometheusVersion || !this.datasourceConfigurationPrometheusFlavor) {\n      return false;\n    }\n\n    if (targetFlavor !== this.datasourceConfigurationPrometheusFlavor) {\n      return false;\n    }\n\n    return semver.gte(this.datasourceConfigurationPrometheusVersion, targetVersion);\n  }\n\n  _addTracingHeaders(httpOptions: PromQueryRequest, options: DataQueryRequest<PromQuery>) {\n    httpOptions.headers = {};\n    if (this.access === 'proxy') {\n      httpOptions.headers['X-Dashboard-Id'] = options.dashboardId;\n      httpOptions.headers['X-Dashboard-UID'] = options.dashboardUID;\n      httpOptions.headers['X-Panel-Id'] = options.panelId;\n    }\n  }\n\n  /**\n   * Any request done from this data source should go through here as it contains some common processing for the\n   * request. Any processing done here needs to be also copied on the backend as this goes through data source proxy\n   * but not through the same code as alerting.\n   */\n  _request<T = any>(\n    url: string,\n    data: Record<string, string> | null,\n    overrides: Partial<BackendSrvRequest> = {}\n  ): Observable<FetchResponse<T>> {\n    if (this.access === 'direct') {\n      const error = new Error(\n        'Browser access mode in the Prometheus datasource is no longer available. Switch to server access mode.'\n      );\n      return throwError(() => error);\n    }\n\n    data = data || {};\n    for (const [key, value] of this.customQueryParameters) {\n      if (data[key] == null) {\n        data[key] = value;\n      }\n    }\n\n    let queryUrl = this.url + url;\n    if (url.startsWith(`/api/datasources/${this.id}`)) {\n      // This url is meant to be a replacement for the whole URL. Replace the entire URL\n      queryUrl = url;\n    }\n\n    const options: BackendSrvRequest = defaults(overrides, {\n      url: queryUrl,\n      method: this.httpMethod,\n      headers: {},\n    });\n\n    if (options.method === 'GET') {\n      if (data && Object.keys(data).length) {\n        options.url =\n          options.url +\n          (options.url.search(/\\?/) >= 0 ? '&' : '?') +\n          Object.entries(data)\n            .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n            .join('&');\n      }\n    } else {\n      options.headers!['Content-Type'] = 'application/x-www-form-urlencoded';\n      options.data = data;\n    }\n\n    if (this.basicAuth || this.withCredentials) {\n      options.withCredentials = true;\n    }\n\n    if (this.basicAuth) {\n      options.headers!.Authorization = this.basicAuth;\n    }\n\n    return getBackendSrv().fetch<T>(options);\n  }\n\n  async importFromAbstractQueries(abstractQueries: AbstractQuery[]): Promise<PromQuery[]> {\n    return abstractQueries.map((abstractQuery) => this.languageProvider.importFromAbstractQuery(abstractQuery));\n  }\n\n  async exportToAbstractQueries(queries: PromQuery[]): Promise<AbstractQuery[]> {\n    return queries.map((query) => this.languageProvider.exportToAbstractQuery(query));\n  }\n\n  // Use this for tab completion features, wont publish response to other components\n  async metadataRequest<T = any>(url: string, params = {}, options?: Partial<BackendSrvRequest>) {\n    // If URL includes endpoint that supports POST and GET method, try to use configured method. This might fail as POST is supported only in v2.10+.\n    if (GET_AND_POST_METADATA_ENDPOINTS.some((endpoint) => url.includes(endpoint))) {\n      try {\n        return await lastValueFrom(\n          this._request<T>(`/api/datasources/${this.id}/resources${url}`, params, {\n            method: this.httpMethod,\n            hideFromInspector: true,\n            showErrorAlert: false,\n            ...options,\n          })\n        );\n      } catch (err) {\n        // If status code of error is Method Not Allowed (405) and HTTP method is POST, retry with GET\n        if (this.httpMethod === 'POST' && isFetchError(err) && (err.status === 405 || err.status === 400)) {\n          console.warn(`Couldn't use configured POST HTTP method for this request. Trying to use GET method instead.`);\n        } else {\n          throw err;\n        }\n      }\n    }\n\n    return await lastValueFrom(\n      this._request<T>(`/api/datasources/${this.id}/resources${url}`, params, {\n        method: 'GET',\n        hideFromInspector: true,\n        ...options,\n      })\n    ); // toPromise until we change getTagValues, getTagKeys to Observable\n  }\n\n  interpolateQueryExpr(value: string | string[] = [], variable: any) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return prometheusRegularEscape(value);\n    }\n\n    if (typeof value === 'string') {\n      return prometheusSpecialRegexEscape(value);\n    }\n\n    const escapedValues = value.map((val) => prometheusSpecialRegexEscape(val));\n\n    if (escapedValues.length === 1) {\n      return escapedValues[0];\n    }\n\n    return '(' + escapedValues.join('|') + ')';\n  }\n\n  targetContainsTemplate(target: PromQuery) {\n    return this.templateSrv.containsTemplate(target.expr);\n  }\n\n  prepareTargets = (options: DataQueryRequest<PromQuery>, start: number, end: number) => {\n    const queries: PromQueryRequest[] = [];\n    const activeTargets: PromQuery[] = [];\n    const clonedTargets = cloneDeep(options.targets);\n\n    for (const target of clonedTargets) {\n      if (!target.expr || target.hide) {\n        continue;\n      }\n\n      target.requestId = options.panelId + target.refId;\n      const metricName = this.languageProvider.histogramMetrics.find((m) => target.expr.includes(m));\n\n      // In Explore, we run both (instant and range) queries if both are true (selected) or both are undefined (legacy Explore queries)\n      if (options.app === CoreApp.Explore && target.range === target.instant) {\n        // Create instant target\n        const instantTarget: any = cloneDeep(target);\n        instantTarget.format = 'table';\n        instantTarget.instant = true;\n        instantTarget.range = false;\n        instantTarget.valueWithRefId = true;\n        delete instantTarget.maxDataPoints;\n        instantTarget.requestId += '_instant';\n\n        // Create range target\n        const rangeTarget: any = cloneDeep(target);\n        rangeTarget.format = 'time_series';\n        rangeTarget.instant = false;\n        instantTarget.range = true;\n\n        // Create exemplar query\n        if (target.exemplar) {\n          // Only create exemplar target for different metric names\n          if (\n            !metricName ||\n            (metricName && !activeTargets.some((activeTarget) => activeTarget.expr.includes(metricName)))\n          ) {\n            const exemplarTarget = cloneDeep(target);\n            exemplarTarget.instant = false;\n            exemplarTarget.requestId += '_exemplar';\n            queries.push(this.createQuery(exemplarTarget, options, start, end));\n            activeTargets.push(exemplarTarget);\n          }\n          instantTarget.exemplar = false;\n          rangeTarget.exemplar = false;\n        }\n\n        // Add both targets to activeTargets and queries arrays\n        activeTargets.push(instantTarget, rangeTarget);\n        queries.push(\n          this.createQuery(instantTarget, options, start, end),\n          this.createQuery(rangeTarget, options, start, end)\n        );\n        // If running only instant query in Explore, format as table\n      } else if (target.instant && options.app === CoreApp.Explore) {\n        const instantTarget: any = cloneDeep(target);\n        instantTarget.format = 'table';\n        queries.push(this.createQuery(instantTarget, options, start, end));\n        activeTargets.push(instantTarget);\n      } else {\n        // It doesn't make sense to query for exemplars in dashboard if only instant is selected\n        if (target.exemplar && !target.instant) {\n          if (\n            !metricName ||\n            (metricName && !activeTargets.some((activeTarget) => activeTarget.expr.includes(metricName)))\n          ) {\n            const exemplarTarget = cloneDeep(target);\n            exemplarTarget.requestId += '_exemplar';\n            queries.push(this.createQuery(exemplarTarget, options, start, end));\n            activeTargets.push(exemplarTarget);\n          }\n          target.exemplar = false;\n        }\n        queries.push(this.createQuery(target, options, start, end));\n        activeTargets.push(target);\n      }\n    }\n\n    return {\n      queries,\n      activeTargets,\n    };\n  };\n\n  shouldRunExemplarQuery(target: PromQuery, request: DataQueryRequest<PromQuery>): boolean {\n    if (target.exemplar) {\n      // We check all already processed targets and only create exemplar target for not used metric names\n      const metricName = this.languageProvider.histogramMetrics.find((m) => target.expr.includes(m));\n      // Remove targets that weren't processed yet (in targets array they are after current target)\n      const currentTargetIdx = request.targets.findIndex((t) => t.refId === target.refId);\n      const targets = request.targets.slice(0, currentTargetIdx).filter((t) => !t.hide);\n\n      if (!metricName || (metricName && !targets.some((t) => t.expr.includes(metricName)))) {\n        return true;\n      }\n      return false;\n    }\n    return false;\n  }\n\n  processTargetV2(target: PromQuery, request: DataQueryRequest<PromQuery>) {\n    const processedTargets: PromQuery[] = [];\n    const processedTarget = {\n      ...target,\n      exemplar: this.shouldRunExemplarQuery(target, request),\n      requestId: request.panelId + target.refId,\n      // We need to pass utcOffsetSec to backend to calculate aligned range\n      utcOffsetSec: this.timeSrv.timeRange().to.utcOffset() * 60,\n    };\n    if (target.instant && target.range) {\n      // We have query type \"Both\" selected\n      // We should send separate queries with different refId\n      processedTargets.push(\n        {\n          ...processedTarget,\n          refId: processedTarget.refId,\n          instant: false,\n        },\n        {\n          ...processedTarget,\n          refId: processedTarget.refId + '-Instant',\n          range: false,\n        }\n      );\n    } else {\n      processedTargets.push(processedTarget);\n    }\n\n    return processedTargets;\n  }\n\n  query(request: DataQueryRequest<PromQuery>): Observable<DataQueryResponse> {\n    if (this.access === 'proxy') {\n      const targets = request.targets.map((target) => this.processTargetV2(target, request));\n      const startTime = new Date();\n      return super.query({ ...request, targets: targets.flat() }).pipe(\n        map((response) =>\n          transformV2(response, request, { exemplarTraceIdDestinations: this.exemplarTraceIdDestinations })\n        ),\n        tap((response: DataQueryResponse) => {\n          trackQuery(response, request, startTime);\n        })\n      );\n      // Run queries trough browser/proxy\n    } else {\n      const start = this.getPrometheusTime(request.range.from, false);\n      const end = this.getPrometheusTime(request.range.to, true);\n      const { queries, activeTargets } = this.prepareTargets(request, start, end);\n\n      // No valid targets, return the empty result to save a round trip.\n      if (!queries || !queries.length) {\n        return of({\n          data: [],\n          state: LoadingState.Done,\n        });\n      }\n\n      if (request.app === CoreApp.Explore) {\n        return this.exploreQuery(queries, activeTargets, end);\n      }\n\n      return this.panelsQuery(queries, activeTargets, end, request.requestId, request.scopedVars);\n    }\n  }\n\n  private exploreQuery(queries: PromQueryRequest[], activeTargets: PromQuery[], end: number) {\n    let runningQueriesCount = queries.length;\n\n    const subQueries = queries.map((query, index) => {\n      const target = activeTargets[index];\n\n      const filterAndMapResponse = pipe(\n        // Decrease the counter here. We assume that each request returns only single value and then completes\n        // (should hold until there is some streaming requests involved).\n        tap(() => runningQueriesCount--),\n        filter((response: any) => (response.cancelled ? false : true)),\n        map((response: any) => {\n          const data = transform(response, {\n            query,\n            target,\n            responseListLength: queries.length,\n            exemplarTraceIdDestinations: this.exemplarTraceIdDestinations,\n          });\n          return {\n            data,\n            key: query.requestId,\n            state: runningQueriesCount === 0 ? LoadingState.Done : LoadingState.Loading,\n          } as DataQueryResponse;\n        })\n      );\n\n      return this.runQuery(query, end, filterAndMapResponse);\n    });\n\n    return merge(...subQueries);\n  }\n\n  private panelsQuery(\n    queries: PromQueryRequest[],\n    activeTargets: PromQuery[],\n    end: number,\n    requestId: string,\n    scopedVars: ScopedVars\n  ) {\n    const observables = queries.map((query, index) => {\n      const target = activeTargets[index];\n\n      const filterAndMapResponse = pipe(\n        filter((response: any) => (response.cancelled ? false : true)),\n        map((response: any) => {\n          const data = transform(response, {\n            query,\n            target,\n            responseListLength: queries.length,\n            scopedVars,\n            exemplarTraceIdDestinations: this.exemplarTraceIdDestinations,\n          });\n          return data;\n        })\n      );\n\n      return this.runQuery(query, end, filterAndMapResponse);\n    });\n\n    return forkJoin(observables).pipe(\n      map((results) => {\n        const data = results.reduce((result, current) => {\n          return [...result, ...current];\n        }, []);\n        return {\n          data,\n          key: requestId,\n          state: LoadingState.Done,\n        };\n      })\n    );\n  }\n\n  private runQuery<T>(query: PromQueryRequest, end: number, filter: OperatorFunction<any, T>): Observable<T> {\n    if (query.instant) {\n      return this.performInstantQuery(query, end).pipe(filter);\n    }\n\n    if (query.exemplar) {\n      return this.getExemplars(query).pipe(\n        catchError(() => {\n          return of({\n            data: [],\n            state: LoadingState.Done,\n          });\n        }),\n        filter\n      );\n    }\n\n    return this.performTimeSeriesQuery(query, query.start, query.end).pipe(filter);\n  }\n\n  createQuery(target: PromQuery, options: DataQueryRequest<PromQuery>, start: number, end: number) {\n    const query: PromQueryRequest = {\n      hinting: target.hinting,\n      instant: target.instant,\n      exemplar: target.exemplar,\n      step: 0,\n      expr: '',\n      requestId: target.requestId,\n      refId: target.refId,\n      start: 0,\n      end: 0,\n    };\n    const range = Math.ceil(end - start);\n\n    // options.interval is the dynamically calculated interval\n    let interval: number = rangeUtil.intervalToSeconds(options.interval);\n    // Minimum interval (\"Min step\"), if specified for the query, or same as interval otherwise.\n    const minInterval = rangeUtil.intervalToSeconds(\n      this.templateSrv.replace(target.interval || options.interval, options.scopedVars)\n    );\n    // Scrape interval as specified for the query (\"Min step\") or otherwise taken from the datasource.\n    // Min step field can have template variables in it, make sure to replace it.\n    const scrapeInterval = target.interval\n      ? rangeUtil.intervalToSeconds(this.templateSrv.replace(target.interval, options.scopedVars))\n      : rangeUtil.intervalToSeconds(this.interval);\n\n    const intervalFactor = target.intervalFactor || 1;\n    // Adjust the interval to take into account any specified minimum and interval factor plus Prometheus limits\n    const adjustedInterval = this.adjustInterval(interval, minInterval, range, intervalFactor);\n    let scopedVars = {\n      ...options.scopedVars,\n      ...this.getRangeScopedVars(options.range),\n      ...this.getRateIntervalScopedVariable(adjustedInterval, scrapeInterval),\n    };\n    // If the interval was adjusted, make a shallow copy of scopedVars with updated interval vars\n    if (interval !== adjustedInterval) {\n      interval = adjustedInterval;\n      scopedVars = Object.assign({}, options.scopedVars, {\n        __interval: { text: interval + 's', value: interval + 's' },\n        __interval_ms: { text: interval * 1000, value: interval * 1000 },\n        ...this.getRateIntervalScopedVariable(interval, scrapeInterval),\n        ...this.getRangeScopedVars(options.range),\n      });\n    }\n\n    query.step = interval;\n\n    let expr = target.expr;\n\n    // Apply adhoc filters\n    expr = this.enhanceExprWithAdHocFilters(expr);\n\n    // Only replace vars in expression after having (possibly) updated interval vars\n    query.expr = this.templateSrv.replace(expr, scopedVars, this.interpolateQueryExpr);\n\n    // Align query interval with step to allow query caching and to ensure\n    // that about-same-time query results look the same.\n    const adjusted = alignRange(start, end, query.step, this.timeSrv.timeRange().to.utcOffset() * 60);\n    query.start = adjusted.start;\n    query.end = adjusted.end;\n    this._addTracingHeaders(query, options);\n\n    return query;\n  }\n\n  getRateIntervalScopedVariable(interval: number, scrapeInterval: number) {\n    // Fall back to the default scrape interval of 15s if scrapeInterval is 0 for some reason.\n    if (scrapeInterval === 0) {\n      scrapeInterval = 15;\n    }\n    const rateInterval = Math.max(interval + scrapeInterval, 4 * scrapeInterval);\n    return { __rate_interval: { text: rateInterval + 's', value: rateInterval + 's' } };\n  }\n\n  adjustInterval(interval: number, minInterval: number, range: number, intervalFactor: number) {\n    // Prometheus will drop queries that might return more than 11000 data points.\n    // Calculate a safe interval as an additional minimum to take into account.\n    // Fractional safeIntervals are allowed, however serve little purpose if the interval is greater than 1\n    // If this is the case take the ceil of the value.\n    let safeInterval = range / 11000;\n    if (safeInterval > 1) {\n      safeInterval = Math.ceil(safeInterval);\n    }\n    return Math.max(interval * intervalFactor, minInterval, safeInterval);\n  }\n\n  performTimeSeriesQuery(query: PromQueryRequest, start: number, end: number) {\n    if (start > end) {\n      throw { message: 'Invalid time range' };\n    }\n\n    const url = '/api/v1/query_range';\n    const data: any = {\n      query: query.expr,\n      start,\n      end,\n      step: query.step,\n    };\n\n    if (this.queryTimeout) {\n      data['timeout'] = this.queryTimeout;\n    }\n\n    return this._request<PromDataSuccessResponse<PromMatrixData>>(url, data, {\n      requestId: query.requestId,\n      headers: query.headers,\n    }).pipe(\n      catchError((err: FetchError<PromDataErrorResponse<PromMatrixData>>) => {\n        if (err.cancelled) {\n          return of(err);\n        }\n\n        return throwError(this.handleErrors(err, query));\n      })\n    );\n  }\n\n  performInstantQuery(\n    query: PromQueryRequest,\n    time: number\n  ): Observable<FetchResponse<PromDataSuccessResponse<PromVectorData | PromScalarData>> | FetchError> {\n    const url = '/api/v1/query';\n    const data: any = {\n      query: query.expr,\n      time,\n    };\n\n    if (this.queryTimeout) {\n      data['timeout'] = this.queryTimeout;\n    }\n\n    return this._request<PromDataSuccessResponse<PromVectorData | PromScalarData>>(\n      `/api/datasources/${this.id}/resources${url}`,\n      data,\n      {\n        requestId: query.requestId,\n        headers: query.headers,\n      }\n    ).pipe(\n      catchError((err: FetchError<PromDataErrorResponse<PromVectorData | PromScalarData>>) => {\n        if (err.cancelled) {\n          return of(err);\n        }\n\n        return throwError(this.handleErrors(err, query));\n      })\n    );\n  }\n\n  handleErrors = (err: any, target: PromQuery) => {\n    const error: DataQueryError = {\n      message: (err && err.statusText) || 'Unknown error during query transaction. Please check JS console logs.',\n      refId: target.refId,\n    };\n\n    if (err.data) {\n      if (typeof err.data === 'string') {\n        error.message = err.data;\n      } else if (err.data.error) {\n        error.message = safeStringifyValue(err.data.error);\n      }\n    } else if (err.message) {\n      error.message = err.message;\n    } else if (typeof err === 'string') {\n      error.message = err;\n    }\n\n    error.status = err.status;\n    error.statusText = err.statusText;\n\n    return error;\n  };\n\n  metricFindQuery(query: string) {\n    if (!query) {\n      return Promise.resolve([]);\n    }\n\n    const scopedVars = {\n      __interval: { text: this.interval, value: this.interval },\n      __interval_ms: { text: rangeUtil.intervalToMs(this.interval), value: rangeUtil.intervalToMs(this.interval) },\n      ...this.getRangeScopedVars(this.timeSrv.timeRange()),\n    };\n    const interpolated = this.templateSrv.replace(query, scopedVars, this.interpolateQueryExpr);\n    const metricFindQuery = new PrometheusMetricFindQuery(this, interpolated);\n    return metricFindQuery.process();\n  }\n\n  getRangeScopedVars(range: TimeRange = this.timeSrv.timeRange()) {\n    const msRange = range.to.diff(range.from);\n    const sRange = Math.round(msRange / 1000);\n    return {\n      __range_ms: { text: msRange, value: msRange },\n      __range_s: { text: sRange, value: sRange },\n      __range: { text: sRange + 's', value: sRange + 's' },\n    };\n  }\n\n  async annotationQuery(options: AnnotationQueryRequest<PromQuery>): Promise<AnnotationEvent[]> {\n    if (this.access === 'direct') {\n      const error = new Error(\n        'Browser access mode in the Prometheus datasource is no longer available. Switch to server access mode.'\n      );\n      return Promise.reject(error);\n    }\n\n    const annotation = options.annotation;\n    const { expr = '' } = annotation;\n\n    if (!expr) {\n      return Promise.resolve([]);\n    }\n\n    const step = options.annotation.step || ANNOTATION_QUERY_STEP_DEFAULT;\n    const queryModel = {\n      expr,\n      range: true,\n      instant: false,\n      exemplar: false,\n      interval: step,\n      refId: 'X',\n      datasource: this.getRef(),\n    };\n\n    return await lastValueFrom(\n      getBackendSrv()\n        .fetch<BackendDataSourceResponse>({\n          url: '/api/ds/query',\n          method: 'POST',\n          headers: this.getRequestHeaders(),\n          data: {\n            from: (this.getPrometheusTime(options.range.from, false) * 1000).toString(),\n            to: (this.getPrometheusTime(options.range.to, true) * 1000).toString(),\n            queries: [this.applyTemplateVariables(queryModel, {})],\n          },\n          requestId: `prom-query-${annotation.name}`,\n        })\n        .pipe(\n          map((rsp: FetchResponse<BackendDataSourceResponse>) => {\n            return this.processAnnotationResponse(options, rsp.data);\n          })\n        )\n    );\n  }\n\n  processAnnotationResponse = (options: AnnotationQueryRequest<PromQuery>, data: BackendDataSourceResponse) => {\n    const frames: DataFrame[] = toDataQueryResponse({ data: data }).data;\n    if (!frames || !frames.length) {\n      return [];\n    }\n\n    const annotation = options.annotation;\n    const { tagKeys = '', titleFormat = '', textFormat = '' } = annotation;\n\n    const step = rangeUtil.intervalToSeconds(annotation.step || ANNOTATION_QUERY_STEP_DEFAULT) * 1000;\n    const tagKeysArray = tagKeys.split(',');\n\n    const eventList: AnnotationEvent[] = [];\n\n    for (const frame of frames) {\n      const timeField = frame.fields[0];\n      const valueField = frame.fields[1];\n      const labels = valueField?.labels || {};\n\n      const tags = Object.keys(labels)\n        .filter((label) => tagKeysArray.includes(label))\n        .map((label) => labels[label]);\n\n      const timeValueTuple: Array<[number, number]> = [];\n\n      let idx = 0;\n      valueField.values.toArray().forEach((value: string) => {\n        let timeStampValue: number;\n        let valueValue: number;\n        const time = timeField.values.get(idx);\n\n        // If we want to use value as a time, we use value as timeStampValue and valueValue will be 1\n        if (options.annotation.useValueForTime) {\n          timeStampValue = Math.floor(parseFloat(value));\n          valueValue = 1;\n        } else {\n          timeStampValue = Math.floor(parseFloat(time));\n          valueValue = parseFloat(value);\n        }\n\n        idx++;\n        timeValueTuple.push([timeStampValue, valueValue]);\n      });\n\n      const activeValues = timeValueTuple.filter((value) => value[1] > 0);\n      const activeValuesTimestamps = activeValues.map((value) => value[0]);\n\n      // Instead of creating singular annotation for each active event we group events into region if they are less\n      // or equal to `step` apart.\n      let latestEvent: AnnotationEvent | null = null;\n\n      for (const timestamp of activeValuesTimestamps) {\n        // We already have event `open` and we have new event that is inside the `step` so we just update the end.\n        if (latestEvent && (latestEvent.timeEnd ?? 0) + step >= timestamp) {\n          latestEvent.timeEnd = timestamp;\n          continue;\n        }\n\n        // Event exists but new one is outside of the `step` so we add it to eventList.\n        if (latestEvent) {\n          eventList.push(latestEvent);\n        }\n\n        // We start a new region.\n        latestEvent = {\n          time: timestamp,\n          timeEnd: timestamp,\n          annotation,\n          title: renderLegendFormat(titleFormat, labels),\n          tags,\n          text: renderLegendFormat(textFormat, labels),\n        };\n      }\n\n      if (latestEvent) {\n        // Finish up last point if we have one\n        latestEvent.timeEnd = activeValuesTimestamps[activeValuesTimestamps.length - 1];\n        eventList.push(latestEvent);\n      }\n    }\n\n    return eventList;\n  };\n\n  getExemplars(query: PromQueryRequest) {\n    const url = '/api/v1/query_exemplars';\n    return this._request<PromDataSuccessResponse<PromExemplarData>>(\n      url,\n      { query: query.expr, start: query.start.toString(), end: query.end.toString() },\n      { requestId: query.requestId, headers: query.headers }\n    );\n  }\n\n  async getTagKeys(options?: any) {\n    if (options?.series) {\n      // Get tags for the provided series only\n      const seriesLabels: Array<Record<string, string[]>> = await Promise.all(\n        options.series.map((series: string) => this.languageProvider.fetchSeriesLabels(series))\n      );\n      // Combines tags from all options.series provided\n      let tags: string[] = [];\n      seriesLabels.map((value) => (tags = tags.concat(Object.keys(value))));\n      const uniqueLabels = [...new Set(tags)];\n      return uniqueLabels.map((value: any) => ({ text: value }));\n    } else {\n      // Get all tags\n      const params = this.getTimeRangeParams();\n      const result = await this.metadataRequest('/api/v1/labels', params);\n      return result?.data?.data?.map((value: any) => ({ text: value })) ?? [];\n    }\n  }\n\n  async getTagValues(options: { key?: string } = {}) {\n    const params = this.getTimeRangeParams();\n    const result = await this.metadataRequest(`/api/v1/label/${options.key}/values`, params);\n    return result?.data?.data?.map((value: any) => ({ text: value })) ?? [];\n  }\n\n  async getBuildInfo() {\n    try {\n      const buildInfo = await discoverDataSourceFeatures({ url: this.url, name: this.name, type: 'prometheus' });\n      return buildInfo;\n    } catch (error) {\n      // We don't want to break the rest of functionality if build info does not work correctly\n      return undefined;\n    }\n  }\n\n  getBuildInfoMessage(buildInfo: PromApiFeatures) {\n    const enabled = <Badge color=\"green\" icon=\"check\" text=\"Ruler API enabled\" />;\n    const disabled = <Badge color=\"orange\" icon=\"exclamation-triangle\" text=\"Ruler API not enabled\" />;\n    const unsupported = (\n      <Tooltip\n        placement=\"top\"\n        content=\"Prometheus does not allow editing rules, connect to either a Mimir or Cortex datasource to manage alerts via Grafana.\"\n      >\n        <div>\n          <Badge color=\"red\" icon=\"exclamation-triangle\" text=\"Ruler API not supported\" />\n        </div>\n      </Tooltip>\n    );\n\n    const LOGOS = {\n      [PromApplication.Cortex]: '/public/app/plugins/datasource/prometheus/img/cortex_logo.svg',\n      [PromApplication.Mimir]: '/public/app/plugins/datasource/prometheus/img/mimir_logo.svg',\n      [PromApplication.Prometheus]: '/public/app/plugins/datasource/prometheus/img/prometheus_logo.svg',\n      [PromApplication.Thanos]: '/public/app/plugins/datasource/prometheus/img/thanos_logo.svg',\n    };\n\n    const COLORS: Record<PromApplication, BadgeColor> = {\n      [PromApplication.Cortex]: 'blue',\n      [PromApplication.Mimir]: 'orange',\n      [PromApplication.Prometheus]: 'red',\n      [PromApplication.Thanos]: 'purple', // Purple hex taken from thanos.io\n    };\n\n    const AppDisplayNames: Record<PromApplication, string> = {\n      [PromApplication.Cortex]: 'Cortex',\n      [PromApplication.Mimir]: 'Mimir',\n      [PromApplication.Prometheus]: 'Prometheus',\n      [PromApplication.Thanos]: 'Thanos',\n    };\n\n    const application = this.datasourceConfigurationPrometheusFlavor ?? buildInfo.application;\n\n    // this will inform the user about what \"subtype\" the datasource is; Mimir, Cortex or vanilla Prometheus\n    const applicationSubType = (\n      <Badge\n        text={\n          <span>\n            <img\n              style={{ width: 14, height: 14, verticalAlign: 'text-bottom' }}\n              src={LOGOS[application ?? PromApplication.Prometheus]}\n              alt=\"\"\n            />{' '}\n            {application ? AppDisplayNames[application] : 'Unknown'}\n          </span>\n        }\n        color={COLORS[application ?? PromApplication.Prometheus]}\n      />\n    );\n\n    return (\n      <div\n        style={{\n          display: 'grid',\n          gridTemplateColumns: 'max-content max-content',\n          rowGap: '0.5rem',\n          columnGap: '2rem',\n          marginTop: '1rem',\n        }}\n      >\n        <div>Type</div>\n        <div>{applicationSubType}</div>\n        <>\n          <div>Ruler API</div>\n          {/* Prometheus does not have a Ruler API  so show that it is not supported */}\n          {buildInfo.application === PromApplication.Prometheus && <div>{unsupported}</div>}\n          {buildInfo.application !== PromApplication.Prometheus && (\n            <div>{buildInfo.features.rulerApiEnabled ? enabled : disabled}</div>\n          )}\n        </>\n      </div>\n    );\n  }\n\n  async testDatasource() {\n    const now = new Date().getTime();\n    const request: DataQueryRequest<PromQuery> = {\n      targets: [{ refId: 'test', expr: '1+1', instant: true }],\n      requestId: `${this.id}-health`,\n      scopedVars: {},\n      dashboardId: 0,\n      panelId: 0,\n      interval: '1m',\n      intervalMs: 60000,\n      maxDataPoints: 1,\n      range: {\n        from: dateTime(now - 1000),\n        to: dateTime(now),\n      },\n    } as DataQueryRequest<PromQuery>;\n\n    const buildInfo = await this.getBuildInfo();\n\n    return lastValueFrom(this.query(request))\n      .then((res: DataQueryResponse) => {\n        if (!res || !res.data || res.state !== LoadingState.Done) {\n          return { status: 'error', message: `Error reading Prometheus: ${res?.error?.message}` };\n        } else {\n          return {\n            status: 'success',\n            message: 'Data source is working',\n            details: buildInfo && {\n              verboseMessage: this.getBuildInfoMessage(buildInfo),\n            },\n          };\n        }\n      })\n      .catch((err: any) => {\n        console.error('Prometheus Error', err);\n        return { status: 'error', message: err.message };\n      });\n  }\n\n  interpolateVariablesInQueries(queries: PromQuery[], scopedVars: ScopedVars): PromQuery[] {\n    let expandedQueries = queries;\n    if (queries && queries.length) {\n      expandedQueries = queries.map((query) => {\n        const expandedQuery = {\n          ...query,\n          datasource: this.getRef(),\n          expr: this.enhanceExprWithAdHocFilters(\n            this.templateSrv.replace(query.expr, scopedVars, this.interpolateQueryExpr)\n          ),\n          interval: this.templateSrv.replace(query.interval, scopedVars),\n        };\n        return expandedQuery;\n      });\n    }\n    return expandedQueries;\n  }\n\n  getQueryHints(query: PromQuery, result: any[]) {\n    return getQueryHints(query.expr ?? '', result, this);\n  }\n\n  getInitHints() {\n    return getInitHints(this);\n  }\n\n  async loadRules() {\n    try {\n      const res = await this.metadataRequest('/api/v1/rules', {}, { showErrorAlert: false });\n      const groups = res.data?.data?.groups;\n\n      if (groups) {\n        this.ruleMappings = extractRuleMappingFromGroups(groups);\n      }\n    } catch (e) {\n      console.log('Rules API is experimental. Ignore next error.');\n      console.error(e);\n    }\n  }\n\n  async areExemplarsAvailable() {\n    try {\n      const res = await this.metadataRequest(\n        '/api/v1/query_exemplars',\n        {\n          query: 'test',\n          start: dateTime().subtract(30, 'minutes').valueOf().toString(),\n          end: dateTime().valueOf().toString(),\n        },\n        {\n          // Avoid alerting the user if this test fails\n          showErrorAlert: false,\n        }\n      );\n      if (res.data.status === 'success') {\n        return true;\n      }\n      return false;\n    } catch (err) {\n      return false;\n    }\n  }\n\n  modifyQuery(query: PromQuery, action: QueryFixAction): PromQuery {\n    let expression = query.expr ?? '';\n    switch (action.type) {\n      case 'ADD_FILTER': {\n        const { key, value } = action.options ?? {};\n        if (key && value) {\n          expression = addLabelToQuery(expression, key, value);\n        }\n\n        break;\n      }\n      case 'ADD_FILTER_OUT': {\n        const { key, value } = action.options ?? {};\n        if (key && value) {\n          expression = addLabelToQuery(expression, key, value, '!=');\n        }\n        break;\n      }\n      case 'ADD_HISTOGRAM_QUANTILE': {\n        expression = `histogram_quantile(0.95, sum(rate(${expression}[$__rate_interval])) by (le))`;\n        break;\n      }\n      case 'ADD_RATE': {\n        expression = `rate(${expression}[$__rate_interval])`;\n        break;\n      }\n      case 'ADD_SUM': {\n        expression = `sum(${expression.trim()}) by ($1)`;\n        break;\n      }\n      case 'EXPAND_RULES': {\n        if (action.options) {\n          expression = expandRecordingRules(expression, action.options);\n        }\n        break;\n      }\n      default:\n        break;\n    }\n    return { ...query, expr: expression };\n  }\n\n  getPrometheusTime(date: string | DateTime, roundUp: boolean) {\n    if (typeof date === 'string') {\n      date = dateMath.parse(date, roundUp)!;\n    }\n\n    return Math.ceil(date.valueOf() / 1000);\n  }\n\n  getTimeRangeParams(): { start: string; end: string } {\n    const range = this.timeSrv.timeRange();\n    return {\n      start: this.getPrometheusTime(range.from, false).toString(),\n      end: this.getPrometheusTime(range.to, true).toString(),\n    };\n  }\n\n  getOriginalMetricName(labelData: { [key: string]: string }) {\n    return getOriginalMetricName(labelData);\n  }\n\n  enhanceExprWithAdHocFilters(expr: string) {\n    const adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n\n    const finalQuery = adhocFilters.reduce((acc: string, filter: { key?: any; operator?: any; value?: any }) => {\n      const { key, operator } = filter;\n      let { value } = filter;\n      if (operator === '=~' || operator === '!~') {\n        value = prometheusRegularEscape(value);\n      }\n      return addLabelToQuery(acc, key, value, operator);\n    }, expr);\n    return finalQuery;\n  }\n\n  // Used when running queries trough backend\n  filterQuery(query: PromQuery): boolean {\n    if (query.hide || !query.expr) {\n      return false;\n    }\n    return true;\n  }\n\n  // Used when running queries trough backend\n  applyTemplateVariables(target: PromQuery, scopedVars: ScopedVars): Record<string, any> {\n    const variables = cloneDeep(scopedVars);\n\n    // We want to interpolate these variables on backend\n    delete variables.__interval;\n    delete variables.__interval_ms;\n\n    //Add ad hoc filters\n    const expr = this.enhanceExprWithAdHocFilters(target.expr);\n\n    return {\n      ...target,\n      legendFormat: this.templateSrv.replace(target.legendFormat, variables),\n      expr: this.templateSrv.replace(expr, variables, this.interpolateQueryExpr),\n      interval: this.templateSrv.replace(target.interval, variables),\n    };\n  }\n\n  getVariables(): string[] {\n    return this.templateSrv.getVariables().map((v) => `$${v.name}`);\n  }\n\n  interpolateString(string: string) {\n    return this.templateSrv.replace(string, undefined, this.interpolateQueryExpr);\n  }\n}\n\n/**\n * Align query range to step.\n * Rounds start and end down to a multiple of step.\n * @param start Timestamp marking the beginning of the range.\n * @param end Timestamp marking the end of the range.\n * @param step Interval to align start and end with.\n * @param utcOffsetSec Number of seconds current timezone is offset from UTC\n */\nexport function alignRange(\n  start: number,\n  end: number,\n  step: number,\n  utcOffsetSec: number\n): { end: number; start: number } {\n  const alignedEnd = Math.floor((end + utcOffsetSec) / step) * step - utcOffsetSec;\n  const alignedStart = Math.floor((start + utcOffsetSec) / step) * step - utcOffsetSec;\n  return {\n    end: alignedEnd,\n    start: alignedStart,\n  };\n}\n\nexport function extractRuleMappingFromGroups(groups: any[]) {\n  return groups.reduce(\n    (mapping, group) =>\n      group.rules\n        .filter((rule: any) => rule.type === 'recording')\n        .reduce(\n          (acc: { [key: string]: string }, rule: any) => ({\n            ...acc,\n            [rule.name]: rule.query,\n          }),\n          mapping\n        ),\n    {}\n  );\n}\n\n// NOTE: these two functions are very similar to the escapeLabelValueIn* functions\n// in language_utils.ts, but they are not exactly the same algorithm, and we found\n// no way to reuse one in the another or vice versa.\nexport function prometheusRegularEscape(value: any) {\n  return typeof value === 'string' ? value.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, \"\\\\\\\\'\") : value;\n}\n\nexport function prometheusSpecialRegexEscape(value: any) {\n  return typeof value === 'string' ? value.replace(/\\\\/g, '\\\\\\\\\\\\\\\\').replace(/[$^*{}\\[\\]\\'+?.()|]/g, '\\\\\\\\$&') : value;\n}\n","import { DataSourcePlugin } from '@grafana/data';\n\nimport PromCheatSheet from './components/PromCheatSheet';\nimport PromQueryEditorByApp from './components/PromQueryEditorByApp';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { PrometheusDatasource } from './datasource';\n\nexport const plugin = new DataSourcePlugin(PrometheusDatasource)\n  .setQueryEditor(PromQueryEditorByApp)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditorHelp(PromCheatSheet);\n","/**\n * Shared types that can be reused by Loki and other data sources\n */\n\nimport { ComponentType } from 'react';\n\nimport { DataSourceApi, RegistryItem, SelectableValue } from '@grafana/data';\n\nexport interface QueryBuilderLabelFilter {\n  label: string;\n  op: string;\n  value: string;\n}\n\nexport interface QueryBuilderOperation {\n  id: string;\n  params: QueryBuilderOperationParamValue[];\n}\n\nexport interface QueryWithOperations {\n  operations: QueryBuilderOperation[];\n}\n\nexport interface QueryBuilderOperationDef<T = any> extends RegistryItem {\n  documentation?: string;\n  params: QueryBuilderOperationParamDef[];\n  defaultParams: QueryBuilderOperationParamValue[];\n  category: string;\n  hideFromList?: boolean;\n  alternativesKey?: string;\n  /** Can be used to control operation placement when adding a new operations, lower are placed first */\n  orderRank?: number;\n  renderer: QueryBuilderOperationRenderer;\n  addOperationHandler: QueryBuilderAddOperationHandler<T>;\n  paramChangedHandler?: QueryBuilderOnParamChangedHandler;\n  explainHandler?: QueryBuilderExplainOperationHandler;\n  changeTypeHandler?: (op: QueryBuilderOperation, newDef: QueryBuilderOperationDef<T>) => QueryBuilderOperation;\n}\n\nexport type QueryBuilderAddOperationHandler<T> = (\n  def: QueryBuilderOperationDef,\n  query: T,\n  modeller: VisualQueryModeller\n) => T;\n\nexport type QueryBuilderExplainOperationHandler = (op: QueryBuilderOperation, def?: QueryBuilderOperationDef) => string;\n\nexport type QueryBuilderOnParamChangedHandler = (\n  index: number,\n  operation: QueryBuilderOperation,\n  operationDef: QueryBuilderOperationDef\n) => QueryBuilderOperation;\n\nexport type QueryBuilderOperationRenderer = (\n  model: QueryBuilderOperation,\n  def: QueryBuilderOperationDef,\n  innerExpr: string\n) => string;\n\nexport type QueryBuilderOperationParamValue = string | number | boolean;\n\nexport interface QueryBuilderOperationParamDef {\n  name: string;\n  type: 'string' | 'number' | 'boolean';\n  options?: string[] | number[] | Array<SelectableValue<string>>;\n  hideName?: boolean;\n  restParam?: boolean;\n  optional?: boolean;\n  placeholder?: string;\n  description?: string;\n  minWidth?: number;\n  editor?: ComponentType<QueryBuilderOperationParamEditorProps>;\n  runQueryOnEnter?: boolean;\n}\n\nexport interface QueryBuilderOperationEditorProps {\n  operation: QueryBuilderOperation;\n  index: number;\n  query: any;\n  datasource: DataSourceApi;\n  queryModeller: VisualQueryModeller;\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n}\n\nexport interface QueryBuilderOperationParamEditorProps {\n  value?: QueryBuilderOperationParamValue;\n  paramDef: QueryBuilderOperationParamDef;\n  /** Parameter index */\n  index: number;\n  operation: QueryBuilderOperation;\n  operationIndex: number;\n  query: any;\n  datasource: DataSourceApi;\n  onChange: (index: number, value: QueryBuilderOperationParamValue) => void;\n  onRunQuery: () => void;\n}\n\nexport enum QueryEditorMode {\n  Code = 'code',\n  Builder = 'builder',\n}\n\nexport interface VisualQueryModeller {\n  getOperationsForCategory(category: string): QueryBuilderOperationDef[];\n  getAlternativeOperations(key: string): QueryBuilderOperationDef[];\n  getCategories(): string[];\n  getOperationDef(id: string): QueryBuilderOperationDef | undefined;\n}\n","// XXX remove in v8 or beyond\nmodule.exports = require('./index.js')\n"],"names":["DataSourcesRoutesContext","useInitDataSourceSettings","uid","dispatch","state","useTestDataSource","useLoadDataSources","useLoadDataSource","useLoadDataSourcePlugins","useAddDatasource","dataSourcesRoutes","useDataSourcesRoutes","plugin","useUpdateDatasource","dataSource","useDeleteLoadedDataSource","name","useDataSource","useDataSourceExploreUrl","useDataSourceMeta","pluginType","useDataSourceSettings","useDataSourceSettingsNav","dataSourceId","pageId","loadError","loading","navIndex","navIndexId","node","useDataSourceRights","readOnly","hasWriteRights","hasDeleteRights","CHEAT_SHEET_ITEMS","props","item","index","e","QueryPattern","pattern","onPatternSelect","hasNewQueryOption","hasPreviousQuery","selectedPatternName","setSelectedPatternName","styles","getStyles","lang","promql","Card","RawQuery","Button","theme","QueryPatternsModal","isOpen","onClose","onChange","onAddQuery","query","queries","app","openTabs","setOpenTabs","visualQuery","hasOperations","hasMetric","hasLabels","hasBinaryQueries","selectAsNewQuery","Modal","patternType","Collapse","tabs","t","isMatrixData","result","isExemplarData","LegendFormatMode","queryEditorModeDefaultLocalStorageKey","changeEditorMode","editorMode","store","getDefaultEditorMode","expr","defaultEditor","value","getQueryWithDefaults","isBothInstantAndRange","splitSeparator","PROMETHEUS_QUERY_BUILDER_MAX_RESULTS","MetricSelect","datasource","onGetMetrics","labelsFilters","setState","customFilterOption","option","searchQuery","label","acc","cur","formatOptionLabel","meta","formatLabelFilters","queryAndFilterToLabelValuesString","queryString","formatKeyValueStringsForLabelValuesQuery","getMetricLabels","results","debouncedSearch","metrics","LabelFilterItem","defaultOp","onDelete","onGetLabelNames","onGetLabelValues","invalidLabel","invalidValue","getLabelValuesAutofillSuggestions","isMultiSelect","operator","operators","op","getSelectOptionsFromString","labelValueSearch","Select","selectors","labelNames","change","labelValues","changes","MISSING_LABEL_FILTER_ERROR_MESSAGE","LabelFilters","labelFilterRequired","items","setItems","onLabelsChange","newItems","newLabels","x","hasLabelFilter","onChangeItem","NestedQuery","nestedQuery","onRemove","onRunQuery","showExplain","val","AutoSizeInput","evt","IconButton","PromQueryBuilder","update","def","NestedQueryList","nestedQueries","onNestedQueryUpdate","updatedList","EXPLAIN_LABEL_FILTER_CONTENT","PromQueryBuilderExplained","visQuery","OperationExplainedBox","OperationListExplained","data","highlightedOp","setHighlightedOp","onChangeLabels","labels","withTemplateVariableOptions","optionsPromise","variables","options","forLabel","k","labelsToConsider","labelsIndex","labelName","filter","getLabelValuesAutocompleteSuggestions","interpolatedLabelsToConsider","labelObject","response","getLabelValuesFromLabelValuesAPI","getLabelValuesFromSeriesAPI","promQLExpression","forLabelInterpolated","set","labelValue","labelNameString","v","getMetrics","OperationsEditorRow","OperationList","QueryBuilderHints","m","QueryPreview","PromQueryBuilderContainer","stateSlice","exprChanged","onVisQueryChange","visualQueryChange","action","parseResult","PromExemplarField","rest","error","setError","prevError","usePrevious","iconButtonStyles","InlineLabel","Tooltip","PromExploreExtraField","rangeOptions","getQueryTypeOptions","prevQuery","onExemplarChange","exemplar","onChangeQueryStep","interval","onStepChange","onReturnKeyDown","onQueryTypeChange","getQueryTypeChangeHandler","testIds","RadioButtonGroup","includeBoth","queryType","legendModeOptions","PromQueryLegendEditor","legendFormat","mode","getLegendMode","inputRef","onLegendFormatChanged","newFormat","onLegendModeChanged","getLegendModeLabel","PromQueryBuilderOptions","onChangeFormat","onChangeStep","queryTypeOptions","event","isEnabled","onIntervalFactorChange","formatOption","FORMAT_OPTIONS","queryTypeValue","getQueryTypeValue","queryTypeLabel","QueryOptionGroup","getCollapsedInfo","shouldShowExemplarSwitch","INTERVAL_FACTOR_OPTIONS","isCancelablePromiseRejection","promise","makePromiseCancelable","hasCanceled_","resolve","reject","canceledPromiseRejection","EMPTY_SELECTOR","METRIC_LABEL","LIST_ITEM_SIZE","buildSelector","singleMetric","selectedLabels","selectedValues","facetLabels","possibleLabels","lastFacetted","possibleValues","existingValues","stylesFactory","UnthemedPrometheusMetricsBrowser","selector","l","selected","nextValue","values","updatedFields","status","cb","languageProvider","lastUsedLabels","rawLabels","arr","rawValues","metricsMetadata","streams","labelSearchTerm","metricSearchTerm","validationStatus","valueSearchTerm","LoadingPlaceholder","nonMetricLabels","empty","metricCount","Label","Input","i","style","PrometheusMetricsBrowser","Field","MonacoQueryFieldLazy","MonacoQueryFieldWrapper","lastRunValueRef","runQueryOnBlur","handleRunQuery","handleBlur","handleChange","RECORDING_RULES_GROUP","LAST_USED_LABELS_KEY","getChooserText","metricsLookupDisabled","hasSyntax","hasMetrics","willApplySuggestion","suggestion","typeaheadContext","typeaheadText","nextChar","PromQueryField","context","initHints","initHint","queryHints","queryHint","remainingTasks","err","override","nextQuery","hint","typeahead","history","prefix","text","wrapperClasses","labelKey","prism","prevProps","range","changedRangeToRefresh","prevRange","sameMinuteFrom","sameMinuteTo","ExtraFieldElement","labelBrowserVisible","syntaxLoaded","chooserText","buttonDisabled","LocalStorageValueProvider","onLastUsedLabelsSave","onLastUsedLabelsDelete","Icon","PromQueryCodeEditor","PromQueryEditorSelector","parseModalOpen","setParseModalOpen","queryPatternsModalOpen","setQueryPatternsModalOpen","dataIsStale","setDataIsStale","explain","setExplain","useFlag","onEditorModeChange","newMetricEditorMode","onChangeInternal","onShowExplainChange","ConfirmModal","prevValue","QueryHeaderSwitch","QueryEditorModeToggle","PromQueryEditorForAlerting","PromQueryEditorByApp","AzureCloud","KnownAzureClouds","isCredentialsComplete","credentials","concealed","getDefaultAzureCloud","getSecret","secret","hasCredentials","getDefaultCredentials","getCredentials","updateCredentials","setDefaultCredentials","resetCredentials","authTypeOptions","AzureCredentialsForm","azureCloudOptions","onCredentialsChange","getSubscriptions","disabled","hasRequiredFields","subscriptions","setSubscriptions","loadSubscriptionsClicked","onLoadSubscriptions","updateSubscriptions","canceled","received","autoSelect","onSubscriptionChange","opt","onAuthTypeChange","updated","onAzureCloudChange","onTenantIdChange","onClientIdChange","onClientSecretChange","onClientSecretReset","AzureAuthSettings","dataSourceConfig","overrideAudienceAllowed","overrideAudienceChecked","setOverrideAudienceChecked","onOverrideAudienceChange","ev","onResourceIdChange","InlineFieldRow","InlineField","ExemplarSetting","isInternalLink","setIsInternalLink","DataSourcePicker","ds","ExemplarsSettings","newField","newOptions","PromFlavorVersions","FormField","httpOptions","editorOptions","prometheusFlavorSelectItems","getVersionString","version","flavor","versionsLessThanOrEqual","el","closestVersion","differenceBetweenActualAndClosest","unableToDeterminePrometheusVersion","setPrometheusVersion","onOptionsChange","onUpdate","updatedOptions","rawResponse","rawVersionStringFromApi","parsedVersion","updatedUpdatedOptions","PromSettings","onChangeHandler","promSettingsValidationEvents","o","exemplarOptions","getValueFromEventItem","eventItem","key","ConfigEditor","showAccessOptions","azureAuthSettings","config","enabled","Alert","DataSourceHttpSettings","SecureSocksProxySettings","AlertingSettings","AnnotationQueryEditor","annotation","onAnnotationChange","PrometheusMetricFindQuery","labelNamesRegex","labelValuesRegex","metricNamesRegex","queryResultRegex","labelValuesQuery","metricNamesQuery","queryResultQuery","lastValueFrom","start","end","params","url","metric","_labels","metricFilterPattern","metricName","matchedMetricName","instantQuery","map","metricData","self","SUM_HINT_THRESHOLD_COUNT","getQueryHints","series","hints","nameMatch","counterNameMetric","certain","match","token","metadata","fixableQuery","fix","mapping","mappingForQuery","ruleName","getInitHints","INFINITY_SAMPLE_REGEX","isTableResult","dataFrame","target","isHeatmapResult","transformV2","request","tableFrames","framesWithoutTable","df","processedTableFrames","transformDFToTable","exemplarFrames","framesWithoutTableAndExemplars","destinations","processedExemplarFrames","exemplarTraceIdDestination","traceIDField","field","links","getDataLinks","heatmapResults","framesWithoutTableHeatmapsAndExemplars","f","le","heatmapResultsGroupedByQuery","h","processedHeatmapResultsGroupedByQuery","heatmapResultsGroup","heatmapResultsGroupedByValues","HISTOGRAM_QUANTILE_LABEL_NAME","notLE","dataFrames","sortedHeatmap","sortSeriesByLabel","mergeHeatmapFrames","transformToHistogramOverTime","otherFrames","flattenedProcessedHeatmapFrames","dfs","dataFramesByRefId","refIds","refId","valueText","getValueText","valueField","getValueField","timeField","getTimeField","labelFields","promLabels","numberField","ArrayVector","parseSampleValue","labelsForField","getLabelValue","fields","responseLength","transform","transformOptions","prometheusResult","events","exemplarData","sampledExemplars","sampleExemplars","ArrayDataFrame","transformMetricDataToTable","transformToDataFrame","dataLinks","dsSettings","step","bucketedExemplars","alignedTs","standardDeviation","sampledBuckets","ts","exemplarsInBucket","sampledBucketValues","ex","curr","prev","createLabelInfo","stepMs","baseTimestamp","dps","dpValue","timestamp","endTimestamp","md","metricFields","d","metricField","isMs","valueName","parseValue","displayNameFromDS","__name__","labelsWithoutName","labelPart","title","getOriginalMetricName","labelData","frames","countFields","frame","seriesList","topSeries","s","bottomSeries","j","bottomPoint","s1","s2","le1","le2","trackQuery","startTime","PrometheusVariableSupport","templateSrv","timeSrv","of","scopedVars","interpolated","metricFindQuery","from","ANNOTATION_QUERY_STEP_DEFAULT","GET_AND_POST_METADATA_ENDPOINTS","PrometheusDatasource","DataSourceWithBackend","instanceSettings","activeTargets","clonedTargets","instantTarget","rangeTarget","activeTarget","exemplarTarget","tagKeys","titleFormat","textFormat","tagKeysArray","eventList","tags","timeValueTuple","idx","timeStampValue","valueValue","time","activeValuesTimestamps","latestEvent","targetVersion","targetFlavor","overrides","throwError","queryUrl","abstractQueries","abstractQuery","endpoint","variable","prometheusRegularEscape","prometheusSpecialRegexEscape","escapedValues","currentTargetIdx","targets","processedTargets","processedTarget","tap","runningQueriesCount","subQueries","filterAndMapResponse","pipe","merge","requestId","observables","forkJoin","current","catchError","minInterval","scrapeInterval","intervalFactor","adjustedInterval","adjusted","alignRange","rateInterval","safeInterval","msRange","sRange","queryModel","rsp","seriesLabels","buildInfo","Badge","unsupported","LOGOS","COLORS","AppDisplayNames","application","applicationSubType","now","res","expandedQueries","groups","extractRuleMappingFromGroups","expression","date","roundUp","string","utcOffsetSec","alignedEnd","alignedStart","group","rule","QueryEditorMode","module"],"sourceRoot":""}
"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{80808:(Je,ae,p)=>{p.r(ae),p.d(ae,{plugin:()=>Ue});var se=p(7238),t=p(68404),ge=p(93003),de=p(32695),pe=p(97064),fe=p(89014),v=p(49371),he=p(56991);const{Select:re,Input:ve}=fe.LegacyForms,X=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],Y=[{label:"second",value:1},{label:"millisecond",value:2}],Ee=s=>{const{onChange:e,value:a}=s,r=(0,he.L)();return t.createElement(t.Fragment,null,t.createElement("h5",null,"OpenTSDB settings"),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`select-version-${r}`},"Version"),t.createElement(re,{inputId:`select-version-${r}`,options:X,value:X.find(n=>n.value===a.jsonData.tsdbVersion)??X[0],onChange:ne("tsdbVersion",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`select-resolution-${r}`},"Resolution"),t.createElement(re,{inputId:`select-resolution-${r}`,options:Y,value:Y.find(n=>n.value===a.jsonData.tsdbResolution)??Y[0],onChange:ne("tsdbResolution",a,e)})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:7,htmlFor:`lookup-input-${r}`},"Lookup limit"),t.createElement(ve,{id:`lookup-input-${r}`,type:"number",value:a.jsonData.lookupLimit??1e3,onChange:be("lookupLimit",a,e)})))},ne=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.value}})},be=(s,e,a)=>r=>{a({...e,jsonData:{...e.jsonData,[s]:r.currentTarget.value}})},Te=s=>{const{options:e,onOptionsChange:a}=s;return t.createElement(t.Fragment,null,t.createElement(de.E,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:a}),ge.v.featureToggles.secureSocksDatasourceProxy&&t.createElement(pe.i,{options:e,onOptionsChange:a}),t.createElement(Ee,{value:e,onChange:a}))};var Q=p(52423),we=p(8928),Z=p(29516),T=p(63134),j=p(25474),F=p(46739),G=p(91605),D=p(44727);const Ne=(0,Q.css)({paddingRight:"4px"});function ye({query:s,onChange:e,onRunQuery:a,aggregators:r,fillPolicies:n,tsdbVersion:l}){const c=r.map(i=>(0,T.E)(i)),o=n.map(i=>(0,T.E)(i));return t.createElement("div",{className:"gf-form-inline","data-testid":oe.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Leave interval blank for auto or for example use ",t.createElement("code",null,"1m"))},"Down sample"),t.createElement(j.I,{width:25,className:Ne,"data-testid":oe.interval,placeholder:"interval",value:s.downsampleInterval??"",onChange:i=>{const m=i.currentTarget.value;e({...s,downsampleInterval:m})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{className:"gf-form-input",value:s.downsampleAggregator?(0,T.E)(s.downsampleAggregator):void 0,options:c,onChange:({value:i})=>{i&&(e({...s,downsampleAggregator:i}),a())}})),l>=2&&t.createElement("div",{className:"gf-form"},t.createElement(G.W,{className:"width-6 query-keyword"},"Fill"),t.createElement(F.Ph,{inputId:"opentsdb-fillpolicy-select",value:s.downsampleFillPolicy?(0,T.E)(s.downsampleFillPolicy):void 0,options:o,onChange:({value:i})=>{i&&(e({...s,downsampleFillPolicy:i}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword"},"Disable downsampling"),t.createElement(D.x,{value:s.disableDownsampling??!1,onChange:()=>{const i=s.disableDownsampling??!1;e({...s,disableDownsampling:!i}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const oe={section:"opentsdb-downsample",interval:"downsample-interval"};var g=p(82897),le=p(90723),V=p(81697);function Ce({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,filterTypes:n,suggestTagValues:l}){const c=(0,Z.wW)(le.gN),[o,i]=(0,t.useState)(),[m,u]=(0,t.useState)(),[h,y]=(0,t.useState)(),[I,w]=(0,t.useState)(),[b,O]=(0,t.useState)(!1),[E,x]=(0,t.useState)("iliteral_or"),[P,M]=(0,t.useState)(""),[R,B]=(0,t.useState)(""),[A,U]=(0,t.useState)(!1),[W,_]=(0,t.useState)(""),ee=n.map(d=>(0,T.E)(d));function J(){O(!b)}function f(){if(s.tags&&(0,g.size)(s.tags)>0){_("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!b){O(!0);return}const d={type:E,tagk:P,filter:R,groupBy:A};s.filters=s.filters?s.filters.concat([d]):[d],x("literal_or"),M(""),B(""),U(!1),e(s),a(),J()}function C(d){s.filters?.splice(d,1),e(s),a()}function L(d,S){C(S),M(d.tagk),B(d.filter),x(d.type),U(d.groupBy),f()}const ue=" ",H=(0,t.useCallback)((d,S)=>{const te=d.value??"";return S.split(ue).reduce((je,We)=>je&&te.toLowerCase().includes(We.toLowerCase()),!0)},[]);return t.createElement("div",{className:"gf-form-inline","data-testid":z.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:t.createElement("div",null,"Filters does not work with tags, either of the two will work but not both.")},"Filters"),s.filters&&s.filters.map((d,S)=>t.createElement(v.c,{key:S,width:"auto","data-testid":z.list+S},d.tagk," = ",d.type,"(",d.filter,"), groupBy = ",""+d.groupBy,t.createElement("button",{type:"button",className:c,onClick:()=>L(d,S)},t.createElement(V.J,{name:"pen"})),t.createElement("button",{type:"button",className:c,onClick:()=>C(S),"data-testid":z.remove},t.createElement(V.J,{name:"times"})))),!b&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:J,"aria-label":"Add filter"},t.createElement(V.J,{name:"plus"}))),b&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:P?(0,T.E)(P):void 0,placeholder:"key",allowCustomValue:!0,filterOption:H,onOpenMenu:async()=>{u(!0);const S=(await r(s)).map(te=>(0,T.E)(te));i(S),u(!1)},isLoading:m,options:o,onChange:({value:d})=>{d&&M(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(G.W,{className:"width-4 query-keyword"},"Type"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",value:E?(0,T.E)(E):void 0,options:ee,onChange:({value:d})=>{d&&x(d)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:R?(0,T.E)(R):void 0,placeholder:"filter",allowCustomValue:!0,filterOption:H,onOpenMenu:async()=>{if(!h){w(!0);const d=await l();y(d),w(!1)}},isLoading:I,options:h,onChange:({value:d})=>{d&&B(d)}})),t.createElement(v.c,{width:5,className:"query-keyword"},"Group by"),t.createElement(D.x,{value:A,onChange:()=>{U(!A)}}),t.createElement("div",{className:"gf-form"},W&&t.createElement("div",{className:"gf-form-label",title:W,"data-testid":z.error},t.createElement(V.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:c,onClick:f},"add filter"),t.createElement("button",{type:"button",className:c,onClick:J},t.createElement(V.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const z={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};function Se({query:s,onChange:e,onRunQuery:a,suggestMetrics:r,aggregators:n}){const[l,c]=(0,t.useState)({}),o=" ",i=(0,t.useCallback)((u,h)=>{const y=u.value??"";return h.split(o).reduce((w,b)=>w&&y.toLowerCase().includes(b.toLowerCase()),!0)},[]),m=n.map(u=>(0,T.E)(u));return t.createElement("div",{className:"gf-form-inline","data-testid":ie.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:8,className:"query-keyword"},"Metric"),t.createElement(F.Ph,{width:25,inputId:"opentsdb-metric-select",className:"gf-form-input",value:s.metric?(0,T.E)(s.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,filterOption:i,onOpenMenu:async()=>{if(!l.metrics){c({isLoading:!0});const u=await r();c({metrics:u,isLoading:void 0})}},isLoading:l.isLoading,options:l.metrics,onChange:({value:u})=>{u&&(e({...s,metric:u}),a())}})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:"auto",className:"query-keyword"},"Aggregator"),t.createElement(F.Ph,{inputId:"opentsdb-aggregator-select",className:"gf-form-input",value:s.aggregator?(0,T.E)(s.aggregator):void 0,options:m,onChange:({value:u})=>{u&&(e({...s,aggregator:u}),a())}})),t.createElement("div",{className:"gf-form max-width-20"},t.createElement(v.c,{className:"query-keyword",width:6,tooltip:t.createElement("div",null,"Use patterns like $tag_tagname to replace part of the alias for a tag value")},"Alias"),t.createElement(j.I,{"data-testid":ie.alias,placeholder:"series alias",value:s.alias??"",onChange:u=>{const h=u.currentTarget.value;e({...s,alias:h})},onBlur:()=>a()})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const ie={section:"opentsdb-metricsection",alias:"metric-alias"};function Ve({query:s,onChange:e,onRunQuery:a,tsdbVersion:r}){return t.createElement("div",{className:"gf-form-inline","data-testid":K.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8},"Rate"),t.createElement(D.x,{"data-testid":K.shouldComputeRate,value:s.shouldComputeRate??!1,onChange:()=>{const n=s.shouldComputeRate??!1;e({...s,shouldComputeRate:!n}),a()}})),s.shouldComputeRate&&t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:"auto"},"Counter"),t.createElement(D.x,{"data-testid":K.isCounter,value:s.isCounter??!1,onChange:()=>{const n=s.isCounter??!1;e({...s,isCounter:!n}),a()}})),s.shouldComputeRate&&s.isCounter&&t.createElement("div",{className:"gf-form"},t.createElement(G.W,{width:"auto",className:"query-keyword"},"Counter max"),t.createElement(j.I,{"data-testid":K.counterMax,placeholder:"max value",value:s.counterMax??"",onChange:n=>{const l=n.currentTarget.value;e({...s,counterMax:l})},onBlur:()=>a()}),t.createElement(G.W,{width:"auto",className:"query-keyword"},"Reset value"),t.createElement(j.I,{"data-testid":K.counterResetValue,placeholder:"reset value",value:s.counterResetValue??"",onChange:n=>{const l=n.currentTarget.value;e({...s,counterResetValue:l})},onBlur:()=>a()})),r>2&&t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:"auto"},"Explicit tags"),t.createElement(D.x,{"data-testid":K.explicitTags,value:s.explicitTags??!1,onChange:()=>{const n=s.explicitTags??!1;e({...s,explicitTags:!n}),a()}})),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const K={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function xe({query:s,onChange:e,onRunQuery:a,suggestTagKeys:r,suggestTagValues:n,tsdbVersion:l}){const c=(0,Z.wW)(le.gN),[o,i]=(0,t.useState)(),[m,u]=(0,t.useState)(),[h,y]=(0,t.useState)(),[I,w]=(0,t.useState)(),[b,O]=(0,t.useState)(!1),[E,x]=(0,t.useState)(""),[P,M]=(0,t.useState)(""),[R,B]=(0,t.useState)("");function A(){O(!b)}function U(){if(s.filters&&(0,g.size)(s.filters)>0){B("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!b){O(!0);return}if(s.tags&&(0,g.has)(s.tags,E)){const f="Duplicate tag key '"+E+"'.";B(f);return}s.tags||(s.tags={}),s.tags[E]=P,x(""),M(""),e(s),a(),A()}function W(f){delete s.tags[f],e(s),a()}function _(f,C){W(f),x(f),M(C),U()}const ee=" ",J=(0,t.useCallback)((f,C)=>{const L=f.value??"";return C.split(ee).reduce((H,d)=>H&&L.toLowerCase().includes(d.toLowerCase()),!0)},[]);return t.createElement("div",{className:"gf-form-inline","data-testid":$.section},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{className:"query-keyword",width:8,tooltip:l>=2?t.createElement("div",null,"Please use filters, tags are deprecated in opentsdb 2.2"):void 0},"Tags"),s.tags&&Object.keys(s.tags).map((f,C)=>{const L=s.tags[f];return t.createElement(v.c,{key:C,width:"auto","data-testid":$.list+C},f,"=",L,t.createElement("button",{type:"button",className:c,onClick:()=>_(f,L)},t.createElement(V.J,{name:"pen"})),t.createElement("button",{type:"button",className:c,onClick:()=>W(f),"data-testid":$.remove},t.createElement(V.J,{name:"times"})))}),!b&&t.createElement("button",{className:"gf-form-label",type:"button",onClick:A,"aria-label":"Add tag"},t.createElement(V.J,{name:"plus"}))),b&&t.createElement("div",{className:"gf-form-inline"},t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagk-select",className:"gf-form-input",value:E?(0,T.E)(""+E):void 0,placeholder:"key",onOpenMenu:async()=>{u(!0);const C=(await r(s)).map(L=>(0,T.E)(L));i(C),u(!1)},isLoading:m,options:o,onChange:({value:f})=>{f&&x(f)}})),t.createElement("div",{className:"gf-form"},t.createElement(F.Ph,{inputId:"opentsdb-suggested-tagv-select",className:"gf-form-input",value:P?(0,T.E)(P):void 0,placeholder:"value",allowCustomValue:!0,filterOption:J,onOpenMenu:async()=>{if(!h){w(!0);const f=await n();y(f),w(!1)}},isLoading:I,options:h,onChange:({value:f})=>{f&&M(f)}})),t.createElement("div",{className:"gf-form"},R&&t.createElement("div",{className:"gf-form-label",title:R,"data-testid":$.error},t.createElement(V.J,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})),t.createElement("div",{className:"gf-form-label"},t.createElement("button",{type:"button",className:c,onClick:U},"add tag"),t.createElement("button",{type:"button",className:c,onClick:A},t.createElement(V.J,{name:"times"}))))),t.createElement("div",{className:"gf-form gf-form--grow"},t.createElement("div",{className:"gf-form-label gf-form-label--grow"})))}const $={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function Fe({datasource:s,onRunQuery:e,onChange:a,query:r,range:n,queries:l}){const c=(0,Z.wW)(ke),[o,i]=(0,t.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),m=["none","nan","null","zero"],[u,h]=(0,t.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),y=s.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),s.getAggregators().then(E=>{E.length!==0&&i(E)}),s.getFilterTypes().then(E=>{E.length!==0&&h(E)});async function I(){return s.metricFindQuery("metrics()").then(O)}async function w(){return s.metricFindQuery("suggest_tagv()").then(O)}async function b(E){return s.suggestTagKeys(E)}function O(E){return E.map(x=>({value:we.QX.escapeHtml(x.text),description:x.text}))}return t.createElement("div",{className:c.container,"data-testid":Ie.editor},t.createElement("div",{className:c.visualEditor},t.createElement(Se,{query:r,onChange:a,onRunQuery:e,suggestMetrics:I,aggregators:o}),t.createElement(ye,{query:r,onChange:a,onRunQuery:e,aggregators:o,fillPolicies:m,tsdbVersion:y}),y>=2&&t.createElement(Ce,{query:r,onChange:a,onRunQuery:e,filterTypes:u,suggestTagValues:w,suggestTagKeys:b}),t.createElement(xe,{query:r,onChange:a,onRunQuery:e,suggestTagValues:w,suggestTagKeys:b,tsdbVersion:y}),t.createElement(Ve,{query:r,onChange:a,onRunQuery:e,tsdbVersion:y})))}function ke(s){return{container:Q.css`
      display: flex;
    `,visualEditor:Q.css`
      flex-grow: 1;
    `,toggleButton:Q.css`
      margin-left: ${s.spacing(.5)};
    `}}const Ie={editor:"opentsdb-editor"};var Oe=p(46060),Le=p(16313),q=p(53786),k=p(3363),Pe=p(94514),N=p(2101),ce=p(16911),Me=p(21053),me=p(47214),Ae=p(98639);const De=s=>{const{query:e,onChange:a}=s,[r,n]=(0,t.useState)(e.target??""),[l,c]=(0,t.useState)(e.isGlobal??!1),o=(m,u)=>{a({...e,[m]:u,fromAnnotations:!0})},i=m=>{m=!m,c(m),o("isGlobal",m)};return t.createElement("div",{className:"gf-form-group"},t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"OpenTSDB metrics query"),t.createElement(j.I,{value:r,onChange:m=>n(m.currentTarget.value??""),onBlur:()=>o("target",r),placeholder:"events.eventname"})),t.createElement("div",{className:"gf-form"},t.createElement(v.c,{width:12},"Show Global Annotations?"),t.createElement(D.x,{value:l,onChange:m=>i(l)})))},Ke=s=>({fromAnnotations:!0,target:s.target??"",name:s.name??"",isGlobal:s.isGlobal??!1}),Re=s=>{const e=s.target&&typeof s.target!="string"?s.target:Ke(s);return s.target=e,s};class Be extends se.MF{constructor(e,a=(0,Ae.J)()){super(e),this.templateSrv=a,this.type="opentsdb",this.url=e.url,this.name=e.name,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,e.jsonData=e.jsonData||{},this.tsdbVersion=e.jsonData.tsdbVersion||1,this.tsdbResolution=e.jsonData.tsdbResolution||1,this.lookupLimit=e.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:De,prepareAnnotation:Re}}query(e){if(e.targets.some(o=>o.fromAnnotations)){const o=[];for(const i of e.targets)i.target&&o.push(new Oe.y(m=>{this.annotationEvent(e,i).then(u=>m.next({data:[(0,ce.g0)(u)]})).catch(u=>m.next({data:[(0,ce.g0)([])]})).finally(()=>m.complete())}));return(0,Le.T)(...o)}const a=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),r=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),n=[];(0,g.each)(e.targets,o=>{o.metric&&n.push(this.convertTargetToQuery(o,e,this.tsdbVersion))});const l=(0,g.compact)(n);if((0,g.isEmpty)(l))return(0,q.of)({data:[]});const c={};return(0,g.each)(l,o=>{o.filters&&o.filters.length>0?(0,g.each)(o.filters,i=>{c[i.tagk]=!0}):(0,g.each)(o.tags,(i,m)=>{c[m]=!0})}),e.targets=(0,g.filter)(e.targets,o=>o.hide!==!0),this.performTimeSeriesQuery(l,a,r).pipe((0,Pe.K)(o=>{throw o?.data?.error?.message||"Error performing time series query."}),(0,N.U)(o=>{const i=this.mapMetricsToTargets(o.data,e,this.tsdbVersion);return{data:(0,g.map)(o.data,(u,h)=>(h=i[h],h===-1&&(h=0),this._saveTagKeys(u),this.transformMetricData(u,c,e.targets[h],e,this.tsdbResolution)))}}))}annotationEvent(e,a){const r=this.convertToTSDBTime(e.range.raw.from,!1,e.timezone),n=this.convertToTSDBTime(e.range.raw.to,!0,e.timezone),l=[],c=[];l.push({aggregator:"sum",metric:a.target});const o=(0,g.compact)(l);return(0,k.n)(this.performTimeSeriesQuery(o,r,n).pipe((0,N.U)(i=>{if(i.data[0]){let m=i.data[0].annotations;a.isGlobal&&(m=i.data[0].globalAnnotations),m&&(0,g.each)(m,u=>{const h={text:u.description,time:Math.floor(u.startTime)*1e3,annotation:a};c.push(h)})}return c})))}targetContainsTemplate(e){if(e.filters&&e.filters.length>0){for(let a=0;a<e.filters.length;a++)if(this.templateSrv.containsTemplate(e.filters[a].filter))return!0}if(e.tags&&Object.keys(e.tags).length>0){for(const a in e.tags)if(this.templateSrv.containsTemplate(e.tags[a]))return!0}return!1}performTimeSeriesQuery(e,a,r){let n=!1;this.tsdbResolution===2&&(n=!0);const l={start:a,queries:e,msResolution:n,globalAnnotations:!0};this.tsdbVersion===3&&(l.showQuery=!0),r&&(l.end=r);const c={method:"POST",url:this.url+"/api/query",data:l};return this._addCredentialOptions(c),(0,me.i)().fetch(c)}suggestTagKeys(e){const a=e.metric??"";return Promise.resolve(this.tagKeys[a]||[])}_saveTagKeys(e){const a=Object.keys(e.tags);(0,g.each)(e.aggregateTags,r=>{a.push(r)}),this.tagKeys[e.metric]=a}_performSuggestQuery(e,a){return this._get("/api/suggest",{type:a,q:e,max:this.lookupLimit}).pipe((0,N.U)(r=>r.data))}_performMetricKeyValueLookup(e,a){if(!e||!a)return(0,q.of)([]);const r=a.split(",").map(o=>o.trim()),n=r[0];let l=n+"=*";r.length>1&&(l+=","+r.splice(1).join(","));const c=e+"{"+l+"}";return this._get("/api/search/lookup",{m:c,limit:this.lookupLimit}).pipe((0,N.U)(o=>{o=o.data.results;const i=[];return(0,g.each)(o,m=>{i.indexOf(m.tags[n])===-1&&i.push(m.tags[n])}),i}))}_performMetricKeyLookup(e){return e?this._get("/api/search/lookup",{m:e,limit:1e3}).pipe((0,N.U)(a=>{a=a.data.results;const r=[];return(0,g.each)(a,n=>{(0,g.each)(n.tags,(l,c)=>{r.indexOf(c)===-1&&r.push(c)})}),r})):(0,q.of)([])}_get(e,a){const r={method:"GET",url:this.url+e,params:a};return this._addCredentialOptions(r),(0,me.i)().fetch(r)}_addCredentialOptions(e){(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers={Authorization:this.basicAuth})}metricFindQuery(e){if(!e)return Promise.resolve([]);let a;try{a=this.templateSrv.replace(e,{},"distributed")}catch(w){return Promise.reject(w)}const r=w=>(0,g.map)(w,b=>({text:b})),n=/metrics\((.*)\)/,l=/tag_names\((.*)\)/,c=/tag_values\((.*?),\s?(.*)\)/,o=/suggest_tagk\((.*)\)/,i=/suggest_tagv\((.*)\)/,m=a.match(n);if(m)return(0,k.n)(this._performSuggestQuery(m[1],"metrics").pipe((0,N.U)(r)));const u=a.match(l);if(u)return(0,k.n)(this._performMetricKeyLookup(u[1]).pipe((0,N.U)(r)));const h=a.match(c);if(h)return(0,k.n)(this._performMetricKeyValueLookup(h[1],h[2]).pipe((0,N.U)(r)));const y=a.match(o);if(y)return(0,k.n)(this._performSuggestQuery(y[1],"tagk").pipe((0,N.U)(r)));const I=a.match(i);return I?(0,k.n)(this._performSuggestQuery(I[1],"tagv").pipe((0,N.U)(r))):Promise.resolve([])}testDatasource(){return(0,k.n)(this._performSuggestQuery("cpu","metrics").pipe((0,N.U)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,k.n)(this._get("/api/aggregators").pipe((0,N.U)(e=>e.data&&(0,g.isArray)(e.data)?e.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,k.n)(this._get("/api/config/filters").pipe((0,N.U)(e=>e.data?Object.keys(e.data).sort():[]))),this.filterTypesPromise)}transformMetricData(e,a,r,n,l){const c=this.createMetricLabel(e,r,a,n),o=[];return(0,g.each)(e.dps,(i,m)=>{l===2?o.push([i,m*1]):o.push([i,m*1e3])}),{target:c,datapoints:o}}createMetricLabel(e,a,r,n){if(a.alias){const o=(0,g.clone)(n.scopedVars||{});return(0,g.each)(e.tags,(i,m)=>{o["tag_"+m]={value:i}}),this.templateSrv.replace(a.alias,o)}let l=e.metric;const c=[];return(0,g.isEmpty)(e.tags)||(0,g.each)((0,g.toPairs)(e.tags),o=>{(0,g.has)(r,o[0])&&c.push(o[0]+"="+o[1])}),(0,g.isEmpty)(c)||(l+="{"+c.join(", ")+"}"),l}convertTargetToQuery(e,a,r){if(!e.metric||e.hide)return null;const n={metric:this.templateSrv.replace(e.metric,a.scopedVars,"pipe"),aggregator:"avg"};if(e.aggregator&&(n.aggregator=this.templateSrv.replace(e.aggregator)),e.shouldComputeRate&&(n.rate=!0,n.rateOptions={counter:!!e.isCounter},e.counterMax&&e.counterMax.length&&(n.rateOptions.counterMax=parseInt(e.counterMax,10)),e.counterResetValue&&e.counterResetValue.length&&(n.rateOptions.resetValue=parseInt(e.counterResetValue,10)),r>=2&&(n.rateOptions.dropResets=!n.rateOptions.counterMax&&(!n.rateOptions.ResetValue||n.rateOptions.ResetValue===0))),!e.disableDownsampling){let l=this.templateSrv.replace(e.downsampleInterval||a.interval);l.match(/\.[0-9]+s/)&&(l=parseFloat(l)*1e3+"ms"),n.downsample=l+"-"+e.downsampleAggregator,e.downsampleFillPolicy&&e.downsampleFillPolicy!=="none"&&(n.downsample+="-"+e.downsampleFillPolicy)}if(e.filters&&e.filters.length>0)n.filters=(0,g.cloneDeep)(e.filters),n.filters&&this.interpolateVariablesInFilters(n,a);else if(n.tags=(0,g.cloneDeep)(e.tags),n.tags)for(const l in n.tags)n.tags[l]=this.templateSrv.replace(n.tags[l],a.scopedVars,"pipe");return e.explicitTags&&(n.explicitTags=!0),n}interpolateVariablesInFilters(e,a){e.filters=e.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,a.scopedVars,"pipe"),r.filter=this.templateSrv.replace(r.filter,a.scopedVars,"pipe"),r))}mapMetricsToTargets(e,a,r){let n,l;return(0,g.map)(e,c=>r===3?c.query.index:(0,g.findIndex)(a.targets,o=>o.filters&&o.filters.length>0?o.metric===c.metric:o.metric===c.metric&&(0,g.every)(o.tags,(i,m)=>(n=this.templateSrv.replace(i,a.scopedVars,"pipe"),l=n.split("|"),(0,g.includes)(l,c.tags[m])||n==="*"))))}interpolateVariablesInQueries(e,a){return e.length?e.map(r=>({...r,metric:this.templateSrv.replace(r.metric,a)})):e}convertToTSDBTime(e,a,r){return e==="now"?null:(e=Me.parse(e,a,r),e.valueOf())}}const Ue=new se.hf(Be).setQueryEditor(Fe).setConfigEditor(Te)}}]);

//# sourceMappingURL=opentsdbPlugin.b8ee3762184556abd06f.js.map
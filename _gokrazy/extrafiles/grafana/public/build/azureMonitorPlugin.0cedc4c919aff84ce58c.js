"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2364],{"./public/app/plugins/datasource/grafana-azure-monitor-datasource/module.ts":(e,t,r)=>{r.r(t),r.d(t,{plugin:()=>qe});var s=r("./packages/grafana-data/src/index.ts"),a=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),i=r.n(a),o=r("./packages/grafana-runtime/src/index.ts"),n=r("./public/app/features/dashboard/services/TimeSrv.ts"),c=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/azureMetadata/index.ts"),u=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/types/index.ts");const l=Symbol("Concealed client secret");function p(e){return e.jsonData.azureAuthType?e.jsonData.azureAuthType:e.jsonData.tenantId&&e.jsonData.clientId?"clientsecret":o.config.azure.managedIdentityEnabled?"msi":"clientsecret"}function d(){switch(o.config.azure.cloud){case u._.Public:case u._.None:case void 0:return"azuremonitor";case u._.China:return"chinaazuremonitor";case u._.USGovernment:return"govazuremonitor";case u._.Germany:return"germanyazuremonitor";default:throw new Error(`The cloud '${o.config.azure.cloud}' not supported.`)}}function m(e){switch(e){case"azuremonitor":return"https://portal.azure.com";case"chinaazuremonitor":return"https://portal.azure.cn";case"govazuremonitor":return"https://portal.azure.us";case"germanyazuremonitor":return"https://portal.microsoftazure.de";default:throw new Error("The cloud not supported.")}}function h(e){switch(p(e)){case"msi":return d();case"clientsecret":return e.jsonData.cloudName||d()}}function g(e){if(e.secureJsonFields.clientSecret)return l;{var t;const r=null===(t=e.secureJsonData)||void 0===t?void 0:t.clientSecret;return"string"==typeof r&&r.length>0?r:void 0}}function f(e){switch(p(e)){case"msi":return o.config.azure.managedIdentityEnabled?{authType:"msi",defaultSubscriptionId:e.jsonData.subscriptionId}:{authType:"clientsecret",azureCloud:d()};case"clientsecret":return{authType:"clientsecret",azureCloud:e.jsonData.cloudName||d(),tenantId:e.jsonData.tenantId,clientId:e.jsonData.clientId,clientSecret:g(e),defaultSubscriptionId:e.jsonData.subscriptionId}}}var y=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/time_grain_converter.ts"),v=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/common.ts");class b{static parseResponseValues(e,t,r){const s=[];if(!e)return s;for(let i=0;i<e.value.length;i++)if(!(0,a.find)(s,["value",(0,a.get)(e.value[i],r)])){const o=(0,a.get)(e.value[i],r),n=(0,a.get)(e.value[i],t,o);s.push({text:n,value:o})}return s}static parseResourceNames(e,t){const r=[];if(!e)return r;for(let s=0;s<e.value.length;s++)"string"==typeof e.value[s].type&&e.value[s].type.toLocaleLowerCase()===t.toLocaleLowerCase()&&r.push({text:e.value[s].name,value:e.value[s].name});return r}static parseMetadata(e,t){var r,s;const a=["None","Average","Minimum","Maximum","Total","Count"],i=null==e?void 0:e.value.find((e=>e.name.value===t));return i?{primaryAggType:i.primaryAggregationType,supportedAggTypes:i.supportedAggregationTypes||a,supportedTimeGrains:[{label:"Auto",value:"auto"},...b.parseTimeGrains(null!==(r=i.metricAvailabilities)&&void 0!==r?r:[])],dimensions:b.parseDimensions(null!==(s=i.dimensions)&&void 0!==s?s:[])}:{primaryAggType:"",supportedAggTypes:a,supportedTimeGrains:[],dimensions:[]}}static parseTimeGrains(e){const t=[];return e?(e.forEach((e=>{e.timeGrain&&t.push({label:y.Z.createTimeGrainFromISO8601Duration(e.timeGrain),value:e.timeGrain})})),t):t}static parseDimensions(e){return e.map((e=>({label:e.localizedValue||e.value,value:e.value})))}static parseSubscriptions(e){const t=[];if(!e)return t;const r="subscriptionId";for(let s=0;s<e.value.length;s++)(0,a.find)(t,["value",(0,a.get)(e.value[s],r)])||t.push({text:`${(0,a.get)(e.value[s],"displayName")}`,value:(0,a.get)(e.value[s],r)});return t}static parseSubscriptionsForSelect(e){const t=[];if(!e)return t;const r="subscriptionId";for(let s=0;s<e.data.value.length;s++)(0,a.find)(t,["value",(0,a.get)(e.data.value[s],r)])||t.push({label:`${(0,a.get)(e.data.value[s],"displayName")} - ${(0,a.get)(e.data.value[s],r)}`,value:(0,a.get)(e.data.value[s],r)});return t}static parseWorkspacesForSelect(e){const t=[];if(!e)return t;const r="customerId";for(let s=0;s<e.data.value.length;s++)(0,a.find)(t,["value",(0,a.get)(e.data.value[s].properties,r)])||t.push({label:(0,a.get)(e.data.value[s],"name"),value:(0,a.get)(e.data.value[s].properties,r)});return t}}class M{constructor(e){var t,r,s;s={azuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.AppConfiguration/configurationStores","Microsoft.Automation/automationAccounts","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerInstance/containerGroups","Microsoft.ContainerRegistry/registries","Microsoft.ContainerService/managedClusters","Microsoft.CustomerInsights/hubs","Microsoft.DataBoxEdge/dataBoxEdgeDevices","Microsoft.DataFactory/datafactories","Microsoft.DataFactory/factories","Microsoft.DataLakeAnalytics/accounts","Microsoft.DataLakeStore/accounts","Microsoft.DBforMariaDB/servers","Microsoft.DBforMySQL/servers","Microsoft.DBforMySQL/flexibleServers","Microsoft.DBforPostgreSQL/servers","Microsoft.DBforPostgreSQL/flexibleServers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.DocumentDB/databaseAccounts","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.HDInsight/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Kusto/clusters","Microsoft.LocationBasedServices/accounts","Microsoft.Logic/workflows","Microsoft.Logic/integrationServiceEnvironments","Microsoft.NetApp/netAppAccounts/capacityPools","Microsoft.NetApp/netAppAccounts/capacityPools/volumes","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.Network/natGateways","Microsoft.Network/vpngateways","Microsoft.Network/virtualNetworkGateways","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.Search/searchServices","Microsoft.ServiceBus/namespaces","Microsoft.SignalRService/SignalR","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StorageSync/storageSyncServices","Microsoft.StorageSync/storageSyncServices/syncGroups","Microsoft.StorageSync/storageSyncServices/syncGroups/serverEndpoints","Microsoft.StorageSync/storageSyncServices/registeredServers","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],govazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],germanyazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],chinaazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"]},(r="supportedMetricNamespaces")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.cloudName=e}get(){return this.supportedMetricNamespaces[this.cloudName]}}class S{static buildAzureMonitorGetMetricNamespacesUrl(e,t,r,s,a,i){const o=s.split("/"),n=a.split("/"),c=[e,t,"resourceGroups",r,"providers",o.shift()];for(const e in o)c.push(o[e]),c.push(n[e]);return`${c.join("/")}/providers/microsoft.insights/metricNamespaces?api-version=${i}`}static buildAzureMonitorGetMetricNamesUrl(e,t,r,s,a,i,o){const n=s.split("/"),c=a.split("/"),u=[e,t,"resourceGroups",r,"providers",n.shift()];for(const e in n)u.push(n[e]),u.push(c[e]);return`${u.join("/")}/providers/microsoft.insights/metricdefinitions?api-version=${o}&metricnamespace=${encodeURIComponent(i)}`}}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const N="select";class I extends o.DataSourceWithBackend{constructor(e){super(e),w(this,"apiVersion","2018-01-01"),w(this,"apiPreviewVersion","2017-12-01-preview"),w(this,"listByResourceGroupApiVersion","2021-04-01"),w(this,"defaultSubscriptionId",void 0),w(this,"resourcePath",void 0),w(this,"azurePortalUrl",void 0),w(this,"supportedMetricNamespaces",[]),w(this,"timeSrv",void 0),this.instanceSettings=e,this.timeSrv=(0,n.$t)(),this.defaultSubscriptionId=e.jsonData.subscriptionId;const t=h(e);this.resourcePath=`${v.kr.azureMonitor}/subscriptions`,this.supportedMetricNamespaces=new M(t).get(),this.azurePortalUrl=m(t)}isConfigured(){return!this.validateDatasource()}filterQuery(e){return!!(!0!==e.hide&&e.azureMonitor&&e.azureMonitor.resourceGroup&&e.azureMonitor.resourceGroup!==N&&e.azureMonitor.resourceName&&e.azureMonitor.resourceName!==N&&e.azureMonitor.metricDefinition&&e.azureMonitor.metricDefinition!==N&&e.azureMonitor.metricName&&e.azureMonitor.metricName!==N&&e.azureMonitor.aggregation&&e.azureMonitor.aggregation!==N)}applyTemplateVariables(e,t){var r;const s=e.azureMonitor;if(!s)throw new Error("Query is not a valid Azure Monitor Metrics query");s.timeGrain&&s.timeGrainUnit&&"auto"!==s.timeGrain&&(s.timeGrain=y.Z.createISO8601Duration(s.timeGrain,s.timeGrainUnit));const a=(0,o.getTemplateSrv)(),i=a.replace(e.subscription||this.defaultSubscriptionId,t),n=a.replace(s.resourceGroup,t),c=a.replace(s.resourceName,t),l=a.replace(s.metricNamespace,t),p=a.replace(s.metricDefinition,t),d=a.replace((s.timeGrain||"").toString(),t),m=a.replace(s.aggregation,t),h=a.replace(s.top||"",t),g=(null!==(r=s.dimensionFilters)&&void 0!==r?r:[]).filter((e=>e.dimension&&"None"!==e.dimension)).map((e=>{var r;const s=a.replace(null!==(r=e.filter)&&void 0!==r?r:"",t);return{dimension:a.replace(e.dimension,t),operator:e.operator||"eq",filter:s||"*"}}));return{refId:e.refId,subscription:i,queryType:u.B.AzureMonitor,azureMonitor:{resourceGroup:n,resourceName:c,metricDefinition:p,timeGrain:d,allowedTimeGrainsMs:s.allowedTimeGrainsMs,metricName:a.replace(s.metricName,t),metricNamespace:l&&l!==N?l:p,aggregation:m,dimensionFilters:g,top:h||"10",alias:s.alias}}}async getSubscriptions(){return this.isConfigured()?this.getResource(`${this.resourcePath}?api-version=2019-03-01`).then((e=>b.parseSubscriptions(e))):[]}getResourceGroups(e){return this.getResource(`${this.resourcePath}/${e}/resourceGroups?api-version=${this.listByResourceGroupApiVersion}`).then((e=>b.parseResponseValues(e,"name","name")))}getMetricDefinitions(e,t){return this.getResource(`${this.resourcePath}/${e}/resourceGroups/${t}/resources?api-version=${this.listByResourceGroupApiVersion}`).then((e=>b.parseResponseValues(e,"type","type"))).then((e=>(0,a.filter)(e,(e=>{for(let t=0;t<this.supportedMetricNamespaces.length;t++)if(e.value.toLowerCase()===this.supportedMetricNamespaces[t].toLowerCase())return!0;return!1})))).then((e=>{let t=!1;for(let r=0;r<e.length;r++)if("Microsoft.Storage/storageAccounts"===e[r].value){t=!0;break}return t&&(e.push({text:"Microsoft.Storage/storageAccounts/blobServices",value:"Microsoft.Storage/storageAccounts/blobServices"}),e.push({text:"Microsoft.Storage/storageAccounts/fileServices",value:"Microsoft.Storage/storageAccounts/fileServices"}),e.push({text:"Microsoft.Storage/storageAccounts/tableServices",value:"Microsoft.Storage/storageAccounts/tableServices"}),e.push({text:"Microsoft.Storage/storageAccounts/queueServices",value:"Microsoft.Storage/storageAccounts/queueServices"})),e.map((e=>({value:e.value,text:c.D8[e.value.toLowerCase()]||e.value})))}))}getResourceNames(e,t,r,s){let i=`${this.resourcePath}/${e}/resourceGroups/${t}/resources?$filter=resourceType eq '${r}'&api-version=${this.listByResourceGroupApiVersion}`;return s&&(i+=`&$skiptoken=${s}`),this.getResource(i).then((async s=>{let i=[];if((0,a.startsWith)(r,"Microsoft.Storage/storageAccounts/")){i=b.parseResourceNames(s,"Microsoft.Storage/storageAccounts");for(let e=0;e<i.length;e++)i[e].text+="/default",i[e].value+="/default"}else i=b.parseResourceNames(s,r);if(s.nextLink){const a=new URL(s.nextLink).searchParams.get("$skiptoken");if(!a)throw Error("unable to request the next page of resources");const o=await this.getResourceNames(e,t,r,a);i=i.concat(o)}return i}))}getMetricNamespaces(e,t,r,s){const a=S.buildAzureMonitorGetMetricNamespacesUrl(this.resourcePath,e,t,r,s,this.apiPreviewVersion);return this.getResource(a).then((e=>b.parseResponseValues(e,"name","properties.metricNamespaceName")))}getMetricNames(e,t,r,s,a){const i=S.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,r,s,a,this.apiVersion);return this.getResource(i).then((e=>b.parseResponseValues(e,"name.localizedValue","name.value")))}getMetricMetadata(e,t,r,s,a,i){const o=S.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,r,s,a,this.apiVersion);return this.getResource(o).then((e=>b.parseMetadata(e,i)))}async testDatasource(){const e=this.validateDatasource();if(e)return Promise.resolve(e);try{const e=`${this.resourcePath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Monitor service.",title:"Success"})))}catch(e){let t="Azure Monitor: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&e.data.error.code?t+=e.data.error.code+". "+e.data.error.message:e.data&&e.data.error?t+=e.data.error:e.data?t+=e.data:t+="Cannot connect to Azure Monitor REST API.",{status:"error",message:t}}}validateDatasource(){if("clientsecret"===p(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}class A{constructor(e){this.results=e}parseQueryResult(){let e=[],t=[];for(let r=0;r<this.results.length;r++)if(this.results[r].query.raw){const s=this.results[r].query.xaxis,i=this.results[r].query.yaxis,o=this.results[r].query.spliton;t=this.results[r].result.Tables[0].Columns;const n=this.results[r].result.Tables[0].Rows;e=(0,a.concat)(e,this.parseRawQueryResultRow(this.results[r].query,t,n,s,i,o))}else{const t=this.results[r].result.value,s=this.results[r].query.alias;e=(0,a.concat)(e,this.parseQueryResultRow(this.results[r].query,t,s))}return e}parseRawQueryResultRow(e,t,r,s,i,o){const n=[],c=(0,a.map)(t,(e=>({text:e.ColumnName,value:e.ColumnName}))),u=t.findIndex((e=>e.ColumnName===s)),l=i.split(","),p={};(0,a.forEach)(l,(e=>{p[e]=t.findIndex((t=>t.ColumnName===e))}));const d=t.findIndex((e=>e.ColumnName===o)),m="timestamp"===s;return(0,a.forEach)(r,(t=>{(0,a.forEach)(p,((r,s)=>{const a=-1===d?A.findOrCreateBucket(n,s):A.findOrCreateBucket(n,t[d]),i=m?A.dateTimeToEpoch(t[u]):t[u];a.datapoints.push([t[r],i]),a.refId=e.refId,a.query=e.query,a.columnsForDropdown=c}))})),n}parseQueryResultRow(e,t,r){const s=[];if(A.isSingleValue(t)){const r=A.getMetricFieldKey(t),a=A.getKeyForAggregationField(t[r]),i=A.dateTimeToEpoch(t.end);return s.push({target:r,datapoints:[[t[r][a],i]],refId:e.refId,query:e.query}),s}if(A.hasSegmentsField(t.segments[0]))for(let a=0;a<t.segments.length;a++){const i=A.dateTimeToEpoch(t.segments[a].end);for(let o=0;o<t.segments[a].segments.length;o++){const n=A.getMetricFieldKey(t.segments[a].segments[o]),c=A.getKeyForAggregationField(t.segments[a].segments[o][n]),u=this.getTargetName(t.segments[a].segments[o],r),l=A.findOrCreateBucket(s,u);l.datapoints.push([t.segments[a].segments[o][n][c],i]),l.refId=e.refId,l.meta={query:e.query}}}else{const r=A.getMetricFieldKey(t.segments[0]),a=A.findOrCreateBucket(s,r);for(let e=0;e<t.segments.length;e++){const s=A.dateTimeToEpoch(t.segments[e].end),i=A.getKeyForAggregationField(t.segments[e][r]);a.datapoints.push([t.segments[e][r][i],s])}a.refId=e.refId,a.query=e.query}return s}getTargetName(e,t){let r="",s="",i="";for(const t in e)(0,a.isObject)(e[t])?r=t:(s=t,i=e[t]);if(t){const e=/\{\{([\s\S]+?)\}\}/g;return t.replace(e,((e,t,a)=>{const o=t||a;return"metric"===o?r:"groupbyname"===o?s:"groupbyvalue"===o?i:e}))}return r+`{${s}="${i}"}`}static isSingleValue(e){return!A.hasSegmentsField(e)}static findOrCreateBucket(e,t){let r=(0,a.find)(e,["target",t]);return r||(r={target:t,datapoints:[]},e.push(r)),r}static hasSegmentsField(e){const t=(0,a.keys)(e);return(0,a.indexOf)(t,"segments")>-1}static getMetricFieldKey(e){const t=(0,a.keys)(e);return(0,a.filter)((0,a.without)(t,"start","end"),(t=>(0,a.isObject)(e[t])))[0]}static getKeyForAggregationField(e){const t=(0,a.keys)(e);return(0,a.intersection)(t,["sum","avg","min","max","count","unique"])[0]}static dateTimeToEpoch(e){return(0,s.dateTime)(e).valueOf()}static parseMetricNames(e){const t=(0,a.keys)(e.metrics);return A.toTextValueList(t)}parseMetadata(e){const t=this.results.metrics[e];if(!t)throw Error("No data found for metric: "+e);return{primaryAggType:t.defaultAggregation,supportedAggTypes:t.supportedAggregations,supportedGroupBy:t.supportedGroupBy.all}}parseGroupBys(){return A.toTextValueList(this.results.supportedGroupBy)}parseQuerySchema(){const e={Type:"AppInsights",Tables:{}};if(this.results&&this.results&&this.results.Tables)for(let t=0;t<this.results.Tables[0].Rows.length;t++){const r=this.results.Tables[0].Rows[t],s=r[0],a=r[1],i=r[2];e.Tables[s]?e.Tables[s].OrderedColumns.push({Name:a,Type:i}):e.Tables[s]={Name:s,OrderedColumns:[{Name:a,Type:i}]}}return e}static toTextValueList(e){const t=[];for(let r=0;r<e.length;r++)t.push({text:e[r],value:e[r]});return t}}function D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class k extends o.DataSourceWithBackend{constructor(e){super(e),D(this,"resourcePath",void 0),D(this,"version","beta"),D(this,"applicationId",void 0),D(this,"logAnalyticsColumns",{}),this.applicationId=e.jsonData.appInsightsAppId||"",this.resourcePath=`${v.kr.appInsights}/${this.version}/apps/${this.applicationId}`}isConfigured(){return!!this.applicationId&&this.applicationId.length>0}createRawQueryRequest(e,t,r){return e.xaxis&&!e.timeColumn&&(e.timeColumn=e.xaxis),e.yaxis&&!e.valueColumn&&(e.valueColumn=e.yaxis),e.spliton&&!e.segmentColumn&&(e.segmentColumn=e.spliton),{type:"timeSeriesQuery",raw:!1,appInsights:{rawQuery:!0,rawQueryString:(0,o.getTemplateSrv)().replace(e.rawQueryString,t.scopedVars),timeColumn:e.timeColumn,valueColumn:e.valueColumn,segmentColumn:e.segmentColumn}}}applyTemplateVariables(e,t){const r=e.appInsights;if(!r)return e;const s=r;s.timeGrainCount?r.timeGrain=y.Z.createISO8601Duration(s.timeGrainCount,r.timeGrainUnit):r.timeGrain&&r.timeGrainUnit&&"auto"!==r.timeGrain&&(r.timeGrain=y.Z.createISO8601Duration(r.timeGrain,r.timeGrainUnit)),s.groupBy&&!r.dimension&&(r.dimension=[s.groupBy]),s.filter&&!r.dimensionFilter&&(r.dimensionFilter=s.filter),(0,a.isString)(r.dimension)&&("None"===r.dimension?r.dimension=[]:r.dimension=[r.dimension]),r.dimension||(r.dimension=[]);const i=(0,o.getTemplateSrv)();return{refId:e.refId,queryType:u.B.ApplicationInsights,appInsights:{timeGrain:i.replace((r.timeGrain||"").toString(),t),metricName:i.replace(r.metricName,t),aggregation:i.replace(r.aggregation,t),dimension:r.dimension.map((e=>i.replace(e,t))),dimensionFilter:i.replace(r.dimensionFilter,t),alias:r.alias}}}testDatasource(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Application Insights service.",title:"Success"}))).catch((e=>{let t="Application Insights: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&"PathNotFoundError"===e.data.error.code?t+="Invalid Application Id for Application Insights service.":e.data&&e.data.error?t+=e.data.error.code+". "+e.data.error.message:t+="Cannot connect to Application Insights REST API.",{status:"error",message:t}}))}getMetricNames(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then(A.parseMetricNames)}getMetricMetadata(e){const t=`${this.resourcePath}/metrics/metadata`;return this.getResource(t).then((t=>new A(t).parseMetadata(e)))}getGroupBys(e){return this.getMetricMetadata(e).then((e=>new A(e).parseGroupBys()))}getQuerySchema(){const e=`${this.resourcePath}/query/schema`;return this.getResource(e).then((e=>new A(e).parseQuerySchema()))}}var T=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/observable/from.js"),x=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),z=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/ResourcePicker/utils.ts");class j{constructor(e,t,r){this.rawQueryString=e,this.options=t,this.defaultTimeField=r}generate(){let e=this.rawQueryString;const t=/\$__([_a-zA-Z0-9]+)\(([^()]*)\)/gi;e=e.replace(t,((e,t,r)=>"contains"===t?this.getMultiContains(r):e)),e=e.replace(/\$__escapeMulti\(('[^]*')\)/gi,((e,t)=>this.escape(t))),this.options&&(e=e.replace(t,((e,t,r)=>"timeFilter"===t?this.getTimeFilter(r,this.options):"timeFrom"===t?this.getFrom(this.options):"timeTo"===t?this.getUntil(this.options):e)),e=e.replace(/\$__interval/gi,this.options.interval));const r=e;e=encodeURIComponent(e);return{uriString:`query=${e}`,rawQuery:r}}getFrom(e){const t=e.range.from;return`datetime(${(0,s.dateTime)(t).startOf("minute").toISOString()})`}getUntil(e){var t;if("now"===(null===(t=e.rangeRaw)||void 0===t?void 0:t.to)){const e=Date.now();return`datetime(${(0,s.dateTime)(e).startOf("minute").toISOString()})`}{const t=e.range.to;return`datetime(${(0,s.dateTime)(t).startOf("minute").toISOString()})`}}getTimeFilter(e,t){var r;const s=e||this.defaultTimeField;return"now"===(null===(r=t.rangeRaw)||void 0===r?void 0:r.to)?`${s} >= ${this.getFrom(t)}`:`${s}  >= ${this.getFrom(t)} and ${s} <= ${this.getUntil(t)}`}getMultiContains(e){const t=e.indexOf(","),r=e.substring(0,t),s=e.substring(e.indexOf(",")+1);return s&&"all"===s.toLowerCase().trim()?"1 == 1":`${r.trim()} in (${s.trim()})`}escape(e){return e.substring(1,e.length-1).split("','").map((e=>`@'${e}'`)).join(", ")}}class C{constructor(e){this.results=e}parseQueryResult(){let e=[],t=[];for(let r=0;r<this.results.length;r++){if(0===this.results[r].result.tables.length)continue;t=this.results[r].result.tables[0].columns;const s=this.results[r].result.tables[0].rows;e="time_series"===this.results[r].query.resultFormat?(0,a.concat)(e,this.parseTimeSeriesResult(this.results[r].query,t,s)):(0,a.concat)(e,this.parseTableResult(this.results[r].query,t,s))}return e}parseTimeSeriesResult(e,t,r){const s=[];let i=-1,o=-1,n=-1;for(let e=0;e<t.length;e++)-1===i&&"datetime"===t[e].type&&(i=e),-1===o&&"string"===t[e].type&&(o=e),-1===n&&["int","long","real","double"].indexOf(t[e].type)>-1&&(n=e);if(-1===i)throw new Error("No datetime column found in the result. The Time Series format requires a time column.");return(0,a.forEach)(r,(r=>{const a=C.dateTimeToEpoch(r[i]),c=o>-1?r[o]:t[n].name,u=C.findOrCreateBucket(s,c);u.datapoints.push([r[n],a]),u.refId=e.refId,u.meta={executedQueryString:e.query}})),s}parseTableResult(e,t,r){return{type:"table",columns:(0,a.map)(t,(e=>({text:e.name,type:e.type}))),rows:r,refId:e.refId,meta:{executedQueryString:e.query}}}parseToVariables(){const e=this.parseQueryResult(),t=[];return(0,a.forEach)(e,(e=>{(0,a.forEach)((0,a.flattenDeep)(e.rows),(e=>{t.push({text:e,value:e})}))})),t}transformToAnnotations(e){const t=this.parseQueryResult(),r=[];return(0,a.forEach)(t,(t=>{let s=-1,i=-1,o=-1;for(let e=0;e<t.columns.length;e++)-1===s&&"datetime"===t.columns[e].type&&(s=e),-1===i&&"text"===t.columns[e].text.toLowerCase()&&(i=e),-1===o&&"tags"===t.columns[e].text.toLowerCase()&&(o=e);(0,a.forEach)(t.rows,(t=>{r.push({annotation:e.annotation,time:Math.floor(C.dateTimeToEpoch(t[s])),text:t[i]?t[i].toString():"",tags:t[o]?t[o].trim().split(/\s*,\s*/):[]})}))})),r}static findOrCreateBucket(e,t){let r=(0,a.find)(e,["target",t]);return r||(r={target:t,datapoints:[],refId:"",query:""},e.push(r)),r}static dateTimeToEpoch(e){return(0,s.dateTime)(e).valueOf()}static parseSubscriptions(e){const t=[];if(!e)return t;const r="subscriptionId";for(let s=0;s<e.value.length;s++)(0,a.find)(t,["value",(0,a.get)(e.value[s],r)])||t.push({text:`${(0,a.get)(e.value[s],"displayName")}`,value:(0,a.get)(e.value[s],r)});return t}}const G=/([\w\W]+):([\w]+)(?:\s?=\s?([\w\W]+))?/;function R(e){return e.functions?e.functions.map((e=>{const t=e.parameters&&e.parameters.split(", ").map((e=>{const t=e.match(G);if(!t)return;const[,r,s,a]=t;return{name:r,type:s,defaultValue:a,cslDefaultValue:a}})).filter((e=>!!e));return{name:e.name,body:e.body,inputParameters:t||[]}})):[]}function X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class q extends o.DataSourceWithBackend{constructor(e){super(e),X(this,"resourcePath",void 0),X(this,"azurePortalUrl",void 0),X(this,"defaultSubscriptionId",void 0),X(this,"azureMonitorPath",void 0),X(this,"firstWorkspace",void 0),X(this,"cache",void 0),this.instanceSettings=e,this.cache=new Map,this.resourcePath=`${v.kr.logAnalytics}`,this.azureMonitorPath=`${v.kr.azureMonitor}/subscriptions`;const t=h(e);this.azurePortalUrl=m(t),this.defaultSubscriptionId=this.instanceSettings.jsonData.subscriptionId||""}isConfigured(){return!this.validateDatasource()}filterQuery(e){var t;return!(!0===e.hide||null===(t=e.azureLogAnalytics)||void 0===t||!t.query||!e.azureLogAnalytics.resource&&!e.azureLogAnalytics.workspace)}async getSubscriptions(){if(!this.isConfigured())return[];const e=`${this.azureMonitorPath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>C.parseSubscriptions(e)))}async getWorkspaces(e){const t=await this.getWorkspaceList(e);return(0,a.map)(t.value,(e=>({text:e.name,value:e.id})))||[]}getWorkspaceList(e){const t=(0,o.getTemplateSrv)().replace(e||this.defaultSubscriptionId),r=this.azureMonitorPath+`/${t}/providers/Microsoft.OperationalInsights/workspaces?api-version=2017-04-26-preview`;return this.getResource(r)}async getMetadata(e){const t=`${this.resourcePath}/v1${e}/metadata`;return await this.getResource(t)}async getKustoSchema(e){return function(e,t){const r={name:t,tables:e.tables,functions:R(e),majorVersion:0,minorVersion:0};return{clusterType:"Engine",cluster:{connectionString:t,databases:[r]},database:r}}(await this.getMetadata(e),e)}applyTemplateVariables(e,t){const r=e.azureLogAnalytics;if(!r)return e;const s=(0,o.getTemplateSrv)(),a=s.replace(r.resource,t);let i=s.replace(r.workspace,t);i||a||!this.firstWorkspace||(i=this.firstWorkspace);const n=s.replace(r.query,t,v.Ll);return{refId:e.refId,queryType:u.B.LogAnalytics,azureLogAnalytics:{resultFormat:r.resultFormat,query:n,resource:a,workspace:i}}}query(e){return super.query(e).pipe((0,x.z)((e=>(0,T.D)(this.processResponse(e)))))}async processResponse(e){if(e.data)for(const s of e.data){var t,r;const e=null===(t=s.meta)||void 0===t||null===(r=t.custom)||void 0===r?void 0:r.encodedQuery;if(e&&e.length>0){const e=await this.buildDeepLink(s.meta.custom);if(null!=e&&e.length)for(const t of s.fields)t.config.links=[{url:e,title:"View in Azure Portal",targetBlank:!0}]}}return e}async buildDeepLink(e){const t=encodeURIComponent(e.encodedQuery),r=e.workspace,s=e.subscription,a=await this.getWorkspaceDetails(r);if(!a.workspace||!a.resourceGroup)return"";return`${this.azurePortalUrl}/#blade/Microsoft_OperationsManagementSuite_Workspace/AnalyticsBlade/initiator/AnalyticsShareLinkToQuery/isQueryEditorVisible/true/scope/%7B%22resources%22%3A%5B%7B%22resourceId%22%3A%22%2Fsubscriptions%2F${s}%2Fresourcegroups%2F${a.resourceGroup}%2Fproviders%2Fmicrosoft.operationalinsights%2Fworkspaces%2F${a.workspace}%22%7D%5D%7D/query/${t}/isQueryBase64Compressed/true/timespanInIsoFormat/P1D`}async getWorkspaceDetails(e){if(!this.defaultSubscriptionId)return{};const t=(await this.getWorkspaceList(this.defaultSubscriptionId)).value.find((t=>t.properties.customerId===e));if(!t)return{};const r=/.*resourcegroups\/(.*)\/providers.*/.exec(t.id);return!r||r.length<2?{}:{workspace:t.name,resourceGroup:r[1]}}getDeprecatedDefaultWorkSpace(){return this.instanceSettings.jsonData.logAnalyticsDefaultWorkspace}buildQuery(e,t,r){const s=new j((0,o.getTemplateSrv)().replace(e,{},v.Ll),t,"TimeGenerated").generate().uriString,a=(0,z.uD)(r)?`${this.resourcePath}/v1/workspaces/${r}/query?${s}`:`${this.resourcePath}/v1${r}/query?${s}`;return[{datasource:this.getRef(),path:a,resultFormat:"table"}]}async getDefaultOrFirstSubscription(){var e;if(this.defaultSubscriptionId)return this.defaultSubscriptionId;return null===(e=(await this.getSubscriptions())[0])||void 0===e?void 0:e.value}async getFirstWorkspace(){var e;if(this.firstWorkspace)return this.firstWorkspace;const t=await this.getDefaultOrFirstSubscription();if(!t)return;const r=null===(e=(await this.getWorkspaces(t))[0])||void 0===e?void 0:e.value;return r&&(this.firstWorkspace=r),r}annotationQuery(e){if(!e.annotation.rawQuery)return Promise.reject({message:"Query missing in annotation definition"});const t=this.buildQuery(e.annotation.rawQuery,e,e.annotation.workspace),r=this.doQueries(t);return Promise.all(r).then((t=>new C(t).transformToAnnotations(e)))}doQueries(e){return(0,a.map)(e,(e=>this.getResource(e.path).then((t=>({result:t,query:e}))).catch((t=>{throw{error:t,query:e}}))))}async testDatasource(){const e=this.validateDatasource();if(e)return e;let t;try{const e=await this.getFirstWorkspace();if(!e)return{status:"error",message:"Workspace not found."};t=e}catch(e){let t="Azure Log Analytics requires access to Azure Monitor but had the following error: ";return{status:"error",message:this.getErrorMessage(t,e)}}try{const e=(0,z.uD)(t)?`${this.resourcePath}/v1/workspaces/${t}/metadata`:`${this.resourcePath}/v1${t}/metadata`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Log Analytics service.",title:"Success"})))}catch(e){let t="Azure Log Analytics: ";return{status:"error",message:this.getErrorMessage(t,e)}}}getErrorMessage(e,t){return e+=t.statusText?t.statusText+": ":"",t.data&&t.data.error&&t.data.error.code?e+=t.data.error.code+". "+t.data.error.message:t.data&&t.data.error?e+=t.data.error:t.data?e+=t.data:e+="Cannot connect to Azure Log Analytics REST API.",e}validateDatasource(){if("clientsecret"===p(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}var F=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/resourcePicker/resourcePickerData.ts"),Q=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/observable/forkJoin.js"),P=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),V=r("./public/app/features/templating/template_srv.ts");class B extends k{constructor(e){super(e)}applyTemplateVariables(e,t){const r=e.insightsAnalytics;if(!r)return e;const s=r.rawQueryString&&!r.query?r.rawQueryString:r.query;return{refId:e.refId,queryType:u.B.InsightsAnalytics,insightsAnalytics:{query:(0,o.getTemplateSrv)().replace(s,t),resultFormat:r.resultFormat}}}}var L=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/migrateQuery.ts"),O=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js");class W extends o.DataSourceWithBackend{filterQuery(e){var t;return!(null===(t=e.azureResourceGraph)||void 0===t||!t.query)}applyTemplateVariables(e,t){const r=e.azureResourceGraph;if(!r)return e;const s=(0,o.getTemplateSrv)(),a=s.getVariables().map((e=>`$${e.name}`)),n=i().find(e.subscriptions,(e=>i().includes(a,e))),c=[...s.replace(n,t,(e=>e)).split(",").filter((e=>e.length>0)),...i().filter(e.subscriptions,(e=>!i().includes(a,e)))],l=s.replace(r.query,t,v.Ll);return{refId:e.refId,queryType:u.B.AzureResourceGraph,subscriptions:c,azureResourceGraph:{resultFormat:"table",query:l}}}}function $(e){var t,r,s,a,i;const o="string"==typeof e.rawQuery?e.rawQuery:null,n="string"==typeof e.workspace?e.workspace:null;if(!o||!n||null!==(t=e.target)&&void 0!==t&&null!==(r=t.azureLogAnalytics)&&void 0!==r&&r.query)return e;const c=Object.assign({},null!==(s=e.target)&&void 0!==s?s:{},{refId:null!==(a=null===(i=e.target)||void 0===i?void 0:i.refId)&&void 0!==a?a:"Anno",queryType:u.B.LogAnalytics,azureLogAnalytics:{query:o,resource:n}});return Object.assign({},e,{rawQuery:void 0,workspace:void 0,subscription:void 0,queryType:void 0,target:c})}var E=r("../../opt/drone/yarncache/rxjs-npm-7.5.1-ce59cbb6a3-78e3eecb16.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),U=r("./packages/grafana-ui/src/index.ts"),J=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),K=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/LogsQueryEditor/index.tsx"),_=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/useLastError.ts"),H=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/Space.tsx");const Z=e=>({subscriptions:e.match(/^Subscriptions\(\)/i),resourceGroups:e.match(/^ResourceGroups\(\)/i),resourceGroupsWithSub:e.match(/^ResourceGroups\(([^\)]+?)(,\s?([^,]+?))?\)/i),metricDefinitions:e.match(/^Namespaces\(([^\)]+?)(,\s?([^,]+?))?\)/i),metricDefinitionsWithSub:e.match(/^Namespaces\(([^,]+?),\s?([^,]+?)\)/i),resourceNames:e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?)\)/i),resourceNamesWithSub:e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/i),metricNamespace:e.match(/^MetricNamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNamespaceWithSub:e.match(/^metricnamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNames:e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNamesWithSub:e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?(.+?)\)/i),appInsightsMetricNameQuery:e.match(/^AppInsightsMetricNames\(\)/i),appInsightsGroupByQuery:e.match(/^AppInsightsGroupBys\(([^\)]+?)(,\s?([^,]+?))?\)/i),workspacesQuery:e.match(/^workspaces\(\)/i),workspacesQueryWithSub:e.match(/^workspaces\(["']?([^\)]+?)["']?\)/i)}),Y=async(e,t)=>"string"!=typeof e?e:(e=>{const t=Z(e);return Object.keys(t).some((e=>!!t[e]))})(e)?((e,t)=>{const r=Z(e),s=t.azureMonitorDatasource.defaultSubscriptionId;return{refId:"A",queryType:u.B.GrafanaTemplateVariableFn,grafanaTemplateVariableFn:r.appInsightsMetricNameQuery?{rawQuery:e,kind:"AppInsightsMetricNameQuery"}:r.appInsightsGroupByQuery?{kind:"AppInsightsGroupByQuery",rawQuery:e,metricName:r.appInsightsGroupByQuery[1]}:r.subscriptions?{kind:"SubscriptionsQuery",rawQuery:e}:r.resourceGroupsWithSub?{kind:"ResourceGroupsQuery",rawQuery:e,subscription:r.resourceGroupsWithSub[1]}:r.resourceGroups&&s?{kind:"ResourceGroupsQuery",rawQuery:e,subscription:s}:r.metricDefinitionsWithSub?{kind:"MetricDefinitionsQuery",rawQuery:e,subscription:r.metricDefinitionsWithSub[1],resourceGroup:r.metricDefinitionsWithSub[2]}:r.metricDefinitions&&s?{kind:"MetricDefinitionsQuery",rawQuery:e,subscription:s,resourceGroup:r.metricDefinitions[1]}:r.resourceNamesWithSub?{kind:"ResourceNamesQuery",rawQuery:e,subscription:r.resourceNamesWithSub[1],resourceGroup:r.resourceNamesWithSub[2],metricDefinition:r.resourceNamesWithSub[3]}:r.resourceNames&&s?{kind:"ResourceNamesQuery",rawQuery:e,subscription:s,resourceGroup:r.resourceNames[1],metricDefinition:r.resourceNames[2]}:r.metricNamespaceWithSub?{kind:"MetricNamespaceQuery",rawQuery:e,subscription:r.metricNamespaceWithSub[1],resourceGroup:r.metricNamespaceWithSub[2],metricDefinition:r.metricNamespaceWithSub[3],resourceName:r.metricNamespaceWithSub[4]}:r.metricNamespace&&s?{kind:"MetricNamespaceQuery",rawQuery:e,subscription:s,resourceGroup:r.metricNamespace[1],metricDefinition:r.metricNamespace[2],resourceName:r.metricNamespace[3]}:r.metricNames&&s&&-1===r.metricNames[3].indexOf(",")?{kind:"MetricNamesQuery",rawQuery:e,subscription:s,resourceGroup:r.metricNames[1],metricDefinition:r.metricNames[2],resourceName:r.metricNames[3],metricNamespace:r.metricNames[4]}:r.metricNamesWithSub?{kind:"MetricNamesQuery",rawQuery:e,subscription:r.metricNamesWithSub[1],resourceGroup:r.metricNamesWithSub[2],metricDefinition:r.metricNamesWithSub[3],resourceName:r.metricNamesWithSub[4],metricNamespace:r.metricNamesWithSub[5]}:r.workspacesQueryWithSub?{kind:"WorkspacesQuery",rawQuery:e,subscription:(r.workspacesQueryWithSub[1]||"").trim()}:r.workspacesQuery&&s?{kind:"WorkspacesQuery",rawQuery:e,subscription:s}:{kind:"SubscriptionsQuery",rawQuery:e},subscription:s}})(e,t.datasource):(async(e,t)=>{const r=t.azureMonitorDatasource.defaultSubscriptionId;let s="";if(e){const e=t.azureLogAnalyticsDatasource.getDeprecatedDefaultWorkSpace();s=e?(0,z.uD)(e)?await t.resourcePickerData.getResourceURIFromWorkspace(e):e:await t.azureLogAnalyticsDatasource.getFirstWorkspace()||""}return{refId:"A",queryType:u.B.LogAnalytics,azureLogAnalytics:{query:e,resource:s},subscription:r}})(e,t.datasource);var ee,te=r("../../opt/drone/yarncache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const re=[{label:"Grafana Query Function",value:u.B.GrafanaTemplateVariableFn},{label:"Logs",value:u.B.LogAnalytics}],se=e=>{var t;let{query:r,updateQuery:s,datasource:a}=e;const[i,o]=(0,J.useState)("");(0,J.useEffect)((()=>{var e;o((null===(e=r.grafanaTemplateVariableFn)||void 0===e?void 0:e.rawQuery)||"")}),[null===(t=r.grafanaTemplateVariableFn)||void 0===t?void 0:t.rawQuery]);const n=(0,J.useCallback)((e=>{Y(e,{datasource:a}).then((t=>{t.queryType===u.B.GrafanaTemplateVariableFn?s(t):s(Object.assign({},r,{grafanaTemplateVariableFn:{kind:"UnknownQuery",rawQuery:e}}))}))}),[a,r,s]);return(0,te.jsx)(U.InlineField,{label:"Grafana template variable function",children:(0,te.jsx)(U.Input,{placeholder:"type a grafana template variable function, ex: Subscriptions()",value:i,onChange:e=>{o(e.target.value)},onBlur:()=>n(i)})})},ae=e=>{const t={refId:"A",queryType:u.B.GrafanaTemplateVariableFn},[r,s]=(0,J.useState)(t);(0,J.useEffect)((()=>{Y(e.query,{datasource:e.datasource}).then((e=>{s(e)}))}),[e.query,e.datasource]);const[a,i]=(0,_.Z)();return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(U.InlineField,{label:"Select query type",children:(0,te.jsx)(U.Select,{"aria-label":"select query type",onChange:e=>{e.value&&s(Object.assign({},r,{queryType:e.value}))},options:re,width:25,value:r.queryType})}),r.queryType===u.B.LogAnalytics&&(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(K.Z,{subscriptionId:r.subscription,query:r,datasource:e.datasource,onChange:t=>{var r;s(t),null!==(r=t.azureLogAnalytics)&&void 0!==r&&r.query&&e.onChange(t)},variableOptionGroup:{label:"Template Variables",options:[]},setError:i,hideFormatAs:!0}),a&&(0,te.jsxs)(te.Fragment,{children:[ee||(ee=(0,te.jsx)(H.T,{v:2})),(0,te.jsx)(U.Alert,{severity:"error",title:"An error occurred while requesting metadata from Azure Monitor",children:a})]})]}),r.queryType===u.B.GrafanaTemplateVariableFn&&(0,te.jsx)(se,{query:r,updateQuery:e.onChange,datasource:e.datasource})]})};var ie,oe,ne,ce,ue,le,pe,de=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/messageFromError.ts");class me extends s.CustomVariableSupport{constructor(e){var t,r,s;super(),s=ae,(r="editor")in(t=this)?Object.defineProperty(t,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[r]=s,this.datasource=e,this.datasource=e,this.query=this.query.bind(this)}query(e){return(0,T.D)((async()=>{const t=await Y(e.targets[0],{datasource:this.datasource});if(t.queryType===u.B.GrafanaTemplateVariableFn&&t.grafanaTemplateVariableFn)try{const e=await this.callGrafanaTemplateVariableFn(t.grafanaTemplateVariableFn);return{data:e?[(0,s.toDataFrame)(e)]:[]}}catch(e){return{data:[],error:{message:(0,de.Z)(e)}}}return e.targets[0]=t,(0,E.n)(this.datasource.query(e))})())}callGrafanaTemplateVariableFn(e){if(this.datasource.insightsAnalyticsDatasource){if("AppInsightsMetricNameQuery"===e.kind)return this.datasource.insightsAnalyticsDatasource.getMetricNames();if("AppInsightsGroupByQuery"===e.kind)return this.datasource.insightsAnalyticsDatasource.getGroupBys((0,o.getTemplateSrv)().replace(e.metricName))}return"SubscriptionsQuery"===e.kind?this.datasource.getSubscriptions():"ResourceGroupsQuery"===e.kind?this.datasource.getResourceGroups(this.replaceVariable(e.subscription)):"MetricDefinitionsQuery"===e.kind?this.datasource.getMetricDefinitions(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup)):"ResourceNamesQuery"===e.kind?this.datasource.getResourceNames(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition)):"MetricNamespaceQuery"===e.kind?this.datasource.getMetricNamespaces(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition),this.replaceVariable(e.resourceName)):"MetricNamesQuery"===e.kind?this.datasource.getMetricNames(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition),this.replaceVariable(e.resourceName),this.replaceVariable(e.metricNamespace)):"WorkspacesQuery"===e.kind?this.datasource.azureLogAnalyticsDatasource.getWorkspaces(this.replaceVariable(e.subscription)):null}replaceVariable(e){return(0,o.getTemplateSrv)().replace((e||"").trim())}}function he(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ge extends s.DataSourceApi{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,V.J)();super(e),he(this,"annotations",{prepareAnnotation:$}),he(this,"azureMonitorDatasource",void 0),he(this,"azureLogAnalyticsDatasource",void 0),he(this,"resourcePickerData",void 0),he(this,"azureResourceGraphDatasource",void 0),he(this,"appInsightsDatasource",void 0),he(this,"insightsAnalyticsDatasource",void 0),he(this,"pseudoDatasource",{}),this.templateSrv=t,this.azureMonitorDatasource=new I(e),this.azureLogAnalyticsDatasource=new q(e),this.azureResourceGraphDatasource=new W(e),this.resourcePickerData=new F.Z(e),this.pseudoDatasource={[u.B.AzureMonitor]:this.azureMonitorDatasource,[u.B.LogAnalytics]:this.azureLogAnalyticsDatasource,[u.B.AzureResourceGraph]:this.azureResourceGraphDatasource};const r=h(e);"azuremonitor"!==r&&"chinaazuremonitor"!==r||(this.appInsightsDatasource=new k(e),this.insightsAnalyticsDatasource=new B(e),this.pseudoDatasource[u.B.ApplicationInsights]=this.appInsightsDatasource,this.pseudoDatasource[u.B.InsightsAnalytics]=this.insightsAnalyticsDatasource),this.variables=new me(this)}filterQuery(e){var t,r;if(!e.queryType)return!0;const s=this.pseudoDatasource[e.queryType];return null===(t=null==s||null===(r=s.filterQuery)||void 0===r?void 0:r.call(s,e))||void 0===t||t}query(e){const t=new Map;for(const r of e.targets){const s=(0,L.N)(r);if(!s.queryType||s.hide||!fe(s))continue;if(!t.has(s.queryType)){const r=(0,a.cloneDeep)(e);r.requestId=`${r.requestId}-${s.refId}`,r.targets=[],t.set(s.queryType,r)}const i=t.get(s.queryType);null==i||i.targets.push(s)}const r=Array.from(t.entries()).map((e=>{let[t,r]=e;const s=this.pseudoDatasource[t];if(!s)throw new Error("Data source not created for query type "+t);return s.query(r)}));return 1===r.length?r[0]:r.length>1?(0,Q.D)(r).pipe((0,O.U)((e=>{const t=[];for(const r of e)for(const e of r.data)t.push(e);return{state:s.LoadingState.Done,data:t}}))):(0,P.of)({state:s.LoadingState.Done,data:[]})}targetContainsTemplate(e){if(e.subscription&&this.templateSrv.variableExists(e.subscription))return!0;let t;return e.queryType===u.B.AzureMonitor?t=JSON.stringify(e.azureMonitor):e.queryType===u.B.LogAnalytics?t=JSON.stringify(e.azureLogAnalytics):e.queryType===u.B.AzureResourceGraph&&(t=JSON.stringify([e.azureResourceGraph,e.subscriptions])),!!t&&this.templateSrv.variableExists(t)}async annotationQuery(e){return this.azureLogAnalyticsDatasource.annotationQuery(e)}async testDatasource(){var e;const t=[];return t.push(this.azureMonitorDatasource.testDatasource()),t.push(this.azureLogAnalyticsDatasource.testDatasource()),null!==(e=this.appInsightsDatasource)&&void 0!==e&&e.isConfigured()&&t.push(this.appInsightsDatasource.testDatasource()),await Promise.all(t).then((e=>{let t="success",r="";for(let s=0;s<e.length;s++)"success"!==e[s].status&&(t=e[s].status),r+=`${s+1}. ${e[s].message} `;return{status:t,message:r,title:(0,a.upperFirst)(t)}}))}getResourceGroups(e){return this.azureMonitorDatasource.getResourceGroups(this.replaceTemplateVariable(e))}getMetricDefinitions(e,t){return this.azureMonitorDatasource.getMetricDefinitions(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t))}getResourceNames(e,t,r){return this.azureMonitorDatasource.getResourceNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(r))}getMetricNames(e,t,r,s,a){return this.azureMonitorDatasource.getMetricNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(r),this.replaceTemplateVariable(s),this.replaceTemplateVariable(a))}getMetricNamespaces(e,t,r,s){return this.azureMonitorDatasource.getMetricNamespaces(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(r),this.replaceTemplateVariable(s))}getMetricMetadata(e,t,r,s,a,i){return this.azureMonitorDatasource.getMetricMetadata(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(r),this.replaceTemplateVariable(s),this.replaceTemplateVariable(a),this.replaceTemplateVariable(i))}getAppInsightsMetricNames(){var e;return null===(e=this.appInsightsDatasource)||void 0===e?void 0:e.getMetricNames()}getAppInsightsMetricMetadata(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.getMetricMetadata(e)}getAppInsightsColumns(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.logAnalyticsColumns[e]}getAzureLogAnalyticsWorkspaces(e){return this.azureLogAnalyticsDatasource.getWorkspaces(e)}getSubscriptions(){return this.azureMonitorDatasource.getSubscriptions()}interpolateVariablesInQueries(e,t){return e.map((e=>{var r;if(!e.queryType)return e;const s=this.pseudoDatasource[e.queryType];return null!==(r=null==s?void 0:s.applyTemplateVariables(e,t))&&void 0!==r?r:e}))}replaceTemplateVariable(e){return this.templateSrv.replace(e)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}isTemplateVariable(e){return this.getVariables().includes(e)}}function fe(e){switch(e.queryType){case u.B.AzureMonitor:return!!e.azureMonitor;case u.B.LogAnalytics:return!!e.azureLogAnalytics;case u.B.AzureResourceGraph:return!!e.azureResourceGraph;case u.B.GrafanaTemplateVariableFn:return!!e.grafanaTemplateVariableFn;case u.B.ApplicationInsights:return!!e.appInsights;case u.B.InsightsAnalytics:return!!e.insightsAnalytics;default:return!1}}const{Input:ye}=U.LegacyForms,ve=[{value:"msi",label:"Managed Identity"},{value:"clientsecret",label:"App Registration"}],be=e=>{const{credentials:t,azureCloudOptions:r,onCredentialsChange:s,getSubscriptions:a,disabled:i}=e,o=function(e){switch(e.authType){case"msi":return!0;case"clientsecret":return!!(e.azureCloud&&e.tenantId&&e.clientId&&e.clientSecret)}}(t),[n,c]=(0,J.useState)([]),[u,l]=(0,J.useReducer)((e=>e+1),0);(0,J.useEffect)((()=>{if(!a||!o)return void p([]);let e=!1;return a().then((t=>{e||p(t,u)})),()=>{e=!0}}),[u]);const p=function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(c(e),a)if(r&&!t.defaultSubscriptionId&&e.length>0)d(e[0]);else if(t.defaultSubscriptionId){e.find((e=>e.value===t.defaultSubscriptionId))||d(void 0)}},d=e=>{if(s){const r=Object.assign({},t,{defaultSubscriptionId:null==e?void 0:e.value});s(r)}};return(0,te.jsxs)("div",{className:"gf-form-group",children:[e.managedIdentityEnabled&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ie||(ie=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",tooltip:"Choose the type of authentication to Azure services",children:"Authentication"})),(0,te.jsx)(U.Select,{menuShouldPortal:!0,className:"width-15",value:ve.find((e=>e.value===t.authType)),options:ve,onChange:e=>{if(s){c([]);const r=Object.assign({},t,{authType:e.value||"msi",defaultSubscriptionId:void 0});s(r)}},disabled:i})]})}),"clientsecret"===t.authType&&(0,te.jsxs)(te.Fragment,{children:[r&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[oe||(oe=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",tooltip:"Choose an Azure Cloud",children:"Azure Cloud"})),(0,te.jsx)(U.Select,{"aria-label":"Azure Cloud",menuShouldPortal:!0,className:"width-15",value:r.find((e=>e.value===t.azureCloud)),options:r,onChange:e=>{if(s&&"clientsecret"===t.authType){c([]);const r=Object.assign({},t,{azureCloud:e.value,defaultSubscriptionId:void 0});s(r)}},disabled:i})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ne||(ne=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Directory (tenant) ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(ye,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.tenantId||"",onChange:e=>{if(s&&"clientsecret"===t.authType){c([]);const r=Object.assign({},t,{tenantId:e.target.value,defaultSubscriptionId:void 0});s(r)}},disabled:i})})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ce||(ce=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Application (client) ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(ye,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientId||"",onChange:e=>{if(s&&"clientsecret"===t.authType){c([]);const r=Object.assign({},t,{clientId:e.target.value,defaultSubscriptionId:void 0});s(r)}},disabled:i})})]})}),!i&&("symbol"==typeof t.clientSecret?(0,te.jsxs)("div",{className:"gf-form-inline",children:[ue||(ue=(0,te.jsxs)("div",{className:"gf-form",children:[(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Client Secret"}),(0,te.jsx)(ye,{"data-testid":"client-secret",className:"width-25",placeholder:"configured",disabled:!0})]})),(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",type:"button",onClick:()=>{if(s&&"clientsecret"===t.authType){c([]);const e=Object.assign({},t,{clientSecret:"",defaultSubscriptionId:void 0});s(e)}},disabled:i,children:"reset"})})})]}):(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[le||(le=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Client Secret"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(ye,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientSecret||"",onChange:e=>{if(s&&"clientsecret"===t.authType){c([]);const r=Object.assign({},t,{clientSecret:e.target.value,defaultSubscriptionId:void 0});s(r)}},disabled:i})})]})}))]}),a&&(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[pe||(pe=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Default Subscription"})),(0,te.jsx)("div",{className:"width-30",children:(0,te.jsx)(U.Select,{"aria-label":"Default Subscription",menuShouldPortal:!0,value:t.defaultSubscriptionId?n.find((e=>e.value===t.defaultSubscriptionId)):void 0,options:n,onChange:d,disabled:i})})]})}),!i&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",size:"sm",type:"button",onClick:l,disabled:!o,children:"Load Subscriptions"})})})})]}),e.children]})};var Me;const Se=[{value:"azuremonitor",label:"Azure"},{value:"govazuremonitor",label:"Azure US Government"},{value:"germanyazuremonitor",label:"Azure Germany"},{value:"chinaazuremonitor",label:"Azure China"}],we=e=>{const{updateOptions:t,getSubscriptions:r}=e,s=(0,J.useMemo)((()=>f(e.options)),[e.options]);return(0,te.jsxs)(te.Fragment,{children:[Me||(Me=(0,te.jsx)("h3",{className:"page-heading",children:"Authentication"})),(0,te.jsx)(be,{managedIdentityEnabled:o.config.azure.managedIdentityEnabled,credentials:s,azureCloudOptions:Se,onCredentialsChange:e=>{t((t=>function(e,t){switch(t.authType){case"msi":if(!o.config.azure.managedIdentityEnabled)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"msi",subscriptionId:t.defaultSubscriptionId})});case"clientsecret":return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"clientsecret",cloudName:t.azureCloud||d(),tenantId:t.tenantId,clientId:t.clientId,subscriptionId:t.defaultSubscriptionId}),secureJsonData:Object.assign({},e.secureJsonData,{clientSecret:"string"==typeof t.clientSecret&&t.clientSecret.length>0?t.clientSecret:void 0}),secureJsonFields:Object.assign({},e.secureJsonFields,{clientSecret:"symbol"==typeof t.clientSecret})})}}(t,e)))},getSubscriptions:r,disabled:e.options.readOnly})]})};var Ne,Ie;const Ae=e=>{const{updateOptions:t}=e,r=(0,J.useMemo)((()=>f(e.options)),[e.options]);return"clientsecret"===r.authType&&!1===e.options.jsonData.azureLogAnalyticsSameAs?(0,te.jsxs)(te.Fragment,{children:[Ne||(Ne=(0,te.jsx)("h3",{className:"page-heading",children:"Azure Monitor Logs"})),(0,te.jsxs)(te.Fragment,{children:[Ie||(Ie=(0,te.jsx)(U.Alert,{severity:"error",title:"Deprecated",children:"Using different credentials for Azure Monitor Logs is no longer supported. Authentication information above will be used instead. Please create a new data source with the credentials below."})),(0,te.jsx)(be,{managedIdentityEnabled:!1,credentials:Object.assign({},r,{authType:"clientsecret",tenantId:e.options.jsonData.logAnalyticsTenantId,clientId:e.options.jsonData.logAnalyticsClientId}),disabled:!0,children:(0,te.jsx)(U.Button,{onClick:()=>{t((e=>Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureLogAnalyticsSameAs:!0})})))},children:"Clear Azure Monitor Logs Credentials"})})]})]}):null};var De,ke,Te,xe,ze;const{Input:je}=U.LegacyForms;class Ce extends J.PureComponent{constructor(){var e,t,r;super(...arguments),r=()=>{this.props.onResetOptionKey("appInsightsApiKey")},(t="onAppInsightsResetApiKey")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}render(){const{options:e,onUpdateJsonDataOption:t,onUpdateSecureJsonDataOption:r}=this.props;return(0,te.jsxs)(te.Fragment,{children:[De||(De=(0,te.jsx)("h3",{className:"page-heading",children:"Azure Application Insights"})),ke||(ke=(0,te.jsx)(U.Alert,{severity:"info",title:"Application Insights credentials are deprecated",children:"Configure using Azure AD App Registration above and update existing queries to use Metrics or Logs."})),(0,te.jsxs)("div",{className:"gf-form-group",children:[e.secureJsonFields.appInsightsApiKey?(0,te.jsxs)("div",{className:"gf-form-inline",children:[Te||(Te=(0,te.jsxs)("div",{className:"gf-form",children:[(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"API Key"}),(0,te.jsx)(je,{className:"width-25",placeholder:"configured",disabled:!0})]})),(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",type:"button",onClick:this.onAppInsightsResetApiKey,disabled:this.props.options.readOnly,children:"reset"})})})]}):(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[xe||(xe=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"API Key"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(je,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:e.secureJsonData.appInsightsApiKey||"",onChange:r("appInsightsApiKey"),disabled:this.props.options.readOnly})})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ze||(ze=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Application ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(je,{className:"width-30",value:e.jsonData.appInsightsAppId||"",onChange:t("appInsightsAppId"),disabled:this.props.options.readOnly})})]})})]})]})}}function Ge(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Re extends J.PureComponent{constructor(e){var t;super(e),Ge(this,"templateSrv",(0,o.getTemplateSrv)()),Ge(this,"baseURL",void 0),Ge(this,"updateOptions",(e=>{const t=e(this.props.options);this.props.onOptionsChange(t),this.setState({unsaved:!0})})),Ge(this,"saveOptions",(async()=>{this.state.unsaved&&(await(0,o.getBackendSrv)().put(`/api/datasources/${this.props.options.id}`,this.props.options).then((e=>{(0,s.updateDatasourcePluginOption)(this.props,"version",e.datasource.version)})),this.setState({unsaved:!1}))})),Ge(this,"getSubscriptions",(async()=>{await this.saveOptions();try{const e=await(0,o.getBackendSrv)().fetch({url:this.baseURL+"?api-version=2019-03-01",method:"GET"}).toPromise();return this.setState({error:void 0}),b.parseSubscriptionsForSelect(e)}catch(t){var e;return this.setState({error:{title:"Error requesting subscriptions",description:"Could not request subscriptions from Azure. Check your credentials and try again.",details:null==t||null===(e=t.data)||void 0===e?void 0:e.message}}),Promise.resolve([])}})),Ge(this,"onUpdateJsonDataOption",(e=>t=>{(0,s.updateDatasourcePluginJsonDataOption)(this.props,e,t.currentTarget.value)})),Ge(this,"onUpdateSecureJsonDataOption",(e=>t=>{(0,s.updateDatasourcePluginSecureJsonDataOption)(this.props,e,t.currentTarget.value)})),Ge(this,"resetSecureKey",(e=>{(0,s.updateDatasourcePluginResetOption)(this.props,e)})),this.state={unsaved:!1,appInsightsInitiallyConfigured:(t=e.options,!(!t.jsonData.appInsightsAppId||!t.secureJsonFields.appInsightsApiKey))},this.baseURL=`/api/datasources/${this.props.options.id}/resources/${v.kr.azureMonitor}/subscriptions`}render(){const{options:e}=this.props,{error:t}=this.state;return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(we,{options:e,updateOptions:this.updateOptions,getSubscriptions:this.getSubscriptions}),(0,te.jsx)(Ae,{options:e,updateOptions:this.updateOptions}),this.state.appInsightsInitiallyConfigured&&(0,te.jsx)(Ce,{options:e,onUpdateJsonDataOption:this.onUpdateJsonDataOption,onUpdateSecureJsonDataOption:this.onUpdateSecureJsonDataOption,onResetOptionKey:this.resetSecureKey}),t&&(0,te.jsxs)(U.Alert,{severity:"error",title:t.title,children:[(0,te.jsx)("p",{children:t.description}),t.details&&(0,te.jsx)("details",{style:{whiteSpace:"pre-wrap"},children:t.details})]})]})}}var Xe=r("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/QueryEditor/QueryEditor.tsx");const qe=new s.DataSourcePlugin(ge).setConfigEditor(Re).setQueryEditor(Xe.Z)}}]);
//# sourceMappingURL=azureMonitorPlugin.0cedc4c919aff84ce58c.js.map